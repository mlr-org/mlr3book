## Cluster Analysis {#cluster}

`r library(mlr3book)`

Cluster analysis is a type of unsupervised machine learning where the goal is to group data into clusters, where each cluster contains similar observations.
The similarity is based on specified metrics that are task and application dependent. 
Cluster analysis is closely related to classification in a sense that each observation needs to be assigned to a cluster or a class. 
However, unlike classification problem where each observation is labeled, clustering works on data sets without true labels or class assignments. 


The package `r mlr_pkg("mlr3cluster")` extends `r mlr_pkg("mlr3")` with the following objects for cluster analysis:

* `r ref("mlr3cluster::TaskClust", text = "TaskClust")` to define clustering tasks
* `r ref("mlr3cluster::LearnerClust", text = "LearnerClust")` as base class for clustering learners
* `r ref("mlr3cluster::PredictionClust", text = "PredictionClust")` as specialized class for `r ref("Prediction")` objects
* `r ref("mlr3cluster::MeasureClust", text = "MeasureClust")` as specialized class for performance measures

In this chapter, we give an introduction to cluster analysis in mlr3. 

### Task
```{r 07-special-cluster-001, message=FALSE, warning=FALSE}
library("mlr3")
library("mlr3cluster")
library("mlr3viz")

task = tsk("usarrests")
autoplot(task)
```

Since clustering is type of unsupervised learning, `TaskClust` is slightly different from `TaskRegr` and `TaskClassif` objects. 
More specifically:

  * `truth()` function is missing because observations are not labeled. 
  * `target` field is empty and will return `character(0)` if accessed anyways. 


### Train and Predict
Clustering learners provide both `train` and `predict` methods. 
The analysis typically consists of building clusters using all available data. 
Nevertheless, some learners can assign new observations to existing groups with `predict`.
However, `predict` does not always make sense, (e.g., hierarchical clustering).
Moreover, some learners estimate probability of each observation belonging in a given cluster.
`predict_types` field prints a list of prediction types for each learner. 

After training, `model` field stores learner's model that looks different for each learner depending on the underlying library.  
`predict` returns `PredictionClust` object that gives a simplified view of the learned model. 
If the new "test" data is the same data on which the learner was trained, `predict` simply returns assignments for the observations on which the clusterer learned.  
If "test" data contains new observations, `predict` will estimate cluster assignments for the "test" set (some learners do not do that so read the documentation first).

```{r 07-special-cluster-002, message=FALSE, warning=FALSE}
# create task and learner
task = tsk("usarrests")
learner = lrn("clust.kmeans")

# assigning each observation to one of the two clusters (default in clust.kmeans)
learner$train(task)
learner$model

# make "predictions" for the same data
prediction = learner$predict(task)
autoplot(prediction, task)
```


### Measures
To assess the quality of clustering, there are a few built-in evaluation metrics available. 
One of them is silhouette quality index that measures how each point within a cluster is similar to other points within the same cluster as compared to points in the neighboring clusters. 
Using silhouette plots, one can visually assess the quality of the analysis and choose the most optimal number of clusters for the data. 

```{r 07-special-cluster-003, message=FALSE, warning=FALSE}
# silhouette plot allows to visually inspect the quality of clustering 
autoplot(prediction, task, type = "sil")
```


### Visualization
Cluster analysis in mlr3 is integrated with `r mlr_pkg("mlr3viz")` which provides a number of useful plots. 

```{r 07-special-cluster-004, message=FALSE, warning=FALSE}
task = tsk("usarrests")
learner = lrn("clust.kmeans")
learner$train(task)
prediction = learner$predict(task)

# performing PCA on task and showing assignments
autoplot(prediction, task, type = "pca")

# same as above but with probability ellipse that assumes normal distribution
autoplot(prediction, task, type = "pca", frame = TRUE, frame.type = 'norm')


task = tsk("usarrests")
learner = lrn("clust.agnes")
learner$train(task)

# dendrogram for hierarchical clustering
autoplot(learner)

# advanced dendrogram options from `factoextra::fviz_dend`
autoplot(learner,
  k = learner$param_set$values$k, rect_fill = TRUE,
  rect = TRUE, rect_border = c("red", "cyan"))
```