<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Appendix A — Solutions to exercises – Applied Machine Learning Using mlr3 in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../chapters/appendices/tasks.html" rel="next">
<link href="../../chapters/references.html" rel="prev">
<link href="../../Figures/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-0d45b1ff1595a53868627e64e30aef28.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-54b1fec74e0844836633235e285d9714.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../chapters/appendices/solutions.html">Appendices</a></li><li class="breadcrumb-item"><a href="../../chapters/appendices/solutions.html"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Solutions to exercises</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Applied Machine Learning Using mlr3 in R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mlr-org/mlr3book/tree/main/book/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../../Applied-Machine-Learning-Using-mlr3-in-R.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter1/introduction_and_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction and Overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Fundamentals</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter2/data_and_basic_modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data and Basic Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter3/evaluation_and_benchmarking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Evaluation and Benchmarking</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Tuning and Feature Selection</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter4/hyperparameter_optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Hyperparameter Optimization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter5/advanced_tuning_methods_and_black_box_optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Advanced Tuning Methods and Black Box Optimization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter6/feature_selection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Feature Selection</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Pipelines and Preprocessing</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter7/sequential_pipelines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Sequential Pipelines</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter8/non-sequential_pipelines_and_tuning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Non-sequential Pipelines and Tuning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter9/preprocessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Preprocessing</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter10/advanced_technical_aspects_of_mlr3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Advanced Technical Aspects of mlr3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter11/large-scale_benchmarking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Large-Scale Benchmarking</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter12/model_interpretation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Model Interpretation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter13/beyond_regression_and_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Beyond Regression and Classification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter14/algorithmic_fairness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Algorithmic Fairness</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter15/predsets_valid_inttune.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Predict Sets, Validation and Internal Tuning (+)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter16/advanced_hyperparameter_specification_using_paradox.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Advanced Hyperparameter Specification using paradox</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">References</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/solutions.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Solutions to exercises</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Tasks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/overview-tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Overview Tables</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/errata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Errata</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/session_info.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Session Info</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#solutions-to-sec-basics" id="toc-solutions-to-sec-basics" class="nav-link active" data-scroll-target="#solutions-to-sec-basics"><span class="header-section-number">A.1</span> Solutions to <span>Chapter 2</span></a></li>
  <li><a href="#solutions-to-sec-performance" id="toc-solutions-to-sec-performance" class="nav-link" data-scroll-target="#solutions-to-sec-performance"><span class="header-section-number">A.2</span> Solutions to <span>Chapter 3</span></a></li>
  <li><a href="#solutions-to-sec-optimization" id="toc-solutions-to-sec-optimization" class="nav-link" data-scroll-target="#solutions-to-sec-optimization"><span class="header-section-number">A.3</span> Solutions to <span>Chapter 4</span></a></li>
  <li><a href="#solutions-to-sec-optimization-advanced" id="toc-solutions-to-sec-optimization-advanced" class="nav-link" data-scroll-target="#solutions-to-sec-optimization-advanced"><span class="header-section-number">A.4</span> Solutions to <span>Chapter 5</span></a></li>
  <li><a href="#solutions-to-sec-feature-selection" id="toc-solutions-to-sec-feature-selection" class="nav-link" data-scroll-target="#solutions-to-sec-feature-selection"><span class="header-section-number">A.5</span> Solutions to <span>Chapter 6</span></a></li>
  <li><a href="#solutions-to-sec-pipelines" id="toc-solutions-to-sec-pipelines" class="nav-link" data-scroll-target="#solutions-to-sec-pipelines"><span class="header-section-number">A.6</span> Solutions to <span>Chapter 7</span></a></li>
  <li><a href="#solutions-to-sec-pipelines-nonseq" id="toc-solutions-to-sec-pipelines-nonseq" class="nav-link" data-scroll-target="#solutions-to-sec-pipelines-nonseq"><span class="header-section-number">A.7</span> Solutions to <span>Chapter 8</span></a></li>
  <li><a href="#solutions-for-sec-preprocessing" id="toc-solutions-for-sec-preprocessing" class="nav-link" data-scroll-target="#solutions-for-sec-preprocessing"><span class="header-section-number">A.8</span> Solutions for <span>Chapter 9</span></a></li>
  <li><a href="#solutions-to-sec-technical" id="toc-solutions-to-sec-technical" class="nav-link" data-scroll-target="#solutions-to-sec-technical"><span class="header-section-number">A.9</span> Solutions to <span>Chapter 10</span></a></li>
  <li><a href="#solutions-to-sec-large-benchmarking" id="toc-solutions-to-sec-large-benchmarking" class="nav-link" data-scroll-target="#solutions-to-sec-large-benchmarking"><span class="header-section-number">A.10</span> Solutions to <span>Chapter 11</span></a></li>
  <li><a href="#solutions-to-sec-interpretation" id="toc-solutions-to-sec-interpretation" class="nav-link" data-scroll-target="#solutions-to-sec-interpretation"><span class="header-section-number">A.11</span> Solutions to <span>Chapter 12</span></a></li>
  <li><a href="#solutions-to-sec-special" id="toc-solutions-to-sec-special" class="nav-link" data-scroll-target="#solutions-to-sec-special"><span class="header-section-number">A.12</span> Solutions to <span>Chapter 13</span></a></li>
  <li><a href="#solutions-to-sec-fairness" id="toc-solutions-to-sec-fairness" class="nav-link" data-scroll-target="#solutions-to-sec-fairness"><span class="header-section-number">A.13</span> Solutions to <span>Chapter 14</span></a></li>
  <li><a href="#solutions-to-sec-predsets-valid-inttune" id="toc-solutions-to-sec-predsets-valid-inttune" class="nav-link" data-scroll-target="#solutions-to-sec-predsets-valid-inttune"><span class="header-section-number">A.14</span> Solutions to <span>Chapter 15</span></a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/mlr-org/mlr3book/edit/main/book/chapters/appendices/solutions.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mlr-org/mlr3book/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/mlr-org/mlr3book/blob/main/book/chapters/appendices/solutions.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../chapters/appendices/solutions.html">Appendices</a></li><li class="breadcrumb-item"><a href="../../chapters/appendices/solutions.html"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Solutions to exercises</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-solutions" class="quarto-section-identifier">Appendix A — Solutions to exercises</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><!-- ENSURE ONLINE ONLY AND REFERENCE IN PREFACE --><section id="solutions-to-sec-basics" class="level2" data-number="A.1"><h2 data-number="A.1" class="anchored" data-anchor-id="solutions-to-sec-basics">
<span class="header-section-number">A.1</span> Solutions to <a href="../chapter2/data_and_basic_modeling.html" class="quarto-xref"><span>Chapter 2</span></a>
</h2>
<ol type="1">
<li>Train a classification model with the <code>classif.rpart</code> learner on the “Pima Indians Diabetes” dataset. Do this without using <code>tsk("pima")</code>, and instead by constructing a task from the dataset in the <code>mlbench</code>-package: <code>data(PimaIndiansDiabetes2, package = "mlbench")</code>. Make sure to define the <code>pos</code> outcome as positive class. Train the model on a random 80% subset of the given data and evaluate its performance with the classification error measure on the remaining data. (Note that the data set has NAs in its features. You can either rely on <code>rpart</code>‘s capability to handle them internally (’surrogate splits’) or remove them from the initial <code>data.frame</code> by using <code>na.omit</code>).</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">PimaIndiansDiabetes2</span>, package <span class="op">=</span> <span class="st">"mlbench"</span><span class="op">)</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">as_task_classif</span><span class="op">(</span><span class="va">PimaIndiansDiabetes2</span>, target <span class="op">=</span> <span class="st">"diabetes"</span>, positive <span class="op">=</span> <span class="st">"pos"</span><span class="op">)</span></span>
<span><span class="va">splits</span> <span class="op">=</span> <span class="fu">partition</span><span class="op">(</span><span class="va">task</span>, ratio <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">splits</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$train
  [1]   1   2   3   4   5   6   7   8  11  13  15  16  17  18  19  20  21
 [18]  22  25  26  27  28  29  30  31  32  33  34  35  36  37  39  40  41
 [35]  42  43  44  45  47  48  49  51  52  54  55  56  58  59  60  61  62
 [52]  65  66  67  69  71  72  73  77  79  81  82  83  84  85  86  87  89
 [69]  91  92  93  97  98  99 100 101 103 104 105 106 107 108 109 110 111
 [86] 112 114 115 116 117 118 119 121 122 123 124 125 126 127 128 129 130
[103] 131 132 133 134 135 136 137 138 139 140 141 143 145 146 147 148 150
[120] 153 158 159 161 162 163 164 166 167 168 169 170 173 175 176 177 178
[137] 179 180 181 182 183 184 185 186 187 189 190 191 192 193 194 197 198
[154] 201 203 204 205 206 207 208 209 212 213 214 215 216 217 218 219 220
[171] 221 222 227 228 229 230 232 233 234 235 236 238 240 241 242 243 244
[188] 247 248 249 250 252 253 254 255 256 257 259 260 261 262 263 264 265
[205] 266 267 268 269 270 271 272 273 276 277 279 280 281 282 283 284 285
[222] 286 287 289 290 291 293 294 295 296 297 299 300 301 302 303 304 305
[239] 307 309 310 311 314 315 316 318 320 321 322 323 324 325 326 327 328
[256] 329 330 332 333 334 335 336 337 338 339 340 343 345 346 349 350 351
[273] 352 354 355 356 357 358 359 360 361 363 365 367 368 369 371 373 374
[290] 375 376 377 378 379 380 381 382 383 384 385 388 389 390 391 392 394
[307] 395 397 400 401 402 403 404 405 406 407 408 409 411 412 413 415 416
[324] 418 419 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435
[341] 436 437 438 439 440 441 442 443 444 446 448 449 451 453 454 455 457
[358] 458 459 460 461 462 463 464 465 467 468 470 471 472 473 474 475 476
[375] 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493
[392] 494 495 496 498 499 500 501 502 503 504 505 506 507 508 509 510 511
[409] 512 513 514 516 517 519 521 522 525 526 527 529 530 531 532 533 534
[426] 535 536 537 539 540 541 543 544 545 546 547 548 549 551 553 554 555
[443] 556 557 558 560 561 562 565 566 567 568 569 570 572 573 575 576 577
[460] 578 579 580 581 582 583 585 586 587 588 590 591 592 593 594 595 597
[477] 598 599 600 601 602 603 604 605 606 607 610 612 613 614 615 616 619
[494] 620 621 622 623 624 626 627 628 630 631 632 633 635 636 637 639 640
[511] 641 642 643 644 646 647 648 649 650 651 652 654 655 657 658 660 661
[528] 662 663 664 666 668 669 671 672 674 675 676 677 678 679 680 681 682
[545] 683 684 685 686 687 688 690 691 692 694 695 696 697 700 701 702 703
[562] 704 705 707 708 710 711 712 714 716 717 718 720 721 722 723 724 725
[579] 726 728 729 730 731 732 733 734 735 736 737 739 740 741 742 743 744
[596] 745 746 747 748 750 751 752 753 755 756 757 758 759 760 763 764 765
[613] 767 768

$test
  [1]   9  10  12  14  23  24  38  46  50  53  57  63  64  68  70  74  75
 [18]  76  78  80  88  90  94  95  96 102 113 120 142 144 149 151 152 154
 [35] 155 156 157 160 165 171 172 174 188 195 196 199 200 202 210 211 223
 [52] 224 225 226 231 237 239 245 246 251 258 274 275 278 288 292 298 306
 [69] 308 312 313 317 319 331 341 342 344 347 348 353 362 364 366 370 372
 [86] 386 387 393 396 398 399 410 414 417 420 445 447 450 452 456 466 469
[103] 497 515 518 520 523 524 528 538 542 550 552 559 563 564 571 574 584
[120] 589 596 608 609 611 617 618 625 629 634 638 645 653 656 659 665 667
[137] 670 673 689 693 698 699 706 709 713 715 719 727 738 749 754 761 762
[154] 766

$validation
integer(0)</code></pre>
</div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">learner</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.rpart"</span> , predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="va">learner</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;LearnerClassifRpart&gt; (classif.rpart): Classification Tree ───────────
• Model: -
• Parameters: xval=0
• Packages: mlr3 and rpart
• Predict Types: response and [prob]
• Feature Types: logical, integer, numeric, factor, and ordered
• Encapsulation: none (fallback: -)
• Properties: importance, missings, multiclass, selected_features,
twoclass, and weights
• Other settings: use_weights = 'use'</code></pre>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span>, row_ids <span class="op">=</span> <span class="va">splits</span><span class="op">$</span><span class="va">train</span><span class="op">)</span></span>
<span><span class="va">learner</span><span class="op">$</span><span class="va">model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 614 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

  1) root 614 217 neg (0.35342 0.64658)  
    2) glucose&gt;=139.5 154  47 pos (0.69481 0.30519)  
      4) glucose&gt;=166.5 61  10 pos (0.83607 0.16393) *
      5) glucose&lt; 166.5 93  37 pos (0.60215 0.39785)  
       10) pregnant&gt;=6.5 31   6 pos (0.80645 0.19355) *
       11) pregnant&lt; 6.5 62  31 pos (0.50000 0.50000)  
         22) age&gt;=23.5 55  25 pos (0.54545 0.45455)  
           44) pedigree&gt;=0.319 36  13 pos (0.63889 0.36111) *
           45) pedigree&lt; 0.319 19   7 neg (0.36842 0.63158) *
         23) age&lt; 23.5 7   1 neg (0.14286 0.85714) *
    3) glucose&lt; 139.5 460 110 neg (0.23913 0.76087)  
      6) mass&gt;=26.9 345 107 neg (0.31014 0.68986)  
       12) age&gt;=29.5 162  75 neg (0.46296 0.53704)  
         24) glucose&gt;=99.5 120  53 pos (0.55833 0.44167)  
           48) pedigree&gt;=0.5485 42  11 pos (0.73810 0.26190) *
           49) pedigree&lt; 0.5485 78  36 neg (0.46154 0.53846)  
             98) age&lt; 54.5 70  34 pos (0.51429 0.48571)  
              196) pedigree&gt;=0.2 59  26 pos (0.55932 0.44068)  
                392) pedigree&lt; 0.416 46  17 pos (0.63043 0.36957)  
                  784) pressure&lt; 85 35  10 pos (0.71429 0.28571) *
                  785) pressure&gt;=85 11   4 neg (0.36364 0.63636) *
                393) pedigree&gt;=0.416 13   4 neg (0.30769 0.69231) *
              197) pedigree&lt; 0.2 11   3 neg (0.27273 0.72727) *
             99) age&gt;=54.5 8   0 neg (0.00000 1.00000) *
         25) glucose&lt; 99.5 42   8 neg (0.19048 0.80952) *
       13) age&lt; 29.5 183  32 neg (0.17486 0.82514) *
      7) mass&lt; 26.9 115   3 neg (0.02609 0.97391) *</code></pre>
</div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span>, row_ids <span class="op">=</span> <span class="va">splits</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span><span class="fu">as.data.table</span><span class="op">(</span><span class="va">prediction</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     row_ids truth response prob.pos prob.neg
  1:       9   pos      pos  0.83607   0.1639
  2:      10   pos      neg  0.36364   0.6364
  3:      12   pos      pos  0.83607   0.1639
  4:      14   pos      pos  0.83607   0.1639
  5:      23   pos      pos  0.83607   0.1639
 ---                                         
150:     749   pos      pos  0.83607   0.1639
151:     754   pos      pos  0.83607   0.1639
152:     761   neg      neg  0.17486   0.8251
153:     762   pos      pos  0.83607   0.1639
154:     766   neg      neg  0.02609   0.9739</code></pre>
</div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">measure</span> <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"classif.ce"</span><span class="op">)</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="va">measure</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
    0.1818 </code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Calculate the true positive, false positive, true negative, and false negative rates of the predictions made by the model in Exercise 1. Try to solve this in two ways: (a) Using <code>mlr3measures</code>-predefined measure objects, and (b) without using <code>mlr3</code> tools by directly working on the ground truth and prediction vectors. Compare the results.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># true positive rate</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"classif.tpr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.tpr 
     0.6275 </code></pre>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># false positive rate</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"classif.fpr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.fpr 
    0.08738 </code></pre>
</div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># true negative rate</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"classif.tnr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.tnr 
     0.9126 </code></pre>
</div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># false negative rate</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"classif.fnr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.fnr 
     0.3725 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># true positives</span></span>
<span><span class="va">TP</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">$</span><span class="va">truth</span> <span class="op">==</span> <span class="st">"pos"</span> <span class="op">&amp;</span> <span class="va">prediction</span><span class="op">$</span><span class="va">response</span> <span class="op">==</span> <span class="st">"pos"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># false positives</span></span>
<span><span class="va">FP</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">$</span><span class="va">truth</span> <span class="op">==</span> <span class="st">"neg"</span> <span class="op">&amp;</span> <span class="va">prediction</span><span class="op">$</span><span class="va">response</span> <span class="op">==</span> <span class="st">"pos"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># true negatives</span></span>
<span><span class="va">TN</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">$</span><span class="va">truth</span> <span class="op">==</span> <span class="st">"neg"</span> <span class="op">&amp;</span> <span class="va">prediction</span><span class="op">$</span><span class="va">response</span> <span class="op">==</span> <span class="st">"neg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># false negatives</span></span>
<span><span class="va">FN</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">$</span><span class="va">truth</span> <span class="op">==</span> <span class="st">"pos"</span> <span class="op">&amp;</span> <span class="va">prediction</span><span class="op">$</span><span class="va">response</span> <span class="op">==</span> <span class="st">"neg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># true positive rate</span></span>
<span><span class="va">TP</span> <span class="op">/</span> <span class="op">(</span><span class="va">TP</span> <span class="op">+</span> <span class="va">FN</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6275</code></pre>
</div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># false positive rate</span></span>
<span><span class="va">FP</span> <span class="op">/</span> <span class="op">(</span><span class="va">FP</span> <span class="op">+</span> <span class="va">TN</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.08738</code></pre>
</div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># true negative rate</span></span>
<span><span class="va">TN</span> <span class="op">/</span> <span class="op">(</span><span class="va">TN</span> <span class="op">+</span> <span class="va">FP</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9126</code></pre>
</div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># false negative rate</span></span>
<span><span class="va">FN</span> <span class="op">/</span> <span class="op">(</span><span class="va">FN</span> <span class="op">+</span> <span class="va">TP</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3725</code></pre>
</div>
</div>
<p>The results are the same.</p>
<ol start="3" type="1">
<li>Change the threshold of the model from Exercise 1 such that the false negative rate is lower. What is one reason you might do this in practice?</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># confusion matrix with threshold 0.5</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="va">confusion</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        truth
response pos neg
     pos  32   9
     neg  19  94</code></pre>
</div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction</span><span class="op">$</span><span class="fu">set_threshold</span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># confusion matrix with threshold 0.3</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="va">confusion</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        truth
response pos neg
     pos  38  16
     neg  13  87</code></pre>
</div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># false positive rate</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"classif.fpr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.fpr 
     0.1553 </code></pre>
</div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># false negative rate</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"classif.fnr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.fnr 
     0.2549 </code></pre>
</div>
</div>
<p>With a false negative rate of 0.38, we miss a lot of people who have diabetes but are predicted to not have it. This could give a false sense of security. By lowering the threshold, we can reduce the false negative rate.</p>
</section><section id="solutions-to-sec-performance" class="level2" data-number="A.2"><h2 data-number="A.2" class="anchored" data-anchor-id="solutions-to-sec-performance">
<span class="header-section-number">A.2</span> Solutions to <a href="../chapter3/evaluation_and_benchmarking.html" class="quarto-xref"><span>Chapter 3</span></a>
</h2>
<ol type="1">
<li>Apply a repeated cross-validation resampling strategy on <code>tsk("mtcars")</code> and evaluate the performance of <code>lrn("regr.rpart")</code>. Use five repeats of three folds each. Calculate the MSE for each iteration and visualize the result. Finally, calculate the aggregated performance score.</li>
</ol>
<p>We start by instantiating our task and learner as usual:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.rpart"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can instantiate a temporary resampling on the task to illustrate how it assigns observations across the 5 repeats (column <code>rep</code>) and 3 folds:</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">resampling</span> <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"repeated_cv"</span>, repeats <span class="op">=</span> <span class="fl">5</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">resampling</span><span class="op">$</span><span class="fu">instantiate</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span><span class="va">resampling</span><span class="op">$</span><span class="va">instance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     row_id rep fold
  1:      1   1    2
  2:      2   1    2
  3:      3   1    3
  4:      4   1    1
  5:      5   1    1
 ---                
156:     28   5    1
157:     29   5    3
158:     30   5    3
159:     31   5    1
160:     32   5    2</code></pre>
</div>
</div>
<p>Note instantiating manually is not necessary when using <code><a href="https://mlr3.mlr-org.com/reference/resample.html">resample()</a></code>, as it automatically instantiates the resampling for us, so we pass it a new resampling which has not been instantiated:</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">resampling</span> <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"repeated_cv"</span>, repeats <span class="op">=</span> <span class="fl">5</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">rr</span> <span class="op">=</span> <span class="fu">resample</span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">resampling</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can <code>$score()</code> the resampling with the MSE measure across each of the 5x3 resampling iterations:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">scores</span> <span class="op">=</span> <span class="va">rr</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">scores</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    task_id learner_id resampling_id iteration regr.mse
 1:  mtcars regr.rpart   repeated_cv         1    16.52
 2:  mtcars regr.rpart   repeated_cv         2    18.42
 3:  mtcars regr.rpart   repeated_cv         3    15.70
 4:  mtcars regr.rpart   repeated_cv         4    11.91
 5:  mtcars regr.rpart   repeated_cv         5    14.78
---                                                    
11:  mtcars regr.rpart   repeated_cv        11    20.60
12:  mtcars regr.rpart   repeated_cv        12    28.19
13:  mtcars regr.rpart   repeated_cv        13    25.86
14:  mtcars regr.rpart   repeated_cv        14    19.07
15:  mtcars regr.rpart   repeated_cv        15    19.88
Hidden columns: task, learner, resampling, prediction_test</code></pre>
</div>
</div>
<p>We can manually calculate these scores since <code>rr</code> contains all the individual predictions. The <code>$predictions()</code> method returns a list of predictions for each iteration, which we can use to calculate the MSE for the first iteration:</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">preds</span> <span class="op">=</span> <span class="va">rr</span><span class="op">$</span><span class="fu">predictions</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pred_1</span> <span class="op">=</span> <span class="fu">as.data.table</span><span class="op">(</span><span class="va">preds</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">pred_1</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">truth</span> <span class="op">-</span> <span class="va">response</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    rmse
1: 16.52</code></pre>
</div>
</div>
<p>To visualize the results, we can use <code>ggplot2</code> directly on the <code>scores</code> object, which behaves like any other <code>data.table</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="co"># Barchart of the per-iteration scores</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">scores</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">iteration</span>, y <span class="op">=</span> <span class="va">regr.mse</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-010-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Boxplot of the scores</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">scores</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">regr.mse</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">0</span>, labels <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-010-2.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Alternatively, the <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> function provides defaults for the <code>ResampleResult</code> object. Note that it internally scores the resampling using the MSE for regression tasks per default.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">rr</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-011-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">rr</span>, type <span class="op">=</span> <span class="st">"histogram"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-011-2.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>The aggregate score is the mean of the MSE scores across all iterations, which we can calculate using <code>$aggregate()</code> or by manually averaging the scores we stored before:</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">scores</span><span class="op">$</span><span class="va">regr.mse</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 21.94</code></pre>
</div>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>regr.mse 
   21.94 </code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Use <code>tsk("spam")</code> and five-fold CV to benchmark <code>lrn("classif.ranger")</code>, <code>lrn("classif.log_reg")</code>, and <code>lrn("classif.xgboost", nrounds = 100)</code> with respect to AUC. Which learner appears to perform best? How confident are you in your conclusion? Think about the stability of results and investigate this by re-rerunning the experiment with different seeds. What can be done to improve this?</li>
</ol>
<p>First we instantiate our learners with their initial parameters, setting the <code>predict_type = "prob"</code> once for all of them using <code><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrns()</a></code>. We then set the <code>nrounds</code> parameter for XGBoost to 100 and construct a resampling object for 5-fold CV:</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"spam"</span><span class="op">)</span></span>
<span><span class="va">learners</span> <span class="op">=</span> <span class="fu">lrns</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"classif.ranger"</span>, <span class="st">"classif.log_reg"</span>, <span class="st">"classif.xgboost"</span><span class="op">)</span>,</span>
<span>                predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="va">learners</span><span class="op">$</span><span class="va">classif.xgboost</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">nrounds</span> <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could have alternatively instantiated the learners like this, but would have needed to repeat the <code>predict_type = "prob"</code> argument multiple times.</p>
<div class="cell" data-eva="false">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.ranger"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span>,</span>
<span>  <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.log_reg"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span>,</span>
<span>  <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.xgboost"</span>, nrounds <span class="op">=</span> <span class="fl">100</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we can construct a benchmark design grid with the instantiated objects using <code><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">design</span> <span class="op">=</span> <span class="fu">benchmark_grid</span><span class="op">(</span></span>
<span>  tasks <span class="op">=</span> <span class="va">task</span>,</span>
<span>  learners <span class="op">=</span> <span class="va">learners</span>,</span>
<span>  resamplings <span class="op">=</span> <span class="va">resampling</span></span>
<span><span class="op">)</span></span>
<span><span class="va">design</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   task         learner resampling
1: spam  classif.ranger         cv
2: spam classif.log_reg         cv
3: spam classif.xgboost         cv</code></pre>
</div>
</div>
<p>To perform the benchmark, we use the aptly named <code><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark()</a></code> function:</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmr</span> <span class="op">=</span> <span class="fu">benchmark</span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span><span class="va">bmr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;BenchmarkResult&gt; of 15 rows with 3 resampling run ───────────────────
 nr task_id      learner_id resampling_id iters warnings errors
  1    spam  classif.ranger            cv     5        0      0
  2    spam classif.log_reg            cv     5        0      0
  3    spam classif.xgboost            cv     5        0      0</code></pre>
</div>
</div>
<p>And visualize the results as a boxplot:</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">bmr</span>, measure <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"classif.auc"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-017-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>In this example,<code>lrn("classif.xgboost")</code> outperforms <code>lrn("classif.ranger")</code>, and both outperform <code>lrn("classif.log_reg")</code>. Naturally this is only a visual inspection of the results — proper statistical testing of benchmark results can be conducted using the <code>mlr3benchmark</code> package, but for the purposes of this exercise a plot suffices.</p>
<p>When we re-run the same experiment with a different seed, we get a slightly different result.</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">3235</span><span class="op">)</span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu">benchmark_grid</span><span class="op">(</span></span>
<span>  tasks <span class="op">=</span> <span class="va">task</span>,</span>
<span>  learners <span class="op">=</span> <span class="va">learners</span>,</span>
<span>  resamplings <span class="op">=</span> <span class="va">resampling</span></span>
<span><span class="op">)</span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu">benchmark</span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">bmr</span>, measure <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"classif.auc"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-018-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>The overall trend remains about the same, but do we trust these results? Note that we applied both <code>lrn("classif.log_reg")</code> and <code>lrn("classif.ranger")</code> with their initial parameters. While <code>lrn("classif.log_reg")</code> does not have any hyperparameters to tune, <code>lrn("classif.ranger")</code> does have several, at least one of which is usually tuned (<code>mtry</code>). In case of <code>lrn("classif.xgboost")</code> however, we arbitrarily chose <code>nrounds = 100</code> rather than using the learner with its initial value of <code>nrounds = 1</code>, which would be equivalent to a single tree decision tree. To make any generalizations based on this experiment, we need to properly tune all relevant hyperparmeters in a systematic way. We cover this and more in <a href="../chapter4/hyperparameter_optimization.html" class="quarto-xref"><span>Chapter 4</span></a>.</p>
<ol start="3" type="1">
<li>A colleague reports a 93.1% classification accuracy using <code>lrn("classif.rpart")</code> on <code>tsk("penguins_simple")</code>. You want to reproduce their results and ask them about their resampling strategy. They said they used a custom three-fold CV with folds assigned as <code>factor(task$row_ids %% 3)</code>. See if you can reproduce their results.</li>
</ol>
<p>We make use of the <code>custom_cv</code> resampling strategy here:</p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">task</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"penguins_simple"</span><span class="op">)</span></span>
<span><span class="va">rsmp_cv</span> <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"custom_cv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We apply the rule to assign resampling folds we were provided with: Every third observation is assigned to the same fold:</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rsmp_cv</span><span class="op">$</span><span class="fu">instantiate</span><span class="op">(</span>task <span class="op">=</span> <span class="va">task</span>, f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="va">row_ids</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">rsmp_cv</span><span class="op">$</span><span class="va">instance</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ 0: int [1:111] 3 6 9 12 15 18 21 24 27 30 ...
 $ 1: int [1:111] 1 4 7 10 13 16 19 22 25 28 ...
 $ 2: int [1:111] 2 5 8 11 14 17 20 23 26 29 ...</code></pre>
</div>
</div>
<p>We are now ready to conduct the resampling and aggregate results:</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rr</span> <span class="op">=</span> <span class="fu">resample</span><span class="op">(</span></span>
<span>  task <span class="op">=</span> <span class="va">task</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="va">rsmp_cv</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.acc 
     0.9309 </code></pre>
</div>
</div>
<p>Converting to percentages and rounding to one decimal place, we get the same result as our colleague! Luckily they kept track of their resampling to ensure their results were reproducible.</p>
<ol start="4" type="1">
<li>(*) Program your own ROC plotting function without using <code>mlr3</code>’s <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> function. The signature of your function should be <code>my_roc_plot(task, learner, train_indices, test_indices)</code>. Your function should use the <code>$set_threshold()</code> method of <code>Prediction</code>, as well as <code>mlr3measures</code>.</li>
</ol>
<p>Here is a function to calculate the true positive rate (TPR, <em>Sensitivity</em>) and false positive rate (FPR, <em>1 - Specificity</em>) in a loop across a grid of probabilities. These are set as thresholds with the <code>$set_threshold()</code> method of the <code>PredictionClassif</code> object. This way we construct the ROC curve by iteratively calculating its x and y values, after which we can use <code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step()</a></code> to draw a step function. Note that we do not need to re-train the learner, we merely adjust the threshold applied to the predictions we made at the top of the function</p>
<div class="cell">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">my_roc_plot</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">train_indices</span>, <span class="va">test_indices</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Train learner, predict once.</span></span>
<span>  <span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span>, <span class="va">train_indices</span><span class="op">)</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span>, <span class="va">test_indices</span><span class="op">)</span></span>
<span>  <span class="co"># Positive class predictions from prediction matrix</span></span>
<span>  <span class="va">pos_pred</span> <span class="op">=</span> <span class="va">pred</span><span class="op">$</span><span class="va">prob</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">pred</span><span class="op">$</span><span class="va">prob</span><span class="op">)</span> <span class="op">==</span> <span class="va">task</span><span class="op">$</span><span class="va">positive</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Set a grid of probabilities to evaluate at.</span></span>
<span>  <span class="va">prob_grid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.001</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># For each possible threshold, calculate TPR,</span></span>
<span>  <span class="co"># FPR + aggregate to data.table</span></span>
<span>  <span class="va">grid</span> <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">prob_grid</span>, \<span class="op">(</span><span class="va">thresh</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pred</span><span class="op">$</span><span class="fu">set_threshold</span><span class="op">(</span><span class="va">thresh</span><span class="op">)</span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>      thresh <span class="op">=</span> <span class="va">thresh</span>,</span>
<span>      <span class="co"># y axis == sensitivity == TPR</span></span>
<span>      tpr <span class="op">=</span> <span class="fu">mlr3measures</span><span class="fu">::</span><span class="fu"><a href="https://mlr3measures.mlr-org.com/reference/tpr.html">tpr</a></span><span class="op">(</span></span>
<span>        truth <span class="op">=</span> <span class="va">pred</span><span class="op">$</span><span class="va">truth</span>, response <span class="op">=</span> <span class="va">pred</span><span class="op">$</span><span class="va">response</span>,</span>
<span>        positive <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="va">positive</span><span class="op">)</span>,</span>
<span>      <span class="co"># x axis == 1 - specificity == 1 - TNR == FPR</span></span>
<span>      fpr <span class="op">=</span> <span class="fu">mlr3measures</span><span class="fu">::</span><span class="fu"><a href="https://mlr3measures.mlr-org.com/reference/fpr.html">fpr</a></span><span class="op">(</span></span>
<span>        truth <span class="op">=</span> <span class="va">pred</span><span class="op">$</span><span class="va">truth</span>, response <span class="op">=</span> <span class="va">pred</span><span class="op">$</span><span class="va">response</span>,</span>
<span>        positive <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="va">positive</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Order descending by threshold to use ggplot2::geom_step</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setorder.html">setorderv</a></span><span class="op">(</span><span class="va">grid</span>, cols <span class="op">=</span> <span class="st">"thresh"</span>, order <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">grid</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">fpr</span>, y <span class="op">=</span> <span class="va">tpr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Step function starting with (h)orizontal, then (v)ertical</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span>direction <span class="op">=</span> <span class="st">"hv"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>      title <span class="op">=</span> <span class="st">"My Custom ROC Curve"</span>,</span>
<span>      subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%s on %s"</span>, <span class="va">learner</span><span class="op">$</span><span class="va">id</span>, <span class="va">task</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>,</span>
<span>      x <span class="op">=</span> <span class="st">"1 - Specificity"</span>, y <span class="op">=</span> <span class="st">"Sensitivity"</span>,</span>
<span>      caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"n = %i. Test set: %i"</span>, <span class="va">task</span><span class="op">$</span><span class="va">nrow</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">test_indices</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We try our function using <code>tsk("sonar")</code> and <code>lrn("classif.ranger")</code> learner with 100 trees. We set <code>predict_type = "prob"</code> since we need probability predictions to apply thresholds, rather than hard class predictions.</p>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Setting up example task and learner for testing</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"sonar"</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.ranger"</span>, num.trees <span class="op">=</span> <span class="fl">100</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="va">split</span> <span class="op">=</span> <span class="fu">partition</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">my_roc_plot</span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">split</span><span class="op">$</span><span class="va">train</span>, <span class="va">split</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-023-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can compare it with the pre-built plot function in <code>mlr3viz</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span>, <span class="va">split</span><span class="op">$</span><span class="va">train</span><span class="op">)</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span>, <span class="va">split</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">pred</span>, type <span class="op">=</span> <span class="st">"roc"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in ggplot2::fortify(object, raw_curves = raw_curves, reduce_points = reduce_points): Arguments in `...` must be used.
✖ Problematic argument:
• raw_curves = raw_curves
ℹ Did you misspell an argument name?</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-024-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Note the slight discrepancy between the two curves. This is caused by some implementation differences used by the <code>precrec</code> which is used for this functionality in <code>mlr3viz</code>. There are different approaches to drawing ROC curves, and our implementation above is one of the simpler ones!</p>
</section><section id="solutions-to-sec-optimization" class="level2" data-number="A.3"><h2 data-number="A.3" class="anchored" data-anchor-id="solutions-to-sec-optimization">
<span class="header-section-number">A.3</span> Solutions to <a href="../chapter4/hyperparameter_optimization.html" class="quarto-xref"><span>Chapter 4</span></a>
</h2>
<ol type="1">
<li>Tune the <code>mtry</code>, <code>sample.fraction</code>, and <code>num.trees</code> hyperparameters of <code>lrn("regr.ranger")</code> on <code>tsk("mtcars")</code>. Use a simple random search with 50 evaluations. Evaluate with a three-fold CV and the root mean squared error. Visualize the effects that each hyperparameter has on the performance via simple marginal plots, which plot a single hyperparameter versus the cross-validated MSE.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.ranger"</span>,</span>
<span>  mtry <span class="op">=</span> <span class="fu">to_tune</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  sample.fraction <span class="op">=</span> <span class="fu">to_tune</span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  num.trees <span class="op">=</span> <span class="fu">to_tune</span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance</span> <span class="op">=</span> <span class="fu">ti</span><span class="op">(</span></span>
<span>  learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>  task <span class="op">=</span> <span class="va">task</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"regr.rmse"</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu">trm</span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tuner</span> <span class="op">=</span> <span class="fu">tnr</span><span class="op">(</span><span class="st">"random_search"</span>, batch_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tuner</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mtry num.trees sample.fraction learner_param_vals  x_domain regr.rmse
1:    9       151          0.9767          &lt;list[5]&gt; &lt;list[3]&gt;     2.541</code></pre>
</div>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># all evaluations</span></span>
<span><span class="fu">as.data.table</span><span class="op">(</span><span class="va">instance</span><span class="op">$</span><span class="va">archive</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    mtry num.trees sample.fraction regr.rmse runtime_learners
 1:    9       470          0.7231     2.705            0.052
 2:    7       340          0.8201     2.658            0.038
 3:    7       491          0.9959     2.603            0.052
 4:    4       393          0.7478     2.710            0.042
 5:    3       243          0.7422     2.715            0.033
---                                                          
46:    2       331          0.9665     2.687            0.038
47:    4       465          0.7353     2.644            0.050
48:    7       157          0.8018     2.634            0.030
49:    4       266          0.7425     2.625            0.034
50:    7       184          0.5544     2.936            0.030
6 variables not shown: [timestamp, warnings, errors, x_domain, batch_nr, resample_result]</code></pre>
</div>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># best configuration</span></span>
<span><span class="va">instance</span><span class="op">$</span><span class="va">result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mtry num.trees sample.fraction learner_param_vals  x_domain regr.rmse
1:    9       151          0.9767          &lt;list[5]&gt; &lt;list[3]&gt;     2.541</code></pre>
</div>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># incumbent plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">instance</span>, type <span class="op">=</span> <span class="st">"incumbent"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-025-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># marginal plots</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">instance</span>, type <span class="op">=</span> <span class="st">"marginal"</span>, cols_x <span class="op">=</span> <span class="st">"mtry"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-025-2.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">instance</span>, type <span class="op">=</span> <span class="st">"marginal"</span>, cols_x <span class="op">=</span> <span class="st">"sample.fraction"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-025-3.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">instance</span>, type <span class="op">=</span> <span class="st">"marginal"</span>, cols_x <span class="op">=</span> <span class="st">"num.trees"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-025-4.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<ol start="2" type="1">
<li>Evaluate the performance of the model created in Exercise 1 with nested resampling. Use a holdout validation for the inner resampling and a three-fold CV for the outer resampling.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.ranger"</span>,</span>
<span>  mtry <span class="op">=</span> <span class="fu">to_tune</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  sample.fraction <span class="op">=</span> <span class="fu">to_tune</span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  num.trees <span class="op">=</span> <span class="fu">to_tune</span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">at</span> <span class="op">=</span> <span class="fu">auto_tuner</span><span class="op">(</span></span>
<span>  tuner <span class="op">=</span> <span class="fu">tnr</span><span class="op">(</span><span class="st">"random_search"</span>, batch_size <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"holdout"</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"regr.rmse"</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu">trm</span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rr</span> <span class="op">=</span> <span class="fu">resample</span><span class="op">(</span><span class="va">task</span>, <span class="va">at</span>, <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"regr.rmse"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>regr.rmse 
    2.542 </code></pre>
</div>
</div>
<p>The <code>"rmse"</code> is slightly higher than the one we obtained in Exercise 1. We see that the performance estimated while tuning overestimates the true performance</p>
<ol start="3" type="1">
<li>Tune and benchmark an XGBoost model against a logistic regression (without tuning the latter) and determine which has the best Brier score. Use <code>mlr3tuningspaces</code> and nested resampling, try to pick appropriate inner and outer resampling strategies that balance computational efficiency vs.&nbsp;stability of the results.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"sonar"</span><span class="op">)</span></span>
<span><span class="va">lrn_log_reg</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.log_reg"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load xgboost learner with search space</span></span>
<span><span class="va">lrn_xgboost</span> <span class="op">=</span> <span class="fu">lts</span><span class="op">(</span><span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.xgboost"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span>, booster <span class="op">=</span> <span class="st">"gbtree"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># search space for xgboost</span></span>
<span><span class="va">lrn_xgboost</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="fu">search_space</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet(8)&gt;
                  id    class  lower    upper nlevels        default
1:             alpha ParamDbl -6.908    6.908     Inf &lt;NoDefault[0]&gt;
2: colsample_bylevel ParamDbl  0.100    1.000     Inf &lt;NoDefault[0]&gt;
3:  colsample_bytree ParamDbl  0.100    1.000     Inf &lt;NoDefault[0]&gt;
4:               eta ParamDbl -9.210    0.000     Inf &lt;NoDefault[0]&gt;
5:            lambda ParamDbl -6.908    6.908     Inf &lt;NoDefault[0]&gt;
6:         max_depth ParamInt  1.000   20.000      20 &lt;NoDefault[0]&gt;
7:           nrounds ParamInt  1.000 5000.000    5000 &lt;NoDefault[0]&gt;
8:         subsample ParamDbl  0.100    1.000     Inf &lt;NoDefault[0]&gt;
1 variable not shown: [value]
Trafo is set.</code></pre>
</div>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">at_xgboost</span> <span class="op">=</span> <span class="fu">auto_tuner</span><span class="op">(</span></span>
<span>  tuner <span class="op">=</span> <span class="fu">tnr</span><span class="op">(</span><span class="st">"random_search"</span>, batch_size <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="va">lrn_xgboost</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"classif.bbrier"</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu">trm</span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu">benchmark_grid</span><span class="op">(</span></span>
<span>  tasks <span class="op">=</span> <span class="va">task</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_log_reg</span>, <span class="va">at_xgboost</span><span class="op">)</span>,</span>
<span>  resamplings <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu">benchmark</span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"classif.bbrier"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr task_id            learner_id resampling_id iters classif.bbrier
1:  1   sonar       classif.log_reg            cv     5         0.2423
2:  2   sonar classif.xgboost.tuned            cv     5         0.1037
Hidden columns: resample_result</code></pre>
</div>
</div>
<p>We use the <a href="https://mlr3tuningspaces.mlr-org.com/reference/lts.html"><code>lts()</code></a> function from the <a href="https://mlr3tuningspaces.mlr-org.com"><code>mlr3tuningspaces</code></a> package to load the <code>lrn("classif.xgboost")</code> with a search space. The learner is wrapped in an <a href="https://mlr3tuning.mlr-org.com/reference/auto_tuner.html"><code>auto_tuner()</code></a>, which is then benchmarked against the <code>lrn("classif.log_reg")</code>.</p>
<ol start="4" type="1">
<li>(*) Write a function that implements an iterated random search procedure that drills down on the optimal configuration by applying random search to iteratively smaller search spaces. Your function should have seven inputs: <code>task</code>, <code>learner</code>, <code>search_space</code>, <code>resampling</code>, <code>measure</code>, <code>random_search_stages</code>, and <code>random_search_size</code>. You should only worry about programming this for fully numeric and bounded search spaces that have no dependencies. In pseudo-code:
<ol type="1">
<li>Create a random design of size <code>random_search_size</code> from the given search space and evaluate the learner on it.</li>
<li>Identify the best configuration.</li>
<li>Create a smaller search space around this best config, where you define the new range for each parameter as: <code>new_range[i] = (best_conf[i] - 0.25 * current_range[i], best_conf[i] + 0.25*current_range[i])</code>. Ensure that this <code>new_range</code> respects the initial bound of the original <code>search_space</code> by taking the <code><a href="https://rdrr.io/r/base/Extremes.html">max()</a></code> of the new and old lower bound, and the <code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code> of the new and the old upper bound (“clipping”).</li>
<li>Iterate the previous steps <code>random_search_stages</code> times and at the end return the best configuration you have ever evaluated.</li>
</ol>
</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3misc.mlr-org.com">mlr3misc</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">focus_search</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">search_space</span>, <span class="va">resampling</span>, <span class="va">measure</span>, <span class="va">random_search_stages</span>, <span class="va">random_search_size</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="kw">repeat</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="co"># tune learner on random design</span></span>
<span>    <span class="va">instance</span> <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span></span>
<span>      tuner <span class="op">=</span> <span class="fu">tnr</span><span class="op">(</span><span class="st">"random_search"</span>, batch_size <span class="op">=</span> <span class="va">random_search_size</span><span class="op">)</span>,</span>
<span>      learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>      task <span class="op">=</span> <span class="va">task</span>,</span>
<span>      resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>      measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>      search_space <span class="op">=</span> <span class="va">search_space</span>,</span>
<span>      terminator <span class="op">=</span> <span class="fu">trm</span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="va">random_search_size</span><span class="op">)</span>,</span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># identify the best configuration</span></span>
<span>    <span class="va">best_config</span> <span class="op">=</span> <span class="va">instance</span><span class="op">$</span><span class="va">result_x_search_space</span></span>
<span></span>
<span>    <span class="co"># narrow search space</span></span>
<span>    <span class="va">params</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3misc.mlr-org.com/reference/compat-map.html">map</a></span><span class="op">(</span><span class="va">search_space</span><span class="op">$</span><span class="fu">subspaces</span><span class="op">(</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">subspace</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">best</span> <span class="op">=</span> <span class="va">best_config</span><span class="op">[[</span><span class="va">subspace</span><span class="op">$</span><span class="fu">ids</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">lower</span> <span class="op">=</span> <span class="va">subspace</span><span class="op">$</span><span class="va">lower</span></span>
<span>      <span class="va">upper</span> <span class="op">=</span> <span class="va">subspace</span><span class="op">$</span><span class="va">upper</span></span>
<span></span>
<span>      <span class="va">new_lower</span> <span class="op">=</span> <span class="va">best</span> <span class="op">-</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">lower</span></span>
<span>      <span class="va">new_upper</span> <span class="op">=</span> <span class="va">best</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">upper</span></span>
<span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="st">"ParamInt"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">subspace</span><span class="op">$</span><span class="va">class</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">new_lower</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">new_lower</span><span class="op">)</span></span>
<span>        <span class="va">new_upper</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">new_upper</span><span class="op">)</span></span>
<span></span>
<span>        <span class="fu">p_int</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">new_lower</span>, <span class="va">lower</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">new_upper</span>, <span class="va">upper</span><span class="op">)</span>, tags <span class="op">=</span> <span class="va">subspace</span><span class="op">$</span><span class="va">tags</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="fu">p_dbl</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">new_lower</span>, <span class="va">lower</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">new_upper</span>, <span class="va">upper</span><span class="op">)</span>, tags <span class="op">=</span> <span class="va">subspace</span><span class="op">$</span><span class="va">tags</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="va">search_space</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3misc.mlr-org.com/reference/invoke.html">invoke</a></span><span class="op">(</span><span class="va">ps</span>, .args <span class="op">=</span> <span class="va">params</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">random_search_stages</span> <span class="op">=</span> <span class="va">random_search_stages</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">random_search_stages</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">best_config</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">focus_search</span><span class="op">(</span></span>
<span>  task <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.xgboost"</span><span class="op">)</span>,</span>
<span>  search_space <span class="op">=</span> <span class="fu">ps</span><span class="op">(</span></span>
<span>    eta <span class="op">=</span> <span class="fu">p_dbl</span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.01</span>, upper <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    max_depth <span class="op">=</span> <span class="fu">p_int</span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1</span>, upper <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    nrounds <span class="op">=</span> <span class="fu">p_int</span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">10</span>, upper <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"regr.rmse"</span><span class="op">)</span>,</span>
<span>  random_search_stages <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  random_search_size <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      eta max_depth nrounds
1: 0.4148         4      86</code></pre>
</div>
</div>
<p>As a stretch goal, look into <code>mlr3tuning</code>’s internal source code and turn your function into an R6 class inheriting from the <code>TunerBatch</code> class – test it out on a learner of your choice.</p>
<div class="cell">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r6.r-lib.org">R6</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3tuning.mlr-org.com">mlr3tuning</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">TunerBatchFocusSearch</span> <span class="op">=</span> <span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"TunerFocusSearch"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="va">TunerBatch</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">param_set</span> <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span></span>
<span>        random_search_stages <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1L</span>, tags <span class="op">=</span> <span class="st">"required"</span><span class="op">)</span>,</span>
<span>        random_search_size <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1L</span>, tags <span class="op">=</span> <span class="st">"required"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="va">param_set</span><span class="op">$</span><span class="va">values</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>random_search_stages <span class="op">=</span> <span class="fl">10L</span>, random_search_size <span class="op">=</span> <span class="fl">50L</span><span class="op">)</span></span>
<span></span>
<span>      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span></span>
<span>        id <span class="op">=</span> <span class="st">"focus_search"</span>,</span>
<span>        param_set <span class="op">=</span> <span class="va">param_set</span>,</span>
<span>        param_classes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ParamLgl"</span>, <span class="st">"ParamInt"</span>, <span class="st">"ParamDbl"</span>, <span class="st">"ParamFct"</span><span class="op">)</span>,</span>
<span>        properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dependencies"</span>, <span class="st">"single-crit"</span>, <span class="st">"multi-crit"</span><span class="op">)</span>,</span>
<span>        label <span class="op">=</span> <span class="st">"Focus Search"</span>,</span>
<span>        man <span class="op">=</span> <span class="st">"mlr3tuning::mlr_tuners_focus_search"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    .optimize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inst</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">pv</span> <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span></span>
<span>      <span class="va">search_space</span> <span class="op">=</span> <span class="va">inst</span><span class="op">$</span><span class="va">search_space</span></span>
<span></span>
<span>       <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">pv</span><span class="op">$</span><span class="va">random_search_stages</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>        <span class="co"># evaluate random design</span></span>
<span>        <span class="va">xdt</span> <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/generate_design_random.html">generate_design_random</a></span><span class="op">(</span><span class="va">search_space</span>, <span class="va">pv</span><span class="op">$</span><span class="va">random_search_size</span><span class="op">)</span><span class="op">$</span><span class="va">data</span></span>
<span>        <span class="va">inst</span><span class="op">$</span><span class="fu">eval_batch</span><span class="op">(</span><span class="va">xdt</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># identify the best configuration</span></span>
<span>        <span class="va">best_config</span> <span class="op">=</span> <span class="va">inst</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="fu">best</span><span class="op">(</span>batch <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># narrow search space</span></span>
<span>        <span class="va">params</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3misc.mlr-org.com/reference/compat-map.html">map</a></span><span class="op">(</span><span class="va">search_space</span><span class="op">$</span><span class="fu">subspaces</span><span class="op">(</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">subspace</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">best</span> <span class="op">=</span> <span class="va">best_config</span><span class="op">[[</span><span class="va">subspace</span><span class="op">$</span><span class="fu">ids</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span>          <span class="va">lower</span> <span class="op">=</span> <span class="va">subspace</span><span class="op">$</span><span class="va">lower</span></span>
<span>          <span class="va">upper</span> <span class="op">=</span> <span class="va">subspace</span><span class="op">$</span><span class="va">upper</span></span>
<span></span>
<span>          <span class="va">new_lower</span> <span class="op">=</span> <span class="va">best</span> <span class="op">-</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">lower</span></span>
<span>          <span class="va">new_upper</span> <span class="op">=</span> <span class="va">best</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">upper</span></span>
<span></span>
<span>          <span class="kw">if</span> <span class="op">(</span><span class="st">"ParamInt"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">subspace</span><span class="op">$</span><span class="va">class</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">new_lower</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">new_lower</span><span class="op">)</span></span>
<span>            <span class="va">new_upper</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">new_upper</span><span class="op">)</span></span>
<span></span>
<span>            <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">new_lower</span>, <span class="va">lower</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">new_upper</span>, <span class="va">upper</span><span class="op">)</span>, tags <span class="op">=</span> <span class="va">subspace</span><span class="op">$</span><span class="va">tags</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>          <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">new_lower</span>, <span class="va">lower</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">new_upper</span>, <span class="va">upper</span><span class="op">)</span>, tags <span class="op">=</span> <span class="va">subspace</span><span class="op">$</span><span class="va">tags</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">}</span><span class="op">)</span></span>
<span>        <span class="va">search_space</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3misc.mlr-org.com/reference/invoke.html">invoke</a></span><span class="op">(</span><span class="va">ps</span>, .args <span class="op">=</span> <span class="va">params</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">xdt</span> <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/generate_design_random.html">generate_design_random</a></span><span class="op">(</span><span class="va">search_space</span>, <span class="va">pv</span><span class="op">$</span><span class="va">random_search_size</span><span class="op">)</span><span class="op">$</span><span class="va">data</span></span>
<span>        <span class="va">inst</span><span class="op">$</span><span class="fu">eval_batch</span><span class="op">(</span><span class="va">xdt</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">mlr_tuners</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="st">"focus_search"</span>, <span class="va">TunerBatchFocusSearch</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/ti.html">ti</a></span><span class="op">(</span></span>
<span>  task <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.xgboost"</span><span class="op">)</span>,</span>
<span>  search_space <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span></span>
<span>    eta <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.01</span>, upper <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    max_depth <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1</span>, upper <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    nrounds <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">10</span>, upper <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.rmse"</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"none"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tuner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr</a></span><span class="op">(</span><span class="st">"focus_search"</span>, random_search_stages <span class="op">=</span> <span class="fl">2</span>, random_search_size <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tuner</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      eta max_depth nrounds learner_param_vals  x_domain regr.rmse
1: 0.3046         1      91          &lt;list[6]&gt; &lt;list[3]&gt;     2.992</code></pre>
</div>
</div>
</section><section id="solutions-to-sec-optimization-advanced" class="level2" data-number="A.4"><h2 data-number="A.4" class="anchored" data-anchor-id="solutions-to-sec-optimization-advanced">
<span class="header-section-number">A.4</span> Solutions to <a href="../chapter5/advanced_tuning_methods_and_black_box_optimization.html" class="quarto-xref"><span>Chapter 5</span></a>
</h2>
<ol type="1">
<li>Tune the <code>mtry</code>, <code>sample.fraction</code>, and <code>num.trees</code> hyperparameters of <code>lrn("regr.ranger")</code> on <code>tsk("mtcars")</code> and evaluate this with a three-fold CV and the root mean squared error (same as <a href="../chapter4/hyperparameter_optimization.html" class="quarto-xref"><span>Chapter 4</span></a>, Exercise 1). Use <code>tnr("mbo")</code> with 50 evaluations. Compare this with the performance progress of a random search run from <a href="../chapter4/hyperparameter_optimization.html" class="quarto-xref"><span>Chapter 4</span></a>, Exercise 1. Plot the progress of performance over iterations and visualize the spatial distribution of the evaluated hyperparameter configurations for both algorithms.</li>
</ol>
<p>We first construct the learner, task, resampling, measure and terminator and then the instance.</p>
<div class="cell">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3mbo.mlr-org.com">mlr3mbo</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bbotk.mlr-org.com">bbotk</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridisLite/">viridisLite</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span>,</span>
<span>  mtry <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  sample.fraction <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  num.trees <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">measure</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.rmse"</span><span class="op">)</span></span>
<span><span class="va">terminator</span> <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">instance_rs</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/ti.html">ti</a></span><span class="op">(</span></span>
<span>  learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>  task <span class="op">=</span> <span class="va">task</span>,</span>
<span>  resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>  measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>  terminator <span class="op">=</span> <span class="va">terminator</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using a random search results in the following final performance:</p>
<div class="cell">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tuner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr</a></span><span class="op">(</span><span class="st">"random_search"</span>, batch_size <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">tuner</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance_rs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mtry num.trees sample.fraction learner_param_vals  x_domain regr.rmse
1:    8       487          0.9051          &lt;list[5]&gt; &lt;list[3]&gt;     2.415</code></pre>
</div>
</div>
<p>We then construct a new instance and optimize it via Bayesian Optimization (BO) using <code>tnr("mbo")</code> in its default configuration (see also <a href="https://mlr3mbo.mlr-org.com/reference/mbo_defaults.html"><code>mbo_defaults</code></a>):</p>
<div class="cell">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance_bo</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/ti.html">ti</a></span><span class="op">(</span></span>
<span>  learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>  task <span class="op">=</span> <span class="va">task</span>,</span>
<span>  resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>  measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>  terminator <span class="op">=</span> <span class="va">terminator</span></span>
<span><span class="op">)</span></span>
<span><span class="va">tuner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr</a></span><span class="op">(</span><span class="st">"mbo"</span><span class="op">)</span></span>
<span><span class="va">tuner</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance_bo</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mtry num.trees sample.fraction learner_param_vals  x_domain regr.rmse
1:    5       499          0.9956          &lt;list[5]&gt; &lt;list[3]&gt;     2.525</code></pre>
</div>
</div>
<p>We then add relevant information to the archives of the instances so that we can combine their data and use this data for generating the desired plots.</p>
<div class="cell">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance_rs</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="va">iteration</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">.N</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">instance_rs</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="va">best_rmse</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cummin</a></span><span class="op">(</span><span class="va">regr.rmse</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">instance_rs</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="va">method</span> <span class="op">:=</span> <span class="st">"Random Search"</span><span class="op">]</span></span>
<span><span class="va">instance_bo</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="va">iteration</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">.N</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">instance_bo</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="va">best_rmse</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cummin</a></span><span class="op">(</span><span class="va">regr.rmse</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">instance_bo</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="va">method</span> <span class="op">:=</span> <span class="st">"BO"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">plot_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">instance_rs</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"iteration"</span>, <span class="st">"best_rmse"</span>, <span class="st">"method"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  <span class="va">instance_bo</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"iteration"</span>, <span class="st">"best_rmse"</span>, <span class="st">"method"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">iteration</span>, y <span class="op">=</span> <span class="va">best_rmse</span>, colour <span class="op">=</span> <span class="va">method</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">plot_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">viridis</a></span><span class="op">(</span><span class="fl">2</span>, end <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Number of Configurations"</span>, y <span class="op">=</span> <span class="st">"Best regr.rmse"</span>, colour <span class="op">=</span> <span class="st">"Method"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-033-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We see that BO manages to slightly outperform the random search. Ideally, we would replicate running both optimizers multiple times with different random seeds and visualize their average performance along with a dispersion measure to properly take randomness of the optimization process into account. We could even use the same first few random samples as the initial design in BO to allow for a fairer comparison.</p>
<p>To visualize the spatial distribution of the evaluated hyperparameter configurations we will plot for each evaluated configuration the number of trees on the x-axis and the sample fraction on the y-axis. The label of each point corresponds to the mtry parameter directly.</p>
<div class="cell">
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">relevant_columns</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mtry"</span>, <span class="st">"sample.fraction"</span>, <span class="st">"num.trees"</span>, <span class="st">"iteration"</span>, <span class="st">"method"</span><span class="op">)</span></span>
<span><span class="va">plot_data_sampling</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>  <span class="va">instance_rs</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="va">..relevant_columns</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>  <span class="va">instance_bo</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="va">..relevant_columns</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">num.trees</span>, y <span class="op">=</span> <span class="va">sample.fraction</span>, colour <span class="op">=</span> <span class="va">method</span>, label <span class="op">=</span> <span class="va">mtry</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">plot_data_sampling</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">viridis</a></span><span class="op">(</span><span class="fl">2</span>, end <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Method"</span>, override.aes <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">""</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-034-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We observe that the random search samples uniformly at random – as expected. BO, however, focuses on regions of the search space with a high number of trees between 350 and 400, a high sample fraction and mtry values of around 5 to 8. This is also the region where the final result returned by BO is located. Nevertheless, BO also explores the search space, i.e., along the line of a high sample fraction close to 1.</p>
<ol start="2" type="1">
<li>Minimize the 2D Rastrigin function <span class="math inline">\(f: [-5.12, 5.12] \times [-5.12, 5.12] \rightarrow \mathbb{R}\)</span>, <span class="math inline">\(\mathbf{x} \mapsto 10 D+\sum_{i=1}^D\left[x_i^2-10 \cos \left(2 \pi x_i\right)\right]\)</span>, <span class="math inline">\(D = 2\)</span> via BO (standard sequential single-objective BO via <code><a href="https://mlr3mbo.mlr-org.com/reference/mlr_loop_functions_ego.html">bayesopt_ego()</a></code>) using the lower confidence bound with <code>lambda = 1</code> as acquisition function and <code>"NLOPT_GN_ORIG_DIRECT"</code> via <code>opt("nloptr")</code> as acquisition function optimizer. Use a budget of 40 function evaluations. Run this with both the “default” Gaussian process surrogate model with Matérn 5/2 kernel, and the “default” random forest surrogate model. Compare their anytime performance (similarly as in <a href="../chapter5/advanced_tuning_methods_and_black_box_optimization.html#fig-bayesian-sinusoidal_bo_rs" class="quarto-xref">Figure&nbsp;<span>5.7</span></a>). You can construct the surrogate models with default settings using:</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">surrogate_gp</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/srlrn.html">srlrn</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/default_gp.html">default_gp</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">surrogate_rf</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/srlrn.html">srlrn</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/default_rf.html">default_rf</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We first construct the function, making use of efficient evaluation operating on a <code>data.table</code> directly. We then wrap this function in the corresponding <a href="https://bbotk.mlr-org.com/reference/ObjectiveRFunDt.html"><code>ObjectiveRFunDt</code></a> objective class and construct the instance.</p>
<div class="cell">
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rastrigin</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">xdt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">D</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">xdt</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">=</span> <span class="fl">10</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">xdt</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="op">(</span><span class="fl">10</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">*</span> <span class="va">xdt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html">data.table</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">objective</span> <span class="op">=</span> <span class="va"><a href="https://bbotk.mlr-org.com/reference/ObjectiveRFunDt.html">ObjectiveRFunDt</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  fun <span class="op">=</span> <span class="va">rastrigin</span>,</span>
<span>  domain <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="op">-</span><span class="fl">5.12</span>, upper <span class="op">=</span> <span class="fl">5.12</span><span class="op">)</span>,</span>
<span>    x2 <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="op">-</span><span class="fl">5.12</span>, upper <span class="op">=</span> <span class="fl">5.12</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  codomain <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>tags <span class="op">=</span> <span class="st">"minimize"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  id <span class="op">=</span> <span class="st">"rastrigin2D"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance</span> <span class="op">=</span> <span class="va"><a href="https://bbotk.mlr-org.com/reference/OptimInstanceSingleCrit.html">OptimInstanceSingleCrit</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  objective <span class="op">=</span> <span class="va">objective</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>OptimInstanceSingleCrit is deprecated. Use OptimInstanceBatchSingleCrit instead.</code></pre>
</div>
</div>
<p>We then construct the surrogates as well as the acquisition function and acquisition function optimizer (we will terminate the acquisition function optimization once optimization process stagnates by <code>1e-5</code> over the last 100 iterations) and construct the two BO optimizers.</p>
<div class="cell">
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">surrogate_gp</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/srlrn.html">srlrn</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/default_gp.html">default_gp</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">surrogate_rf</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/srlrn.html">srlrn</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/default_rf.html">default_rf</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">acq_function</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/acqf.html">acqf</a></span><span class="op">(</span><span class="st">"cb"</span>, lambda <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">acq_optimizer</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/acqo.html">acqo</a></span><span class="op">(</span><span class="fu"><a href="https://bbotk.mlr-org.com/reference/opt.html">opt</a></span><span class="op">(</span><span class="st">"nloptr"</span>, algorithm <span class="op">=</span> <span class="st">"NLOPT_GN_ORIG_DIRECT"</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"stagnation"</span>, iters <span class="op">=</span> <span class="fl">100</span>, threshold <span class="op">=</span> <span class="fl">1e-5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optimizer_gp</span> <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/opt.html">opt</a></span><span class="op">(</span><span class="st">"mbo"</span>,</span>
<span>  loop_function <span class="op">=</span> <span class="va">bayesopt_ego</span>,</span>
<span>  surrogate <span class="op">=</span> <span class="va">surrogate_gp</span>,</span>
<span>  acq_function <span class="op">=</span> <span class="va">acq_function</span>,</span>
<span>  acq_optimizer <span class="op">=</span> <span class="va">acq_optimizer</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optimizer_rf</span> <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/opt.html">opt</a></span><span class="op">(</span><span class="st">"mbo"</span>,</span>
<span>  loop_function <span class="op">=</span> <span class="va">bayesopt_ego</span>,</span>
<span>  surrogate <span class="op">=</span> <span class="va">surrogate_rf</span>,</span>
<span>  acq_function <span class="op">=</span> <span class="va">acq_function</span>,</span>
<span>  acq_optimizer <span class="op">=</span> <span class="va">acq_optimizer</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will use the following initial design for both optimizers:</p>
<div class="cell">
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">initial_design</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>  x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3.95</span>, <span class="fl">1.16</span>, <span class="fl">3.72</span>, <span class="op">-</span><span class="fl">1.39</span>, <span class="op">-</span><span class="fl">0.11</span>, <span class="fl">5.00</span>, <span class="op">-</span><span class="fl">2.67</span>, <span class="fl">2.44</span><span class="op">)</span>,</span>
<span>  x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.18</span>, <span class="op">-</span><span class="fl">3.93</span>, <span class="fl">3.74</span>, <span class="op">-</span><span class="fl">1.37</span>, <span class="fl">5.02</span>, <span class="op">-</span><span class="fl">0.09</span>, <span class="op">-</span><span class="fl">2.65</span>, <span class="fl">2.46</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">instance</span><span class="op">$</span><span class="fu">eval_batch</span><span class="op">(</span><span class="va">initial_design</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then proceed to optimize the instance with each of the two optimizers and make sure to extract the relevant data from the archive of the instance.</p>
<div class="cell">
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">optimizer_gp</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   x1 x2  x_domain y
1:  0  0 &lt;list[2]&gt; 0</code></pre>
</div>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gp_data</span> <span class="op">=</span> <span class="va">instance</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">gp_data</span><span class="op">[</span>, <span class="va">y_min</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cummin</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">gp_data</span><span class="op">[</span>, <span class="va">iteration</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">.N</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">gp_data</span><span class="op">[</span>, <span class="va">surrogate</span> <span class="op">:=</span> <span class="st">"Gaussian Process"</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="fu">clear</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance</span><span class="op">$</span><span class="fu">eval_batch</span><span class="op">(</span><span class="va">initial_design</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optimizer_rf</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   x1 x2  x_domain y
1:  0  0 &lt;list[2]&gt; 0</code></pre>
</div>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rf_data</span> <span class="op">=</span> <span class="va">instance</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">rf_data</span><span class="op">[</span>, <span class="va">y_min</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cummin</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">rf_data</span><span class="op">[</span>, <span class="va">iteration</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">.N</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">rf_data</span><span class="op">[</span>, <span class="va">surrogate</span> <span class="op">:=</span> <span class="st">"Random forest"</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then combine the data and use it to generate the desired plot:</p>
<div class="cell">
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">gp_data</span>, <span class="va">rf_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">iteration</span>, y <span class="op">=</span> <span class="va">y_min</span>, colour <span class="op">=</span> <span class="va">surrogate</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">plot_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">viridis</a></span><span class="op">(</span><span class="fl">2</span>, end <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Best Observed Function Value"</span>, x <span class="op">=</span> <span class="st">"Number of Function Evaluations"</span>,</span>
<span>       colour <span class="op">=</span> <span class="st">"Surrogate Model"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-041-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>As expected, we observe that the BO algorithm with the Gaussian Process surrogate appears to outperform the random forest surrogate counterpart. However, ideally we would replicate running each algorithm using different random seeds and visualize the average performance along with some dispersion measure to properly take randomness of the optimization process into account.</p>
<ol start="3" type="1">
<li>Minimize the following function: <span class="math inline">\(f: [-10, 10] \rightarrow \mathbb{R}^2, x \mapsto \left(x^2, (x - 2)^2\right)\)</span> with respect to both objectives. Use the ParEGO algorithm. Construct the objective function using the <a href="https://bbotk.mlr-org.com/reference/ObjectiveRFunMany.html"><code>ObjectiveRFunMany</code></a> class. Terminate the optimization after a runtime of 100 evals. Plot the resulting Pareto front and compare it to the analytical solution, <span class="math inline">\(y_2 = \left(\sqrt{y_1}-2\right)^2\)</span> with <span class="math inline">\(y_1\)</span> ranging from <span class="math inline">\(0\)</span> to <span class="math inline">\(4\)</span>.</li>
</ol>
<p>We first construct the function, wrap it in the objective and then create the instance.</p>
<div class="cell">
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fun</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">xss</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">evaluations</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">xss</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">xs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y1 <span class="op">=</span> <span class="va">xs</span><span class="op">$</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2</span>, y2 <span class="op">=</span> <span class="op">(</span><span class="va">xs</span><span class="op">$</span><span class="va">x</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="va">evaluations</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">objective</span> <span class="op">=</span> <span class="va"><a href="https://bbotk.mlr-org.com/reference/ObjectiveRFunMany.html">ObjectiveRFunMany</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  fun <span class="op">=</span> <span class="va">fun</span>,</span>
<span>  domain <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="op">-</span><span class="fl">10</span>, upper <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  codomain <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span>y1 <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>tags <span class="op">=</span> <span class="st">"minimize"</span><span class="op">)</span>, y2 <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>tags <span class="op">=</span> <span class="st">"minimize"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  id <span class="op">=</span> <span class="st">"schaffer1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance</span> <span class="op">=</span> <span class="va"><a href="https://bbotk.mlr-org.com/reference/OptimInstanceMultiCrit.html">OptimInstanceMultiCrit</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  objective <span class="op">=</span> <span class="va">objective</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>OptimInstanceMultiCrit is deprecated. Use OptimInstanceBatchMultiCrit instead.</code></pre>
</div>
</div>
<p>As a surrogate we will use a random forest. ParEGO is a scalarization based multi-objective BO algorithm and therefore we use the Expected Improvement as acquisition function. We will use the same acquisition functon optimizer as earlier.</p>
<div class="cell">
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">surrogate</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/srlrn.html">srlrn</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/default_rf.html">default_rf</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">acq_function</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/acqf.html">acqf</a></span><span class="op">(</span><span class="st">"ei"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">acq_optimizer</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/acqo.html">acqo</a></span><span class="op">(</span><span class="fu"><a href="https://bbotk.mlr-org.com/reference/opt.html">opt</a></span><span class="op">(</span><span class="st">"nloptr"</span>, algorithm <span class="op">=</span> <span class="st">"NLOPT_GN_ORIG_DIRECT"</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"stagnation"</span>, iters <span class="op">=</span> <span class="fl">100</span>, threshold <span class="op">=</span> <span class="fl">1e-5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optimizer</span> <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/opt.html">opt</a></span><span class="op">(</span><span class="st">"mbo"</span>,</span>
<span>  loop_function <span class="op">=</span> <span class="va">bayesopt_parego</span>,</span>
<span>  surrogate <span class="op">=</span> <span class="va">surrogate</span>,</span>
<span>  acq_function <span class="op">=</span> <span class="va">acq_function</span>,</span>
<span>  acq_optimizer <span class="op">=</span> <span class="va">acq_optimizer</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then optimize the instance:</p>
<div class="cell">
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">optimizer</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x  x_domain       y1     y2
 1: 1.5663 &lt;list[1]&gt; 2.453196 0.1881
 2: 0.2773 &lt;list[1]&gt; 0.076884 2.9678
 3: 1.2346 &lt;list[1]&gt; 1.524158 0.5859
 4: 0.0000 &lt;list[1]&gt; 0.000000 4.0000
 5: 0.0823 &lt;list[1]&gt; 0.006774 3.6776
---                                 
34: 1.1065 &lt;list[1]&gt; 1.224428 0.7983
35: 0.4572 &lt;list[1]&gt; 0.209075 2.3801
36: 0.9602 &lt;list[1]&gt; 0.922021 1.0811
37: 1.0242 &lt;list[1]&gt; 1.049056 0.9521
38: 0.7346 &lt;list[1]&gt; 0.539702 1.6011</code></pre>
</div>
</div>
<p>Finally, we visualize the resulting Pareto front (in black) and its analytical counterpart (in darkgrey).</p>
<div class="cell">
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">true_pareto</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html">data.table</a></span><span class="op">(</span>y1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">4</span>, length.out <span class="op">=</span> <span class="fl">1001</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">true_pareto</span><span class="op">[</span>, <span class="va">y2</span> <span class="op">:=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">y1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span> <span class="op">^</span><span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">y1</span>, y <span class="op">=</span> <span class="va">y2</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">instance</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="fu">best</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">true_pareto</span>, colour <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span>direction <span class="op">=</span> <span class="st">"hv"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-045-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="solutions-to-sec-feature-selection" class="level2" data-number="A.5"><h2 data-number="A.5" class="anchored" data-anchor-id="solutions-to-sec-feature-selection">
<span class="header-section-number">A.5</span> Solutions to <a href="../chapter6/feature_selection.html" class="quarto-xref"><span>Chapter 6</span></a>
</h2>
<ol type="1">
<li>Compute the correlation filter scores on <code>tsk("mtcars")</code> and use the filter to select the five features most strongly correlated with the target. Resample <code>lrn("regr.kknn")</code> on both the full dataset and the reduced one, and compare both performances based on 10-fold CV with respect to MSE. NB: Here, we have performed the feature filtering outside of CV, which is generally not a good idea as it biases the CV performance estimation. To do this properly, filtering should be embedded inside the CV via pipelines – try to come back to this exercise after you read <a href="../chapter8/non-sequential_pipelines_and_tuning.html" class="quarto-xref"><span>Chapter 8</span></a> to implement this with less bias.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">filter</span> <span class="op">=</span> <span class="fu">flt</span><span class="op">(</span><span class="st">"correlation"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">filter</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># sorted filter scores</span></span>
<span><span class="va">filter</span><span class="op">$</span><span class="va">scores</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    wt    cyl   disp     hp   drat     vs     am   carb   gear   qsec 
0.8677 0.8522 0.8476 0.7762 0.6812 0.6640 0.5998 0.5509 0.4803 0.4187 </code></pre>
</div>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># subset task to 5 most correlated features</span></span>
<span><span class="va">task</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">filter</span><span class="op">$</span><span class="va">scores</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">task</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;TaskRegr&gt; (32x6): Motor Trends ──────────────────────────────────────
• Target: mpg
• Properties: -
• Features (5):
  • dbl (5): cyl, disp, drat, hp, wt</code></pre>
</div>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span></span>
<span>  tasks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">task</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.kknn"</span><span class="op">)</span>,</span>
<span>  resamplings <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr task_id learner_id resampling_id iters regr.mse
1:  1  mtcars  regr.kknn            cv    10    6.678
2:  2  mtcars  regr.kknn            cv    10    9.083
Hidden columns: resample_result</code></pre>
</div>
</div>
<p>The <code>"mse"</code> is much lower on the filtered task.</p>
<ol start="2" type="1">
<li>Apply backward selection to <code>tsk("penguins")</code> with <code>lrn("classif.rpart")</code> and holdout resampling by the classification accuracy measure. Compare the results with those in <a href="../chapter6/feature_selection.html#sec-fs-wrapper-example" class="quarto-xref"><span>Section 6.2.1</span></a> by also running the forward selection from that section. Do the selected features differ? Which feature selection method reports a higher classification accuracy in its <code>$result</code>?</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fselector_sbs</span> <span class="op">=</span> <span class="fu">fs</span><span class="op">(</span><span class="st">"sequential"</span>, strategy <span class="op">=</span> <span class="st">"sbs"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance_sbs</span> <span class="op">=</span> <span class="fu">fsi</span><span class="op">(</span></span>
<span>  task <span class="op">=</span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"holdout"</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"none"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fselector_sbs</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance_sbs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass flipper_length island   sex  year
1:       TRUE        TRUE      TRUE          FALSE  FALSE FALSE FALSE
3 variables not shown: [features, n_features, classif.acc]</code></pre>
</div>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># optimization path sbs</span></span>
<span><span class="va">fselector_sbs</span><span class="op">$</span><span class="fu">optimization_path</span><span class="op">(</span><span class="va">instance_sbs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass flipper_length island   sex  year
1:       TRUE        TRUE      TRUE           TRUE   TRUE  TRUE  TRUE
2:      FALSE        TRUE      TRUE           TRUE   TRUE  TRUE  TRUE
3:      FALSE        TRUE      TRUE          FALSE   TRUE  TRUE  TRUE
4:      FALSE        TRUE      TRUE          FALSE  FALSE  TRUE  TRUE
5:      FALSE        TRUE      TRUE          FALSE  FALSE  TRUE FALSE
6:      FALSE        TRUE      TRUE          FALSE  FALSE FALSE FALSE
7:      FALSE        TRUE     FALSE          FALSE  FALSE FALSE FALSE
2 variables not shown: [classif.acc, batch_nr]</code></pre>
</div>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance_sbs</span><span class="op">$</span><span class="va">result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass flipper_length island   sex  year
1:       TRUE        TRUE      TRUE          FALSE  FALSE FALSE FALSE
3 variables not shown: [features, n_features, classif.acc]</code></pre>
</div>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fselector_sfs</span> <span class="op">=</span> <span class="fu">fs</span><span class="op">(</span><span class="st">"sequential"</span>, strategy <span class="op">=</span> <span class="st">"sfs"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance_sfs</span> <span class="op">=</span> <span class="fu">fsi</span><span class="op">(</span></span>
<span>  task <span class="op">=</span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"holdout"</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"none"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fselector_sfs</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance_sfs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass flipper_length island   sex  year
1:       TRUE        TRUE     FALSE           TRUE  FALSE FALSE FALSE
3 variables not shown: [features, n_features, classif.acc]</code></pre>
</div>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># optimization path sfs</span></span>
<span><span class="va">fselector_sfs</span><span class="op">$</span><span class="fu">optimization_path</span><span class="op">(</span><span class="va">instance_sfs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass flipper_length island   sex  year
1:       TRUE       FALSE     FALSE          FALSE  FALSE FALSE FALSE
2:       TRUE       FALSE     FALSE           TRUE  FALSE FALSE FALSE
3:       TRUE        TRUE     FALSE           TRUE  FALSE FALSE FALSE
4:       TRUE        TRUE      TRUE           TRUE  FALSE FALSE FALSE
5:       TRUE        TRUE      TRUE           TRUE  FALSE FALSE  TRUE
6:       TRUE        TRUE      TRUE           TRUE   TRUE FALSE  TRUE
7:       TRUE        TRUE      TRUE           TRUE   TRUE  TRUE  TRUE
2 variables not shown: [classif.acc, batch_nr]</code></pre>
</div>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance_sfs</span><span class="op">$</span><span class="va">result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass flipper_length island   sex  year
1:       TRUE        TRUE     FALSE           TRUE  FALSE FALSE FALSE
3 variables not shown: [features, n_features, classif.acc]</code></pre>
</div>
</div>
<p>The sequential backward search selects 5 features, while the sequential forward search selects all features. The sequential backward search reports a higher classification accuracy.</p>
<ol start="3" type="1">
<li>There is a problem in the performance comparison in Exercise 2 as feature selection is performed on the test-set. Change the process by applying forward feature selection with <code><a href="https://mlr3fselect.mlr-org.com/reference/auto_fselector.html">auto_fselector()</a></code>. Compare the performance to backward feature selection from Exercise 2 using nested resampling.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">afs_sfs</span> <span class="op">=</span> <span class="fu">auto_fselector</span><span class="op">(</span></span>
<span>  fselector <span class="op">=</span> <span class="fu">fs</span><span class="op">(</span><span class="st">"sequential"</span>, strategy <span class="op">=</span> <span class="st">"sfs"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span>, id <span class="op">=</span> <span class="st">"classif.rpart.sfs"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"holdout"</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">afs_sbs</span> <span class="op">=</span> <span class="fu">auto_fselector</span><span class="op">(</span></span>
<span>  fselector <span class="op">=</span> <span class="fu">fs</span><span class="op">(</span><span class="st">"sequential"</span>, strategy <span class="op">=</span> <span class="st">"sbs"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span>, id <span class="op">=</span> <span class="st">"classif.rpart.sbs"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"holdout"</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span></span>
<span>  tasks <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">afs_sfs</span>, <span class="va">afs_sbs</span><span class="op">)</span>,</span>
<span>  resamplings <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr  task_id                  learner_id resampling_id iters
1:  1 penguins classif.rpart.sfs.fselector            cv     5
2:  2 penguins classif.rpart.sbs.fselector            cv     5
1 variable not shown: [classif.acc]
Hidden columns: resample_result</code></pre>
</div>
</div>
<p>Now the sequential forward search selects yields a slightly higher classification accuracy.</p>
<ol start="4" type="1">
<li>(*) Write a feature selection algorithm that is a hybrid of a filter and a wrapper method. This search algorithm should compute filter scores for all features and then perform a forward search. But instead of tentatively adding all remaining features to the current feature set, it should only stochastically try a subset of the available features. Features with high filter scores should be added with higher probability. Start by coding a stand-alone R method for this search (based on a learner, task, resampling, performance measure and some control settings).</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3verse.mlr-org.com">mlr3verse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"sonar"</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">measure</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span></span>
<span><span class="va">filter</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3filters.mlr-org.com/reference/flt.html">flt</a></span><span class="op">(</span><span class="st">"auc"</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="va">max_features</span> <span class="op">=</span> <span class="fl">10</span></span>
<span></span>
<span></span>
<span><span class="va">filter_forward_selection_search</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">resampling</span>, <span class="va">measure</span>, <span class="va">filter</span>, <span class="va">n</span>, <span class="va">max_features</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">features</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="va">feature_names</span></span>
<span></span>
<span>  <span class="co"># calculate filter scores</span></span>
<span>  <span class="va">filter</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span>  <span class="va">scores</span> <span class="op">=</span> <span class="va">filter</span><span class="op">$</span><span class="va">scores</span></span>
<span></span>
<span>  <span class="va">result_features</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="kw">while</span><span class="op">(</span><span class="va">max_features</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">result_features</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="co"># select n features to try</span></span>
<span>    <span class="va">filter_features</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span><span class="op">)</span>, prob <span class="op">=</span> <span class="va">scores</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># create feature matrix</span></span>
<span>    <span class="va">states</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">FALSE</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">features</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">filter_features</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># add filter features to matrix</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">filter_features</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">states</span><span class="op">[</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">features</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">filter_features</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># add already selected features to matrix</span></span>
<span>    <span class="va">states</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">features</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">result_features</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span></span>
<span>    <span class="co"># convert matrix to design</span></span>
<span>    <span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setattr.html">setnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">states</span><span class="op">)</span>, <span class="va">features</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># evaluate feature combinations</span></span>
<span>    <span class="va">instance</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3fselect.mlr-org.com/reference/fselect.html">fselect</a></span><span class="op">(</span></span>
<span>      fselector <span class="op">=</span> <span class="fu"><a href="https://mlr3fselect.mlr-org.com/reference/fs.html">fs</a></span><span class="op">(</span><span class="st">"design_points"</span>, design <span class="op">=</span> <span class="va">design</span>, batch_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      task <span class="op">=</span>  <span class="va">task</span>,</span>
<span>      learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>      resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>      measure <span class="op">=</span> <span class="va">measure</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># current best set</span></span>
<span>    <span class="va">result_features</span> <span class="op">=</span> <span class="va">instance</span><span class="op">$</span><span class="va">result_feature_set</span></span>
<span></span>
<span>    <span class="co"># remove selected features from scores</span></span>
<span>    <span class="va">scores</span> <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">result_features</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">result_features</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">filter_forward_selection_search</span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">resampling</span>, <span class="va">measure</span>, <span class="va">filter</span>, <span class="va">n</span>, <span class="va">max_features</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "V11" "V13" "V2"  "V24" "V27" "V34" "V36" "V52" "V56" "V58"</code></pre>
</div>
</div>
<p>Then, as a stretch goal, see if you can implement this as an R6 class inheriting from <code>FSelectorBatch</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r6.r-lib.org">R6</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mllg.github.io/checkmate/">checkmate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3verse.mlr-org.com">mlr3verse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3fselect.mlr-org.com">mlr3fselect</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">FSelectorBatchSequentialFilter</span> <span class="op">=</span> <span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"FSelectorBatchSequentialFilter"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="va">FSelectorBatch</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span></span>
<span>    <span class="co">#' @description</span></span>
<span>    <span class="co">#' Creates a new instance of this [R6][R6::R6Class] class.`</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">param_set</span> <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span></span>
<span>        filter <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_uty</a></span><span class="op">(</span>tags <span class="op">=</span> <span class="st">"required"</span><span class="op">)</span>,</span>
<span>        n <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1</span>, tags <span class="op">=</span> <span class="st">"required"</span><span class="op">)</span>,</span>
<span>        max_features <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span></span>
<span>        id <span class="op">=</span> <span class="st">"filter_sequential"</span>,</span>
<span>        param_set <span class="op">=</span> <span class="va">param_set</span>,</span>
<span>        properties <span class="op">=</span> <span class="st">"single-crit"</span>,</span>
<span>        label <span class="op">=</span> <span class="st">"Sequential Filter Search"</span>,</span>
<span>        man <span class="op">=</span> <span class="st">"mlr3fselect::mlr_fselectors_sequential"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span>,</span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    .optimize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inst</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">pv</span> <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span></span>
<span>      <span class="va">features</span> <span class="op">=</span> <span class="va">inst</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">cols_x</span></span>
<span>      <span class="va">max_features</span> <span class="op">=</span> <span class="va">pv</span><span class="op">$</span><span class="va">max_features</span> <span class="op"><a href="https://mllg.github.io/checkmate/reference/coalesce.html">%??%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">features</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># calculate filter scores</span></span>
<span>      <span class="va">pv</span><span class="op">$</span><span class="va">filter</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="va">inst</span><span class="op">$</span><span class="va">objective</span><span class="op">$</span><span class="va">task</span><span class="op">)</span></span>
<span>      <span class="va">scores</span> <span class="op">=</span> <span class="va">pv</span><span class="op">$</span><span class="va">filter</span><span class="op">$</span><span class="va">scores</span></span>
<span></span>
<span>      <span class="va">result_features</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>      <span class="kw">while</span><span class="op">(</span><span class="va">max_features</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">result_features</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>        <span class="co"># select n features to try</span></span>
<span>        <span class="va">filter_features</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">pv</span><span class="op">$</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span><span class="op">)</span>, prob <span class="op">=</span> <span class="va">scores</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># create feature matrix</span></span>
<span>        <span class="va">states</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">FALSE</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">features</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">filter_features</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># add filter features to matrix</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">filter_features</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">states</span><span class="op">[</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">features</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">filter_features</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="co"># add already selected features to matrix</span></span>
<span>        <span class="va">states</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">features</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">result_features</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span></span>
<span>        <span class="co"># convert matrix to design</span></span>
<span>        <span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setattr.html">setnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">states</span><span class="op">)</span>, <span class="va">features</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># evaluate feature combinations</span></span>
<span>        <span class="va">inst</span><span class="op">$</span><span class="fu">eval_batch</span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># current best set</span></span>
<span>        <span class="va">res</span> <span class="op">=</span> <span class="va">inst</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="fu">best</span><span class="op">(</span>batch <span class="op">=</span> <span class="va">inst</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">n_batch</span><span class="op">)</span></span>
<span>        <span class="va">result_features</span> <span class="op">=</span> <span class="va">features</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html">as.logical</a></span><span class="op">(</span><span class="va">res</span><span class="op">[</span>, <span class="va">features</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>        <span class="co"># remove selected features from scores</span></span>
<span>        <span class="va">scores</span> <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">result_features</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">mlr_fselectors</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="st">"sequential_filter"</span>, <span class="va">FSelectorBatchSequentialFilter</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3fselect.mlr-org.com/reference/fselect.html">fselect</a></span><span class="op">(</span></span>
<span>  fselector <span class="op">=</span> <span class="fu"><a href="https://mlr3fselect.mlr-org.com/reference/fs.html">fs</a></span><span class="op">(</span></span>
<span>    <span class="st">"sequential_filter"</span>,</span>
<span>    filter <span class="op">=</span> <span class="fu"><a href="https://mlr3filters.mlr-org.com/reference/flt.html">flt</a></span><span class="op">(</span><span class="st">"auc"</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    max_features <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  task <span class="op">=</span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"sonar"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="solutions-to-sec-pipelines" class="level2" data-number="A.6"><h2 data-number="A.6" class="anchored" data-anchor-id="solutions-to-sec-pipelines">
<span class="header-section-number">A.6</span> Solutions to <a href="../chapter7/sequential_pipelines.html" class="quarto-xref"><span>Chapter 7</span></a>
</h2>
<ol type="1">
<li>Concatenate the PipeOps named in the exercise by using <code>%&gt;&gt;%</code>. The resulting <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> can then be converted to a <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> by using <a href="https://mlr3.mlr-org.com/reference/as_learner.html"><code>as_learner()</code></a>.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3pipelines.mlr-org.com">mlr3pipelines</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com">mlr3learners</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"imputeoor"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"scale"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.log_reg"</span><span class="op">)</span></span>
<span><span class="va">graph_learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>The <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a> can be trained like any other <code>Learner</code> object, thereby filling in its <code>$model</code> field. It is possible to access the <code>$state</code> of any <code>PipeOp</code> through this field: the states are named after the <code>PipeOp</code>’s <code>$id</code>. The logistic regression model can then be extracted from the state of the <code>po("learner")</code> that contains the <code>lrn("classif.log_reg")</code>.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">graph_learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"pima"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># access the state of the po("learner") to get the model</span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="va">graph_learner</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">classif.log_reg</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)         age     glucose     insulin        mass    pedigree 
   -0.88835     0.15584     1.13631    -0.17477     0.74383     0.32121 
   pregnant    pressure     triceps 
    0.39594    -0.24967     0.05599 </code></pre>
</div>
</div>
<p>Alternatively, the underlying <code>lrn("classif.log_reg")</code> can be accessed through the <code>$base_learner()</code> method:</p>
<div class="cell">
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model</span> <span class="op">=</span> <span class="va">graph_learner</span><span class="op">$</span><span class="fu">base_learner</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)         age     glucose     insulin        mass    pedigree 
   -0.88835     0.15584     1.13631    -0.17477     0.74383     0.32121 
   pregnant    pressure     triceps 
    0.39594    -0.24967     0.05599 </code></pre>
</div>
</div>
<p>As a third option, the trained <code>PipeOp</code> can be accessed through the <code>$graph_model</code> field of the <code>GraphLearner</code>. The trained <code>PipeOp</code> has a <code>$learner_model</code> field, which contains the trained <code>Learner</code> object, which contains the model.</p>
<div class="cell">
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pipeop</span> <span class="op">=</span> <span class="va">graph_learner</span><span class="op">$</span><span class="va">graph_model</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">classif.log_reg</span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="va">pipeop</span><span class="op">$</span><span class="va">learner_model</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)         age     glucose     insulin        mass    pedigree 
   -0.88835     0.15584     1.13631    -0.17477     0.74383     0.32121 
   pregnant    pressure     triceps 
    0.39594    -0.24967     0.05599 </code></pre>
</div>
</div>
<ol start="3" type="1">
<li>Set the <code>$keep_results</code> flag of the Graph to <code>TRUE</code> to keep the results of the individual PipeOps. Afterwards, the input of the <code>lrn("classif.log_reg")</code> can be accessed through the <code>$.result</code> field of its predecessor, the <code>po("scale")</code>. Note that the <code>$.result</code> is a <code>list</code>, we want to access its only element, named <code>$output</code>.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">graph_learner</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">keep_results</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="va">graph_learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"pima"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># access the input of the learner</span></span>
<span><span class="va">scale_result</span> <span class="op">=</span> <span class="va">graph_learner</span><span class="op">$</span><span class="va">graph_model</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">scale</span><span class="op">$</span><span class="va">.result</span></span>
<span></span>
<span><span class="va">scale_output_task</span> <span class="op">=</span> <span class="va">scale_result</span><span class="op">$</span><span class="va">output</span></span>
<span></span>
<span><span class="va">age_column</span> <span class="op">=</span> <span class="va">scale_output_task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">age</span></span>
<span></span>
<span><span class="co"># check if the age column is standardized:</span></span>
<span><span class="co"># 1. does it have mean 0? -- almost, up to numerical precision!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">age_column</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.988e-16</code></pre>
</div>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 2. does it have standard deviation 1? -- yes!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">age_column</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
</section><section id="solutions-to-sec-pipelines-nonseq" class="level2" data-number="A.7"><h2 data-number="A.7" class="anchored" data-anchor-id="solutions-to-sec-pipelines-nonseq">
<span class="header-section-number">A.7</span> Solutions to <a href="../chapter8/non-sequential_pipelines_and_tuning.html" class="quarto-xref"><span>Chapter 8</span></a>
</h2>
<ol type="1">
<li>Use the <code>po("pca")</code> to replace numeric columns with their PCA transform. To restrict this operator to only columns without missing values, the <code>affect_columns</code> with a fitting <a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html"><code>Selector</code></a> can be used: The <code><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_missing()</a></code>, which selects columns <em>with</em> missing values, combined with <code><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_invert()</a></code>, which inverts the selection. Since <code>po("pca")</code> only operates on numeric columns, it is not necessary to use a <code>Selector</code> to select numeric columns.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/as_graph.html">as_graph</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"pca"</span>,</span>
<span>  affect_columns <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_invert</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_missing</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># apply the graph to the pima task</span></span>
<span><span class="va">graph_result</span> <span class="op">=</span> <span class="va">graph</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"pima"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we get the following features</span></span>
<span><span class="va">graph_result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">feature_names</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PC1"      "PC2"      "PC3"      "glucose"  "insulin"  "mass"    
[7] "pressure" "triceps" </code></pre>
</div>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Compare with feature-columns of tsk("pima") with missing values:</span></span>
<span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_missing</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"pima"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "glucose"  "insulin"  "mass"     "pressure" "triceps" </code></pre>
</div>
</div>
<p>Alternatively, <code>po("select")</code> can be used to select the columns without missing values that are passed to <code>po("pca")</code>. Another <code>po("select")</code> can be used to select all the other columns. It is put in parallel with the first <code>po("select")</code> using <code><a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html">gunion()</a></code>. It is necessary to use different <code>$id</code> values for both <code>po("select")</code> to avoid a name clash in the <code>Graph</code>. To combine the output from both paths, <code>po("featureunion")</code> can be used.</p>
<div class="cell">
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">path1</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"select"</span>, id <span class="op">=</span> <span class="st">"select_non_missing"</span>,</span>
<span>  selector <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_invert</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_missing</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"pca"</span><span class="op">)</span></span>
<span><span class="va">path2</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"select"</span>, id <span class="op">=</span> <span class="st">"select_missing"</span>,</span>
<span>  selector <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_missing</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html">gunion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">path1</span>, <span class="va">path2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"featureunion"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># apply the graph to the pima task</span></span>
<span><span class="va">graph_result</span> <span class="op">=</span> <span class="va">graph</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"pima"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">graph_result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">feature_names</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PC1"      "PC2"      "PC3"      "glucose"  "insulin"  "mass"    
[7] "pressure" "triceps" </code></pre>
</div>
</div>
<ol start="2" type="1">
<li>First, observe the feature names produced by the level 0 learners when applied to the <code>tsk("wine")</code> task:</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lrn_rpart</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="va">po_rpart_cv</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner_cv"</span>, learner <span class="op">=</span> <span class="va">lrn_rpart</span>,</span>
<span>  resampling.folds <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"rpart_cv"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">lrn_knn</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.kknn"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="va">po_knn_cv</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner_cv"</span>,</span>
<span>  learner <span class="op">=</span> <span class="va">lrn_knn</span>,</span>
<span>  resampling.folds <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"knn_cv"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we restrict ourselves to two level 0 learners here to</span></span>
<span><span class="co"># focus on the essentials.</span></span>
<span></span>
<span><span class="va">gr_level_0</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html">gunion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">po_rpart_cv</span>, <span class="va">po_knn_cv</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gr_combined</span> <span class="op">=</span> <span class="va">gr_level_0</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"featureunion"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gr_combined</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"wine"</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">head</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   type rpart_cv.prob.1 rpart_cv.prob.2 rpart_cv.prob.3 knn_cv.prob.1
1:    1          1.0000          0.0000               0             1
2:    1          1.0000          0.0000               0             1
3:    1          1.0000          0.0000               0             1
4:    1          1.0000          0.0000               0             1
5:    1          0.2857          0.7143               0             1
6:    1          1.0000          0.0000               0             1
2 variables not shown: [knn_cv.prob.2, knn_cv.prob.3]</code></pre>
</div>
</div>
<p>To use <code>po("select")</code> to <em>remove</em>, instead of <em>keep</em>, a feature based on a pattern, use <a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html"><code>selector_invert</code></a> together with <a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html"><code>selector_grep</code></a>. To remove the “<code>1</code>” class columns, i.e.&nbsp;all columns with names that end in “1”, the following <code>po("select")</code> could be used:</p>
<div class="cell">
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">drop_one</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"select"</span>, selector <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_invert</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_grep</a></span><span class="op">(</span><span class="st">"\\.1$"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Train it on the wine task with lrn("classif.multinom"):</span></span>
<span></span>
<span><span class="va">gr_stack</span> <span class="op">=</span> <span class="va">gr_combined</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="va">drop_one</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.multinom"</span>, trace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glrn_stack</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span><span class="va">gr_stack</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glrn_stack</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"wine"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glrn_stack</span><span class="op">$</span><span class="fu">base_learner</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
nnet::multinom(formula = type ~ ., data = task$data(), trace = FALSE)

Coefficients:
  (Intercept) rpart_cv.prob.2 rpart_cv.prob.3 knn_cv.prob.2
2      -6.559          -8.273           15.96        44.974
3     -29.359         -19.237           14.07        -9.424
  knn_cv.prob.3
2         14.64
3         64.42

Residual Deviance: 5.504 
AIC: 25.5 </code></pre>
</div>
</div>
<ol start="3" type="1">
<li>A solution that does not need to specify the target classes at all is to use a custom <a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html"><code>Selector</code></a>, as was shown in <a href="../chapter8/non-sequential_pipelines_and_tuning.html#sec-pipelines-bagging" class="quarto-xref"><span>Section 8.3.1</span></a>:</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">selector_remove_one_prob_column</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">class_removing</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="va">class_names</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">selector_use</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_invert</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_grep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"\\."</span>, <span class="va">class_removing</span> ,<span class="st">"$"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">selector_use</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using this selector in <a href="../chapter8/non-sequential_pipelines_and_tuning.html#sec-pipelines-stack" class="quarto-xref"><span>Section 8.3.2</span></a>, one could use the resulting stacking learner on any classification task with arbitrary target classes. It can be used as an alternative to the <code>Selector</code> used in exercise 2:</p>
<div class="cell">
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">drop_one_alt</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"select"</span>, selector <span class="op">=</span> <span class="va">selector_remove_one_prob_column</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The same as above:</span></span>
<span><span class="va">gr_stack</span> <span class="op">=</span> <span class="va">gr_combined</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="va">drop_one_alt</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.multinom"</span>, trace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">glrn_stack</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span><span class="va">gr_stack</span><span class="op">)</span></span>
<span><span class="va">glrn_stack</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"wine"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># As before, the first class was dropped.</span></span>
<span><span class="va">glrn_stack</span><span class="op">$</span><span class="fu">base_learner</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
nnet::multinom(formula = type ~ ., data = task$data(), trace = FALSE)

Coefficients:
  (Intercept) rpart_cv.prob.2 rpart_cv.prob.3 knn_cv.prob.2
2      -3.735         -0.1002          -10.62         21.81
3     -21.486        -17.2448          -21.62         40.16
  knn_cv.prob.3
2         18.13
3         53.81

Residual Deviance: 27.4 
AIC: 47.4 </code></pre>
</div>
</div>
<ol start="4" type="1">
<li>We choose to use the following options for imputation, factor encoding, and model training. Note the use of <code><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">pos()</a></code> and <code><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrns()</a></code>, which return lists of <code>PipeOp</code> and <code>Learner</code> objects, respectively.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb161"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">imputing</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">pos</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"imputeoor"</span>, <span class="st">"imputesample"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">factor_encoding</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">pos</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"encode"</span>, <span class="st">"encodeimpact"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">models</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrns</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"classif.rpart"</span>, <span class="st">"classif.log_reg"</span>, <span class="st">"classif.svm"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use the <code>ppl("branch")</code> pipeline to get <code>Graphs</code> with alternative path branching, controlled by its own hyperparameter. We need to give the <code>po("branch")</code> operators that are created here individual prefixes to avoid nameclashes when we put everything together.</p>
<div class="cell">
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">full_graph</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"branch"</span>,</span>
<span>    prefix_branchops <span class="op">=</span> <span class="st">"impute_"</span>, graphs <span class="op">=</span> <span class="va">imputing</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"branch"</span>,</span>
<span>    prefix_branchops <span class="op">=</span> <span class="st">"encode_"</span>, graphs <span class="op">=</span> <span class="va">factor_encoding</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"branch"</span>,</span>
<span>    prefix_branchops <span class="op">=</span> <span class="st">"model_"</span>, graphs <span class="op">=</span> <span class="va">models</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">full_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-063-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>The easiest way to set up the search space for this pipeline is to use <code><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune()</a></code>. It is necessary to record the dependencies of the hyperparameters of the preprocessing and model <code>PipeOps</code> on the branch hyperparameters. For this, <code><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune()</a></code> needs to be applied to a <code>Domain</code> object – <code><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl()</a></code>, <code><a href="https://paradox.mlr-org.com/reference/Domain.html">p_fct()</a></code>, etc. – that has its dependency declared using the <code>depends</code> argument.</p>
<div class="cell">
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://paradox.mlr-org.com">"paradox"</a></span><span class="op">)</span></span>
<span><span class="va">full_graph</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="fu">set_values</span><span class="op">(</span></span>
<span>  impute_branch.selection <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  encode_branch.selection <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  model_branch.selection <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span></span>
<span>  encodeimpact.smoothing <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span><span class="fl">1e-3</span>, <span class="fl">1e3</span>, logscale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    depends <span class="op">=</span> <span class="va">encode_branch.selection</span> <span class="op">==</span> <span class="st">"encodeimpact"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  encode.method <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_fct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"one-hot"</span>, <span class="st">"poly"</span><span class="op">)</span>,</span>
<span>    depends <span class="op">=</span> <span class="va">encode_branch.selection</span> <span class="op">==</span> <span class="st">"encode"</span><span class="op">)</span><span class="op">)</span>,</span>
<span></span>
<span>  classif.rpart.cp <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span><span class="fl">0.001</span>, <span class="fl">0.3</span>, logscale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    depends <span class="op">=</span> <span class="va">model_branch.selection</span> <span class="op">==</span> <span class="st">"classif.rpart"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  classif.svm.cost <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span><span class="fl">1e-5</span>, <span class="fl">1e5</span>, logscale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    depends <span class="op">=</span> <span class="va">model_branch.selection</span> <span class="op">==</span> <span class="st">"classif.svm"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  classif.svm.gamma <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span><span class="fl">1e-5</span>, <span class="fl">1e5</span>, logscale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    depends <span class="op">=</span> <span class="va">model_branch.selection</span> <span class="op">==</span> <span class="st">"classif.svm"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also set a few SVM kernel hyperparameters record their dependency on the model selection branch hyperparameter. We could record these dependencies in the <code>Graph</code>, using the <code>$add_dep()</code> method of the <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a>, but here we use the simpler approach of adding a single item search space component.</p>
<div class="cell">
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">full_graph</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="fu">set_values</span><span class="op">(</span></span>
<span>  classif.svm.type <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_fct</a></span><span class="op">(</span><span class="st">"C-classification"</span>,</span>
<span>    depends <span class="op">=</span> <span class="va">model_branch.selection</span> <span class="op">==</span> <span class="st">"classif.svm"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  classif.svm.kernel <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_fct</a></span><span class="op">(</span><span class="st">"radial"</span>,</span>
<span>    depends <span class="op">=</span> <span class="va">model_branch.selection</span> <span class="op">==</span> <span class="st">"classif.svm"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To turn this <code>Graph</code> into an AutoML-system, we use an <code>AutoTuner</code>. Here we use random search, but any other <code>Tuner</code> could be used.</p>
<div class="cell">
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3tuning.mlr-org.com">"mlr3tuning"</a></span><span class="op">)</span></span>
<span><span class="va">automl_at</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/auto_tuner.html">auto_tuner</a></span><span class="op">(</span></span>
<span>  tuner <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr</a></span><span class="op">(</span><span class="st">"random_search"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="va">full_graph</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.ce"</span><span class="op">)</span>,</span>
<span>  term_evals <span class="op">=</span> <span class="fl">30</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now benchmark this <code>AutoTuner</code> on a few tasks and compare it with the untuned random forest with out-of-range (OOR) imputation:</p>
<div class="cell">
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="va">automl_at</span>,</span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"imputeoor"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.ranger"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">learners</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="st">"automl"</span></span>
<span><span class="va">learners</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="st">"ranger"</span></span>
<span></span>
<span><span class="va">tasks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"breast_cancer"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"pima"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"sonar"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123L</span><span class="op">)</span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">tasks</span>, learners <span class="op">=</span> <span class="va">learners</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr       task_id learner_id resampling_id iters classif.ce
1:  1 breast_cancer     automl            cv     3    0.03513
2:  2 breast_cancer     ranger            cv     3    0.02489
3:  3          pima     automl            cv     3    0.22917
4:  4          pima     ranger            cv     3    0.23047
5:  5         sonar     automl            cv     3    0.22098
6:  6         sonar     ranger            cv     3    0.16812
Hidden columns: resample_result</code></pre>
</div>
</div>
<p>The <code>AutoTuner</code> performs better than the untuned random forest on one task. This is, of course, a toy example to demonstrate the capabilities of <code>mlr3pipelines</code> in combination with the <code>mlr3tuning</code> package. To use this kind of setup on real world data, one would need to take care of making the process more robust, e.g.&nbsp;by using the <code>ppl("robustify")</code> pipeline, and by using fallback learners.</p>
</section><section id="solutions-for-sec-preprocessing" class="level2" data-number="A.8"><h2 data-number="A.8" class="anchored" data-anchor-id="solutions-for-sec-preprocessing">
<span class="header-section-number">A.8</span> Solutions for <a href="../chapter9/preprocessing.html" class="quarto-xref"><span>Chapter 9</span></a>
</h2>
<p>We will consider a prediction problem similar to the one from this chapter, but using the King County Housing regression data instead (available with <code>tsk("kc_housing")</code>). To evaluate the models, we again use 10-fold CV, mean absolute error and <code>lrn("regr.glmnet")</code>. For now we will ignore the <code>date</code> column and simply remove it:</p>
<div class="cell">
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/mlr-org/mlr3data">"mlr3data"</a></span><span class="op">)</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"kc_housing"</span><span class="op">)</span></span>
<span><span class="va">task</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="va">feature_names</span>, <span class="st">"date"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li>Have a look at the features, are there any features which might be problematic? If so, change or remove them. Check the dataset and learner properties to understand which preprocessing steps you need to do.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     price           bathrooms       bedrooms       condition   
 Min.   :  75000   Min.   :0.00   Min.   : 0.00   Min.   :1.00  
 1st Qu.: 321950   1st Qu.:1.75   1st Qu.: 3.00   1st Qu.:3.00  
 Median : 450000   Median :2.25   Median : 3.00   Median :3.00  
 Mean   : 540088   Mean   :2.11   Mean   : 3.37   Mean   :3.41  
 3rd Qu.: 645000   3rd Qu.:2.50   3rd Qu.: 4.00   3rd Qu.:4.00  
 Max.   :7700000   Max.   :8.00   Max.   :33.00   Max.   :5.00  
                                                                
     floors         grade            lat            long     
 Min.   :1.00   Min.   : 1.00   Min.   :47.2   Min.   :-123  
 1st Qu.:1.00   1st Qu.: 7.00   1st Qu.:47.5   1st Qu.:-122  
 Median :1.50   Median : 7.00   Median :47.6   Median :-122  
 Mean   :1.49   Mean   : 7.66   Mean   :47.6   Mean   :-122  
 3rd Qu.:2.00   3rd Qu.: 8.00   3rd Qu.:47.7   3rd Qu.:-122  
 Max.   :3.50   Max.   :13.00   Max.   :47.8   Max.   :-121  
                                                             
   sqft_above   sqft_basement    sqft_living    sqft_living15 
 Min.   : 290   Min.   :  10    Min.   :  290   Min.   : 399  
 1st Qu.:1190   1st Qu.: 450    1st Qu.: 1427   1st Qu.:1490  
 Median :1560   Median : 700    Median : 1910   Median :1840  
 Mean   :1788   Mean   : 742    Mean   : 2080   Mean   :1987  
 3rd Qu.:2210   3rd Qu.: 980    3rd Qu.: 2550   3rd Qu.:2360  
 Max.   :9410   Max.   :4820    Max.   :13540   Max.   :6210  
                NA's   :13126                                 
    sqft_lot         sqft_lot15          view       waterfront     
 Min.   :    520   Min.   :   651   Min.   :0.000   Mode :logical  
 1st Qu.:   5040   1st Qu.:  5100   1st Qu.:0.000   FALSE:21450    
 Median :   7618   Median :  7620   Median :0.000   TRUE :163      
 Mean   :  15107   Mean   : 12768   Mean   :0.234                  
 3rd Qu.:  10688   3rd Qu.: 10083   3rd Qu.:0.000                  
 Max.   :1651359   Max.   :871200   Max.   :4.000                  
                                                                   
    yr_built     yr_renovated      zipcode     
 Min.   :1900   Min.   :1934    Min.   :98001  
 1st Qu.:1951   1st Qu.:1987    1st Qu.:98033  
 Median :1975   Median :2000    Median :98065  
 Mean   :1971   Mean   :1996    Mean   :98078  
 3rd Qu.:1997   3rd Qu.:2007    3rd Qu.:98118  
 Max.   :2015   Max.   :2015    Max.   :98199  
                NA's   :20699                  </code></pre>
</div>
</div>
<p>The <code>zipcode</code> should not be interpreted as a numeric value, so we cast it to a factor. We could argue to remove <code>lat</code> and <code>long</code> as handling them as linear effects is not necessarily a suitable, but we will keep them since <code>glmnet</code> performs internal feature selection anyways.</p>
<div class="cell">
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">zipencode</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"mutate"</span>, mutation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>zipcode <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">zipcode</span><span class="op">)</span><span class="op">)</span>, id <span class="op">=</span> <span class="st">"zipencode"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Build a suitable pipeline that allows <code>glmnet</code> to be trained on the dataset. Construct a new <code>glmnet</code> model with <code>ppl("robustify")</code>. Compare the two pipelines in a benchmark experiment.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lrn_glmnet</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.glmnet"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">graph_preproc</span> <span class="op">=</span></span>
<span>  <span class="va">zipencode</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"fixfactors"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"encodeimpact"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"missind"</span>, type <span class="op">=</span> <span class="st">"integer"</span>, affect_columns <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_type</a></span><span class="op">(</span><span class="st">"integer"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"imputehist"</span>, affect_columns <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_type</a></span><span class="op">(</span><span class="st">"integer"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"featureunion"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"imputeoor"</span>, affect_columns <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_type</a></span><span class="op">(</span><span class="st">"factor"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="va">lrn_glmnet</span></span>
<span></span>
<span><span class="va">graph_preproc</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-072-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p><code>glmnet</code> does not support factors or missing values. So our pipeline needs to handle both. First we fix the factor levels to ensure that all 70 zipcodes are fixed. We can consider 70 levels high cardinality, so we use impact encoding. We use the same imputation strategy as in <a href="../chapter9/preprocessing.html" class="quarto-xref"><span>Chapter 9</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">graph_robustify</span> <span class="op">=</span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_graphs_robustify.html">pipeline_robustify</a></span><span class="op">(</span>task <span class="op">=</span> <span class="va">task</span>, learner <span class="op">=</span> <span class="va">lrn_glmnet</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="va">lrn_glmnet</span></span>
<span></span>
<span><span class="va">graph_robustify</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-073-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">glrn_preproc</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span><span class="va">graph_preproc</span>, id <span class="op">=</span> <span class="st">"glmnet_preproc"</span><span class="op">)</span></span>
<span><span class="va">glrn_robustify</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span><span class="va">graph_robustify</span>, id <span class="op">=</span> <span class="st">"glmnet_robustify"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span></span>
<span>  tasks <span class="op">=</span> <span class="va">task</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">glrn_preproc</span>, <span class="va">glrn_robustify</span><span class="op">)</span>,</span>
<span>  resamplings <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Multiple lambdas have been fit. Lambda will be set to 0.01 (see parameter 's').
This happened in PipeOp regr.glmnet's $predict()
Warning: Multiple lambdas have been fit. Lambda will be set to 0.01 (see parameter 's').
This happened in PipeOp regr.glmnet's $predict()
Warning: Multiple lambdas have been fit. Lambda will be set to 0.01 (see parameter 's').
This happened in PipeOp regr.glmnet's $predict()
Warning: Multiple lambdas have been fit. Lambda will be set to 0.01 (see parameter 's').
This happened in PipeOp regr.glmnet's $predict()
Warning: Multiple lambdas have been fit. Lambda will be set to 0.01 (see parameter 's').
This happened in PipeOp regr.glmnet's $predict()
Warning: Multiple lambdas have been fit. Lambda will be set to 0.01 (see parameter 's').
This happened in PipeOp regr.glmnet's $predict()</code></pre>
</div>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.rmse"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr    task_id
1:  1 kc_housing
2:  2 kc_housing
4 variables not shown: [learner_id, resampling_id, iters, regr.rmse]
Hidden columns: resample_result</code></pre>
</div>
</div>
<p>Our preprocessing pipeline performs slightly better than the robustified one.</p>
<ol start="3" type="1">
<li>Now consider the <code>date</code> feature: How can you extract information from this feature in a way that <code>glmnet</code> can use? Does this improve the performance of your pipeline? Finally, consider the spatial nature of the dataset. Can you extract an additional feature from the lat / long coordinates? (Hint: Downtown Seattle has lat/long coordinates <code>47.605</code>/<code>122.334</code>).</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"kc_housing"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">graph_mutate</span> <span class="op">=</span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"mutate"</span>, mutation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    date <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>    distance_downtown <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">lat</span> <span class="op">-</span> <span class="fl">47.605</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">long</span>  <span class="op">+</span> <span class="fl">122.334</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="va">zipencode</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"encodeimpact"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"missind"</span>, type <span class="op">=</span> <span class="st">"integer"</span>, affect_columns <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_type</a></span><span class="op">(</span><span class="st">"integer"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"imputehist"</span>, affect_columns <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_type</a></span><span class="op">(</span><span class="st">"integer"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"featureunion"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"imputeoor"</span>, affect_columns <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_type</a></span><span class="op">(</span><span class="st">"factor"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="va">lrn_glmnet</span></span>
<span></span>
<span><span class="va">glrn_mutate</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span><span class="va">graph_mutate</span><span class="op">)</span></span>
<span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span></span>
<span>  tasks <span class="op">=</span> <span class="va">task</span>,</span>
<span>  learners <span class="op">=</span> <span class="va">glrn_mutate</span>,</span>
<span>  resamplings <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmr_2</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">combine</span><span class="op">(</span><span class="va">bmr_2</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.mae"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr    task_id
1:  1 kc_housing
2:  2 kc_housing
3:  3 kc_housing
4 variables not shown: [learner_id, resampling_id, iters, regr.mae]
Hidden columns: resample_result</code></pre>
</div>
</div>
<p>We simply convert the <code>date</code> feature into a numeric timestamp so that <code>glmnet</code> can handle the feature. We create one additional feature as the distance to downtown Seattle. This improves the average error of our model by a further 1400$.</p>
</section><section id="solutions-to-sec-technical" class="level2" data-number="A.9"><h2 data-number="A.9" class="anchored" data-anchor-id="solutions-to-sec-technical">
<span class="header-section-number">A.9</span> Solutions to <a href="../chapter10/advanced_technical_aspects_of_mlr3.html" class="quarto-xref"><span>Chapter 10</span></a>
</h2>
<ol type="1">
<li>Consider the following example where you resample a learner (debug learner, sleeps for 3 seconds during <code>$train()</code>) on 4 workers using the multisession backend:</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.debug"</span>, sleep_train <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/resample.html">resample</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">resampling</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;ResampleResult&gt; with 6 resampling iterations ────────────────────────
  task_id    learner_id resampling_id iteration     prediction_test
 penguins classif.debug            cv         1 &lt;PredictionClassif&gt;
 penguins classif.debug            cv         2 &lt;PredictionClassif&gt;
 penguins classif.debug            cv         3 &lt;PredictionClassif&gt;
 penguins classif.debug            cv         4 &lt;PredictionClassif&gt;
 penguins classif.debug            cv         5 &lt;PredictionClassif&gt;
 penguins classif.debug            cv         6 &lt;PredictionClassif&gt;
2 variables not shown: [warnings, errors]</code></pre>
</div>
</div>
<ol type="i">
<li>Assuming that the learner would actually calculate something and not just sleep: Would all CPUs be busy?</li>
<li>Prove your point by measuring the elapsed time, e.g., using <a href="https://www.rdocumentation.org/packages/base/topics/system.time"><code>system.time()</code></a>.</li>
<li>What would you change in the setup and why?</li>
</ol>
<p>Not all CPUs would be utilized for the whole duration. All 4 of them are occupied for the first 4 iterations of the cross-validation. The 5th iteration, however, only runs in parallel to the 6th fold, leaving 2 cores idle. This is supported by the elapsed time of roughly 6 seconds for 6 jobs compared to also roughly 6 seconds for 8 jobs:</p>
<div class="cell">
<div class="sourceCode" id="cb183"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.debug"</span>, sleep_train <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/resample.html">resample</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">resampling</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.303   0.013   6.169 </code></pre>
</div>
<div class="sourceCode" id="cb185"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/resample.html">resample</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">resampling</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.335   0.006   6.196 </code></pre>
</div>
</div>
<p>If possible, the number of resampling iterations should be an integer multiple of the number of workers. Therefore, a simple adaptation either increases the number of folds for improved accuracy of the error estimate or reduces the number of folds for improved runtime.</p>
<ol start="2" type="1">
<li>Create a new custom binary classification measure which scores (“prob”-type) predictions. This measure should compute the absolute difference between the predicted probability for the positive class and a 0-1 encoding of the ground truth and then average these values across the test set. Test this with <code>classif.log_reg</code> on <code>tsk("sonar")</code>.</li>
</ol>
<p>The rules can easily be translated to R code where we first convert select the predicted probabilities for the positive class, 0-1 encode the truth vector and then calculate the mean absolute error between the two vectors.</p>
<div class="cell">
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mae_prob</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, <span class="va">prob</span>, <span class="va">task</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># retrieve positive class from task</span></span>
<span>  <span class="va">positive</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="va">positive</span></span>
<span>  <span class="co"># select positive class probabilities</span></span>
<span>  <span class="va">prob_positive</span> <span class="op">=</span> <span class="va">prob</span><span class="op">[</span>, <span class="va">positive</span><span class="op">]</span></span>
<span>  <span class="co"># obtain 0-1 encoding of truth</span></span>
<span>  <span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">truth</span> <span class="op">==</span> <span class="va">positive</span><span class="op">)</span></span>
<span>  <span class="co"># average the absolute difference</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">prob_positive</span> <span class="op">-</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function can be embedded in the <code>Measure</code> class accordingly.</p>
<div class="cell">
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">MeasureMaeProb</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"MeasureMaeProb"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="fu">mlr3</span><span class="fu">::</span><span class="va"><a href="https://mlr3.mlr-org.com/reference/MeasureClassif.html">MeasureClassif</a></span>, <span class="co"># classification measure</span></span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span> <span class="co"># initialize class</span></span>
<span>      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span> <span class="co"># initialize method of parent class</span></span>
<span>        id <span class="op">=</span> <span class="st">"mae_prob"</span>, <span class="co"># unique ID</span></span>
<span>        packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># no dependencies</span></span>
<span>        properties <span class="op">=</span> <span class="st">"requires_task"</span>, <span class="co"># needs access to task for positive class</span></span>
<span>        predict_type <span class="op">=</span> <span class="st">"prob"</span>, <span class="co"># measures probability prediction</span></span>
<span>        range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="co"># results in values between [0, 1]</span></span>
<span>        minimize <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># smaller values are better</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    .score <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">prediction</span>, <span class="va">task</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> <span class="co"># define score as private method</span></span>
<span>      <span class="co"># call loss function</span></span>
<span>      <span class="fu">mae_prob</span><span class="op">(</span><span class="va">prediction</span><span class="op">$</span><span class="va">truth</span>, <span class="va">prediction</span><span class="op">$</span><span class="va">prob</span>, <span class="va">task</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because this is a custom class that is not available in the <code>mlr_measures</code> dictionary, we have to create a new instance using the <code>$new()</code> constructor.</p>
<div class="cell">
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">msr_mae_prob</span> <span class="op">=</span> <span class="va">MeasureMaeProb</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">msr_mae_prob</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;MeasureMaeProb&gt; (mae_prob) ──────────────────────────────────────────
• Packages: mlr3
• Range: [0, 1]
• Minimize: TRUE
• Average: macro
• Parameters: list()
• Properties: requires_task
• Predict type: prob
• Predict sets: test
• Aggregator: mean()</code></pre>
</div>
</div>
<p>To try this measure, we resample a logistic regression on the sonar task using five-fold cross-validation.</p>
<div class="cell">
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># predict_type is set to "prob", as otherwise our measure does not work</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.log_reg"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"sonar"</span><span class="op">)</span></span>
<span><span class="va">rr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/resample.html">resample</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: algorithm did not converge</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: algorithm did not converge</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: algorithm did not converge</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: algorithm did not converge</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: algorithm did not converge</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
</div>
</div>
<p>We now score the resample result using our custom measure and <code>msr("classif.acc")</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb202"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">score</span> <span class="op">=</span> <span class="va">rr</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">msr_mae_prob</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case, there is a clear relationship between the classification accuracy and our custom measure, i.e.&nbsp;the higher the accuracy, the lower the mean absolute error of the predicted probabilities.</p>
<div class="cell">
<div class="sourceCode" id="cb203"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">score</span><span class="op">$</span><span class="va">mae_prob</span>, <span class="va">score</span><span class="op">$</span><span class="va">classif.acc</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.9982</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>“Tune” the <code>error_train</code> hyperparameter of the <code>classif.debug</code> learner on a continuous interval from 0 to 1, using a simple classification tree as the fallback learner and the penguins task. Tune for 50 iterations using random search and 10-fold cross-validation. Inspect the resulting archive and find out which evaluations resulted in an error, and which did not. Now do the same in the interval 0.3 to 0.7. Are your results surprising?</li>
</ol>
<p>First, we create the learner that we want to tune, mark the relevant parameter for tuning and set the fallback learner to a classification tree.</p>
<div class="cell">
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lrn_debug</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.debug"</span>,</span>
<span>  error_train <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">lrn_debug</span><span class="op">$</span><span class="fu">encapsulate</span><span class="op">(</span><span class="st">"evaluate"</span>, fallback <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lrn_debug</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;LearnerClassifDebug&gt; (classif.debug): Debug Learner for Classificatio
• Model: -
• Parameters: error_train=&lt;RangeTuneToken&gt;
• Validate: NULL
• Packages: mlr3
• Predict Types: [response] and prob
• Feature Types: logical, integer, numeric, character, factor, and
ordered
• Encapsulation: evaluate (fallback: LearnerClassifRpart)
• Properties: hotstart_forward, internal_tuning, marshal, missings,
multiclass, twoclass, validation, and weights
• Other settings: use_weights = 'use'</code></pre>
</div>
</div>
<p>This example is unusual, because we expect better results from the fallback classification tree than from the primary debug learner, which predicts the mode of the target distribution. Nonetheless it serves as a good example to illustrate the effects of training errors on the tuning results.</p>
<p>We proceed with optimizing the classification accuracy of the learner on the penguins task.</p>
<div class="cell">
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tune.html">tune</a></span><span class="op">(</span></span>
<span>  learner <span class="op">=</span>  <span class="va">lrn_debug</span>,</span>
<span>  task <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span><span class="op">)</span>,</span>
<span>  tuner <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr</a></span><span class="op">(</span><span class="st">"random_search"</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span>,</span>
<span>  term_evals <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ERROR [09:50:40.787] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:41.118] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:41.053] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:41.187] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:41.233] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:41.233] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:41.277] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:41.318] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:41.832] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:41.925] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:41.900] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:41.932] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:42.022] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:42.172] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:42.178] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:42.192] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:42.223] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:42.300] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:42.321] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:42.415] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:42.677] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:42.941] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:42.894] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:42.983] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.056] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.289] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.365] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.379] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.466] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.624] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.630] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.637] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.590] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.686] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.730] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.709] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.765] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.784] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.835] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.987] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.992] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:43.991] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:44.090] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:44.139] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:44.748] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.007] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.008] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:44.980] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:44.985] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.101] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.116] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.138] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.243] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.409] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.418] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.420] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.508] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.525] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.548] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.635] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.784] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.791] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.808] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.889] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.903] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.927] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.938] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.010] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:45.989] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.163] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.122] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.164] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.304] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.454] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.499] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.463] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.517] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.552] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.572] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.644] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.656] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.682] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.696] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.947] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.985] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:46.994] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.227] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.249] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.254] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.260] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.356] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.378] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.597] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.560] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.605] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.622] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.694] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.671] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.731] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.745] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.785] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.791] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.965] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:47.969] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.041] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.073] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.113] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.175] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.347] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.480] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.684] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.735] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.742] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.812] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.803] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.863] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.879] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:48.923] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.088] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.093] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.050] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.176] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.190] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.231] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.301] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.744] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.786] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.752] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.793] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.867] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.896] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.860] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.942] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:49.992] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:50.183] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:50.278] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:50.277] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:50.396] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:50.518] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:50.673] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.220] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.227] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.228] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.239] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.343] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.360] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.398] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.612] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.628] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.711] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.723] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.811] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:51.831] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:52.092] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:52.350] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:52.356] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:52.308] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:52.410] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:52.460] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:52.477] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:52.510] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:52.631] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:52.691] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:52.808] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.047] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.055] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.199] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.196] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.401] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.455] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.502] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.764] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.770] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.781] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.830] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.962] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.909] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.936] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.948] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:53.996] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:54.149] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:54.174] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:54.527] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:54.532] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:54.548] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:54.549] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:54.668] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:54.685] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:54.703] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:54.771] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:54.747] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:54.942] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:55.010] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:55.053] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:55.121] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:55.139] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:55.451] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:55.657] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:55.622] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:55.947] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.085] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.103] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.259] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.265] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.300] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.279] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.367] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.384] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.391] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.489] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.513] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.669] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:56.843] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.051] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.008] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.151] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.167] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.197] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.165] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.271] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.428] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.534] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.810] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.807] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.816] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.770] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.895] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.914] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.937] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:57.949] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.017] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.170] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.180] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.187] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.190] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.286] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.297] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.321] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.368] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.389] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.565] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.569] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.570] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.582] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.672] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.690] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.797] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:50:58.810] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain</code></pre>
</div>
<div class="sourceCode" id="cb209"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;TuningInstanceBatchSingleCrit&gt; ──────────────────────────────────────
• State: Optimized
• Objective: &lt;ObjectiveTuningBatch&gt;
• Search Space:
            id    class lower upper nlevels
1: error_train ParamDbl     0     1     Inf
• Terminator: &lt;TerminatorEvals&gt; (n_evals=50, k=0)
• Result:
   error_train classif.acc
1:      0.9832      0.9478
• Archive:
    classif.acc error_train
 1:         0.4        0.11
 2:         0.8        0.77
 3:         0.4        0.03
 4:         0.7        0.48
 5:         0.8        0.68
---                        
46:         0.8        0.68
47:         0.5        0.13
48:         0.9        0.75
49:         0.9        0.93
50:         0.8        0.93</code></pre>
</div>
</div>
<p>To find out which evaluations resulted in an error, we can inspect the <code>$archive</code> slot of the instance, which we convert to a <code>data.table</code> for easier filtering.</p>
<div class="cell">
<div class="sourceCode" id="cb211"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">archive</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">instance</span><span class="op">$</span><span class="va">archive</span><span class="op">)</span></span>
<span><span class="va">archive</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"error_train"</span>, <span class="st">"classif.acc"</span>, <span class="st">"errors"</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    error_train classif.acc errors
 1:     0.10572      0.3834      1
 2:     0.77347      0.7657      7
 3:     0.03411      0.3927      0
 4:     0.47503      0.6554      5
 5:     0.67638      0.7586      7
---                               
46:     0.67548      0.7661      7
47:     0.12612      0.4915      2
48:     0.75091      0.8743      9
49:     0.92625      0.9008      9
50:     0.93283      0.8008      8</code></pre>
</div>
</div>
<p>Below, we visualize the relationship between the error probabilty and the classification accuracy.</p>
<div class="cell">
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">archive</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">error_train</span>, y <span class="op">=</span> <span class="va">classif.acc</span>, color <span class="op">=</span> <span class="va">errors</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-087-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Higher values for <code>error_train</code> lead to more resampling iterations using the classification tree fallback learner and therefore to better classification accuracies. Therefore, the best found hyperparameter configurations will tend to have values of <code>error_train</code> close to 1. When multiple parameter configurations have the same test performance, the first one is chosen by <code>$result_learner_param_vals</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb214"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance</span><span class="op">$</span><span class="va">result_learner_param_vals</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$error_train
[1] 0.9832</code></pre>
</div>
</div>
<p>We repeat the same experiment for the tuning interval from 0.3 to 0.7.</p>
<div class="cell">
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lrn_debug</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="fu">set_values</span><span class="op">(</span></span>
<span>  error_train <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance2</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tune.html">tune</a></span><span class="op">(</span></span>
<span>  learner <span class="op">=</span>  <span class="va">lrn_debug</span>,</span>
<span>  task <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span><span class="op">)</span>,</span>
<span>  tuner <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr</a></span><span class="op">(</span><span class="st">"random_search"</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span>,</span>
<span>  term_evals <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ERROR [09:51:03.407] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:03.411] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:03.459] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:03.614] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:03.781] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:03.790] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:03.797] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:03.853] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:03.929] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:03.931] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.110] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.118] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.260] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.237] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.328] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.507] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.563] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.547] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.600] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.801] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.814] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.822] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.910] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.933] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:04.965] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:05.033] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:05.217] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:05.224] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:05.233] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:05.336] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:05.381] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:05.454] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:05.472] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:05.640] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:05.740] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:05.782] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.133] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.155] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.368] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.380] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.466] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.479] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.502] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.514] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.589] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.605] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.815] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.849] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.875] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.948] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:06.969] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:07.101] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:07.166] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:07.239] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:07.345] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:07.459] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:07.614] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:07.633] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:07.653] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:07.842] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:07.959] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.004] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.022] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.202] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.297] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.364] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.575] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.583] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.587] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.589] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.698] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.719] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.735] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.980] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.987] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.997] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:08.997] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:09.056] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:09.130] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:09.106] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:09.162] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:09.372] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:09.472] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:09.488] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:09.609] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:09.783] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:09.860] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:09.902] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:09.876] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:10.004] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:10.171] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:10.296] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:10.266] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:10.374] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:10.553] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:10.558] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:10.666] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:10.792] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:10.963] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:10.973] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.118] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.169] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.334] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.351] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.431] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.449] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.472] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.449] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.551] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.734] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.829] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.807] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.918] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:11.895] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.091] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.051] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.098] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.106] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.195] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.214] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.277] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.332] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.496] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.509] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.588] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.568] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.619] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.696] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.865] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.870] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.875] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.026] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:12.975] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.037] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.048] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.086] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.259] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.345] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.364] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.394] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.472] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.450] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.651] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.661] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.795] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.807] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.836] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.851] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:13.921] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.084] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.097] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.211] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.247] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.475] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.477] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.591] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.609] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.623] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.732] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.913] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.924] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:14.891] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:15.027] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:15.014] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:15.131] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:15.252] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:15.480] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:15.649] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:15.653] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:15.613] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:15.745] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:15.746] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:15.777] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:15.853] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:16.038] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:16.111] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:16.154] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:16.178] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:16.201] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:16.281] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:16.443] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:16.582] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:16.664] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:16.832] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:16.958] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.156] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.183] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.393] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.550] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.563] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.516] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.659] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.683] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.657] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.725] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.775] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.930] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.941] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:17.995] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:18.023] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:18.304] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:18.391] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:18.405] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:18.433] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:18.441] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:18.665] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:18.634] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:18.759] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:18.821] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:19.064] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:19.067] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:19.163] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:19.215] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:19.530] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:19.534] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:19.496] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:19.500] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:19.628] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:19.671] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:19.922] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:19.935] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:20.026] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:20.051] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:20.029] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:20.129] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:20.142] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:20.314] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:20.317] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:20.332] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:20.423] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:20.398] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:20.479] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:21.301] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:21.428] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:21.443] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:21.707] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:21.712] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:21.761] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:21.800] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:21.773] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:21.964] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:21.981] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:22.092] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:22.111] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:22.079] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:22.405] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:22.491] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:22.531] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:22.538] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:22.783] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:22.748] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:22.834] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain

ERROR [09:51:22.932] [mlr3] train: 
✖ Error from classif.debug-&gt;train()
→ Class: Mlr3ErrorLearnerTrain</code></pre>
</div>
<div class="sourceCode" id="cb218"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">archive2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">instance2</span><span class="op">$</span><span class="va">archive</span><span class="op">)</span></span>
<span><span class="va">instance2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;TuningInstanceBatchSingleCrit&gt; ──────────────────────────────────────
• State: Optimized
• Objective: &lt;ObjectiveTuningBatch&gt;
• Search Space:
            id    class lower upper nlevels
1: error_train ParamDbl   0.3   0.7     Inf
• Terminator: &lt;TerminatorEvals&gt; (n_evals=50, k=0)
• Result:
   error_train classif.acc
1:      0.5705      0.8363
• Archive:
    classif.acc error_train
 1:         0.6         0.5
 2:         0.7         0.5
 3:         0.7         0.5
 4:         0.6         0.5
 5:         0.8         0.6
---                        
46:         0.6         0.5
47:         0.7         0.5
48:         0.7         0.4
49:         0.5         0.3
50:         0.6         0.5</code></pre>
</div>
</div>
<p>As before, higher error probabilities during training lead to higher classification accuracies.</p>
<div class="cell">
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">archive2</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">error_train</span>, y <span class="op">=</span> <span class="va">classif.acc</span>, color <span class="op">=</span> <span class="va">errors</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-090-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>However, the best found configurations for the <code>error_train</code> parameter, now tend to be close to 0.7 instead of 1 as before.</p>
<div class="cell">
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance2</span><span class="op">$</span><span class="va">result_learner_param_vals</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$error_train
[1] 0.5705</code></pre>
</div>
</div>
<p>This demonstrates that when utilizing a fallback learner, the tuning results are influenced not only by the direct impact of the tuning parameters on the primary learner but also by their effect on its error probability. Therefore, it is always advisable to manually inspect the tuning results afterward. Note that in most real-world scenarios, the fallback learner performs worse than the primary learner, and thus the effects illustrated here are usually reversed.</p>
</section><section id="solutions-to-sec-large-benchmarking" class="level2" data-number="A.10"><h2 data-number="A.10" class="anchored" data-anchor-id="solutions-to-sec-large-benchmarking">
<span class="header-section-number">A.10</span> Solutions to <a href="../chapter11/large-scale_benchmarking.html" class="quarto-xref"><span>Chapter 11</span></a>
</h2>
<ol type="1">
<li>Load the OpenML collection with ID 269, which contains regression tasks from the AutoML benchmark <span class="citation" data-cites="amlb2022">(<a href="../references.html#ref-amlb2022" role="doc-biblioref">Gijsbers et al. 2022</a>)</span>. Peek into this suite to study the contained data sets and their characteristics. Then find all tasks with less than 4000 observations and convert them to <code>mlr3</code> tasks.</li>
</ol>
<p>We access the AutoML benchmark suite with ID 269 using the <a href="https://mlr3oml.mlr-org.com/reference/ocl.html"><code>ocl()</code></a> function.</p>
<div class="cell">
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3oml.mlr-org.com">mlr3oml</a></span><span class="op">)</span></span>
<span><span class="va">automl_suite</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3oml.mlr-org.com/reference/ocl.html">ocl</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">269</span><span class="op">)</span></span>
<span><span class="va">automl_suite</span><span class="op">$</span><span class="va">task_ids</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To create a summary of the underlying datasets, we pass their IDs to <a href="https://mlr3oml.mlr-org.com/reference/list_oml_data.html"><code>list_oml_data()</code></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_tbl</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3oml.mlr-org.com/reference/list_oml.html">list_oml_data</a></span><span class="op">(</span><span class="va">automl_suite</span><span class="op">$</span><span class="va">data_ids</span><span class="op">)</span></span>
<span><span class="va">data_tbl</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"data_id"</span>, <span class="st">"name"</span>, <span class="st">"NumberOfInstances"</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    data_id                    name NumberOfInstances
 1:     201                     pol             15000
 2:     216               elevators             16599
 3:     287            wine_quality              6497
 4:     416               yprop_4_1              8885
 5:     422                topo_2_1              8885
---                                                  
29:   42728   Airlines_DepDelay_10M          10000000
30:   42729 nyc-taxi-green-dec-2016            581835
31:   42730                us_crime              1994
32:   42731             house_sales             21613
33:   43071     MIP-2016-regression              1090</code></pre>
</div>
</div>
<p>To find those datasets with up to 4000 observations, we can simply filter the table.</p>
<div class="cell">
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_tbl</span> <span class="op">=</span> <span class="va">data_tbl</span><span class="op">[</span><span class="va">NumberOfInstances</span> <span class="op">&lt;</span> <span class="fl">4000</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alternatively, the <a href="https://mlr3oml.mlr-org.com/reference/list_oml_tasks.html"><code>list_oml_tasks()</code></a> also allows to filter OpenML tasks by their characteristics.</p>
<div class="cell">
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">task_tbl</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3oml.mlr-org.com/reference/list_oml.html">list_oml_tasks</a></span><span class="op">(</span></span>
<span>  task_id <span class="op">=</span> <span class="va">automl_suite</span><span class="op">$</span><span class="va">task_ids</span>, number_instances <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4000</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting table contains matching OpenML tasks from the AutoML benchmark suite.</p>
<div class="cell">
<div class="sourceCode" id="cb228"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">task_tbl</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">task_id</span>, <span class="va">data_id</span>, <span class="va">name</span>, <span class="va">NumberOfInstances</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    task_id data_id                 name NumberOfInstances
 1:  167210   41021            Moneyball              1232
 2:  359930     550                quake              2178
 3:  359931     546              sensory               576
 4:  359932     541               socmob              1156
 5:  359933     507             space_ga              3107
 6:  359934     505              tecator               240
 7:  359945   42730             us_crime              1994
 8:  359950     531               boston               506
 9:  359951   42563 house_prices_nominal              1460
10:  360945   43071  MIP-2016-regression              1090</code></pre>
</div>
</div>
<p>We create <code>mlr3</code> tasks from these OpenML IDs using <code>tsk("oml")</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb230"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tasks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">task_tbl</span><span class="op">$</span><span class="va">task_id</span>, <span class="kw">function</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"oml"</span>, task_id <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tasks</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;TaskRegr&gt; (1232x15) ─────────────────────────────────────────────────
• Target: RS
• Properties: -
• Features (14):
  • fct (6): G, League, Playoffs, RankPlayoffs, RankSeason, Team
  • dbl (5): BA, OBP, OOBP, OSLG, SLG
  • int (3): RA, W, Year</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Create an experimental design that compares <code>lrn("regr.ranger")</code> and <code>lrn("regr.rpart")</code> on those tasks. Use the robustify pipeline for both learners and a featureless fallback learner. You can use three-fold CV instead of the OpenML resamplings to save time. Run the comparison experiments with <code>batchtools</code>. Use default hyperparameter settings and do not perform any tuning to keep the experiments simple.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb232"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lrn_ranger</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"robustify"</span>, learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner"</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">lrn_ranger</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="st">"ranger"</span></span>
<span><span class="va">lrn_ranger</span><span class="op">$</span><span class="fu">encapsulate</span><span class="op">(</span><span class="st">"evaluate"</span>, fallback <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.featureless"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lrn_rpart</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"robustify"</span>, learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.rpart"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner"</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.rpart"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">lrn_rpart</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="st">"rpart"</span></span>
<span><span class="va">lrn_rpart</span><span class="op">$</span><span class="fu">encapsulate</span><span class="op">(</span><span class="st">"evaluate"</span>, fallback <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.featureless"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_ranger</span>, <span class="va">lrn_rpart</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We set a seed before calling <a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html"><code>benchmark_grid()</code></a> as this instantiates the resamplings, which is stochastic.</p>
<div class="cell">
<div class="sourceCode" id="cb233"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">tasks</span>, <span class="va">learners</span>, <span class="va">resampling</span><span class="op">)</span></span>
<span><span class="va">design</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    task learner resampling
 1:            Moneyball  ranger         cv
 2:            Moneyball   rpart         cv
 3:                quake  ranger         cv
 4:                quake   rpart         cv
 5:              sensory  ranger         cv
---                                        
16:               boston   rpart         cv
17: house_prices_nominal  ranger         cv
18: house_prices_nominal   rpart         cv
19:  MIP-2016-regression  ranger         cv
20:  MIP-2016-regression   rpart         cv</code></pre>
</div>
</div>
<p>To execute this benchmark design using <a href="https://mlr3batchmark.mlr-org.com"><code>mlr3batchmark</code></a> we start by creating and configuring an experiment registry. We set <code>file.dir = NA</code> to use a temporary directory for the registry.</p>
<div class="cell">
<div class="sourceCode" id="cb235"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3batchmark.mlr-org.com">mlr3batchmark</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: batchtools</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'batchtools'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:mlr3misc':

    chunk</code></pre>
</div>
<div class="sourceCode" id="cb239"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mlr-org/batchtools">batchtools</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg</span> <span class="op">=</span> <span class="fu"><a href="https://batchtools.mlr-org.com/reference/makeExperimentRegistry.html">makeExperimentRegistry</a></span><span class="op">(</span></span>
<span>  file.dir <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  packages <span class="op">=</span> <span class="st">"mlr3verse"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No readable configuration file found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Created registry in '/tmp/RtmpTQ6n4i/registry1955d5c94d2' using cluster functions 'Interactive'</code></pre>
</div>
</div>
<p>The next two steps are to populate the registry with the experiments using <a href="https://mlr3batchmark.mlr-org.com/reference/batchmark.html"><code>batchmark()</code></a> and to submit them. By specifying no IDs in <a href="https://www.rdocumentation.org/packages/batchtools/topics/submitJobs"><code>submitJobs()</code></a>, all jobs returned by <a href="https://www.rdocumentation.org/packages/batchtools/topics/findNotSubmitted"><code>findNotSubmitted()</code></a> are queued, which in this case are all existing jobs.</p>
<div class="cell">
<div class="sourceCode" id="cb242"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://mlr3batchmark.mlr-org.com/reference/batchmark.html">batchmark</a></span><span class="op">(</span><span class="va">design</span>, reg <span class="op">=</span> <span class="va">reg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://batchtools.mlr-org.com/reference/submitJobs.html">submitJobs</a></span><span class="op">(</span>reg <span class="op">=</span> <span class="va">reg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://batchtools.mlr-org.com/reference/waitForJobs.html">waitForJobs</a></span><span class="op">(</span>reg <span class="op">=</span> <span class="va">reg</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After the execution of the experiment finished we can load the results as a <a href="https://mlr3.mlr-org.com/reference/BenchmarkResult.html"><code>BenchmarkResult</code></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb243"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3batchmark.mlr-org.com/reference/reduceResultsBatchmark.html">reduceResultsBatchmark</a></span><span class="op">(</span>reg <span class="op">=</span> <span class="va">reg</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    nr              task_id learner_id resampling_id iters  regr.mse
 1:  1            Moneyball     ranger            cv     3 6.698e+02
 2:  2            Moneyball      rpart            cv     3 1.357e+03
 3:  3                quake     ranger            cv     3 3.827e-02
 4:  4                quake      rpart            cv     3 3.567e-02
 5:  5              sensory     ranger            cv     3 5.072e-01
---                                                                 
16: 16               boston      rpart            cv     3 2.293e+01
17: 17 house_prices_nominal     ranger            cv     3 1.052e+09
18: 18 house_prices_nominal      rpart            cv     3 1.949e+09
19: 19  MIP-2016-regression     ranger            cv     3 7.505e+08
20: 20  MIP-2016-regression      rpart            cv     3 6.277e+08
Hidden columns: resample_result</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>Conduct a global Friedman test and, if appropriate, post hoc Friedman-Nemenyi tests, and interpret the results. As an evaluation measure, use the MSE.</li>
</ol>
<p>First, we load the <a href="https://mlr3benchmark.mlr-org.com"><code>mlr3benchmark</code></a> package and create a <a href="https://mlr3benchmark.mlr-org.com/reference/BenchmarkAggr.html"><code>BenchmarkAggr</code></a> from the benchmark result using <code>msr("regr.mse")</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb245"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3benchmark.mlr-org.com">mlr3benchmark</a></span><span class="op">)</span></span>
<span><span class="va">bma</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3benchmark.mlr-org.com/reference/as_benchmark_aggr.html">as_benchmark_aggr</a></span><span class="op">(</span><span class="va">bmr</span>, measures <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bma</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;BenchmarkAggr&gt; of 20 rows with 10 tasks, 2 learners and 1 measure
                 task_id learner_id       mse
 1:            Moneyball     ranger 6.698e+02
 2:            Moneyball      rpart 1.357e+03
 3:                quake     ranger 3.827e-02
 4:                quake      rpart 3.567e-02
 5:              sensory     ranger 5.072e-01
---                                          
16:               boston      rpart 2.293e+01
17: house_prices_nominal     ranger 1.052e+09
18: house_prices_nominal      rpart 1.949e+09
19:  MIP-2016-regression     ranger 7.505e+08
20:  MIP-2016-regression      rpart 6.277e+08</code></pre>
</div>
</div>
<p>We can also visualize this result using the <a href="https://mlr3benchmark.mlr-org.com/reference/autoplot.html"><code>autoplot()</code></a> function.</p>
<div class="cell">
<div class="sourceCode" id="cb247"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">bma</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions_large-scale_benchmarking-018-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Below, we conduct a global Friedman test. Note that a post-hoc test is not needed because we are only comparing two algorithms.</p>
<div class="cell">
<div class="sourceCode" id="cb248"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bma</span><span class="op">$</span><span class="fu">friedman_test</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Friedman rank sum test

data:  mse and learner_id and task_id
Friedman chi-squared = 1.6, df = 1, p-value = 0.2</code></pre>
</div>
</div>
<p>This experimental design was not able to detect a significant difference on the 5% level so we cannot reject our null hypothesis that the regression tree performs equally well as the random forest.</p>
</section><section id="solutions-to-sec-interpretation" class="level2" data-number="A.11"><h2 data-number="A.11" class="anchored" data-anchor-id="solutions-to-sec-interpretation">
<span class="header-section-number">A.11</span> Solutions to <a href="../chapter12/model_interpretation.html" class="quarto-xref"><span>Chapter 12</span></a>
</h2>
<ol type="1">
<li>Prepare a <code>mlr3</code> regression task for <code>fifa</code> data. Select only variables describing the age and skills of footballers. Train any predictive model for this task, e.g.&nbsp;<code>lrn("regr.ranger")</code>.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb250"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://modeloriented.github.io/DALEX/">DALEX</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"fifa"</span>, package <span class="op">=</span> <span class="st">"DALEX"</span><span class="op">)</span></span>
<span><span class="va">old_theme</span> <span class="op">=</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/theme_dalex.html">set_theme_dalex</a></span><span class="op">(</span><span class="st">"ema"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com">mlr3learners</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">feat_of_interest</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"skill_ball_control"</span>, <span class="st">"skill_curve"</span>, <span class="st">"skill_dribbling"</span>,  <span class="st">"skill_fk_accuracy"</span>, <span class="st">"skill_long_passing"</span>, <span class="st">"value_eur"</span><span class="op">)</span></span>
<span><span class="va">fifa20</span> <span class="op">=</span> <span class="va">fifa</span><span class="op">[</span>,<span class="va">feat_of_interest</span><span class="op">]</span></span>
<span></span>
<span><span class="va">task_fifa</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_task_regr.html">as_task_regr</a></span><span class="op">(</span><span class="va">fifa20</span>, target <span class="op">=</span> <span class="st">"value_eur"</span>, id <span class="op">=</span> <span class="st">"fifa20"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span></span>
<span><span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task_fifa</span><span class="op">)</span></span>
<span><span class="va">learner</span><span class="op">$</span><span class="va">model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$model
Ranger result

Call:
 ranger::ranger(dependent.variable.name = task$target_names, data = data,      num.threads = 1L) 

Type:                             Regression 
Number of trees:                  500 
Sample size:                      5000 
Number of independent variables:  6 
Mtry:                             2 
Target node size:                 5 
Variable importance mode:         none 
Splitrule:                        variance 
OOB prediction error (MSE):       3.404e+13 
R squared (OOB):                  0.5671 </code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Use the permutation importance method to calculate feature importance ranking. Which feature is the most important? Do you find the results surprising?</li>
</ol>
<p><strong>With <code>iml</code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb252"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://giuseppec.github.io/iml/">iml</a></span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="va"><a href="https://giuseppec.github.io/iml/reference/Predictor.html">Predictor</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">learner</span>,</span>
<span>                data <span class="op">=</span> <span class="va">fifa20</span>,</span>
<span>                y <span class="op">=</span> <span class="st">"value_eur"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">effect</span> <span class="op">=</span> <span class="va"><a href="https://giuseppec.github.io/iml/reference/FeatureImp.html">FeatureImp</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">model</span>,</span>
<span>                loss <span class="op">=</span> <span class="st">"rmse"</span><span class="op">)</span></span>
<span><span class="va">effect</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-093-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p><strong>With <code>DALEX</code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb253"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://modeloriented.github.io/DALEX/">DALEX</a></span><span class="op">)</span></span>
<span><span class="va">ranger_exp</span> <span class="op">=</span> <span class="fu">DALEX</span><span class="fu">::</span><span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/explain.html">explain</a></span><span class="op">(</span><span class="va">learner</span>,</span>
<span>  data <span class="op">=</span> <span class="va">fifa20</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fifa20</span><span class="op">)</span>, <span class="st">"value_eur"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  y <span class="op">=</span> <span class="va">fifa</span><span class="op">$</span><span class="va">value_eur</span>,</span>
<span>  label <span class="op">=</span> <span class="st">"Fifa 2020"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ranger_effect</span> <span class="op">=</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_parts.html">model_parts</a></span><span class="op">(</span><span class="va">ranger_exp</span>, B <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ranger_effect</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            variable mean_dropout_loss     label
1       _full_model_           2897186 Fifa 2020
2                age           4658209 Fifa 2020
3        skill_curve           4842955 Fifa 2020
4  skill_fk_accuracy           5167775 Fifa 2020
5    skill_dribbling           5747754 Fifa 2020
6 skill_long_passing           5947734 Fifa 2020</code></pre>
</div>
<div class="sourceCode" id="cb255"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ranger_effect</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-094-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<ol start="3" type="1">
<li>Use the partial dependence plot/profile to draw the global behavior of the model for this feature. Is it aligned with your expectations?</li>
</ol>
<p><strong>With <code>iml</code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb256"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">impfeat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"skill_ball_control"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">effect</span> <span class="op">=</span> <span class="va"><a href="https://giuseppec.github.io/iml/reference/FeatureEffects.html">FeatureEffects</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">model</span>, features <span class="op">=</span> <span class="va">impfeat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">effect</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-095-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p><strong>With <code>DALEX</code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb257"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">impfeat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"skill_ball_control"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ranger_profiles</span> <span class="op">=</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_profile.html">model_profile</a></span><span class="op">(</span><span class="va">ranger_exp</span>, variables <span class="op">=</span> <span class="va">impfeat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ranger_profiles</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-096-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<ol start="4" type="1">
<li>Choose Robert Lewandowski as a specific example and calculate and plot the Shapley values. Which feature is locally the most important and has the strongest influence on his valuation as a soccer player?</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb258"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">player_1</span> <span class="op">=</span> <span class="va">fifa20</span><span class="op">[</span><span class="st">"R. Lewandowski"</span>,<span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>With <code>iml</code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb259"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">shapley</span> <span class="op">=</span> <span class="va"><a href="https://giuseppec.github.io/iml/reference/Shapley.html">Shapley</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">model</span>, x.interest <span class="op">=</span> <span class="va">player_1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">shapley</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-098-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p><strong>With <code>DALEX</code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb260"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ranger_shap</span> <span class="op">=</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/predict_parts.html">predict_parts</a></span><span class="op">(</span><span class="va">ranger_exp</span>,</span>
<span>             new_observation <span class="op">=</span> <span class="va">player_1</span>,</span>
<span>             type <span class="op">=</span> <span class="st">"shap"</span>, B <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ranger_shap</span>, show_boxplots <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-099-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="solutions-to-sec-special" class="level2" data-number="A.12"><h2 data-number="A.12" class="anchored" data-anchor-id="solutions-to-sec-special">
<span class="header-section-number">A.12</span> Solutions to <a href="../chapter13/beyond_regression_and_classification.html" class="quarto-xref"><span>Chapter 13</span></a>
</h2>
<ol type="1">
<li>Run a benchmark experiment on <code>tsk("german_credit")</code> with <code>lrn("classif.featureless")</code>, <code>lrn("classif.log_reg")</code>, and <code>lrn("classif.ranger")</code>. Tune the prediction thresholds of all learners by encapsulating them in a <code>po("learner_cv")</code> (with two-fold CV), followed by a <code>po("tunethreshold")</code>. Use <code>msr("classif.costs", costs = costs)</code>, where the <code>costs</code> matrix is as follows: true positive is <code>-10</code>, true negative is <code>-1</code>, false positive is <code>2</code>, and false negative is <code>3</code>. Use this measure in <code>po("tunethreshold")</code> and when evaluating your benchmark experiment.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb261"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># Load task and learners</span></span>
<span><span class="va">tsk_german</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"german_credit"</span><span class="op">)</span></span>
<span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrns</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"classif.featureless"</span>, <span class="st">"classif.log_reg"</span>,</span>
<span>  <span class="st">"classif.ranger"</span><span class="op">)</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create costs matrix</span></span>
<span><span class="va">costs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">3</span>, <span class="fl">2</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"Predicted Credit"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"good"</span>, <span class="st">"bad"</span><span class="op">)</span>,</span>
<span>                    Truth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"good"</span>, <span class="st">"bad"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">costs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                Truth
Predicted Credit good bad
            good  -10   2
            bad     3  -1</code></pre>
</div>
</div>
<p>Our cost matrix is as expected so we can plug it into our measure and setup our pipeline.</p>
<div class="cell">
<div class="sourceCode" id="cb263"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create measure</span></span>
<span><span class="va">meas_costs</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.costs"</span>, costs <span class="op">=</span> <span class="va">costs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a function to wrap learners in internal cross-validation</span></span>
<span><span class="co">#  to tune the threshold</span></span>
<span><span class="va">pipe</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner_cv"</span>, <span class="va">l</span>, resampling.folds <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"tunethreshold"</span>, measure <span class="op">=</span> <span class="va">meas_costs</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Benchmark</span></span>
<span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">learners</span>, <span class="va">pipe</span><span class="op">)</span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">tsk_german</span>, <span class="va">learners</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"holdout"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="va">meas_costs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>OptimInstanceSingleCrit is deprecated. Use OptimInstanceBatchSingleCrit instead.
OptimInstanceSingleCrit is deprecated. Use OptimInstanceBatchSingleCrit instead.
OptimInstanceSingleCrit is deprecated. Use OptimInstanceBatchSingleCrit instead.</code></pre>
</div>
</div>
<p>Now exploring our results…</p>
<div class="cell">
<div class="sourceCode" id="cb265"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmr</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">learner_id</span>, <span class="va">classif.costs</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          learner_id classif.costs
1: classif.featureless.tunethreshold        -6.180
2:     classif.log_reg.tunethreshold        -6.216
3:      classif.ranger.tunethreshold        -6.180</code></pre>
</div>
</div>
<p>Based on these results, the logistic regression performs the best with the greatest increase to costs, however the difference is only marginal compared to the other learners.</p>
<ol start="2" type="1">
<li>Train and test a survival forest using <code>lrn("surv.rfsrc")</code> (from <code>mlr3extralearners</code>). Run this experiment using <code>tsk("rats")</code> and <code><a href="https://mlr3.mlr-org.com/reference/partition.html">partition()</a></code>. Evaluate your model with the RCLL measure.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb267"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get learners</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3extralearners.mlr-org.com">mlr3extralearners</a></span><span class="op">)</span></span>
<span><span class="co"># Get survival models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3proba.mlr-org.com">mlr3proba</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 methods overwritten by 'mlr3proba':
  method                    from   
  autoplot.LearnerSurvCoxPH mlr3viz
  plot.LearnerSurvCoxPH     mlr3viz</code></pre>
</div>
<div class="sourceCode" id="cb269"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># Use partition to split data and test our model</span></span>
<span><span class="va">tsk_rats</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"rats"</span><span class="op">)</span></span>
<span><span class="va">splits</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/partition.html">partition</a></span><span class="op">(</span><span class="va">tsk_rats</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"surv.rfsrc"</span><span class="op">)</span></span>
<span><span class="va">prediction</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">tsk_rats</span>, <span class="va">splits</span><span class="op">$</span><span class="va">train</span><span class="op">)</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">tsk_rats</span>, <span class="va">splits</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"surv.rcll"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>surv.rcll 
   0.8271 </code></pre>
</div>
</div>
<p>The right-censored logloss provides a measure of predictive accuracy, but it is quite hard to interpret it without comparison to another model. To yield a more informative value, we could either compute the RCLL for an uninformed baseline like the Kaplan-Meier estimator, or we could use the <code>ERV</code> (explained residual variation) parameter in the measure, which returns the RCLL as a percentage increase in performance compared to an uninformed baseline (in this case the Kaplan-Meier estimator):</p>
<div class="cell">
<div class="sourceCode" id="cb271"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"surv.kaplan"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">train</span><span class="op">(</span><span class="va">tsk_rats</span>, <span class="va">splits</span><span class="op">$</span><span class="va">train</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">predict</span><span class="op">(</span><span class="va">tsk_rats</span>, <span class="va">splits</span><span class="op">$</span><span class="va">test</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">score</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"surv.rcll"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>surv.rcll 
   0.8206 </code></pre>
</div>
<div class="sourceCode" id="cb273"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"surv.rcll"</span>, ERV <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  task <span class="op">=</span> <span class="va">tsk_rats</span>, train_set <span class="op">=</span> <span class="va">splits</span><span class="op">$</span><span class="va">train</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>surv.rcll 
-0.007969 </code></pre>
</div>
</div>
<p>Now we can see that our model is only marginally better than the Kaplan-Meier baseline (a 2% performance increase).</p>
<ol start="3" type="1">
<li>Estimate the density of the “precip” task from the <code>mlr3proba</code> package using <code>lrn("dens.hist")</code>, evaluate your estimation with the logloss measure. As a stretch goal, look into the documentation of <code>distr6</code> to learn how to analyse your estimated distribution further.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb275"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get density models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3proba.mlr-org.com">mlr3proba</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># Run experiment</span></span>
<span><span class="va">tsk_precip</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"precip"</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"dens.hist"</span><span class="op">)</span></span>
<span><span class="va">prediction</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">tsk_precip</span><span class="op">)</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">tsk_precip</span><span class="op">)</span></span>
<span><span class="va">prediction</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;PredictionDens&gt; for 70 observations: ────────────────────────────────
 row_ids      pdf    cdf
       1 0.001429 0.9957
       2 0.007143 0.9479
       3 0.005714 0.0400
     ---      ---    ---
      68 0.007143 0.2507
      69 0.012857 0.1163
      70 0.007143 0.9800
1 variable not shown: [distr]</code></pre>
</div>
<div class="sourceCode" id="cb277"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"dens.logloss"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dens.logloss 
       3.896 </code></pre>
</div>
</div>
<p>As before the logloss is not too informative by itself but as the Histogram is itself a baseline, we can use this value for comparison to more sophisticated models. To learn more about our predicted distribution, we could use <code>distr6</code> to summarise the distribution and to compute values such as the pdf and cdf:</p>
<div class="cell">
<div class="sourceCode" id="cb279"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction</span><span class="op">$</span><span class="va">distr</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Histogram Estimator
Support: [0,70]     Scientific Type: ℝ 

Traits:     continuous; univariate
Properties: asymmetric</code></pre>
</div>
<div class="sourceCode" id="cb281"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># pdf evaluated at `50`</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="va">distr</span><span class="op">$</span><span class="fu">pdf</span><span class="op">(</span><span class="fl">50</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.007143</code></pre>
</div>
</div>
<ol start="4" type="1">
<li>Run a benchmark clustering experiment on the “wine” dataset without a label column. Compare the performance of k-means learner with <code>k</code> equal to <code>2</code>, <code>3</code> and <code>4</code> using the silhouette measure and the insample resampling technique. What value of <code>k</code> would you choose based on the silhouette scores?</li>
</ol>
<div class="cell" data-messages="false" data-warnings="false">
<div class="sourceCode" id="cb283"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># Load clustering models and tasks</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3cluster.mlr-org.com">mlr3cluster</a></span><span class="op">)</span></span>
<span><span class="co"># Create the clustering dataset by extracting only the features from the</span></span>
<span><span class="co">#  wine task</span></span>
<span><span class="va">tsk_wine</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"wine"</span><span class="op">)</span></span>
<span><span class="va">tsk_wine</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3cluster.mlr-org.com/reference/as_task_clust.html">as_task_clust</a></span><span class="op">(</span><span class="va">tsk_wine</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>cols <span class="op">=</span> <span class="va">tsk_wine</span><span class="op">$</span><span class="va">feature_names</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Create learners and ensure they have unique IDs</span></span>
<span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.kmeans"</span>, centers <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"K=2"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.kmeans"</span>, centers <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"K=3"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.kmeans"</span>, centers <span class="op">=</span> <span class="fl">4</span>, id <span class="op">=</span> <span class="st">"K=4"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Benchmark</span></span>
<span><span class="va">meas</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"clust.silhouette"</span><span class="op">)</span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">tsk_wine</span>, <span class="va">learners</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"insample"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="va">meas</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">learner_id</span>, <span class="va">clust.silhouette</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   learner_id clust.silhouette
1:        K=2           0.6569
2:        K=3           0.5711
3:        K=4           0.5606</code></pre>
</div>
</div>
<p>We can see that we get the silhouette closest to <code>1</code> with <code>K=2</code> so we might use this value for future experiments.</p>
<ol start="5" type="1">
<li>Manually <code>$train()</code> a GBM regression model from <a href="https://mlr3extralearners.mlr-org.com"><code>mlr3extralearners</code></a> on <code>tsk("mtcars")</code> to predict the 95th percentile of the target variable. Make sure that you split the data and only use the test data for fitting the learner. Use the test data to evaluate your learner with the pinball loss.</li>
</ol>
<p>We start by loading <code>mlr3extralearners</code> and creating the tasks and the test train split.</p>
<div class="cell">
<div class="sourceCode" id="cb285"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3extralearners.mlr-org.com">mlr3extralearners</a></span><span class="op">)</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"california_housing"</span><span class="op">)</span></span>
<span><span class="va">splits</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/partition.html">partition</a></span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the next step, we initialize the learner as <code>"regr.gbm"</code> and explicitly set the <code>quantiles</code> parameter to 0.95. For the learner to be able to predict this quantile, we need to specify the <code>predict_type</code>. Lastly, we train the learner using only the test data.</p>
<div class="cell">
<div class="sourceCode" id="cb286"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lrn_gbm</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.gbm"</span>, predict_type <span class="op">=</span> <span class="st">"quantiles"</span>, quantiles <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="va">lrn_gbm</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span>, row_ids <span class="op">=</span> <span class="va">splits</span><span class="op">$</span><span class="va">train</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To evaluate the learner, we first use it to predict on the test data. Then, we calculate the pinball loss using the predictions.</p>
<div class="cell">
<div class="sourceCode" id="cb287"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prds_gbm</span> <span class="op">=</span> <span class="va">lrn_gbm</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span>, row_ids <span class="op">=</span> <span class="va">splits</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span><span class="va">score_gbm</span> <span class="op">=</span> <span class="va">prds_gbm</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.pinball"</span>, alpha <span class="op">=</span> <span class="fl">0.95</span>, id <span class="op">=</span> <span class="st">"q0.95"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">score_gbm</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>q0.95 
 9152 </code></pre>
</div>
</div>
</section><section id="solutions-to-sec-fairness" class="level2" data-number="A.13"><h2 data-number="A.13" class="anchored" data-anchor-id="solutions-to-sec-fairness">
<span class="header-section-number">A.13</span> Solutions to <a href="../chapter14/algorithmic_fairness.html" class="quarto-xref"><span>Chapter 14</span></a>
</h2>
<ol type="1">
<li>Train a model of your choice on <code>tsk("adult_train")</code> and test it on <code>tsk("adult_test")</code>, use any measure of your choice to evaluate your predictions. Assume our goal is to achieve parity in false omission rates across the protected ‘sex’ attribute. Construct a fairness metric that encodes this and evaluate your model. To get a deeper understanding, look at the <a href="https://mlr3fairness.mlr-org.com/reference/groupwise_metrics.html"><code>groupwise_metrics</code></a> function to obtain performance in each group.</li>
</ol>
<p>For now we simply load the data and look at the data.</p>
<div class="cell">
<div class="sourceCode" id="cb289"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3fairness.mlr-org.com">mlr3fairness</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tsk_adult_train</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"adult_train"</span><span class="op">)</span></span>
<span><span class="va">tsk_adult_test</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"adult_test"</span><span class="op">)</span></span>
<span><span class="va">tsk_adult_train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;TaskClassif&gt; (30718x13) ─────────────────────────────────────────────
• Target: target
• Target classes: &lt;=50K (positive class, 75%), &gt;50K (25%)
• Properties: twoclass
• Features (12):
  • fct (7): education, marital_status, occupation, race, relationship,
  sex, workclass
  • int (5): age, capital_gain, capital_loss, education_num,
  hours_per_week
• Protected attribute: sex</code></pre>
</div>
</div>
<p>We can now train a simple model, e.g., a decision tree and evaluate for accuracy.</p>
<div class="cell">
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span></span>
<span><span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">tsk_adult_train</span><span class="op">)</span></span>
<span><span class="va">prediction</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">tsk_adult_test</span><span class="op">)</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
     0.161 </code></pre>
</div>
</div>
<p>The <em>false omission rate parity</em> metric is available via the key <code>"fairness.fomr"</code>. Note, that evaluating our prediction now requires that we also provide the task.</p>
<div class="cell">
<div class="sourceCode" id="cb293"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">msr_1</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"fairness.fomr"</span><span class="op">)</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="va">msr_1</span>, <span class="va">tsk_adult_test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>fairness.fomr 
      0.03533 </code></pre>
</div>
</div>
<p>In addition, we can look at false omission rates in each group. The <code>groupwise_metrics</code> function creates a metric for each group specified in the <code>pta</code> column role:</p>
<div class="cell">
<div class="sourceCode" id="cb295"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tsk_adult_test</span><span class="op">$</span><span class="va">col_roles</span><span class="op">$</span><span class="va">pta</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "sex"</code></pre>
</div>
</div>
<p>We can then use this metric to evaluate our model again. This gives us the false omission rates for male and female individuals separately.</p>
<div class="cell">
<div class="sourceCode" id="cb297"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">msr_2</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3fairness.mlr-org.com/reference/groupwise_metrics.html">groupwise_metrics</a></span><span class="op">(</span>base_measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.fomr"</span><span class="op">)</span>, task <span class="op">=</span> <span class="va">tsk_adult_test</span><span class="op">)</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="va">msr_2</span>, <span class="va">tsk_adult_test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  subgroup.fomr_Male subgroup.fomr_Female 
              0.2442               0.2089 </code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Improve your model by employing pipelines that use pre- or post-processing methods for fairness. Evaluate your model along the two metrics and visualize the resulting metrics. Compare the different models using an appropriate visualization.</li>
</ol>
<p>First we can again construct the learners above.</p>
<div class="cell">
<div class="sourceCode" id="cb299"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3pipelines.mlr-org.com">mlr3pipelines</a></span><span class="op">)</span></span>
<span><span class="va">lrn_1</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"reweighing_wts"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span></span>
<span><span class="va">lrn_2</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner_cv"</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"EOd"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And run the benchmark again. Note, that we use three-fold CV this time for comparison.</p>
<div class="cell">
<div class="sourceCode" id="cb300"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">learner</span>, <span class="va">lrn_1</span>, <span class="va">lrn_2</span><span class="op">)</span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">tsk_adult_train</span>, <span class="va">learners</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msrs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"classif.acc"</span>, <span class="st">"fairness.fomr"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr     task_id                   learner_id resampling_id iters
1:  1 adult_train                classif.rpart            cv     3
2:  2 adult_train reweighing_wts.classif.rpart            cv     3
3:  3 adult_train            classif.rpart.EOd            cv     3
2 variables not shown: [classif.acc, fairness.fomr]
Hidden columns: resample_result</code></pre>
</div>
</div>
<p>We can now again visualize the result.</p>
<div class="cell">
<div class="sourceCode" id="cb302"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mlr3fairness.mlr-org.com/reference/fairness_accuracy_tradeoff.html">fairness_accuracy_tradeoff</a></span><span class="op">(</span><span class="va">bmr</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"fairness.fomr"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_d</a></span><span class="op">(</span><span class="st">"Learner"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="solutions_files/figure-html/solutions-118-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can notice two main results:</p>
<ul>
<li>We do not improve in the false omission rate by using fairness interventions. One reason might be, that the interventions chosen do not optimize for the <em>false omission rate</em>, but other metrics, e.g.&nbsp;<em>equalized odds</em>.</li>
<li>The spread between the different cross-validation iterations (small dots) is quite large, estimates might come with a considerable error.</li>
</ul>
<ol start="3" type="1">
<li>Add “race” as a second sensitive attribute to your dataset. Add the information to your task and evaluate the initial model again. What changes? Again study the <code>groupwise_metrics</code>.</li>
</ol>
<p>This can be achieved by adding “race” to the <code>"pta"</code> col_role.</p>
<div class="cell">
<div class="sourceCode" id="cb303"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tsk_adult_train</span><span class="op">$</span><span class="fu">set_col_roles</span><span class="op">(</span><span class="st">"race"</span>, add_to <span class="op">=</span> <span class="st">"pta"</span><span class="op">)</span></span>
<span><span class="va">tsk_adult_train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;TaskClassif&gt; (30718x13) ─────────────────────────────────────────────
• Target: target
• Target classes: &lt;=50K (positive class, 75%), &gt;50K (25%)
• Properties: twoclass
• Features (12):
  • fct (7): education, marital_status, occupation, race, relationship,
  sex, workclass
  • int (5): age, capital_gain, capital_loss, education_num,
  hours_per_week
• Protected attribute: sex and race</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb305"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tsk_adult_test</span><span class="op">$</span><span class="fu">set_col_roles</span><span class="op">(</span><span class="st">"race"</span>, add_to <span class="op">=</span> <span class="st">"pta"</span><span class="op">)</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="va">msr_1</span>, <span class="va">tsk_adult_test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>fairness.fomr 
       0.8889 </code></pre>
</div>
</div>
<p>Evaluating for the intersection, we obtain a large deviation from <code>0</code>. Note, that the metric by default computes the maximum discrepancy between all metrics for the non-binary case.</p>
<p>If we now compute the <code>groupwise_metrics</code>, we will get a metric for the intersection of each group.</p>
<div class="cell">
<div class="sourceCode" id="cb307"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">msr_3</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3fairness.mlr-org.com/reference/groupwise_metrics.html">groupwise_metrics</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.fomr"</span><span class="op">)</span>,  <span class="va">tsk_adult_train</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">msr_3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "subgroup.fomr_Male, White"               
 [2] "subgroup.fomr_Male, Black"               
 [3] "subgroup.fomr_Female, Black"             
 [4] "subgroup.fomr_Female, White"             
 [5] "subgroup.fomr_Male, Asian-Pac-Islander"  
 [6] "subgroup.fomr_Male, Amer-Indian-Eskimo"  
 [7] "subgroup.fomr_Female, Other"             
 [8] "subgroup.fomr_Female, Asian-Pac-Islander"
 [9] "subgroup.fomr_Female, Amer-Indian-Eskimo"
[10] "subgroup.fomr_Male, Other"               </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb309"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="va">msr_3</span>, <span class="va">tsk_adult_test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               subgroup.fomr_Male, White 
                                  0.2402 
               subgroup.fomr_Male, Black 
                                  0.2716 
             subgroup.fomr_Female, Black 
                                  0.2609 
             subgroup.fomr_Female, White 
                                  0.1919 
  subgroup.fomr_Male, Asian-Pac-Islander 
                                  0.3168 
  subgroup.fomr_Male, Amer-Indian-Eskimo 
                                  0.1667 
             subgroup.fomr_Female, Other 
                                  0.2500 
subgroup.fomr_Female, Asian-Pac-Islander 
                                  0.3529 
subgroup.fomr_Female, Amer-Indian-Eskimo 
                                  1.0000 
               subgroup.fomr_Male, Other 
                                  0.1111 </code></pre>
</div>
</div>
<p>And we can see, that the reason might be, that the false omission rate for female Amer-Indian-Eskimo is at <code>1.0</code>!</p>
<ol start="4" type="1">
<li>In this chapter we were unable to reduce bias in our experiment. Using everything you have learned in this book, see if you can successfully reduce bias in your model. Critically reflect on this exercise, why might this be a bad idea?</li>
</ol>
<p>Several problems with the existing metrics.</p>
<p>We’ll go through them one by one to deepen our understanding:</p>
<p><strong>Metric and evaluation</strong></p>
<ul>
<li>
<p>In order for the fairness metric to be useful, we need to ensure that the data used for evaluation is representative and sufficiently large.</p>
<p>We can investigate this further by looking at actual counts:</p>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb311"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span>  <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">tsk_adult_test</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"race"</span>, <span class="st">"sex"</span>, <span class="st">"target"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>, , target = &lt;=50K

                    sex
race                 Female Male
  Amer-Indian-Eskimo     56   74
  Asian-Pac-Islander    131  186
  Black                 654  619
  Other                  37   66
  White                3544 6176

, , target = &gt;50K

                    sex
race                 Female Male
  Amer-Indian-Eskimo      3   16
  Asian-Pac-Islander     26  106
  Black                  41  133
  Other                   5   19
  White                 492 2931</code></pre>
</div>
</div>
<p>One of the reasons might be that there are only 3 individuals in the “&gt;50k” category! This is an often encountered problem, as error metrics have a large variance when samples are small. Note, that the pre- and post-processing methods in general do not all support multiple protected attributes.</p>
<ul>
<li>We should question whether comparing the metric between all groups actually makes sense for the question we are trying to answer. Instead, we might want to observe the metric between two specific subgroups, in this case between individuals with <code>sex</code>: <code>Female</code> and <code>race</code>: <code>"Black"</code> or <code>"White"</code>.</li>
</ul>
<p>First, we create a subset of only <code>sex</code>: <code>Female</code> and <code>race</code>: <code>"Black", "White"</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb313"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">adult_subset</span> <span class="op">=</span> <span class="va">tsk_adult_test</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">=</span> <span class="va">adult_subset</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rows</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">race</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Black"</span>, <span class="st">"White"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">df</span><span class="op">$</span><span class="va">sex</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Female"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">adult_subset</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">rows</span><span class="op">)</span></span>
<span><span class="va">adult_subset</span><span class="op">$</span><span class="fu">set_col_roles</span><span class="op">(</span><span class="st">"race"</span>, add_to <span class="op">=</span> <span class="st">"pta"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Currently, there is a bug in the <code>mlr3fairness</code> package that causes the following code chunk to fail. See https://github.com/mlr-org/mlr3fairness/issues/79 for more details.</p>
</div>
</div>
<p>And evaluate our measure again:</p>
<div class="cell">
<div class="sourceCode" id="cb314"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="va">msr_3</span>, task <span class="op">=</span> <span class="va">adult_subset</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see, that between women there is an even bigger discrepancy compared to men.</p>
<ul>
<li>The bias mitigation strategies we employed do not optimize for the <em>false omission rate</em> metric, but other metrics instead. It might therefore be better to try to achieve fairness via other strategies, using different or more powerful models or tuning hyperparameters.</li>
</ul></section><section id="solutions-to-sec-predsets-valid-inttune" class="level2" data-number="A.14"><h2 data-number="A.14" class="anchored" data-anchor-id="solutions-to-sec-predsets-valid-inttune">
<span class="header-section-number">A.14</span> Solutions to <a href="../chapter15/predsets_valid_inttune.html" class="quarto-xref"><span>Chapter 15</span></a>
</h2>
<ol type="1">
<li>Manually <code>$train()</code> a LightGBM classifier from <a href="https://mlr3extralearners.mlr-org.com"><code>mlr3extralearners</code></a> on the pima task using <span class="math inline">\(1/3\)</span> of the training data for validation. As the pima task has missing values, select a method from <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> to impute them. Explicitly set the evaluation metric to logloss (<code>"binary_logloss"</code>), the maximum number of boosting iterations to 1000, the patience parameter to 10, and the step size to 0.01. After training the learner, inspect the final validation scores as well as the early stopped number of iterations.</li>
</ol>
<p>We start by loading the packages and creating the task.</p>
<div class="cell">
<div class="sourceCode" id="cb315"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3extralearners.mlr-org.com">mlr3extralearners</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3pipelines.mlr-org.com">mlr3pipelines</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">tsk_pima</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"pima"</span><span class="op">)</span></span>
<span><span class="va">tsk_pima</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
── &lt;TaskClassif&gt; (768x9): Pima Indian Diabetes ──────────────────────────
• Target: diabetes
• Target classes: pos (positive class, 35%), neg (65%)
• Properties: twoclass
• Features (8):
  • dbl (8): age, glucose, insulin, mass, pedigree, pregnant, pressure,
  triceps</code></pre>
</div>
</div>
<p>Below, we see that the task has five features with missing values.</p>
<div class="cell">
<div class="sourceCode" id="cb317"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tsk_pima</span><span class="op">$</span><span class="fu">missings</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>diabetes      age  glucose  insulin     mass pedigree pregnant pressure 
       0        0        5      374       11        0        0       35 
 triceps 
     227 </code></pre>
</div>
</div>
<p>Next, we create the LightGBM classifier, but don’t specify the validation data yet. We handle the missing values using a simple median imputation.</p>
<div class="cell">
<div class="sourceCode" id="cb319"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lrn_lgbm</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.lightgbm"</span>,</span>
<span>  num_iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  early_stopping_rounds <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  learning_rate <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  eval <span class="op">=</span> <span class="st">"binary_logloss"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">glrn</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"imputemedian"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="va">lrn_lgbm</span><span class="op">)</span></span>
<span><span class="va">glrn</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="st">"lgbm"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After constructing the graphlearner, we now configure the validation data using <a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html"><code>set_validate()</code></a>. The call below sets the <code>$validate</code> field of the LightGBM pipeop to <code>"predefined"</code> and of the graphlearner to <code>0.3</code>. Recall that only the graphlearner itself can specify <em>how</em> the validation data is generated. The individual pipeops can either use it (<code>"predefined"</code>) or not (<code>NULL</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb320"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">set_validate</a></span><span class="op">(</span><span class="va">glrn</span>, validate <span class="op">=</span> <span class="fl">0.3</span>, ids <span class="op">=</span> <span class="st">"classif.lightgbm"</span><span class="op">)</span></span>
<span><span class="va">glrn</span><span class="op">$</span><span class="va">validate</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3</code></pre>
</div>
<div class="sourceCode" id="cb322"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">glrn</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">classif.lightgbm</span><span class="op">$</span><span class="va">validate</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "predefined"</code></pre>
</div>
</div>
<p>Finally, we train the learner and inspect the validation scores and internally tuned parameters.</p>
<div class="cell">
<div class="sourceCode" id="cb324"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">glrn</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">tsk_pima</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glrn</span><span class="op">$</span><span class="va">internal_tuned_values</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$classif.lightgbm.num_iterations
[1] 183</code></pre>
</div>
<div class="sourceCode" id="cb326"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">glrn</span><span class="op">$</span><span class="va">internal_valid_scores</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$classif.lightgbm.binary_logloss
[1] 0.4782</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Wrap the learner from exercise 1) in an <code>AutoTuner</code> using a three-fold CV for the tuning. Also change the rule for aggregating the different boosting iterations from averaging to taking the maximum across the folds. Don’t tune any parameters other than <code>nrounds</code>, which can be done using <code>tnr("internal")</code>. Use the internal validation metric as the tuning measure. Compare this learner with a <code>lrn("classif.rpart")</code> using a 10-fold outer cross-validation with respect to classification accuracy.</li>
</ol>
<p>We start by setting the number of boosting iterations to an internal tune token where the maximum number of boosting iterations is 1000 and the aggregation function the maximum. Note that the input to the aggregation function is a list of integer values (the early stopped values for the different resampling iterations), so we need to <code><a href="https://rdrr.io/r/base/unlist.html">unlist()</a></code> it first before taking the maximum.</p>
<div class="cell">
<div class="sourceCode" id="cb328"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3tuning.mlr-org.com">mlr3tuning</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">glrn</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="fu">set_values</span><span class="op">(</span></span>
<span>  classif.lightgbm.num_iterations <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span></span>
<span>    upper <span class="op">=</span> <span class="fl">1000</span>, internal <span class="op">=</span> <span class="cn">TRUE</span>, aggr <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we change the validation data from <code>0.3</code> to <code>"test"</code>, where we can omit the <code>ids</code> specification as LightGBM is the base learner.</p>
<div class="cell">
<div class="sourceCode" id="cb329"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">set_validate</a></span><span class="op">(</span><span class="va">glrn</span>, validate <span class="op">=</span> <span class="st">"test"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we create the autotuner using the configuration given in the instructions. As the internal validation measures are calculated by <code>lightgbm</code> and not <code>mlr3</code>, we need to specify whether the metric should be minimized.</p>
<div class="cell">
<div class="sourceCode" id="cb330"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">at_lgbm</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/auto_tuner.html">auto_tuner</a></span><span class="op">(</span></span>
<span>  learner <span class="op">=</span> <span class="va">glrn</span>,</span>
<span>  tuner <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr</a></span><span class="op">(</span><span class="st">"internal"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"internal_valid_score"</span>,</span>
<span>    select <span class="op">=</span> <span class="st">"classif.lightgbm.binary_logloss"</span>, minimize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">at_lgbm</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="st">"at_lgbm"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we set up the benchmark design, run it, and evaluate the learners in terms of their classification accuracy.</p>
<div class="cell">
<div class="sourceCode" id="cb331"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span></span>
<span>  task <span class="op">=</span> <span class="va">tsk_pima</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">at_lgbm</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  resamplings <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 
✖ Multiple predict types detected, this will mean that you cannot
  evaluate the same measures on all learners.
→ Class: Mlr3WarningVaryingPredictTypes</code></pre>
</div>
<div class="sourceCode" id="cb333"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr task_id    learner_id resampling_id iters classif.acc
1:  1    pima       at_lgbm            cv    10      0.7670
2:  2    pima classif.rpart            cv    10      0.7462
Hidden columns: resample_result</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>
<p>Consider the code below:</p>
<div class="cell">
<div class="sourceCode" id="cb335"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">branch_lrn</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"branch"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.ranger"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.xgboost"</span>,</span>
<span>      early_stopping_rounds <span class="op">=</span> <span class="fl">10</span>,</span>
<span>      eval_metric <span class="op">=</span> <span class="st">"error"</span>,</span>
<span>      eta <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="fl">0.001</span>, <span class="fl">0.1</span>, logscale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      nrounds <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span>upper <span class="op">=</span> <span class="fl">1000</span>, internal <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">set_validate</a></span><span class="op">(</span><span class="va">branch_lrn</span>, validate <span class="op">=</span> <span class="st">"test"</span>, ids <span class="op">=</span> <span class="st">"classif.xgboost"</span><span class="op">)</span></span>
<span><span class="va">branch_lrn</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="fu">set_values</span><span class="op">(</span>branch.selection <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/to_tune.html">to_tune</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">at</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/auto_tuner.html">auto_tuner</a></span><span class="op">(</span></span>
<span>  tuner <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr</a></span><span class="op">(</span><span class="st">"grid_search"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="va">branch_lrn</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"holdout"</span>, ratio <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>,</span>
<span>  <span class="co"># cannot use internal validation score because ranger does not have one</span></span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.ce"</span><span class="op">)</span>,</span>
<span>  term_evals <span class="op">=</span> <span class="fl">10L</span>,</span>
<span>  store_models <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tsk_sonar</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"sonar"</span><span class="op">)</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/resample.html">resample</a></span><span class="op">(</span></span>
<span>  <span class="va">tsk_sonar</span>, <span class="va">at</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"holdout"</span>, ratio <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>, store_models <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer the following questions (ideally without running the code):</p>
</li>
</ol>
<p>3.1 During the hyperparameter optimization, how many observations are used to train the XGBoost algorithm (excluding validation data) and how many for the random forest? Hint: learners that cannot make use of validation data ignore it.</p>
<p>The outer resampling already removes 20 observations from the data (the outer test set), leaving only 80 data points (the outer train set) for the inner resampling. Then 16 (0.2 * 80; the test set of the inner holdout resampling) observations are used to evaluate the hyperparameter configurations. This leaves 64 (80 - 16) observations for training. For XGBoost, the 16 observations that make up the inner test set are also used for validation, so no more observations from the 64 training points are removed. Because the random forest does not support validation, the 16 observations from the inner test set will only be used for evaluation the hyperparameter configuration, but not simultanteously for internal validation. Therefore, both the random forest and XGBoost models use 64 observations for training.</p>
<p>3.2 How many observations would be used to train the final model if XGBoost was selected? What if the random forest was chosen?</p>
<p>In both cases, all 80 observations (the train set from the outer resampling) would be used. This is because during the final model fit no validation data is generated.</p>
<p>3.3 How would the answers to the last two questions change if we had set the <code>$validate</code> field of the graphlearner to <code>0.25</code> instead of <code>"test"</code>?</p>
<p>In this case, the validation data is no longer identical to the inner resampling test set. Instead, it is split from the 64 observations that make up the inner training set. Because this happens before the task enters the graphlearner, both the XGBoost model <em>and</em> the random forest only have access to 48 ((1 - 0.25) * 64) observations, and the remaining 16 are used to create the validation data. Note that the random forest will again ignore the validation data as it does not have the ‘validation’ property and therefore cannot use it. Also, the autotuner would now use a different set for tuning the step size and boosting iterations (which coincidentally both have size 16). Therefore, the answer to question 3.1 would be 48 instead of 64.</p>
<p>However, this does not change the answer to 3.2, as, again, no validation is performed during the final model fit.</p>
<p>Note that we would normally recommend setting the validation data to <code>"test"</code> when tuning, so this should be thought of as a illustrative example.</p>
<ol start="4" type="1">
<li>
<p>Look at the (failing) code below:</p>
<div class="cell">
<div class="sourceCode" id="cb336"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tsk_sonar</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"sonar"</span><span class="op">)</span></span>
<span><span class="va">glrn</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"pca"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.xgboost"</span>, validate <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error:
! Validate field of PipeOp 'classif.xgboost' must either be NULL or 'predefined'. We recommend specifying the validation data by calling set_validate(&lt;glrn&gt;, validate = &lt;value&gt;) on a GraphLearner. You can read more about this here: https://mlr3book.mlr-org.com/chapters/chapter15/predsets_valid_inttune.html.</code></pre>
</div>
</div>
<p>Can you explain <em>why</em> the code fails? Hint: Should the data that xgboost uses for validation be preprocessed according to the <em>train</em> or <em>predict</em> logic?</p>
</li>
</ol>
<p>If we set the <code>$validate</code> field of the XGBoost classifier to <code>0.3</code>, the validation data would be generated from the output task of <code>PipeOpOpPCA</code>. However, this task has been exclusively preprocessed using the train logic, because the <code>PipeOpPCA</code> does not ‘know’ that the LightGBM classifier wants to do validation. Because validation performance is intended to measure how well a model would perform during prediction, the validation should be preprocessed according to the predict logic. For this reason, splitting of the 30% of the output from <code>PipeOpPCA</code> to use as validation data in the XGBoost classifier would be invalid. Therefore, it is not possible to set the <code>$validate</code> field of <code>PipeOps</code> to values other than <code>predefined' or</code>NULL’. Only the <code>GraphLearner</code> itself can dictate <em>how</em> the validation data is created <em>before</em> it enters the <code>Graph</code>, so the validation data is then preprocessed according to the predict logic.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-amlb2022" class="csl-entry" role="listitem">
Gijsbers, Pieter, Marcos L. P. Bueno, Stefan Coors, Erin LeDell, Sébastien Poirier, Janek Thomas, Bernd Bischl, and Joaquin Vanschoren. 2022. <span>“AMLB: An AutoML Benchmark.”</span> arXiv. <a href="https://doi.org/10.48550/ARXIV.2207.12560">https://doi.org/10.48550/ARXIV.2207.12560</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../../chapters/references.html" class="pagination-link" aria-label="References">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">References</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../chapters/appendices/tasks.html" class="pagination-link" aria-label="Tasks">
        <span class="nav-page-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Tasks</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb338" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb338-2"><a href="#cb338-2" aria-hidden="true" tabindex="-1"></a><span class="an">aliases:</span></span>
<span id="cb338-3"><a href="#cb338-3" aria-hidden="true" tabindex="-1"></a><span class="co">  - "/solutions.html"</span></span>
<span id="cb338-4"><a href="#cb338-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb338-5"><a href="#cb338-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-6"><a href="#cb338-6" aria-hidden="true" tabindex="-1"></a><span class="fu"># Solutions to exercises {#sec-solutions}</span></span>
<span id="cb338-7"><a href="#cb338-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-8"><a href="#cb338-8" aria-hidden="true" tabindex="-1"></a>::: {.content-visible when-format="html"}</span>
<span id="cb338-9"><a href="#cb338-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-10"><a href="#cb338-10" aria-hidden="true" tabindex="-1"></a>{{&lt; include ../../common/_setup.qmd &gt;}}</span>
<span id="cb338-11"><a href="#cb338-11" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ENSURE ONLINE ONLY AND REFERENCE IN PREFACE --&gt;</span></span>
<span id="cb338-12"><a href="#cb338-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-13"><a href="#cb338-13" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-basics</span></span>
<span id="cb338-14"><a href="#cb338-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-15"><a href="#cb338-15" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Train a classification model with the <span class="in">`classif.rpart`</span> learner on the "Pima Indians Diabetes" dataset.</span>
<span id="cb338-16"><a href="#cb338-16" aria-hidden="true" tabindex="-1"></a>  Do this without using <span class="in">`tsk("pima")`</span>, and instead by constructing a task from the dataset in the <span class="in">`mlbench`</span>-package: <span class="in">`data(PimaIndiansDiabetes2, package = "mlbench")`</span>.</span>
<span id="cb338-17"><a href="#cb338-17" aria-hidden="true" tabindex="-1"></a>  Make sure to define the <span class="in">`pos`</span> outcome as positive class.</span>
<span id="cb338-18"><a href="#cb338-18" aria-hidden="true" tabindex="-1"></a>  Train the model on a random 80% subset of the given data and evaluate its performance with the classification error measure on the remaining data.</span>
<span id="cb338-19"><a href="#cb338-19" aria-hidden="true" tabindex="-1"></a>  (Note that the data set has NAs in its features.</span>
<span id="cb338-20"><a href="#cb338-20" aria-hidden="true" tabindex="-1"></a>  You can either rely on <span class="in">`rpart`</span>'s capability to handle them internally ('surrogate splits') or remove them from the initial <span class="in">`data.frame`</span> by using <span class="in">`na.omit`</span>).</span>
<span id="cb338-21"><a href="#cb338-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-22"><a href="#cb338-22" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-001}</span></span>
<span id="cb338-23"><a href="#cb338-23" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-24"><a href="#cb338-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-25"><a href="#cb338-25" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(PimaIndiansDiabetes2, <span class="at">package =</span> <span class="st">"mlbench"</span>)</span>
<span id="cb338-26"><a href="#cb338-26" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">as_task_classif</span>(PimaIndiansDiabetes2, <span class="at">target =</span> <span class="st">"diabetes"</span>, <span class="at">positive =</span> <span class="st">"pos"</span>)</span>
<span id="cb338-27"><a href="#cb338-27" aria-hidden="true" tabindex="-1"></a>splits <span class="ot">=</span> <span class="fu">partition</span>(task, <span class="at">ratio =</span> <span class="fl">0.8</span>)</span>
<span id="cb338-28"><a href="#cb338-28" aria-hidden="true" tabindex="-1"></a>splits</span>
<span id="cb338-29"><a href="#cb338-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-30"><a href="#cb338-30" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span> , <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb338-31"><a href="#cb338-31" aria-hidden="true" tabindex="-1"></a>learner</span>
<span id="cb338-32"><a href="#cb338-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-33"><a href="#cb338-33" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task, <span class="at">row_ids =</span> splits<span class="sc">$</span>train)</span>
<span id="cb338-34"><a href="#cb338-34" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>model</span>
<span id="cb338-35"><a href="#cb338-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-36"><a href="#cb338-36" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> splits<span class="sc">$</span>test)</span>
<span id="cb338-37"><a href="#cb338-37" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(prediction)</span>
<span id="cb338-38"><a href="#cb338-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-39"><a href="#cb338-39" aria-hidden="true" tabindex="-1"></a>measure <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>)</span>
<span id="cb338-40"><a href="#cb338-40" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(measure)</span>
<span id="cb338-41"><a href="#cb338-41" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-42"><a href="#cb338-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-43"><a href="#cb338-43" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Calculate the true positive, false positive, true negative, and false negative rates of the predictions made by the model in Exercise 1.</span>
<span id="cb338-44"><a href="#cb338-44" aria-hidden="true" tabindex="-1"></a>  Try to solve this in two ways: (a) Using <span class="in">`mlr3measures`</span>-predefined measure objects, and (b) without using <span class="in">`mlr3`</span> tools by directly working on the ground truth and prediction vectors.</span>
<span id="cb338-45"><a href="#cb338-45" aria-hidden="true" tabindex="-1"></a>  Compare the results.</span>
<span id="cb338-46"><a href="#cb338-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-47"><a href="#cb338-47" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-002}</span></span>
<span id="cb338-48"><a href="#cb338-48" aria-hidden="true" tabindex="-1"></a><span class="co"># true positive rate</span></span>
<span id="cb338-49"><a href="#cb338-49" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"classif.tpr"</span>))</span>
<span id="cb338-50"><a href="#cb338-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-51"><a href="#cb338-51" aria-hidden="true" tabindex="-1"></a><span class="co"># false positive rate</span></span>
<span id="cb338-52"><a href="#cb338-52" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"classif.fpr"</span>))</span>
<span id="cb338-53"><a href="#cb338-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-54"><a href="#cb338-54" aria-hidden="true" tabindex="-1"></a><span class="co"># true negative rate</span></span>
<span id="cb338-55"><a href="#cb338-55" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"classif.tnr"</span>))</span>
<span id="cb338-56"><a href="#cb338-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-57"><a href="#cb338-57" aria-hidden="true" tabindex="-1"></a><span class="co"># false negative rate</span></span>
<span id="cb338-58"><a href="#cb338-58" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"classif.fnr"</span>))</span>
<span id="cb338-59"><a href="#cb338-59" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-60"><a href="#cb338-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-61"><a href="#cb338-61" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-003}</span></span>
<span id="cb338-62"><a href="#cb338-62" aria-hidden="true" tabindex="-1"></a><span class="co"># true positives</span></span>
<span id="cb338-63"><a href="#cb338-63" aria-hidden="true" tabindex="-1"></a>TP <span class="ot">=</span> <span class="fu">sum</span>(prediction<span class="sc">$</span>truth <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> prediction<span class="sc">$</span>response <span class="sc">==</span> <span class="st">"pos"</span>)</span>
<span id="cb338-64"><a href="#cb338-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-65"><a href="#cb338-65" aria-hidden="true" tabindex="-1"></a><span class="co"># false positives</span></span>
<span id="cb338-66"><a href="#cb338-66" aria-hidden="true" tabindex="-1"></a>FP <span class="ot">=</span> <span class="fu">sum</span>(prediction<span class="sc">$</span>truth <span class="sc">==</span> <span class="st">"neg"</span> <span class="sc">&amp;</span> prediction<span class="sc">$</span>response <span class="sc">==</span> <span class="st">"pos"</span>)</span>
<span id="cb338-67"><a href="#cb338-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-68"><a href="#cb338-68" aria-hidden="true" tabindex="-1"></a><span class="co"># true negatives</span></span>
<span id="cb338-69"><a href="#cb338-69" aria-hidden="true" tabindex="-1"></a>TN <span class="ot">=</span> <span class="fu">sum</span>(prediction<span class="sc">$</span>truth <span class="sc">==</span> <span class="st">"neg"</span> <span class="sc">&amp;</span> prediction<span class="sc">$</span>response <span class="sc">==</span> <span class="st">"neg"</span>)</span>
<span id="cb338-70"><a href="#cb338-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-71"><a href="#cb338-71" aria-hidden="true" tabindex="-1"></a><span class="co"># false negatives</span></span>
<span id="cb338-72"><a href="#cb338-72" aria-hidden="true" tabindex="-1"></a>FN <span class="ot">=</span> <span class="fu">sum</span>(prediction<span class="sc">$</span>truth <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> prediction<span class="sc">$</span>response <span class="sc">==</span> <span class="st">"neg"</span>)</span>
<span id="cb338-73"><a href="#cb338-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-74"><a href="#cb338-74" aria-hidden="true" tabindex="-1"></a><span class="co"># true positive rate</span></span>
<span id="cb338-75"><a href="#cb338-75" aria-hidden="true" tabindex="-1"></a>TP <span class="sc">/</span> (TP <span class="sc">+</span> FN)</span>
<span id="cb338-76"><a href="#cb338-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-77"><a href="#cb338-77" aria-hidden="true" tabindex="-1"></a><span class="co"># false positive rate</span></span>
<span id="cb338-78"><a href="#cb338-78" aria-hidden="true" tabindex="-1"></a>FP <span class="sc">/</span> (FP <span class="sc">+</span> TN)</span>
<span id="cb338-79"><a href="#cb338-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-80"><a href="#cb338-80" aria-hidden="true" tabindex="-1"></a><span class="co"># true negative rate</span></span>
<span id="cb338-81"><a href="#cb338-81" aria-hidden="true" tabindex="-1"></a>TN <span class="sc">/</span> (TN <span class="sc">+</span> FP)</span>
<span id="cb338-82"><a href="#cb338-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-83"><a href="#cb338-83" aria-hidden="true" tabindex="-1"></a><span class="co"># false negative rate</span></span>
<span id="cb338-84"><a href="#cb338-84" aria-hidden="true" tabindex="-1"></a>FN <span class="sc">/</span> (FN <span class="sc">+</span> TP)</span>
<span id="cb338-85"><a href="#cb338-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-86"><a href="#cb338-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-87"><a href="#cb338-87" aria-hidden="true" tabindex="-1"></a>The results are the same.</span>
<span id="cb338-88"><a href="#cb338-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-89"><a href="#cb338-89" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Change the threshold of the model from Exercise 1 such that the false negative rate is lower.</span>
<span id="cb338-90"><a href="#cb338-90" aria-hidden="true" tabindex="-1"></a>  What is one reason you might do this in practice?</span>
<span id="cb338-91"><a href="#cb338-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-92"><a href="#cb338-92" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-004}</span></span>
<span id="cb338-93"><a href="#cb338-93" aria-hidden="true" tabindex="-1"></a><span class="co"># confusion matrix with threshold 0.5</span></span>
<span id="cb338-94"><a href="#cb338-94" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span>confusion</span>
<span id="cb338-95"><a href="#cb338-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-96"><a href="#cb338-96" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="fl">0.3</span>)</span>
<span id="cb338-97"><a href="#cb338-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-98"><a href="#cb338-98" aria-hidden="true" tabindex="-1"></a><span class="co"># confusion matrix with threshold 0.3</span></span>
<span id="cb338-99"><a href="#cb338-99" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span>confusion</span>
<span id="cb338-100"><a href="#cb338-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-101"><a href="#cb338-101" aria-hidden="true" tabindex="-1"></a><span class="co"># false positive rate</span></span>
<span id="cb338-102"><a href="#cb338-102" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"classif.fpr"</span>))</span>
<span id="cb338-103"><a href="#cb338-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-104"><a href="#cb338-104" aria-hidden="true" tabindex="-1"></a><span class="co"># false negative rate</span></span>
<span id="cb338-105"><a href="#cb338-105" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"classif.fnr"</span>))</span>
<span id="cb338-106"><a href="#cb338-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-107"><a href="#cb338-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-108"><a href="#cb338-108" aria-hidden="true" tabindex="-1"></a>With a false negative rate of 0.38, we miss a lot of people who have diabetes but are predicted to not have it.</span>
<span id="cb338-109"><a href="#cb338-109" aria-hidden="true" tabindex="-1"></a>This could give a false sense of security.</span>
<span id="cb338-110"><a href="#cb338-110" aria-hidden="true" tabindex="-1"></a>By lowering the threshold, we can reduce the false negative rate.</span>
<span id="cb338-111"><a href="#cb338-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-112"><a href="#cb338-112" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-performance</span></span>
<span id="cb338-113"><a href="#cb338-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-114"><a href="#cb338-114" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Apply a repeated cross-validation resampling strategy on <span class="in">`tsk("mtcars")`</span> and evaluate the performance of <span class="in">`lrn("regr.rpart")`</span>.</span>
<span id="cb338-115"><a href="#cb338-115" aria-hidden="true" tabindex="-1"></a>Use five repeats of three folds each.</span>
<span id="cb338-116"><a href="#cb338-116" aria-hidden="true" tabindex="-1"></a>Calculate the MSE for each iteration and visualize the result.</span>
<span id="cb338-117"><a href="#cb338-117" aria-hidden="true" tabindex="-1"></a>Finally, calculate the aggregated performance score.</span>
<span id="cb338-118"><a href="#cb338-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-119"><a href="#cb338-119" aria-hidden="true" tabindex="-1"></a>We start by instantiating our task and learner as usual:</span>
<span id="cb338-120"><a href="#cb338-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-121"><a href="#cb338-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-005}</span></span>
<span id="cb338-122"><a href="#cb338-122" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3</span>)</span>
<span id="cb338-123"><a href="#cb338-123" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>)</span>
<span id="cb338-124"><a href="#cb338-124" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.rpart"</span>)</span>
<span id="cb338-125"><a href="#cb338-125" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-126"><a href="#cb338-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-127"><a href="#cb338-127" aria-hidden="true" tabindex="-1"></a>We can instantiate a temporary resampling on the task to illustrate how it assigns observations across the 5 repeats (column <span class="in">`rep`</span>) and 3 folds:</span>
<span id="cb338-128"><a href="#cb338-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-129"><a href="#cb338-129" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-006}</span></span>
<span id="cb338-130"><a href="#cb338-130" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"repeated_cv"</span>, <span class="at">repeats =</span> <span class="dv">5</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb338-131"><a href="#cb338-131" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">instantiate</span>(task)</span>
<span id="cb338-132"><a href="#cb338-132" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span>instance</span>
<span id="cb338-133"><a href="#cb338-133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-134"><a href="#cb338-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-135"><a href="#cb338-135" aria-hidden="true" tabindex="-1"></a>Note instantiating manually is not necessary when using <span class="in">`resample()`</span>, as it automatically instantiates the resampling for us, so we pass it a new resampling which has not been instantiated:</span>
<span id="cb338-136"><a href="#cb338-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-137"><a href="#cb338-137" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-007}</span></span>
<span id="cb338-138"><a href="#cb338-138" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"repeated_cv"</span>, <span class="at">repeats =</span> <span class="dv">5</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb338-139"><a href="#cb338-139" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(task, learner, resampling)</span>
<span id="cb338-140"><a href="#cb338-140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-141"><a href="#cb338-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-142"><a href="#cb338-142" aria-hidden="true" tabindex="-1"></a>Now we can <span class="in">`$score()`</span> the resampling with the MSE measure across each of the 5x3 resampling iterations:</span>
<span id="cb338-143"><a href="#cb338-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-144"><a href="#cb338-144" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-008}</span></span>
<span id="cb338-145"><a href="#cb338-145" aria-hidden="true" tabindex="-1"></a>scores <span class="ot">=</span> rr<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"regr.mse"</span>))</span>
<span id="cb338-146"><a href="#cb338-146" aria-hidden="true" tabindex="-1"></a>scores</span>
<span id="cb338-147"><a href="#cb338-147" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-148"><a href="#cb338-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-149"><a href="#cb338-149" aria-hidden="true" tabindex="-1"></a>We can manually calculate these scores since <span class="in">`rr`</span> contains all the individual predictions.</span>
<span id="cb338-150"><a href="#cb338-150" aria-hidden="true" tabindex="-1"></a>The <span class="in">`$predictions()`</span> method returns a list of predictions for each iteration, which we can use to calculate the MSE for the first iteration:</span>
<span id="cb338-151"><a href="#cb338-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-152"><a href="#cb338-152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-009}</span></span>
<span id="cb338-153"><a href="#cb338-153" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">=</span> rr<span class="sc">$</span><span class="fu">predictions</span>()</span>
<span id="cb338-154"><a href="#cb338-154" aria-hidden="true" tabindex="-1"></a>pred_1 <span class="ot">=</span> <span class="fu">as.data.table</span>(preds[[<span class="dv">1</span>]])</span>
<span id="cb338-155"><a href="#cb338-155" aria-hidden="true" tabindex="-1"></a>pred_1[, <span class="fu">list</span>(<span class="at">rmse =</span> <span class="fu">mean</span>((truth <span class="sc">-</span> response)<span class="sc">^</span><span class="dv">2</span>))]</span>
<span id="cb338-156"><a href="#cb338-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-157"><a href="#cb338-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-158"><a href="#cb338-158" aria-hidden="true" tabindex="-1"></a>To visualize the results, we can use <span class="in">`ggplot2`</span> directly on the <span class="in">`scores`</span> object, which behaves like any other <span class="in">`data.table`</span>:</span>
<span id="cb338-159"><a href="#cb338-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-160"><a href="#cb338-160" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-010}</span></span>
<span id="cb338-161"><a href="#cb338-161" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb338-162"><a href="#cb338-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Barchart of the per-iteration scores</span></span>
<span id="cb338-163"><a href="#cb338-163" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(scores, <span class="fu">aes</span>(<span class="at">x =</span> iteration, <span class="at">y =</span> regr.mse)) <span class="sc">+</span></span>
<span id="cb338-164"><a href="#cb338-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb338-165"><a href="#cb338-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb338-166"><a href="#cb338-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-167"><a href="#cb338-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Boxplot of the scores</span></span>
<span id="cb338-168"><a href="#cb338-168" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(scores, <span class="fu">aes</span>(<span class="at">x =</span> regr.mse)) <span class="sc">+</span></span>
<span id="cb338-169"><a href="#cb338-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb338-170"><a href="#cb338-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span>, <span class="at">labels =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb338-171"><a href="#cb338-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb338-172"><a href="#cb338-172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-173"><a href="#cb338-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-174"><a href="#cb338-174" aria-hidden="true" tabindex="-1"></a>Alternatively, the <span class="in">`autoplot()`</span> function provides defaults for the <span class="in">`ResampleResult`</span> object.</span>
<span id="cb338-175"><a href="#cb338-175" aria-hidden="true" tabindex="-1"></a>Note that it internally scores the resampling using the MSE for regression tasks per default.</span>
<span id="cb338-176"><a href="#cb338-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-177"><a href="#cb338-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-011}</span></span>
<span id="cb338-178"><a href="#cb338-178" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rr)</span>
<span id="cb338-179"><a href="#cb338-179" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rr, <span class="at">type =</span> <span class="st">"histogram"</span>)</span>
<span id="cb338-180"><a href="#cb338-180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-181"><a href="#cb338-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-182"><a href="#cb338-182" aria-hidden="true" tabindex="-1"></a>The aggregate score is the mean of the MSE scores across all iterations, which we can calculate using <span class="in">`$aggregate()`</span> or by manually averaging the scores we stored before:</span>
<span id="cb338-183"><a href="#cb338-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-184"><a href="#cb338-184" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-012}</span></span>
<span id="cb338-185"><a href="#cb338-185" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(scores<span class="sc">$</span>regr.mse)</span>
<span id="cb338-186"><a href="#cb338-186" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"regr.mse"</span>))</span>
<span id="cb338-187"><a href="#cb338-187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-188"><a href="#cb338-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-189"><a href="#cb338-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-190"><a href="#cb338-190" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Use <span class="in">`tsk("spam")`</span> and five-fold CV to benchmark <span class="in">`lrn("classif.ranger")`</span>, <span class="in">`lrn("classif.log_reg")`</span>, and <span class="in">`lrn("classif.xgboost", nrounds = 100)`</span> with respect to AUC.</span>
<span id="cb338-191"><a href="#cb338-191" aria-hidden="true" tabindex="-1"></a>Which learner appears to perform best? How confident are you in your conclusion?</span>
<span id="cb338-192"><a href="#cb338-192" aria-hidden="true" tabindex="-1"></a>Think about the stability of results and investigate this by re-rerunning the experiment with different seeds.</span>
<span id="cb338-193"><a href="#cb338-193" aria-hidden="true" tabindex="-1"></a>What can be done to improve this?</span>
<span id="cb338-194"><a href="#cb338-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-195"><a href="#cb338-195" aria-hidden="true" tabindex="-1"></a>First we instantiate our learners with their initial parameters, setting the <span class="in">`predict_type = "prob"`</span> once for all of them using <span class="in">`lrns()`</span>.</span>
<span id="cb338-196"><a href="#cb338-196" aria-hidden="true" tabindex="-1"></a>We then set the <span class="in">`nrounds`</span> parameter for XGBoost to 100 and construct a resampling object for 5-fold CV:</span>
<span id="cb338-197"><a href="#cb338-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-198"><a href="#cb338-198" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-013}</span></span>
<span id="cb338-199"><a href="#cb338-199" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3</span>)</span>
<span id="cb338-200"><a href="#cb338-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-201"><a href="#cb338-201" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"spam"</span>)</span>
<span id="cb338-202"><a href="#cb338-202" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">lrns</span>(<span class="fu">c</span>(<span class="st">"classif.ranger"</span>, <span class="st">"classif.log_reg"</span>, <span class="st">"classif.xgboost"</span>),</span>
<span id="cb338-203"><a href="#cb338-203" aria-hidden="true" tabindex="-1"></a>                <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb338-204"><a href="#cb338-204" aria-hidden="true" tabindex="-1"></a>learners<span class="sc">$</span>classif.xgboost<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>nrounds <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb338-205"><a href="#cb338-205" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span>
<span id="cb338-206"><a href="#cb338-206" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-207"><a href="#cb338-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-208"><a href="#cb338-208" aria-hidden="true" tabindex="-1"></a>We could have alternatively instantiated the learners like this, but would have needed to repeat the <span class="in">`predict_type = "prob"`</span> argument multiple times.</span>
<span id="cb338-209"><a href="#cb338-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-210"><a href="#cb338-210" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-014, eva=FALSE}</span></span>
<span id="cb338-211"><a href="#cb338-211" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb338-212"><a href="#cb338-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>),</span>
<span id="cb338-213"><a href="#cb338-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>),</span>
<span id="cb338-214"><a href="#cb338-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"classif.xgboost"</span>, <span class="at">nrounds =</span> <span class="dv">100</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb338-215"><a href="#cb338-215" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-216"><a href="#cb338-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-217"><a href="#cb338-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-218"><a href="#cb338-218" aria-hidden="true" tabindex="-1"></a>Next we can construct a benchmark design grid with the instantiated objects using <span class="in">`benchmark_grid()`</span>:</span>
<span id="cb338-219"><a href="#cb338-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-220"><a href="#cb338-220" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-015}</span></span>
<span id="cb338-221"><a href="#cb338-221" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb338-222"><a href="#cb338-222" aria-hidden="true" tabindex="-1"></a>  <span class="at">tasks =</span> task,</span>
<span id="cb338-223"><a href="#cb338-223" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> learners,</span>
<span id="cb338-224"><a href="#cb338-224" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> resampling</span>
<span id="cb338-225"><a href="#cb338-225" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-226"><a href="#cb338-226" aria-hidden="true" tabindex="-1"></a>design</span>
<span id="cb338-227"><a href="#cb338-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-228"><a href="#cb338-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-229"><a href="#cb338-229" aria-hidden="true" tabindex="-1"></a>To perform the benchmark, we use the aptly named <span class="in">`benchmark()`</span> function:</span>
<span id="cb338-230"><a href="#cb338-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-231"><a href="#cb338-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-016, warning=FALSE}</span></span>
<span id="cb338-232"><a href="#cb338-232" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb338-233"><a href="#cb338-233" aria-hidden="true" tabindex="-1"></a>bmr</span>
<span id="cb338-234"><a href="#cb338-234" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-235"><a href="#cb338-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-236"><a href="#cb338-236" aria-hidden="true" tabindex="-1"></a>And visualize the results as a boxplot:</span>
<span id="cb338-237"><a href="#cb338-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-238"><a href="#cb338-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-017}</span></span>
<span id="cb338-239"><a href="#cb338-239" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bmr, <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.auc"</span>))</span>
<span id="cb338-240"><a href="#cb338-240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-241"><a href="#cb338-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-242"><a href="#cb338-242" aria-hidden="true" tabindex="-1"></a>In this example,<span class="in">`lrn("classif.xgboost")`</span> outperforms <span class="in">`lrn("classif.ranger")`</span>, and both outperform <span class="in">`lrn("classif.log_reg")`</span>.</span>
<span id="cb338-243"><a href="#cb338-243" aria-hidden="true" tabindex="-1"></a>Naturally this is only a visual inspection of the results --- proper statistical testing of benchmark results can be conducted using the <span class="in">`mlr3benchmark`</span> package, but for the purposes of this exercise a plot suffices.</span>
<span id="cb338-244"><a href="#cb338-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-245"><a href="#cb338-245" aria-hidden="true" tabindex="-1"></a>When we re-run the same experiment with a different seed, we get a slightly different result.</span>
<span id="cb338-246"><a href="#cb338-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-247"><a href="#cb338-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-018, warning=FALSE}</span></span>
<span id="cb338-248"><a href="#cb338-248" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3235</span>)</span>
<span id="cb338-249"><a href="#cb338-249" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span>
<span id="cb338-250"><a href="#cb338-250" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb338-251"><a href="#cb338-251" aria-hidden="true" tabindex="-1"></a>  <span class="at">tasks =</span> task,</span>
<span id="cb338-252"><a href="#cb338-252" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> learners,</span>
<span id="cb338-253"><a href="#cb338-253" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> resampling</span>
<span id="cb338-254"><a href="#cb338-254" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-255"><a href="#cb338-255" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb338-256"><a href="#cb338-256" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bmr, <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.auc"</span>))</span>
<span id="cb338-257"><a href="#cb338-257" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-258"><a href="#cb338-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-259"><a href="#cb338-259" aria-hidden="true" tabindex="-1"></a>The overall trend remains about the same, but do we trust these results?</span>
<span id="cb338-260"><a href="#cb338-260" aria-hidden="true" tabindex="-1"></a>Note that we applied both <span class="in">`lrn("classif.log_reg")`</span> and <span class="in">`lrn("classif.ranger")`</span> with their initial parameters.</span>
<span id="cb338-261"><a href="#cb338-261" aria-hidden="true" tabindex="-1"></a>While <span class="in">`lrn("classif.log_reg")`</span> does not have any hyperparameters to tune, <span class="in">`lrn("classif.ranger")`</span> does have several, at least one of which is usually tuned (<span class="in">`mtry`</span>).</span>
<span id="cb338-262"><a href="#cb338-262" aria-hidden="true" tabindex="-1"></a>In case of <span class="in">`lrn("classif.xgboost")`</span> however, we arbitrarily chose <span class="in">`nrounds = 100`</span> rather than using the learner with its initial value of <span class="in">`nrounds = 1`</span>, which would be equivalent to a single tree decision tree.</span>
<span id="cb338-263"><a href="#cb338-263" aria-hidden="true" tabindex="-1"></a>To make any generalizations based on this experiment, we need to properly tune all relevant hyperparmeters in a systematic way.</span>
<span id="cb338-264"><a href="#cb338-264" aria-hidden="true" tabindex="-1"></a>We cover this and more in @sec-optimization.</span>
<span id="cb338-265"><a href="#cb338-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-266"><a href="#cb338-266" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>A colleague reports a 93.1% classification accuracy using <span class="in">`lrn("classif.rpart")`</span> on <span class="in">`tsk("penguins_simple")`</span>.</span>
<span id="cb338-267"><a href="#cb338-267" aria-hidden="true" tabindex="-1"></a>You want to reproduce their results and ask them about their resampling strategy.</span>
<span id="cb338-268"><a href="#cb338-268" aria-hidden="true" tabindex="-1"></a>They said they used a custom three-fold CV with folds assigned as <span class="in">`factor(task$row_ids %% 3)`</span>.</span>
<span id="cb338-269"><a href="#cb338-269" aria-hidden="true" tabindex="-1"></a>See if you can reproduce their results.</span>
<span id="cb338-270"><a href="#cb338-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-271"><a href="#cb338-271" aria-hidden="true" tabindex="-1"></a>We make use of the <span class="in">`custom_cv`</span> resampling strategy here:</span>
<span id="cb338-272"><a href="#cb338-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-273"><a href="#cb338-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-019}</span></span>
<span id="cb338-274"><a href="#cb338-274" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"penguins_simple"</span>)</span>
<span id="cb338-275"><a href="#cb338-275" aria-hidden="true" tabindex="-1"></a>rsmp_cv <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"custom_cv"</span>)</span>
<span id="cb338-276"><a href="#cb338-276" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-277"><a href="#cb338-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-278"><a href="#cb338-278" aria-hidden="true" tabindex="-1"></a>We apply the rule to assign resampling folds we were provided with: Every third observation is assigned to the same fold:</span>
<span id="cb338-279"><a href="#cb338-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-280"><a href="#cb338-280" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-020}</span></span>
<span id="cb338-281"><a href="#cb338-281" aria-hidden="true" tabindex="-1"></a>rsmp_cv<span class="sc">$</span><span class="fu">instantiate</span>(<span class="at">task =</span> task, <span class="at">f =</span> <span class="fu">factor</span>(task<span class="sc">$</span>row_ids <span class="sc">%%</span> <span class="dv">3</span>))</span>
<span id="cb338-282"><a href="#cb338-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-283"><a href="#cb338-283" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(rsmp_cv<span class="sc">$</span>instance)</span>
<span id="cb338-284"><a href="#cb338-284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-285"><a href="#cb338-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-286"><a href="#cb338-286" aria-hidden="true" tabindex="-1"></a>We are now ready to conduct the resampling and aggregate results:</span>
<span id="cb338-287"><a href="#cb338-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-288"><a href="#cb338-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-021}</span></span>
<span id="cb338-289"><a href="#cb338-289" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(</span>
<span id="cb338-290"><a href="#cb338-290" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb338-291"><a href="#cb338-291" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>),</span>
<span id="cb338-292"><a href="#cb338-292" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> rsmp_cv</span>
<span id="cb338-293"><a href="#cb338-293" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-294"><a href="#cb338-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-295"><a href="#cb338-295" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.acc"</span>))</span>
<span id="cb338-296"><a href="#cb338-296" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-297"><a href="#cb338-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-298"><a href="#cb338-298" aria-hidden="true" tabindex="-1"></a>Converting to percentages and rounding to one decimal place, we get the same result as our colleague!</span>
<span id="cb338-299"><a href="#cb338-299" aria-hidden="true" tabindex="-1"></a>Luckily they kept track of their resampling to ensure their results were reproducible.</span>
<span id="cb338-300"><a href="#cb338-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-301"><a href="#cb338-301" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>(*) Program your own ROC plotting function without using <span class="in">`mlr3`</span>'s <span class="in">`autoplot()`</span> function. The signature of your function should be <span class="in">`my_roc_plot(task, learner, train_indices, test_indices)`</span>.</span>
<span id="cb338-302"><a href="#cb338-302" aria-hidden="true" tabindex="-1"></a>Your function should use the <span class="in">`$set_threshold()`</span> method of  <span class="in">`Prediction`</span>, as well as <span class="in">`mlr3measures`</span>.</span>
<span id="cb338-303"><a href="#cb338-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-304"><a href="#cb338-304" aria-hidden="true" tabindex="-1"></a>Here is a function to calculate the true positive rate (TPR, *Sensitivity*) and false positive rate (FPR, *1 - Specificity*) in a loop across a grid of probabilities.</span>
<span id="cb338-305"><a href="#cb338-305" aria-hidden="true" tabindex="-1"></a>These are set as thresholds with the <span class="in">`$set_threshold()`</span> method of the <span class="in">`PredictionClassif`</span> object.</span>
<span id="cb338-306"><a href="#cb338-306" aria-hidden="true" tabindex="-1"></a>This way we construct the ROC curve by iteratively calculating its x and y values, after which we can use <span class="in">`geom_step()`</span> to draw a step function.</span>
<span id="cb338-307"><a href="#cb338-307" aria-hidden="true" tabindex="-1"></a>Note that we do not need to re-train the learner, we merely adjust the threshold applied to the predictions we made at the top of the function</span>
<span id="cb338-308"><a href="#cb338-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-309"><a href="#cb338-309" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-022}</span></span>
<span id="cb338-310"><a href="#cb338-310" aria-hidden="true" tabindex="-1"></a>my_roc_plot <span class="ot">=</span> <span class="cf">function</span>(task, learner, train_indices, test_indices) {</span>
<span id="cb338-311"><a href="#cb338-311" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Train learner, predict once.</span></span>
<span id="cb338-312"><a href="#cb338-312" aria-hidden="true" tabindex="-1"></a>  learner<span class="sc">$</span><span class="fu">train</span>(task, train_indices)</span>
<span id="cb338-313"><a href="#cb338-313" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task, test_indices)</span>
<span id="cb338-314"><a href="#cb338-314" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Positive class predictions from prediction matrix</span></span>
<span id="cb338-315"><a href="#cb338-315" aria-hidden="true" tabindex="-1"></a>  pos_pred <span class="ot">=</span> pred<span class="sc">$</span>prob[, <span class="fu">which</span>(<span class="fu">colnames</span>(pred<span class="sc">$</span>prob) <span class="sc">==</span> task<span class="sc">$</span>positive)]</span>
<span id="cb338-316"><a href="#cb338-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-317"><a href="#cb338-317" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set a grid of probabilities to evaluate at.</span></span>
<span id="cb338-318"><a href="#cb338-318" aria-hidden="true" tabindex="-1"></a>  prob_grid <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.001</span>)</span>
<span id="cb338-319"><a href="#cb338-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-320"><a href="#cb338-320" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each possible threshold, calculate TPR,</span></span>
<span id="cb338-321"><a href="#cb338-321" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FPR + aggregate to data.table</span></span>
<span id="cb338-322"><a href="#cb338-322" aria-hidden="true" tabindex="-1"></a>  grid <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">rbindlist</span>(<span class="fu">lapply</span>(prob_grid, \(thresh) {</span>
<span id="cb338-323"><a href="#cb338-323" aria-hidden="true" tabindex="-1"></a>    pred<span class="sc">$</span><span class="fu">set_threshold</span>(thresh)</span>
<span id="cb338-324"><a href="#cb338-324" aria-hidden="true" tabindex="-1"></a>    data.table<span class="sc">::</span><span class="fu">data.table</span>(</span>
<span id="cb338-325"><a href="#cb338-325" aria-hidden="true" tabindex="-1"></a>      <span class="at">thresh =</span> thresh,</span>
<span id="cb338-326"><a href="#cb338-326" aria-hidden="true" tabindex="-1"></a>      <span class="co"># y axis == sensitivity == TPR</span></span>
<span id="cb338-327"><a href="#cb338-327" aria-hidden="true" tabindex="-1"></a>      <span class="at">tpr =</span> mlr3measures<span class="sc">::</span><span class="fu">tpr</span>(</span>
<span id="cb338-328"><a href="#cb338-328" aria-hidden="true" tabindex="-1"></a>        <span class="at">truth =</span> pred<span class="sc">$</span>truth, <span class="at">response =</span> pred<span class="sc">$</span>response,</span>
<span id="cb338-329"><a href="#cb338-329" aria-hidden="true" tabindex="-1"></a>        <span class="at">positive =</span> task<span class="sc">$</span>positive),</span>
<span id="cb338-330"><a href="#cb338-330" aria-hidden="true" tabindex="-1"></a>      <span class="co"># x axis == 1 - specificity == 1 - TNR == FPR</span></span>
<span id="cb338-331"><a href="#cb338-331" aria-hidden="true" tabindex="-1"></a>      <span class="at">fpr =</span> mlr3measures<span class="sc">::</span><span class="fu">fpr</span>(</span>
<span id="cb338-332"><a href="#cb338-332" aria-hidden="true" tabindex="-1"></a>        <span class="at">truth =</span> pred<span class="sc">$</span>truth, <span class="at">response =</span> pred<span class="sc">$</span>response,</span>
<span id="cb338-333"><a href="#cb338-333" aria-hidden="true" tabindex="-1"></a>        <span class="at">positive =</span> task<span class="sc">$</span>positive)</span>
<span id="cb338-334"><a href="#cb338-334" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb338-335"><a href="#cb338-335" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb338-336"><a href="#cb338-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-337"><a href="#cb338-337" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Order descending by threshold to use ggplot2::geom_step</span></span>
<span id="cb338-338"><a href="#cb338-338" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setorderv</span>(grid, <span class="at">cols =</span> <span class="st">"thresh"</span>, <span class="at">order =</span> <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb338-339"><a href="#cb338-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-340"><a href="#cb338-340" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(grid, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> fpr, <span class="at">y =</span> tpr)) <span class="sc">+</span></span>
<span id="cb338-341"><a href="#cb338-341" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step function starting with (h)orizontal, then (v)ertical</span></span>
<span id="cb338-342"><a href="#cb338-342" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_step</span>(<span class="at">direction =</span> <span class="st">"hv"</span>) <span class="sc">+</span></span>
<span id="cb338-343"><a href="#cb338-343" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb338-344"><a href="#cb338-344" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb338-345"><a href="#cb338-345" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb338-346"><a href="#cb338-346" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb338-347"><a href="#cb338-347" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"My Custom ROC Curve"</span>,</span>
<span id="cb338-348"><a href="#cb338-348" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">sprintf</span>(<span class="st">"%s on %s"</span>, learner<span class="sc">$</span>id, task<span class="sc">$</span>id),</span>
<span id="cb338-349"><a href="#cb338-349" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"1 - Specificity"</span>, <span class="at">y =</span> <span class="st">"Sensitivity"</span>,</span>
<span id="cb338-350"><a href="#cb338-350" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="fu">sprintf</span>(<span class="st">"n = %i. Test set: %i"</span>, task<span class="sc">$</span>nrow, <span class="fu">length</span>(test_indices))</span>
<span id="cb338-351"><a href="#cb338-351" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb338-352"><a href="#cb338-352" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-353"><a href="#cb338-353" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-354"><a href="#cb338-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-355"><a href="#cb338-355" aria-hidden="true" tabindex="-1"></a>We try our function using <span class="in">`tsk("sonar")`</span> and <span class="in">`lrn("classif.ranger")`</span> learner with 100 trees.</span>
<span id="cb338-356"><a href="#cb338-356" aria-hidden="true" tabindex="-1"></a>We set <span class="in">`predict_type = "prob"`</span> since we need probability predictions to apply thresholds, rather than hard class predictions.</span>
<span id="cb338-357"><a href="#cb338-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-358"><a href="#cb338-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-023}</span></span>
<span id="cb338-359"><a href="#cb338-359" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3</span>)</span>
<span id="cb338-360"><a href="#cb338-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-361"><a href="#cb338-361" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up example task and learner for testing</span></span>
<span id="cb338-362"><a href="#cb338-362" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>)</span>
<span id="cb338-363"><a href="#cb338-363" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>, <span class="at">num.trees =</span> <span class="dv">100</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb338-364"><a href="#cb338-364" aria-hidden="true" tabindex="-1"></a>split <span class="ot">=</span> <span class="fu">partition</span>(task)</span>
<span id="cb338-365"><a href="#cb338-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-366"><a href="#cb338-366" aria-hidden="true" tabindex="-1"></a><span class="fu">my_roc_plot</span>(task, learner, split<span class="sc">$</span>train, split<span class="sc">$</span>test)</span>
<span id="cb338-367"><a href="#cb338-367" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-368"><a href="#cb338-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-369"><a href="#cb338-369" aria-hidden="true" tabindex="-1"></a>We can compare it with the pre-built plot function in <span class="in">`mlr3viz`</span>:</span>
<span id="cb338-370"><a href="#cb338-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-371"><a href="#cb338-371" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-024}</span></span>
<span id="cb338-372"><a href="#cb338-372" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task, split<span class="sc">$</span>train)</span>
<span id="cb338-373"><a href="#cb338-373" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task, split<span class="sc">$</span>test)</span>
<span id="cb338-374"><a href="#cb338-374" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(pred, <span class="at">type =</span> <span class="st">"roc"</span>)</span>
<span id="cb338-375"><a href="#cb338-375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-376"><a href="#cb338-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-377"><a href="#cb338-377" aria-hidden="true" tabindex="-1"></a>Note the slight discrepancy between the two curves.</span>
<span id="cb338-378"><a href="#cb338-378" aria-hidden="true" tabindex="-1"></a>This is caused by some implementation differences used by the <span class="in">`precrec`</span> which is used for this functionality in <span class="in">`mlr3viz`</span>.</span>
<span id="cb338-379"><a href="#cb338-379" aria-hidden="true" tabindex="-1"></a>There are different approaches to drawing ROC curves, and our implementation above is one of the simpler ones!</span>
<span id="cb338-380"><a href="#cb338-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-381"><a href="#cb338-381" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-optimization</span></span>
<span id="cb338-382"><a href="#cb338-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-383"><a href="#cb338-383" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Tune the <span class="in">`mtry`</span>, <span class="in">`sample.fraction`</span>, and <span class="in">`num.trees`</span> hyperparameters of <span class="in">`lrn("regr.ranger")`</span> on <span class="in">`tsk("mtcars")`</span>.</span>
<span id="cb338-384"><a href="#cb338-384" aria-hidden="true" tabindex="-1"></a>  Use a simple random search with 50 evaluations.</span>
<span id="cb338-385"><a href="#cb338-385" aria-hidden="true" tabindex="-1"></a>  Evaluate with a three-fold CV and the root mean squared error.</span>
<span id="cb338-386"><a href="#cb338-386" aria-hidden="true" tabindex="-1"></a>  Visualize the effects that each hyperparameter has on the performance via simple marginal plots, which plot a single hyperparameter versus the cross-validated MSE.</span>
<span id="cb338-387"><a href="#cb338-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-388"><a href="#cb338-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-025}</span></span>
<span id="cb338-389"><a href="#cb338-389" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-390"><a href="#cb338-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-391"><a href="#cb338-391" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>)</span>
<span id="cb338-392"><a href="#cb338-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-393"><a href="#cb338-393" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>,</span>
<span id="cb338-394"><a href="#cb338-394" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">to_tune</span>(<span class="dv">1</span>, <span class="dv">10</span>),</span>
<span id="cb338-395"><a href="#cb338-395" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample.fraction =</span> <span class="fu">to_tune</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb338-396"><a href="#cb338-396" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.trees =</span> <span class="fu">to_tune</span>(<span class="dv">100</span>, <span class="dv">500</span>)</span>
<span id="cb338-397"><a href="#cb338-397" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-398"><a href="#cb338-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-399"><a href="#cb338-399" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> <span class="fu">ti</span>(</span>
<span id="cb338-400"><a href="#cb338-400" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> learner,</span>
<span id="cb338-401"><a href="#cb338-401" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb338-402"><a href="#cb338-402" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>),</span>
<span id="cb338-403"><a href="#cb338-403" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"regr.rmse"</span>),</span>
<span id="cb338-404"><a href="#cb338-404" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">50</span>)</span>
<span id="cb338-405"><a href="#cb338-405" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-406"><a href="#cb338-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-407"><a href="#cb338-407" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">=</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> <span class="dv">10</span>)</span>
<span id="cb338-408"><a href="#cb338-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-409"><a href="#cb338-409" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(instance)</span>
<span id="cb338-410"><a href="#cb338-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-411"><a href="#cb338-411" aria-hidden="true" tabindex="-1"></a><span class="co"># all evaluations</span></span>
<span id="cb338-412"><a href="#cb338-412" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(instance<span class="sc">$</span>archive)</span>
<span id="cb338-413"><a href="#cb338-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-414"><a href="#cb338-414" aria-hidden="true" tabindex="-1"></a><span class="co"># best configuration</span></span>
<span id="cb338-415"><a href="#cb338-415" aria-hidden="true" tabindex="-1"></a>instance<span class="sc">$</span>result</span>
<span id="cb338-416"><a href="#cb338-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-417"><a href="#cb338-417" aria-hidden="true" tabindex="-1"></a><span class="co"># incumbent plot</span></span>
<span id="cb338-418"><a href="#cb338-418" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(instance, <span class="at">type =</span> <span class="st">"incumbent"</span>)</span>
<span id="cb338-419"><a href="#cb338-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-420"><a href="#cb338-420" aria-hidden="true" tabindex="-1"></a><span class="co"># marginal plots</span></span>
<span id="cb338-421"><a href="#cb338-421" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(instance, <span class="at">type =</span> <span class="st">"marginal"</span>, <span class="at">cols_x =</span> <span class="st">"mtry"</span>)</span>
<span id="cb338-422"><a href="#cb338-422" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(instance, <span class="at">type =</span> <span class="st">"marginal"</span>, <span class="at">cols_x =</span> <span class="st">"sample.fraction"</span>)</span>
<span id="cb338-423"><a href="#cb338-423" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(instance, <span class="at">type =</span> <span class="st">"marginal"</span>, <span class="at">cols_x =</span> <span class="st">"num.trees"</span>)</span>
<span id="cb338-424"><a href="#cb338-424" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-425"><a href="#cb338-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-426"><a href="#cb338-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-427"><a href="#cb338-427" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Evaluate the performance of the model created in Exercise 1 with nested resampling.</span>
<span id="cb338-428"><a href="#cb338-428" aria-hidden="true" tabindex="-1"></a>  Use a holdout validation for the inner resampling and a three-fold CV for the outer resampling.</span>
<span id="cb338-429"><a href="#cb338-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-430"><a href="#cb338-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-026}</span></span>
<span id="cb338-431"><a href="#cb338-431" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-432"><a href="#cb338-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-433"><a href="#cb338-433" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>)</span>
<span id="cb338-434"><a href="#cb338-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-435"><a href="#cb338-435" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>,</span>
<span id="cb338-436"><a href="#cb338-436" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">to_tune</span>(<span class="dv">1</span>, <span class="dv">10</span>),</span>
<span id="cb338-437"><a href="#cb338-437" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample.fraction =</span> <span class="fu">to_tune</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb338-438"><a href="#cb338-438" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.trees =</span> <span class="fu">to_tune</span>(<span class="dv">100</span>, <span class="dv">500</span>)</span>
<span id="cb338-439"><a href="#cb338-439" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-440"><a href="#cb338-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-441"><a href="#cb338-441" aria-hidden="true" tabindex="-1"></a>at <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb338-442"><a href="#cb338-442" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> <span class="dv">50</span>),</span>
<span id="cb338-443"><a href="#cb338-443" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> learner,</span>
<span id="cb338-444"><a href="#cb338-444" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>),</span>
<span id="cb338-445"><a href="#cb338-445" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"regr.rmse"</span>),</span>
<span id="cb338-446"><a href="#cb338-446" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">50</span>)</span>
<span id="cb338-447"><a href="#cb338-447" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-448"><a href="#cb338-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-449"><a href="#cb338-449" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(task, at, <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>))</span>
<span id="cb338-450"><a href="#cb338-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-451"><a href="#cb338-451" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"regr.rmse"</span>))</span>
<span id="cb338-452"><a href="#cb338-452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-453"><a href="#cb338-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-454"><a href="#cb338-454" aria-hidden="true" tabindex="-1"></a>The <span class="in">`"rmse"`</span> is slightly higher than the one we obtained in Exercise 1.</span>
<span id="cb338-455"><a href="#cb338-455" aria-hidden="true" tabindex="-1"></a>We see that the performance estimated while tuning overestimates the true performance</span>
<span id="cb338-456"><a href="#cb338-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-457"><a href="#cb338-457" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Tune and benchmark an XGBoost model against a logistic regression (without tuning the latter) and determine which has the best Brier score.</span>
<span id="cb338-458"><a href="#cb338-458" aria-hidden="true" tabindex="-1"></a>  Use <span class="in">`mlr3tuningspaces`</span> and nested resampling, try to pick appropriate inner and outer resampling strategies that balance computational efficiency vs. stability of the results.</span>
<span id="cb338-459"><a href="#cb338-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-460"><a href="#cb338-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-027}</span></span>
<span id="cb338-461"><a href="#cb338-461" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb338-462"><a href="#cb338-462" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-463"><a href="#cb338-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-464"><a href="#cb338-464" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>)</span>
<span id="cb338-465"><a href="#cb338-465" aria-hidden="true" tabindex="-1"></a>lrn_log_reg <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb338-466"><a href="#cb338-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-467"><a href="#cb338-467" aria-hidden="true" tabindex="-1"></a><span class="co"># load xgboost learner with search space</span></span>
<span id="cb338-468"><a href="#cb338-468" aria-hidden="true" tabindex="-1"></a>lrn_xgboost <span class="ot">=</span> <span class="fu">lts</span>(<span class="fu">lrn</span>(<span class="st">"classif.xgboost"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>, <span class="at">booster =</span> <span class="st">"gbtree"</span>))</span>
<span id="cb338-469"><a href="#cb338-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-470"><a href="#cb338-470" aria-hidden="true" tabindex="-1"></a><span class="co"># search space for xgboost</span></span>
<span id="cb338-471"><a href="#cb338-471" aria-hidden="true" tabindex="-1"></a>lrn_xgboost<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">search_space</span>()</span>
<span id="cb338-472"><a href="#cb338-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-473"><a href="#cb338-473" aria-hidden="true" tabindex="-1"></a>at_xgboost <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb338-474"><a href="#cb338-474" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> <span class="dv">50</span>),</span>
<span id="cb338-475"><a href="#cb338-475" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> lrn_xgboost,</span>
<span id="cb338-476"><a href="#cb338-476" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>),</span>
<span id="cb338-477"><a href="#cb338-477" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.bbrier"</span>),</span>
<span id="cb338-478"><a href="#cb338-478" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">50</span>)</span>
<span id="cb338-479"><a href="#cb338-479" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-480"><a href="#cb338-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-481"><a href="#cb338-481" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb338-482"><a href="#cb338-482" aria-hidden="true" tabindex="-1"></a>  <span class="at">tasks =</span> task,</span>
<span id="cb338-483"><a href="#cb338-483" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> <span class="fu">list</span>(lrn_log_reg, at_xgboost),</span>
<span id="cb338-484"><a href="#cb338-484" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span>
<span id="cb338-485"><a href="#cb338-485" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-486"><a href="#cb338-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-487"><a href="#cb338-487" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb338-488"><a href="#cb338-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-489"><a href="#cb338-489" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.bbrier"</span>))</span>
<span id="cb338-490"><a href="#cb338-490" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-491"><a href="#cb338-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-492"><a href="#cb338-492" aria-hidden="true" tabindex="-1"></a>We use the <span class="in">`r ref("lts()")`</span> function from the <span class="in">`r mlr3tuningspaces`</span> package to load the <span class="in">`lrn("classif.xgboost")`</span> with a search space.</span>
<span id="cb338-493"><a href="#cb338-493" aria-hidden="true" tabindex="-1"></a>The learner is wrapped in an <span class="in">`r ref("auto_tuner()")`</span>, which is then benchmarked against the <span class="in">`lrn("classif.log_reg")`</span>.</span>
<span id="cb338-494"><a href="#cb338-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-495"><a href="#cb338-495" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>(*) Write a function that implements an iterated random search procedure that drills down on the optimal configuration by applying random search to iteratively smaller search spaces.</span>
<span id="cb338-496"><a href="#cb338-496" aria-hidden="true" tabindex="-1"></a>  Your function should have seven inputs: <span class="in">`task`</span>, <span class="in">`learner`</span>, <span class="in">`search_space`</span>, <span class="in">`resampling`</span>, <span class="in">`measure`</span>, <span class="in">`random_search_stages`</span>, and <span class="in">`random_search_size`</span>.</span>
<span id="cb338-497"><a href="#cb338-497" aria-hidden="true" tabindex="-1"></a>  You should only worry about programming this for fully numeric and bounded search spaces that have no dependencies.</span>
<span id="cb338-498"><a href="#cb338-498" aria-hidden="true" tabindex="-1"></a>  In pseudo-code:</span>
<span id="cb338-499"><a href="#cb338-499" aria-hidden="true" tabindex="-1"></a>    (1) Create a random design of size <span class="in">`random_search_size`</span> from the given search space and evaluate the learner on it.</span>
<span id="cb338-500"><a href="#cb338-500" aria-hidden="true" tabindex="-1"></a>    (2) Identify the best configuration.</span>
<span id="cb338-501"><a href="#cb338-501" aria-hidden="true" tabindex="-1"></a>    (3) Create a smaller search space around this best config, where you define the new range for each parameter as: <span class="in">`new_range[i] = (best_conf[i] - 0.25 * current_range[i], best_conf[i] + 0.25*current_range[i])`</span>.</span>
<span id="cb338-502"><a href="#cb338-502" aria-hidden="true" tabindex="-1"></a>      Ensure that this <span class="in">`new_range`</span> respects the initial bound of the original <span class="in">`search_space`</span> by taking the <span class="in">`max()`</span> of the new and old lower bound, and the <span class="in">`min()`</span> of the new and the old upper bound ("clipping").</span>
<span id="cb338-503"><a href="#cb338-503" aria-hidden="true" tabindex="-1"></a>    (4) Iterate the previous steps <span class="in">`random_search_stages`</span> times and at the end return the best configuration you have ever evaluated.</span>
<span id="cb338-504"><a href="#cb338-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-505"><a href="#cb338-505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-028}</span></span>
<span id="cb338-506"><a href="#cb338-506" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3misc)</span>
<span id="cb338-507"><a href="#cb338-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-508"><a href="#cb338-508" aria-hidden="true" tabindex="-1"></a>focus_search <span class="ot">=</span> <span class="cf">function</span>(task, learner, search_space, resampling, measure, random_search_stages, random_search_size) {</span>
<span id="cb338-509"><a href="#cb338-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-510"><a href="#cb338-510" aria-hidden="true" tabindex="-1"></a>  <span class="cf">repeat</span> {</span>
<span id="cb338-511"><a href="#cb338-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-512"><a href="#cb338-512" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tune learner on random design</span></span>
<span id="cb338-513"><a href="#cb338-513" aria-hidden="true" tabindex="-1"></a>    instance <span class="ot">=</span> <span class="fu">tune</span>(</span>
<span id="cb338-514"><a href="#cb338-514" aria-hidden="true" tabindex="-1"></a>      <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> random_search_size),</span>
<span id="cb338-515"><a href="#cb338-515" aria-hidden="true" tabindex="-1"></a>      <span class="at">learner =</span> learner,</span>
<span id="cb338-516"><a href="#cb338-516" aria-hidden="true" tabindex="-1"></a>      <span class="at">task =</span> task,</span>
<span id="cb338-517"><a href="#cb338-517" aria-hidden="true" tabindex="-1"></a>      <span class="at">resampling =</span> resampling,</span>
<span id="cb338-518"><a href="#cb338-518" aria-hidden="true" tabindex="-1"></a>      <span class="at">measure =</span> measure,</span>
<span id="cb338-519"><a href="#cb338-519" aria-hidden="true" tabindex="-1"></a>      <span class="at">search_space =</span> search_space,</span>
<span id="cb338-520"><a href="#cb338-520" aria-hidden="true" tabindex="-1"></a>      <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> random_search_size),</span>
<span id="cb338-521"><a href="#cb338-521" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb338-522"><a href="#cb338-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-523"><a href="#cb338-523" aria-hidden="true" tabindex="-1"></a>    <span class="co"># identify the best configuration</span></span>
<span id="cb338-524"><a href="#cb338-524" aria-hidden="true" tabindex="-1"></a>    best_config <span class="ot">=</span> instance<span class="sc">$</span>result_x_search_space</span>
<span id="cb338-525"><a href="#cb338-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-526"><a href="#cb338-526" aria-hidden="true" tabindex="-1"></a>    <span class="co"># narrow search space</span></span>
<span id="cb338-527"><a href="#cb338-527" aria-hidden="true" tabindex="-1"></a>    params <span class="ot">=</span> <span class="fu">map</span>(search_space<span class="sc">$</span><span class="fu">subspaces</span>(), <span class="cf">function</span>(subspace) {</span>
<span id="cb338-528"><a href="#cb338-528" aria-hidden="true" tabindex="-1"></a>      best <span class="ot">=</span> best_config[[subspace<span class="sc">$</span><span class="fu">ids</span>()]]</span>
<span id="cb338-529"><a href="#cb338-529" aria-hidden="true" tabindex="-1"></a>      lower <span class="ot">=</span> subspace<span class="sc">$</span>lower</span>
<span id="cb338-530"><a href="#cb338-530" aria-hidden="true" tabindex="-1"></a>      upper <span class="ot">=</span> subspace<span class="sc">$</span>upper</span>
<span id="cb338-531"><a href="#cb338-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-532"><a href="#cb338-532" aria-hidden="true" tabindex="-1"></a>      new_lower <span class="ot">=</span> best <span class="sc">-</span> <span class="fl">0.25</span> <span class="sc">*</span> lower</span>
<span id="cb338-533"><a href="#cb338-533" aria-hidden="true" tabindex="-1"></a>      new_upper <span class="ot">=</span> best <span class="sc">+</span> <span class="fl">0.25</span> <span class="sc">*</span> upper</span>
<span id="cb338-534"><a href="#cb338-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-535"><a href="#cb338-535" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="st">"ParamInt"</span> <span class="sc">%in%</span> subspace<span class="sc">$</span>class) {</span>
<span id="cb338-536"><a href="#cb338-536" aria-hidden="true" tabindex="-1"></a>        new_lower <span class="ot">=</span> <span class="fu">round</span>(new_lower)</span>
<span id="cb338-537"><a href="#cb338-537" aria-hidden="true" tabindex="-1"></a>        new_upper <span class="ot">=</span> <span class="fu">round</span>(new_upper)</span>
<span id="cb338-538"><a href="#cb338-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-539"><a href="#cb338-539" aria-hidden="true" tabindex="-1"></a>        <span class="fu">p_int</span>(<span class="fu">max</span>(new_lower, lower), <span class="fu">min</span>(new_upper, upper), <span class="at">tags =</span> subspace<span class="sc">$</span>tags[[<span class="dv">1</span>]])</span>
<span id="cb338-540"><a href="#cb338-540" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb338-541"><a href="#cb338-541" aria-hidden="true" tabindex="-1"></a>        <span class="fu">p_dbl</span>(<span class="fu">max</span>(new_lower, lower), <span class="fu">min</span>(new_upper, upper), <span class="at">tags =</span> subspace<span class="sc">$</span>tags[[<span class="dv">1</span>]])</span>
<span id="cb338-542"><a href="#cb338-542" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb338-543"><a href="#cb338-543" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb338-544"><a href="#cb338-544" aria-hidden="true" tabindex="-1"></a>    search_space <span class="ot">=</span> <span class="fu">invoke</span>(ps, <span class="at">.args =</span> params)</span>
<span id="cb338-545"><a href="#cb338-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-546"><a href="#cb338-546" aria-hidden="true" tabindex="-1"></a>    random_search_stages <span class="ot">=</span> random_search_stages <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb338-547"><a href="#cb338-547" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>random_search_stages) <span class="fu">return</span>(best_config)</span>
<span id="cb338-548"><a href="#cb338-548" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb338-549"><a href="#cb338-549" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-550"><a href="#cb338-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-551"><a href="#cb338-551" aria-hidden="true" tabindex="-1"></a><span class="fu">focus_search</span>(</span>
<span id="cb338-552"><a href="#cb338-552" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>),</span>
<span id="cb338-553"><a href="#cb338-553" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"regr.xgboost"</span>),</span>
<span id="cb338-554"><a href="#cb338-554" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> <span class="fu">ps</span>(</span>
<span id="cb338-555"><a href="#cb338-555" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fl">0.01</span>, <span class="at">upper =</span> <span class="fl">0.5</span>),</span>
<span id="cb338-556"><a href="#cb338-556" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">upper =</span> <span class="dv">10</span>),</span>
<span id="cb338-557"><a href="#cb338-557" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrounds =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">10</span>, <span class="at">upper =</span> <span class="dv">100</span>)</span>
<span id="cb338-558"><a href="#cb338-558" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb338-559"><a href="#cb338-559" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>),</span>
<span id="cb338-560"><a href="#cb338-560" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"regr.rmse"</span>),</span>
<span id="cb338-561"><a href="#cb338-561" aria-hidden="true" tabindex="-1"></a>  <span class="at">random_search_stages =</span> <span class="dv">2</span>,</span>
<span id="cb338-562"><a href="#cb338-562" aria-hidden="true" tabindex="-1"></a>  <span class="at">random_search_size =</span> <span class="dv">50</span></span>
<span id="cb338-563"><a href="#cb338-563" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-564"><a href="#cb338-564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-565"><a href="#cb338-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-566"><a href="#cb338-566" aria-hidden="true" tabindex="-1"></a>As a stretch goal, look into <span class="in">`mlr3tuning`</span>'s internal source code and turn your function into an R6 class inheriting from the <span class="in">`TunerBatch`</span> class -- test it out on a learner of your choice.</span>
<span id="cb338-567"><a href="#cb338-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-568"><a href="#cb338-568" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-029}</span></span>
<span id="cb338-569"><a href="#cb338-569" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(R6)</span>
<span id="cb338-570"><a href="#cb338-570" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3tuning)</span>
<span id="cb338-571"><a href="#cb338-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-572"><a href="#cb338-572" aria-hidden="true" tabindex="-1"></a>TunerBatchFocusSearch <span class="ot">=</span> <span class="fu">R6Class</span>(<span class="st">"TunerFocusSearch"</span>,</span>
<span id="cb338-573"><a href="#cb338-573" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> TunerBatch,</span>
<span id="cb338-574"><a href="#cb338-574" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb338-575"><a href="#cb338-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-576"><a href="#cb338-576" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb338-577"><a href="#cb338-577" aria-hidden="true" tabindex="-1"></a>      param_set <span class="ot">=</span> <span class="fu">ps</span>(</span>
<span id="cb338-578"><a href="#cb338-578" aria-hidden="true" tabindex="-1"></a>        <span class="at">random_search_stages =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>L, <span class="at">tags =</span> <span class="st">"required"</span>),</span>
<span id="cb338-579"><a href="#cb338-579" aria-hidden="true" tabindex="-1"></a>        <span class="at">random_search_size =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>L, <span class="at">tags =</span> <span class="st">"required"</span>)</span>
<span id="cb338-580"><a href="#cb338-580" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb338-581"><a href="#cb338-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-582"><a href="#cb338-582" aria-hidden="true" tabindex="-1"></a>      param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="at">random_search_stages =</span> <span class="dv">10</span>L, <span class="at">random_search_size =</span> <span class="dv">50</span>L)</span>
<span id="cb338-583"><a href="#cb338-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-584"><a href="#cb338-584" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(</span>
<span id="cb338-585"><a href="#cb338-585" aria-hidden="true" tabindex="-1"></a>        <span class="at">id =</span> <span class="st">"focus_search"</span>,</span>
<span id="cb338-586"><a href="#cb338-586" aria-hidden="true" tabindex="-1"></a>        <span class="at">param_set =</span> param_set,</span>
<span id="cb338-587"><a href="#cb338-587" aria-hidden="true" tabindex="-1"></a>        <span class="at">param_classes =</span> <span class="fu">c</span>(<span class="st">"ParamLgl"</span>, <span class="st">"ParamInt"</span>, <span class="st">"ParamDbl"</span>, <span class="st">"ParamFct"</span>),</span>
<span id="cb338-588"><a href="#cb338-588" aria-hidden="true" tabindex="-1"></a>        <span class="at">properties =</span> <span class="fu">c</span>(<span class="st">"dependencies"</span>, <span class="st">"single-crit"</span>, <span class="st">"multi-crit"</span>),</span>
<span id="cb338-589"><a href="#cb338-589" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="st">"Focus Search"</span>,</span>
<span id="cb338-590"><a href="#cb338-590" aria-hidden="true" tabindex="-1"></a>        <span class="at">man =</span> <span class="st">"mlr3tuning::mlr_tuners_focus_search"</span></span>
<span id="cb338-591"><a href="#cb338-591" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb338-592"><a href="#cb338-592" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb338-593"><a href="#cb338-593" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb338-594"><a href="#cb338-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-595"><a href="#cb338-595" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb338-596"><a href="#cb338-596" aria-hidden="true" tabindex="-1"></a>    <span class="at">.optimize =</span> <span class="cf">function</span>(inst) {</span>
<span id="cb338-597"><a href="#cb338-597" aria-hidden="true" tabindex="-1"></a>      pv <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span>values</span>
<span id="cb338-598"><a href="#cb338-598" aria-hidden="true" tabindex="-1"></a>      search_space <span class="ot">=</span> inst<span class="sc">$</span>search_space</span>
<span id="cb338-599"><a href="#cb338-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-600"><a href="#cb338-600" aria-hidden="true" tabindex="-1"></a>       <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(pv<span class="sc">$</span>random_search_stages)) {</span>
<span id="cb338-601"><a href="#cb338-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-602"><a href="#cb338-602" aria-hidden="true" tabindex="-1"></a>        <span class="co"># evaluate random design</span></span>
<span id="cb338-603"><a href="#cb338-603" aria-hidden="true" tabindex="-1"></a>        xdt <span class="ot">=</span> <span class="fu">generate_design_random</span>(search_space, pv<span class="sc">$</span>random_search_size)<span class="sc">$</span>data</span>
<span id="cb338-604"><a href="#cb338-604" aria-hidden="true" tabindex="-1"></a>        inst<span class="sc">$</span><span class="fu">eval_batch</span>(xdt)</span>
<span id="cb338-605"><a href="#cb338-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-606"><a href="#cb338-606" aria-hidden="true" tabindex="-1"></a>        <span class="co"># identify the best configuration</span></span>
<span id="cb338-607"><a href="#cb338-607" aria-hidden="true" tabindex="-1"></a>        best_config <span class="ot">=</span> inst<span class="sc">$</span>archive<span class="sc">$</span><span class="fu">best</span>(<span class="at">batch =</span> i)</span>
<span id="cb338-608"><a href="#cb338-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-609"><a href="#cb338-609" aria-hidden="true" tabindex="-1"></a>        <span class="co"># narrow search space</span></span>
<span id="cb338-610"><a href="#cb338-610" aria-hidden="true" tabindex="-1"></a>        params <span class="ot">=</span> <span class="fu">map</span>(search_space<span class="sc">$</span><span class="fu">subspaces</span>(), <span class="cf">function</span>(subspace) {</span>
<span id="cb338-611"><a href="#cb338-611" aria-hidden="true" tabindex="-1"></a>          best <span class="ot">=</span> best_config[[subspace<span class="sc">$</span><span class="fu">ids</span>()]]</span>
<span id="cb338-612"><a href="#cb338-612" aria-hidden="true" tabindex="-1"></a>          lower <span class="ot">=</span> subspace<span class="sc">$</span>lower</span>
<span id="cb338-613"><a href="#cb338-613" aria-hidden="true" tabindex="-1"></a>          upper <span class="ot">=</span> subspace<span class="sc">$</span>upper</span>
<span id="cb338-614"><a href="#cb338-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-615"><a href="#cb338-615" aria-hidden="true" tabindex="-1"></a>          new_lower <span class="ot">=</span> best <span class="sc">-</span> <span class="fl">0.25</span> <span class="sc">*</span> lower</span>
<span id="cb338-616"><a href="#cb338-616" aria-hidden="true" tabindex="-1"></a>          new_upper <span class="ot">=</span> best <span class="sc">+</span> <span class="fl">0.25</span> <span class="sc">*</span> upper</span>
<span id="cb338-617"><a href="#cb338-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-618"><a href="#cb338-618" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="st">"ParamInt"</span> <span class="sc">%in%</span> subspace<span class="sc">$</span>class) {</span>
<span id="cb338-619"><a href="#cb338-619" aria-hidden="true" tabindex="-1"></a>            new_lower <span class="ot">=</span> <span class="fu">round</span>(new_lower)</span>
<span id="cb338-620"><a href="#cb338-620" aria-hidden="true" tabindex="-1"></a>            new_upper <span class="ot">=</span> <span class="fu">round</span>(new_upper)</span>
<span id="cb338-621"><a href="#cb338-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-622"><a href="#cb338-622" aria-hidden="true" tabindex="-1"></a>            <span class="fu">p_int</span>(<span class="fu">max</span>(new_lower, lower), <span class="fu">min</span>(new_upper, upper), <span class="at">tags =</span> subspace<span class="sc">$</span>tags[[<span class="dv">1</span>]])</span>
<span id="cb338-623"><a href="#cb338-623" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb338-624"><a href="#cb338-624" aria-hidden="true" tabindex="-1"></a>            <span class="fu">p_dbl</span>(<span class="fu">max</span>(new_lower, lower), <span class="fu">min</span>(new_upper, upper), <span class="at">tags =</span> subspace<span class="sc">$</span>tags[[<span class="dv">1</span>]])</span>
<span id="cb338-625"><a href="#cb338-625" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb338-626"><a href="#cb338-626" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb338-627"><a href="#cb338-627" aria-hidden="true" tabindex="-1"></a>        search_space <span class="ot">=</span> <span class="fu">invoke</span>(ps, <span class="at">.args =</span> params)</span>
<span id="cb338-628"><a href="#cb338-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-629"><a href="#cb338-629" aria-hidden="true" tabindex="-1"></a>        xdt <span class="ot">=</span> <span class="fu">generate_design_random</span>(search_space, pv<span class="sc">$</span>random_search_size)<span class="sc">$</span>data</span>
<span id="cb338-630"><a href="#cb338-630" aria-hidden="true" tabindex="-1"></a>        inst<span class="sc">$</span><span class="fu">eval_batch</span>(xdt)</span>
<span id="cb338-631"><a href="#cb338-631" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb338-632"><a href="#cb338-632" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb338-633"><a href="#cb338-633" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb338-634"><a href="#cb338-634" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-635"><a href="#cb338-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-636"><a href="#cb338-636" aria-hidden="true" tabindex="-1"></a>mlr_tuners<span class="sc">$</span><span class="fu">add</span>(<span class="st">"focus_search"</span>, TunerBatchFocusSearch)</span>
<span id="cb338-637"><a href="#cb338-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-638"><a href="#cb338-638" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> <span class="fu">ti</span>(</span>
<span id="cb338-639"><a href="#cb338-639" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>),</span>
<span id="cb338-640"><a href="#cb338-640" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"regr.xgboost"</span>),</span>
<span id="cb338-641"><a href="#cb338-641" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> <span class="fu">ps</span>(</span>
<span id="cb338-642"><a href="#cb338-642" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fl">0.01</span>, <span class="at">upper =</span> <span class="fl">0.5</span>),</span>
<span id="cb338-643"><a href="#cb338-643" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">upper =</span> <span class="dv">10</span>),</span>
<span id="cb338-644"><a href="#cb338-644" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrounds =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">10</span>, <span class="at">upper =</span> <span class="dv">100</span>)</span>
<span id="cb338-645"><a href="#cb338-645" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb338-646"><a href="#cb338-646" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>),</span>
<span id="cb338-647"><a href="#cb338-647" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"regr.rmse"</span>),</span>
<span id="cb338-648"><a href="#cb338-648" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"none"</span>)</span>
<span id="cb338-649"><a href="#cb338-649" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-650"><a href="#cb338-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-651"><a href="#cb338-651" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">=</span> <span class="fu">tnr</span>(<span class="st">"focus_search"</span>, <span class="at">random_search_stages =</span> <span class="dv">2</span>, <span class="at">random_search_size =</span> <span class="dv">50</span>)</span>
<span id="cb338-652"><a href="#cb338-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-653"><a href="#cb338-653" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(instance)</span>
<span id="cb338-654"><a href="#cb338-654" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-655"><a href="#cb338-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-656"><a href="#cb338-656" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-optimization-advanced</span></span>
<span id="cb338-657"><a href="#cb338-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-658"><a href="#cb338-658" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Tune the <span class="in">`mtry`</span>, <span class="in">`sample.fraction`</span>, and <span class="in">`num.trees`</span> hyperparameters of <span class="in">`lrn("regr.ranger")`</span> on <span class="in">`tsk("mtcars")`</span> and evaluate this with a three-fold CV and the root mean squared error (same as @sec-optimization, Exercise 1).</span>
<span id="cb338-659"><a href="#cb338-659" aria-hidden="true" tabindex="-1"></a>Use <span class="in">`tnr("mbo")`</span> with 50 evaluations.</span>
<span id="cb338-660"><a href="#cb338-660" aria-hidden="true" tabindex="-1"></a>Compare this with the performance progress of a random search run from @sec-optimization, Exercise 1.</span>
<span id="cb338-661"><a href="#cb338-661" aria-hidden="true" tabindex="-1"></a>Plot the progress of performance over iterations and visualize the spatial distribution of the evaluated hyperparameter configurations for both algorithms.</span>
<span id="cb338-662"><a href="#cb338-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-663"><a href="#cb338-663" aria-hidden="true" tabindex="-1"></a>We first construct the learner, task, resampling, measure and terminator and then the instance.</span>
<span id="cb338-664"><a href="#cb338-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-665"><a href="#cb338-665" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-030}</span></span>
<span id="cb338-666"><a href="#cb338-666" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3mbo)</span>
<span id="cb338-667"><a href="#cb338-667" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbotk)</span>
<span id="cb338-668"><a href="#cb338-668" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb338-669"><a href="#cb338-669" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb338-670"><a href="#cb338-670" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridisLite)</span>
<span id="cb338-671"><a href="#cb338-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-672"><a href="#cb338-672" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5</span>)</span>
<span id="cb338-673"><a href="#cb338-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-674"><a href="#cb338-674" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>,</span>
<span id="cb338-675"><a href="#cb338-675" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">to_tune</span>(<span class="dv">1</span>, <span class="dv">10</span>),</span>
<span id="cb338-676"><a href="#cb338-676" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample.fraction =</span> <span class="fu">to_tune</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb338-677"><a href="#cb338-677" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.trees =</span> <span class="fu">to_tune</span>(<span class="dv">100</span>, <span class="dv">500</span>)</span>
<span id="cb338-678"><a href="#cb338-678" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-679"><a href="#cb338-679" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>)</span>
<span id="cb338-680"><a href="#cb338-680" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb338-681"><a href="#cb338-681" aria-hidden="true" tabindex="-1"></a>measure <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"regr.rmse"</span>)</span>
<span id="cb338-682"><a href="#cb338-682" aria-hidden="true" tabindex="-1"></a>terminator <span class="ot">=</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">50</span>)</span>
<span id="cb338-683"><a href="#cb338-683" aria-hidden="true" tabindex="-1"></a>instance_rs <span class="ot">=</span> <span class="fu">ti</span>(</span>
<span id="cb338-684"><a href="#cb338-684" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> learner,</span>
<span id="cb338-685"><a href="#cb338-685" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb338-686"><a href="#cb338-686" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> resampling,</span>
<span id="cb338-687"><a href="#cb338-687" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> measure,</span>
<span id="cb338-688"><a href="#cb338-688" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> terminator</span>
<span id="cb338-689"><a href="#cb338-689" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-690"><a href="#cb338-690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-691"><a href="#cb338-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-692"><a href="#cb338-692" aria-hidden="true" tabindex="-1"></a>Using a random search results in the following final performance:</span>
<span id="cb338-693"><a href="#cb338-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-694"><a href="#cb338-694" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-031, warning = FALSE}</span></span>
<span id="cb338-695"><a href="#cb338-695" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">=</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> <span class="dv">50</span>)</span>
<span id="cb338-696"><a href="#cb338-696" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(instance_rs)</span>
<span id="cb338-697"><a href="#cb338-697" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-698"><a href="#cb338-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-699"><a href="#cb338-699" aria-hidden="true" tabindex="-1"></a>We then construct a new instance and optimize it via Bayesian Optimization (BO) using <span class="in">`tnr("mbo")`</span> in its default configuration (see also <span class="in">`r ref("mbo_defaults")`</span>):</span>
<span id="cb338-700"><a href="#cb338-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-701"><a href="#cb338-701" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-032, warning = FALSE}</span></span>
<span id="cb338-702"><a href="#cb338-702" aria-hidden="true" tabindex="-1"></a>instance_bo <span class="ot">=</span> <span class="fu">ti</span>(</span>
<span id="cb338-703"><a href="#cb338-703" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> learner,</span>
<span id="cb338-704"><a href="#cb338-704" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb338-705"><a href="#cb338-705" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> resampling,</span>
<span id="cb338-706"><a href="#cb338-706" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> measure,</span>
<span id="cb338-707"><a href="#cb338-707" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> terminator</span>
<span id="cb338-708"><a href="#cb338-708" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-709"><a href="#cb338-709" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">=</span> <span class="fu">tnr</span>(<span class="st">"mbo"</span>)</span>
<span id="cb338-710"><a href="#cb338-710" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(instance_bo)</span>
<span id="cb338-711"><a href="#cb338-711" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-712"><a href="#cb338-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-713"><a href="#cb338-713" aria-hidden="true" tabindex="-1"></a>We then add relevant information to the archives of the instances so that we can combine their data and use this data for generating the desired plots.</span>
<span id="cb338-714"><a href="#cb338-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-715"><a href="#cb338-715" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-033}</span></span>
<span id="cb338-716"><a href="#cb338-716" aria-hidden="true" tabindex="-1"></a>instance_rs<span class="sc">$</span>archive<span class="sc">$</span>data[, iteration <span class="sc">:</span><span class="er">=</span> <span class="fu">seq_len</span>(.N)]</span>
<span id="cb338-717"><a href="#cb338-717" aria-hidden="true" tabindex="-1"></a>instance_rs<span class="sc">$</span>archive<span class="sc">$</span>data[, best_rmse <span class="sc">:</span><span class="er">=</span> <span class="fu">cummin</span>(regr.rmse)]</span>
<span id="cb338-718"><a href="#cb338-718" aria-hidden="true" tabindex="-1"></a>instance_rs<span class="sc">$</span>archive<span class="sc">$</span>data[, method <span class="sc">:</span><span class="er">=</span> <span class="st">"Random Search"</span>]</span>
<span id="cb338-719"><a href="#cb338-719" aria-hidden="true" tabindex="-1"></a>instance_bo<span class="sc">$</span>archive<span class="sc">$</span>data[, iteration <span class="sc">:</span><span class="er">=</span> <span class="fu">seq_len</span>(.N)]</span>
<span id="cb338-720"><a href="#cb338-720" aria-hidden="true" tabindex="-1"></a>instance_bo<span class="sc">$</span>archive<span class="sc">$</span>data[, best_rmse <span class="sc">:</span><span class="er">=</span> <span class="fu">cummin</span>(regr.rmse)]</span>
<span id="cb338-721"><a href="#cb338-721" aria-hidden="true" tabindex="-1"></a>instance_bo<span class="sc">$</span>archive<span class="sc">$</span>data[, method <span class="sc">:</span><span class="er">=</span> <span class="st">"BO"</span>]</span>
<span id="cb338-722"><a href="#cb338-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-723"><a href="#cb338-723" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">=</span> <span class="fu">rbind</span>(instance_rs<span class="sc">$</span>archive<span class="sc">$</span>data[, <span class="fu">c</span>(<span class="st">"iteration"</span>, <span class="st">"best_rmse"</span>, <span class="st">"method"</span>)],</span>
<span id="cb338-724"><a href="#cb338-724" aria-hidden="true" tabindex="-1"></a>  instance_bo<span class="sc">$</span>archive<span class="sc">$</span>data[, <span class="fu">c</span>(<span class="st">"iteration"</span>, <span class="st">"best_rmse"</span>, <span class="st">"method"</span>)])</span>
<span id="cb338-725"><a href="#cb338-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-726"><a href="#cb338-726" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> iteration, <span class="at">y =</span> best_rmse, <span class="at">colour =</span> method), <span class="at">data =</span> plot_data) <span class="sc">+</span></span>
<span id="cb338-727"><a href="#cb338-727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb338-728"><a href="#cb338-728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">viridis</span>(<span class="dv">2</span>, <span class="at">end =</span> <span class="fl">0.8</span>)) <span class="sc">+</span></span>
<span id="cb338-729"><a href="#cb338-729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Number of Configurations"</span>, <span class="at">y =</span> <span class="st">"Best regr.rmse"</span>, <span class="at">colour =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb338-730"><a href="#cb338-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb338-731"><a href="#cb338-731" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb338-732"><a href="#cb338-732" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-733"><a href="#cb338-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-734"><a href="#cb338-734" aria-hidden="true" tabindex="-1"></a>We see that BO manages to slightly outperform the random search.</span>
<span id="cb338-735"><a href="#cb338-735" aria-hidden="true" tabindex="-1"></a>Ideally, we would replicate running both optimizers multiple times with different random seeds and visualize their average performance along with a dispersion measure to properly take randomness of the optimization process into account.</span>
<span id="cb338-736"><a href="#cb338-736" aria-hidden="true" tabindex="-1"></a>We could even use the same first few random samples as the initial design in BO to allow for a fairer comparison.</span>
<span id="cb338-737"><a href="#cb338-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-738"><a href="#cb338-738" aria-hidden="true" tabindex="-1"></a>To visualize the spatial distribution of the evaluated hyperparameter configurations we will plot for each evaluated configuration the number of trees on the x-axis and the sample fraction on the y-axis.</span>
<span id="cb338-739"><a href="#cb338-739" aria-hidden="true" tabindex="-1"></a>The label of each point corresponds to the mtry parameter directly.</span>
<span id="cb338-740"><a href="#cb338-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-741"><a href="#cb338-741" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-034}</span></span>
<span id="cb338-742"><a href="#cb338-742" aria-hidden="true" tabindex="-1"></a>relevant_columns <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"mtry"</span>, <span class="st">"sample.fraction"</span>, <span class="st">"num.trees"</span>, <span class="st">"iteration"</span>, <span class="st">"method"</span>)</span>
<span id="cb338-743"><a href="#cb338-743" aria-hidden="true" tabindex="-1"></a>plot_data_sampling <span class="ot">=</span> <span class="fu">rbind</span>(</span>
<span id="cb338-744"><a href="#cb338-744" aria-hidden="true" tabindex="-1"></a>  instance_rs<span class="sc">$</span>archive<span class="sc">$</span>data[, ..relevant_columns, <span class="at">with =</span> <span class="cn">FALSE</span>],</span>
<span id="cb338-745"><a href="#cb338-745" aria-hidden="true" tabindex="-1"></a>  instance_bo<span class="sc">$</span>archive<span class="sc">$</span>data[, ..relevant_columns, <span class="at">with =</span> <span class="cn">FALSE</span>])</span>
<span id="cb338-746"><a href="#cb338-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-747"><a href="#cb338-747" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb338-748"><a href="#cb338-748" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> num.trees, <span class="at">y =</span> sample.fraction, <span class="at">colour =</span> method, <span class="at">label =</span> mtry),</span>
<span id="cb338-749"><a href="#cb338-749" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> plot_data_sampling</span>
<span id="cb338-750"><a href="#cb338-750" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb338-751"><a href="#cb338-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">viridis</span>(<span class="dv">2</span>, <span class="at">end =</span> <span class="fl">0.8</span>)) <span class="sc">+</span></span>
<span id="cb338-752"><a href="#cb338-752" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb338-753"><a href="#cb338-753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>() <span class="sc">+</span></span>
<span id="cb338-754"><a href="#cb338-754" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">"Method"</span>, <span class="at">override.aes =</span> <span class="fu">aes</span>(<span class="at">label =</span> <span class="st">""</span>, <span class="at">size =</span> <span class="dv">2</span>))) <span class="sc">+</span></span>
<span id="cb338-755"><a href="#cb338-755" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb338-756"><a href="#cb338-756" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb338-757"><a href="#cb338-757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-758"><a href="#cb338-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-759"><a href="#cb338-759" aria-hidden="true" tabindex="-1"></a>We observe that the random search samples uniformly at random -- as expected.</span>
<span id="cb338-760"><a href="#cb338-760" aria-hidden="true" tabindex="-1"></a>BO, however, focuses on regions of the search space with a high number of trees between 350 and 400, a high sample fraction and mtry values of around 5 to 8.</span>
<span id="cb338-761"><a href="#cb338-761" aria-hidden="true" tabindex="-1"></a>This is also the region where the final result returned by BO is located.</span>
<span id="cb338-762"><a href="#cb338-762" aria-hidden="true" tabindex="-1"></a>Nevertheless, BO also explores the search space, i.e., along the line of a high sample fraction close to 1.</span>
<span id="cb338-763"><a href="#cb338-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-764"><a href="#cb338-764" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Minimize the 2D Rastrigin function $f: <span class="co">[</span><span class="ot">-5.12, 5.12</span><span class="co">]</span> \times <span class="co">[</span><span class="ot">-5.12, 5.12</span><span class="co">]</span> \rightarrow \mathbb{R}$, $\mathbf{x} \mapsto 10 D+\sum_{i=1}^D\left<span class="co">[</span><span class="ot">x_i^2-10 \cos \left(2 \pi x_i\right)\right</span><span class="co">]</span>$, $D = 2$ via BO (standard sequential single-objective BO via <span class="in">`bayesopt_ego()`</span>) using the lower confidence bound with <span class="in">`lambda = 1`</span> as acquisition function and <span class="in">`"NLOPT_GN_ORIG_DIRECT"`</span> via <span class="in">`opt("nloptr")`</span> as acquisition function optimizer.</span>
<span id="cb338-765"><a href="#cb338-765" aria-hidden="true" tabindex="-1"></a>Use a budget of 40 function evaluations.</span>
<span id="cb338-766"><a href="#cb338-766" aria-hidden="true" tabindex="-1"></a>Run this with both the "default" Gaussian process surrogate model with Matérn 5/2 kernel, and the "default" random forest surrogate model.</span>
<span id="cb338-767"><a href="#cb338-767" aria-hidden="true" tabindex="-1"></a>Compare their anytime performance (similarly as in @fig-bayesian-sinusoidal_bo_rs).</span>
<span id="cb338-768"><a href="#cb338-768" aria-hidden="true" tabindex="-1"></a>You can construct the surrogate models with default settings using:</span>
<span id="cb338-769"><a href="#cb338-769" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-035}</span></span>
<span id="cb338-770"><a href="#cb338-770" aria-hidden="true" tabindex="-1"></a>surrogate_gp <span class="ot">=</span> <span class="fu">srlrn</span>(<span class="fu">default_gp</span>())</span>
<span id="cb338-771"><a href="#cb338-771" aria-hidden="true" tabindex="-1"></a>surrogate_rf <span class="ot">=</span> <span class="fu">srlrn</span>(<span class="fu">default_rf</span>())</span>
<span id="cb338-772"><a href="#cb338-772" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-773"><a href="#cb338-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-774"><a href="#cb338-774" aria-hidden="true" tabindex="-1"></a>We first construct the function, making use of efficient evaluation operating on a <span class="in">`data.table`</span> directly.</span>
<span id="cb338-775"><a href="#cb338-775" aria-hidden="true" tabindex="-1"></a>We then wrap this function in the corresponding <span class="in">`r ref("ObjectiveRFunDt")`</span> objective class and construct the instance.</span>
<span id="cb338-776"><a href="#cb338-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-777"><a href="#cb338-777" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-036}</span></span>
<span id="cb338-778"><a href="#cb338-778" aria-hidden="true" tabindex="-1"></a>rastrigin <span class="ot">=</span> <span class="cf">function</span>(xdt) {</span>
<span id="cb338-779"><a href="#cb338-779" aria-hidden="true" tabindex="-1"></a>  D <span class="ot">=</span> <span class="fu">ncol</span>(xdt)</span>
<span id="cb338-780"><a href="#cb338-780" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> <span class="dv">10</span> <span class="sc">*</span> D <span class="sc">+</span> <span class="fu">rowSums</span>(xdt<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> (<span class="dv">10</span> <span class="sc">*</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> xdt)))</span>
<span id="cb338-781"><a href="#cb338-781" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(<span class="at">y =</span> y)</span>
<span id="cb338-782"><a href="#cb338-782" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-783"><a href="#cb338-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-784"><a href="#cb338-784" aria-hidden="true" tabindex="-1"></a>objective <span class="ot">=</span> ObjectiveRFunDt<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb338-785"><a href="#cb338-785" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun =</span> rastrigin,</span>
<span id="cb338-786"><a href="#cb338-786" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain =</span> <span class="fu">ps</span>(<span class="at">x1 =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="sc">-</span><span class="fl">5.12</span>, <span class="at">upper =</span> <span class="fl">5.12</span>),</span>
<span id="cb338-787"><a href="#cb338-787" aria-hidden="true" tabindex="-1"></a>    <span class="at">x2 =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="sc">-</span><span class="fl">5.12</span>, <span class="at">upper =</span> <span class="fl">5.12</span>)),</span>
<span id="cb338-788"><a href="#cb338-788" aria-hidden="true" tabindex="-1"></a>  <span class="at">codomain =</span> <span class="fu">ps</span>(<span class="at">y =</span> <span class="fu">p_dbl</span>(<span class="at">tags =</span> <span class="st">"minimize"</span>)),</span>
<span id="cb338-789"><a href="#cb338-789" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="st">"rastrigin2D"</span>)</span>
<span id="cb338-790"><a href="#cb338-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-791"><a href="#cb338-791" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> OptimInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb338-792"><a href="#cb338-792" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> objective,</span>
<span id="cb338-793"><a href="#cb338-793" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">40</span>))</span>
<span id="cb338-794"><a href="#cb338-794" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-795"><a href="#cb338-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-796"><a href="#cb338-796" aria-hidden="true" tabindex="-1"></a>We then construct the surrogates as well as the acquisition function and acquisition function optimizer (we will terminate the acquisition function optimization once optimization process stagnates by <span class="in">`1e-5`</span> over the last 100 iterations) and construct the two BO optimizers.</span>
<span id="cb338-797"><a href="#cb338-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-798"><a href="#cb338-798" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-037}</span></span>
<span id="cb338-799"><a href="#cb338-799" aria-hidden="true" tabindex="-1"></a>surrogate_gp <span class="ot">=</span> <span class="fu">srlrn</span>(<span class="fu">default_gp</span>())</span>
<span id="cb338-800"><a href="#cb338-800" aria-hidden="true" tabindex="-1"></a>surrogate_rf <span class="ot">=</span> <span class="fu">srlrn</span>(<span class="fu">default_rf</span>())</span>
<span id="cb338-801"><a href="#cb338-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-802"><a href="#cb338-802" aria-hidden="true" tabindex="-1"></a>acq_function <span class="ot">=</span> <span class="fu">acqf</span>(<span class="st">"cb"</span>, <span class="at">lambda =</span> <span class="dv">1</span>)</span>
<span id="cb338-803"><a href="#cb338-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-804"><a href="#cb338-804" aria-hidden="true" tabindex="-1"></a>acq_optimizer <span class="ot">=</span> <span class="fu">acqo</span>(<span class="fu">opt</span>(<span class="st">"nloptr"</span>, <span class="at">algorithm =</span> <span class="st">"NLOPT_GN_ORIG_DIRECT"</span>),</span>
<span id="cb338-805"><a href="#cb338-805" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"stagnation"</span>, <span class="at">iters =</span> <span class="dv">100</span>, <span class="at">threshold =</span> <span class="fl">1e-5</span>))</span>
<span id="cb338-806"><a href="#cb338-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-807"><a href="#cb338-807" aria-hidden="true" tabindex="-1"></a>optimizer_gp <span class="ot">=</span> <span class="fu">opt</span>(<span class="st">"mbo"</span>,</span>
<span id="cb338-808"><a href="#cb338-808" aria-hidden="true" tabindex="-1"></a>  <span class="at">loop_function =</span> bayesopt_ego,</span>
<span id="cb338-809"><a href="#cb338-809" aria-hidden="true" tabindex="-1"></a>  <span class="at">surrogate =</span> surrogate_gp,</span>
<span id="cb338-810"><a href="#cb338-810" aria-hidden="true" tabindex="-1"></a>  <span class="at">acq_function =</span> acq_function,</span>
<span id="cb338-811"><a href="#cb338-811" aria-hidden="true" tabindex="-1"></a>  <span class="at">acq_optimizer =</span> acq_optimizer)</span>
<span id="cb338-812"><a href="#cb338-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-813"><a href="#cb338-813" aria-hidden="true" tabindex="-1"></a>optimizer_rf <span class="ot">=</span> <span class="fu">opt</span>(<span class="st">"mbo"</span>,</span>
<span id="cb338-814"><a href="#cb338-814" aria-hidden="true" tabindex="-1"></a>  <span class="at">loop_function =</span> bayesopt_ego,</span>
<span id="cb338-815"><a href="#cb338-815" aria-hidden="true" tabindex="-1"></a>  <span class="at">surrogate =</span> surrogate_rf,</span>
<span id="cb338-816"><a href="#cb338-816" aria-hidden="true" tabindex="-1"></a>  <span class="at">acq_function =</span> acq_function,</span>
<span id="cb338-817"><a href="#cb338-817" aria-hidden="true" tabindex="-1"></a>  <span class="at">acq_optimizer =</span> acq_optimizer</span>
<span id="cb338-818"><a href="#cb338-818" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-819"><a href="#cb338-819" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-820"><a href="#cb338-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-821"><a href="#cb338-821" aria-hidden="true" tabindex="-1"></a>We will use the following initial design for both optimizers:</span>
<span id="cb338-822"><a href="#cb338-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-823"><a href="#cb338-823" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-038}</span></span>
<span id="cb338-824"><a href="#cb338-824" aria-hidden="true" tabindex="-1"></a>initial_design <span class="ot">=</span> <span class="fu">data.table</span>(</span>
<span id="cb338-825"><a href="#cb338-825" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">3.95</span>, <span class="fl">1.16</span>, <span class="fl">3.72</span>, <span class="sc">-</span><span class="fl">1.39</span>, <span class="sc">-</span><span class="fl">0.11</span>, <span class="fl">5.00</span>, <span class="sc">-</span><span class="fl">2.67</span>, <span class="fl">2.44</span>),</span>
<span id="cb338-826"><a href="#cb338-826" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">c</span>(<span class="fl">1.18</span>, <span class="sc">-</span><span class="fl">3.93</span>, <span class="fl">3.74</span>, <span class="sc">-</span><span class="fl">1.37</span>, <span class="fl">5.02</span>, <span class="sc">-</span><span class="fl">0.09</span>, <span class="sc">-</span><span class="fl">2.65</span>, <span class="fl">2.46</span>)</span>
<span id="cb338-827"><a href="#cb338-827" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-828"><a href="#cb338-828" aria-hidden="true" tabindex="-1"></a>instance<span class="sc">$</span><span class="fu">eval_batch</span>(initial_design)</span>
<span id="cb338-829"><a href="#cb338-829" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-830"><a href="#cb338-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-831"><a href="#cb338-831" aria-hidden="true" tabindex="-1"></a>We then proceed to optimize the instance with each of the two optimizers and make sure to extract the relevant data from the archive of the instance.</span>
<span id="cb338-832"><a href="#cb338-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-833"><a href="#cb338-833" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-039, warning = FALSE}</span></span>
<span id="cb338-834"><a href="#cb338-834" aria-hidden="true" tabindex="-1"></a>optimizer_gp<span class="sc">$</span><span class="fu">optimize</span>(instance)</span>
<span id="cb338-835"><a href="#cb338-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-836"><a href="#cb338-836" aria-hidden="true" tabindex="-1"></a>gp_data <span class="ot">=</span> instance<span class="sc">$</span>archive<span class="sc">$</span>data</span>
<span id="cb338-837"><a href="#cb338-837" aria-hidden="true" tabindex="-1"></a>gp_data[, y_min <span class="sc">:</span><span class="er">=</span> <span class="fu">cummin</span>(y)]</span>
<span id="cb338-838"><a href="#cb338-838" aria-hidden="true" tabindex="-1"></a>gp_data[, iteration <span class="sc">:</span><span class="er">=</span> <span class="fu">seq_len</span>(.N)]</span>
<span id="cb338-839"><a href="#cb338-839" aria-hidden="true" tabindex="-1"></a>gp_data[, surrogate <span class="sc">:</span><span class="er">=</span> <span class="st">"Gaussian Process"</span>]</span>
<span id="cb338-840"><a href="#cb338-840" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-841"><a href="#cb338-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-842"><a href="#cb338-842" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-040, warning = FALSE}</span></span>
<span id="cb338-843"><a href="#cb338-843" aria-hidden="true" tabindex="-1"></a>instance<span class="sc">$</span>archive<span class="sc">$</span><span class="fu">clear</span>()</span>
<span id="cb338-844"><a href="#cb338-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-845"><a href="#cb338-845" aria-hidden="true" tabindex="-1"></a>instance<span class="sc">$</span><span class="fu">eval_batch</span>(initial_design)</span>
<span id="cb338-846"><a href="#cb338-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-847"><a href="#cb338-847" aria-hidden="true" tabindex="-1"></a>optimizer_rf<span class="sc">$</span><span class="fu">optimize</span>(instance)</span>
<span id="cb338-848"><a href="#cb338-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-849"><a href="#cb338-849" aria-hidden="true" tabindex="-1"></a>rf_data <span class="ot">=</span> instance<span class="sc">$</span>archive<span class="sc">$</span>data</span>
<span id="cb338-850"><a href="#cb338-850" aria-hidden="true" tabindex="-1"></a>rf_data[, y_min <span class="sc">:</span><span class="er">=</span> <span class="fu">cummin</span>(y)]</span>
<span id="cb338-851"><a href="#cb338-851" aria-hidden="true" tabindex="-1"></a>rf_data[, iteration <span class="sc">:</span><span class="er">=</span> <span class="fu">seq_len</span>(.N)]</span>
<span id="cb338-852"><a href="#cb338-852" aria-hidden="true" tabindex="-1"></a>rf_data[, surrogate <span class="sc">:</span><span class="er">=</span> <span class="st">"Random forest"</span>]</span>
<span id="cb338-853"><a href="#cb338-853" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-854"><a href="#cb338-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-855"><a href="#cb338-855" aria-hidden="true" tabindex="-1"></a>We then combine the data and use it to generate the desired plot:</span>
<span id="cb338-856"><a href="#cb338-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-857"><a href="#cb338-857" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-041}</span></span>
<span id="cb338-858"><a href="#cb338-858" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">=</span> <span class="fu">rbind</span>(gp_data, rf_data)</span>
<span id="cb338-859"><a href="#cb338-859" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> iteration, <span class="at">y =</span> y_min, <span class="at">colour =</span> surrogate), <span class="at">data =</span> plot_data) <span class="sc">+</span></span>
<span id="cb338-860"><a href="#cb338-860" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb338-861"><a href="#cb338-861" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">viridis</span>(<span class="dv">2</span>, <span class="at">end =</span> <span class="fl">0.8</span>)) <span class="sc">+</span></span>
<span id="cb338-862"><a href="#cb338-862" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Best Observed Function Value"</span>, <span class="at">x =</span> <span class="st">"Number of Function Evaluations"</span>,</span>
<span id="cb338-863"><a href="#cb338-863" aria-hidden="true" tabindex="-1"></a>       <span class="at">colour =</span> <span class="st">"Surrogate Model"</span>) <span class="sc">+</span></span>
<span id="cb338-864"><a href="#cb338-864" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb338-865"><a href="#cb338-865" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb338-866"><a href="#cb338-866" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-867"><a href="#cb338-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-868"><a href="#cb338-868" aria-hidden="true" tabindex="-1"></a>As expected, we observe that the BO algorithm with the Gaussian Process surrogate appears to outperform the random forest surrogate counterpart.</span>
<span id="cb338-869"><a href="#cb338-869" aria-hidden="true" tabindex="-1"></a>However, ideally we would replicate running each algorithm using different random seeds and visualize the average performance along with some dispersion measure to properly take randomness of the optimization process into account.</span>
<span id="cb338-870"><a href="#cb338-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-871"><a href="#cb338-871" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Minimize the following function: $f: <span class="co">[</span><span class="ot">-10, 10</span><span class="co">]</span> \rightarrow \mathbb{R}^2, x \mapsto \left(x^2, (x - 2)^2\right)$ with respect to both objectives.</span>
<span id="cb338-872"><a href="#cb338-872" aria-hidden="true" tabindex="-1"></a>Use the ParEGO algorithm.</span>
<span id="cb338-873"><a href="#cb338-873" aria-hidden="true" tabindex="-1"></a>Construct the objective function using the <span class="in">`r ref("ObjectiveRFunMany")`</span> class.</span>
<span id="cb338-874"><a href="#cb338-874" aria-hidden="true" tabindex="-1"></a>Terminate the optimization after a runtime of 100 evals.</span>
<span id="cb338-875"><a href="#cb338-875" aria-hidden="true" tabindex="-1"></a>Plot the resulting Pareto front and compare it to the analytical solution, $y_2 = \left(\sqrt{y_1}-2\right)^2$ with $y_1$ ranging from $0$ to $4$.</span>
<span id="cb338-876"><a href="#cb338-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-877"><a href="#cb338-877" aria-hidden="true" tabindex="-1"></a>We first construct the function, wrap it in the objective and then create the instance.</span>
<span id="cb338-878"><a href="#cb338-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-879"><a href="#cb338-879" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-042}</span></span>
<span id="cb338-880"><a href="#cb338-880" aria-hidden="true" tabindex="-1"></a>fun <span class="ot">=</span> <span class="cf">function</span>(xss) {</span>
<span id="cb338-881"><a href="#cb338-881" aria-hidden="true" tabindex="-1"></a>  evaluations <span class="ot">=</span> <span class="fu">lapply</span>(xss, <span class="at">FUN =</span> <span class="cf">function</span>(xs) {</span>
<span id="cb338-882"><a href="#cb338-882" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">y1 =</span> xs<span class="sc">$</span>x <span class="sc">^</span> <span class="dv">2</span>, <span class="at">y2 =</span> (xs<span class="sc">$</span>x <span class="sc">-</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb338-883"><a href="#cb338-883" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb338-884"><a href="#cb338-884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>(evaluations)</span>
<span id="cb338-885"><a href="#cb338-885" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-886"><a href="#cb338-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-887"><a href="#cb338-887" aria-hidden="true" tabindex="-1"></a>objective <span class="ot">=</span> ObjectiveRFunMany<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb338-888"><a href="#cb338-888" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun =</span> fun,</span>
<span id="cb338-889"><a href="#cb338-889" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain =</span> <span class="fu">ps</span>(<span class="at">x =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">upper =</span> <span class="dv">10</span>)),</span>
<span id="cb338-890"><a href="#cb338-890" aria-hidden="true" tabindex="-1"></a>  <span class="at">codomain =</span> <span class="fu">ps</span>(<span class="at">y1 =</span> <span class="fu">p_dbl</span>(<span class="at">tags =</span> <span class="st">"minimize"</span>), <span class="at">y2 =</span> <span class="fu">p_dbl</span>(<span class="at">tags =</span> <span class="st">"minimize"</span>)),</span>
<span id="cb338-891"><a href="#cb338-891" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="st">"schaffer1"</span>)</span>
<span id="cb338-892"><a href="#cb338-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-893"><a href="#cb338-893" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> OptimInstanceMultiCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb338-894"><a href="#cb338-894" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> objective,</span>
<span id="cb338-895"><a href="#cb338-895" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">100</span>)</span>
<span id="cb338-896"><a href="#cb338-896" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-897"><a href="#cb338-897" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-898"><a href="#cb338-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-899"><a href="#cb338-899" aria-hidden="true" tabindex="-1"></a>As a surrogate we will use a random forest.</span>
<span id="cb338-900"><a href="#cb338-900" aria-hidden="true" tabindex="-1"></a>ParEGO is a scalarization based multi-objective BO algorithm and therefore we use the Expected Improvement as acquisition function.</span>
<span id="cb338-901"><a href="#cb338-901" aria-hidden="true" tabindex="-1"></a>We will use the same acquisition functon optimizer as earlier.</span>
<span id="cb338-902"><a href="#cb338-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-903"><a href="#cb338-903" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-043}</span></span>
<span id="cb338-904"><a href="#cb338-904" aria-hidden="true" tabindex="-1"></a>surrogate <span class="ot">=</span> <span class="fu">srlrn</span>(<span class="fu">default_rf</span>())</span>
<span id="cb338-905"><a href="#cb338-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-906"><a href="#cb338-906" aria-hidden="true" tabindex="-1"></a>acq_function <span class="ot">=</span> <span class="fu">acqf</span>(<span class="st">"ei"</span>)</span>
<span id="cb338-907"><a href="#cb338-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-908"><a href="#cb338-908" aria-hidden="true" tabindex="-1"></a>acq_optimizer <span class="ot">=</span> <span class="fu">acqo</span>(<span class="fu">opt</span>(<span class="st">"nloptr"</span>, <span class="at">algorithm =</span> <span class="st">"NLOPT_GN_ORIG_DIRECT"</span>),</span>
<span id="cb338-909"><a href="#cb338-909" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"stagnation"</span>, <span class="at">iters =</span> <span class="dv">100</span>, <span class="at">threshold =</span> <span class="fl">1e-5</span>))</span>
<span id="cb338-910"><a href="#cb338-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-911"><a href="#cb338-911" aria-hidden="true" tabindex="-1"></a>optimizer <span class="ot">=</span> <span class="fu">opt</span>(<span class="st">"mbo"</span>,</span>
<span id="cb338-912"><a href="#cb338-912" aria-hidden="true" tabindex="-1"></a>  <span class="at">loop_function =</span> bayesopt_parego,</span>
<span id="cb338-913"><a href="#cb338-913" aria-hidden="true" tabindex="-1"></a>  <span class="at">surrogate =</span> surrogate,</span>
<span id="cb338-914"><a href="#cb338-914" aria-hidden="true" tabindex="-1"></a>  <span class="at">acq_function =</span> acq_function,</span>
<span id="cb338-915"><a href="#cb338-915" aria-hidden="true" tabindex="-1"></a>  <span class="at">acq_optimizer =</span> acq_optimizer</span>
<span id="cb338-916"><a href="#cb338-916" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-917"><a href="#cb338-917" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-918"><a href="#cb338-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-919"><a href="#cb338-919" aria-hidden="true" tabindex="-1"></a>We then optimize the instance:</span>
<span id="cb338-920"><a href="#cb338-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-921"><a href="#cb338-921" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-044, warning = FALSE}</span></span>
<span id="cb338-922"><a href="#cb338-922" aria-hidden="true" tabindex="-1"></a>optimizer<span class="sc">$</span><span class="fu">optimize</span>(instance)</span>
<span id="cb338-923"><a href="#cb338-923" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-924"><a href="#cb338-924" aria-hidden="true" tabindex="-1"></a>Finally, we visualize the resulting Pareto front (in black) and its analytical counterpart (in darkgrey).</span>
<span id="cb338-925"><a href="#cb338-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-926"><a href="#cb338-926" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-045}</span></span>
<span id="cb338-927"><a href="#cb338-927" aria-hidden="true" tabindex="-1"></a>true_pareto <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">y1 =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">4</span>, <span class="at">length.out =</span> <span class="dv">1001</span>))</span>
<span id="cb338-928"><a href="#cb338-928" aria-hidden="true" tabindex="-1"></a>true_pareto[, y2 <span class="sc">:</span><span class="er">=</span> (<span class="fu">sqrt</span>(y1) <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">^</span><span class="dv">2</span>]</span>
<span id="cb338-929"><a href="#cb338-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-930"><a href="#cb338-930" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> y1, <span class="at">y =</span> y2), <span class="at">data =</span> instance<span class="sc">$</span>archive<span class="sc">$</span><span class="fu">best</span>()) <span class="sc">+</span></span>
<span id="cb338-931"><a href="#cb338-931" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb338-932"><a href="#cb338-932" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> true_pareto, <span class="at">colour =</span> <span class="st">"darkgrey"</span>) <span class="sc">+</span></span>
<span id="cb338-933"><a href="#cb338-933" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">direction =</span> <span class="st">"hv"</span>) <span class="sc">+</span></span>
<span id="cb338-934"><a href="#cb338-934" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(y[<span class="dv">1</span>]), <span class="at">y =</span> <span class="fu">expression</span>(y[<span class="dv">2</span>])) <span class="sc">+</span></span>
<span id="cb338-935"><a href="#cb338-935" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb338-936"><a href="#cb338-936" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-937"><a href="#cb338-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-938"><a href="#cb338-938" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-feature-selection</span></span>
<span id="cb338-939"><a href="#cb338-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-940"><a href="#cb338-940" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Compute the correlation filter scores on <span class="in">`tsk("mtcars")`</span> and use the filter to select the five features most strongly correlated with the target.</span>
<span id="cb338-941"><a href="#cb338-941" aria-hidden="true" tabindex="-1"></a>  Resample <span class="in">`lrn("regr.kknn")`</span> on both the full dataset and the reduced one, and compare both performances based on 10-fold CV with respect to MSE.</span>
<span id="cb338-942"><a href="#cb338-942" aria-hidden="true" tabindex="-1"></a>  NB: Here, we have performed the feature filtering outside of CV, which is generally not a good idea as it biases the CV performance estimation.</span>
<span id="cb338-943"><a href="#cb338-943" aria-hidden="true" tabindex="-1"></a>  To do this properly, filtering should be embedded inside the CV via pipelines -- try to come back to this exercise after you read @sec-pipelines-nonseq to implement this with less bias.</span>
<span id="cb338-944"><a href="#cb338-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-945"><a href="#cb338-945" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-046}</span></span>
<span id="cb338-946"><a href="#cb338-946" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-947"><a href="#cb338-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-948"><a href="#cb338-948" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>)</span>
<span id="cb338-949"><a href="#cb338-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-950"><a href="#cb338-950" aria-hidden="true" tabindex="-1"></a>filter <span class="ot">=</span> <span class="fu">flt</span>(<span class="st">"correlation"</span>)</span>
<span id="cb338-951"><a href="#cb338-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-952"><a href="#cb338-952" aria-hidden="true" tabindex="-1"></a>filter<span class="sc">$</span><span class="fu">calculate</span>(task)</span>
<span id="cb338-953"><a href="#cb338-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-954"><a href="#cb338-954" aria-hidden="true" tabindex="-1"></a><span class="co"># sorted filter scores</span></span>
<span id="cb338-955"><a href="#cb338-955" aria-hidden="true" tabindex="-1"></a>filter<span class="sc">$</span>scores</span>
<span id="cb338-956"><a href="#cb338-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-957"><a href="#cb338-957" aria-hidden="true" tabindex="-1"></a><span class="co"># subset task to 5 most correlated features</span></span>
<span id="cb338-958"><a href="#cb338-958" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">select</span>(<span class="fu">names</span>(<span class="fu">head</span>(filter<span class="sc">$</span>scores, <span class="dv">5</span>)))</span>
<span id="cb338-959"><a href="#cb338-959" aria-hidden="true" tabindex="-1"></a>task</span>
<span id="cb338-960"><a href="#cb338-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-961"><a href="#cb338-961" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb338-962"><a href="#cb338-962" aria-hidden="true" tabindex="-1"></a>  <span class="at">tasks =</span> <span class="fu">list</span>(task, <span class="fu">tsk</span>(<span class="st">"mtcars"</span>)),</span>
<span id="cb338-963"><a href="#cb338-963" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> <span class="fu">lrn</span>(<span class="st">"regr.kknn"</span>),</span>
<span id="cb338-964"><a href="#cb338-964" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">10</span>)</span>
<span id="cb338-965"><a href="#cb338-965" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-966"><a href="#cb338-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-967"><a href="#cb338-967" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb338-968"><a href="#cb338-968" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"regr.mse"</span>))</span>
<span id="cb338-969"><a href="#cb338-969" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-970"><a href="#cb338-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-971"><a href="#cb338-971" aria-hidden="true" tabindex="-1"></a>The <span class="in">`"mse"`</span> is much lower on the filtered task.</span>
<span id="cb338-972"><a href="#cb338-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-973"><a href="#cb338-973" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Apply backward selection to <span class="in">`tsk("penguins")`</span> with <span class="in">`lrn("classif.rpart")`</span> and holdout resampling by the classification accuracy measure.</span>
<span id="cb338-974"><a href="#cb338-974" aria-hidden="true" tabindex="-1"></a>  Compare the results with those in @sec-fs-wrapper-example by also running the forward selection from that section.</span>
<span id="cb338-975"><a href="#cb338-975" aria-hidden="true" tabindex="-1"></a>  Do the selected features differ?</span>
<span id="cb338-976"><a href="#cb338-976" aria-hidden="true" tabindex="-1"></a>  Which feature selection method reports a higher classification accuracy in its <span class="in">`$result`</span>?</span>
<span id="cb338-977"><a href="#cb338-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-978"><a href="#cb338-978" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-047}</span></span>
<span id="cb338-979"><a href="#cb338-979" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-980"><a href="#cb338-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-981"><a href="#cb338-981" aria-hidden="true" tabindex="-1"></a>fselector_sbs <span class="ot">=</span> <span class="fu">fs</span>(<span class="st">"sequential"</span>, <span class="at">strategy =</span> <span class="st">"sbs"</span>)</span>
<span id="cb338-982"><a href="#cb338-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-983"><a href="#cb338-983" aria-hidden="true" tabindex="-1"></a>instance_sbs <span class="ot">=</span> <span class="fu">fsi</span>(</span>
<span id="cb338-984"><a href="#cb338-984" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span>  <span class="fu">tsk</span>(<span class="st">"penguins"</span>),</span>
<span id="cb338-985"><a href="#cb338-985" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>),</span>
<span id="cb338-986"><a href="#cb338-986" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>),</span>
<span id="cb338-987"><a href="#cb338-987" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>),</span>
<span id="cb338-988"><a href="#cb338-988" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"none"</span>)</span>
<span id="cb338-989"><a href="#cb338-989" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-990"><a href="#cb338-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-991"><a href="#cb338-991" aria-hidden="true" tabindex="-1"></a>fselector_sbs<span class="sc">$</span><span class="fu">optimize</span>(instance_sbs)</span>
<span id="cb338-992"><a href="#cb338-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-993"><a href="#cb338-993" aria-hidden="true" tabindex="-1"></a><span class="co"># optimization path sbs</span></span>
<span id="cb338-994"><a href="#cb338-994" aria-hidden="true" tabindex="-1"></a>fselector_sbs<span class="sc">$</span><span class="fu">optimization_path</span>(instance_sbs)</span>
<span id="cb338-995"><a href="#cb338-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-996"><a href="#cb338-996" aria-hidden="true" tabindex="-1"></a>instance_sbs<span class="sc">$</span>result</span>
<span id="cb338-997"><a href="#cb338-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-998"><a href="#cb338-998" aria-hidden="true" tabindex="-1"></a>fselector_sfs <span class="ot">=</span> <span class="fu">fs</span>(<span class="st">"sequential"</span>, <span class="at">strategy =</span> <span class="st">"sfs"</span>)</span>
<span id="cb338-999"><a href="#cb338-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1000"><a href="#cb338-1000" aria-hidden="true" tabindex="-1"></a>instance_sfs <span class="ot">=</span> <span class="fu">fsi</span>(</span>
<span id="cb338-1001"><a href="#cb338-1001" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span>  <span class="fu">tsk</span>(<span class="st">"penguins"</span>),</span>
<span id="cb338-1002"><a href="#cb338-1002" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>),</span>
<span id="cb338-1003"><a href="#cb338-1003" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>),</span>
<span id="cb338-1004"><a href="#cb338-1004" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>),</span>
<span id="cb338-1005"><a href="#cb338-1005" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"none"</span>)</span>
<span id="cb338-1006"><a href="#cb338-1006" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1007"><a href="#cb338-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1008"><a href="#cb338-1008" aria-hidden="true" tabindex="-1"></a>fselector_sfs<span class="sc">$</span><span class="fu">optimize</span>(instance_sfs)</span>
<span id="cb338-1009"><a href="#cb338-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1010"><a href="#cb338-1010" aria-hidden="true" tabindex="-1"></a><span class="co"># optimization path sfs</span></span>
<span id="cb338-1011"><a href="#cb338-1011" aria-hidden="true" tabindex="-1"></a>fselector_sfs<span class="sc">$</span><span class="fu">optimization_path</span>(instance_sfs)</span>
<span id="cb338-1012"><a href="#cb338-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1013"><a href="#cb338-1013" aria-hidden="true" tabindex="-1"></a>instance_sfs<span class="sc">$</span>result</span>
<span id="cb338-1014"><a href="#cb338-1014" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1015"><a href="#cb338-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1016"><a href="#cb338-1016" aria-hidden="true" tabindex="-1"></a>The sequential backward search selects 5 features, while the sequential forward search selects all features.</span>
<span id="cb338-1017"><a href="#cb338-1017" aria-hidden="true" tabindex="-1"></a>The sequential backward search reports a higher classification accuracy.</span>
<span id="cb338-1018"><a href="#cb338-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1019"><a href="#cb338-1019" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>There is a problem in the performance comparison in Exercise 2 as feature selection is performed on the test-set.</span>
<span id="cb338-1020"><a href="#cb338-1020" aria-hidden="true" tabindex="-1"></a>  Change the process by applying forward feature selection with <span class="in">`auto_fselector()`</span>.</span>
<span id="cb338-1021"><a href="#cb338-1021" aria-hidden="true" tabindex="-1"></a>  Compare the performance to backward feature selection from Exercise 2 using nested resampling.</span>
<span id="cb338-1022"><a href="#cb338-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1023"><a href="#cb338-1023" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-048}</span></span>
<span id="cb338-1024"><a href="#cb338-1024" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-1025"><a href="#cb338-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1026"><a href="#cb338-1026" aria-hidden="true" tabindex="-1"></a>afs_sfs <span class="ot">=</span> <span class="fu">auto_fselector</span>(</span>
<span id="cb338-1027"><a href="#cb338-1027" aria-hidden="true" tabindex="-1"></a>  <span class="at">fselector =</span> <span class="fu">fs</span>(<span class="st">"sequential"</span>, <span class="at">strategy =</span> <span class="st">"sfs"</span>),</span>
<span id="cb338-1028"><a href="#cb338-1028" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">id =</span> <span class="st">"classif.rpart.sfs"</span>),</span>
<span id="cb338-1029"><a href="#cb338-1029" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>),</span>
<span id="cb338-1030"><a href="#cb338-1030" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>)</span>
<span id="cb338-1031"><a href="#cb338-1031" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1032"><a href="#cb338-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1033"><a href="#cb338-1033" aria-hidden="true" tabindex="-1"></a>afs_sbs <span class="ot">=</span> <span class="fu">auto_fselector</span>(</span>
<span id="cb338-1034"><a href="#cb338-1034" aria-hidden="true" tabindex="-1"></a>  <span class="at">fselector =</span> <span class="fu">fs</span>(<span class="st">"sequential"</span>, <span class="at">strategy =</span> <span class="st">"sbs"</span>),</span>
<span id="cb338-1035"><a href="#cb338-1035" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">id =</span> <span class="st">"classif.rpart.sbs"</span>),</span>
<span id="cb338-1036"><a href="#cb338-1036" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>),</span>
<span id="cb338-1037"><a href="#cb338-1037" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>)</span>
<span id="cb338-1038"><a href="#cb338-1038" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1039"><a href="#cb338-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1040"><a href="#cb338-1040" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb338-1041"><a href="#cb338-1041" aria-hidden="true" tabindex="-1"></a>  <span class="at">tasks =</span> <span class="fu">tsk</span>(<span class="st">"penguins"</span>),</span>
<span id="cb338-1042"><a href="#cb338-1042" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> <span class="fu">list</span>(afs_sfs, afs_sbs),</span>
<span id="cb338-1043"><a href="#cb338-1043" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span>
<span id="cb338-1044"><a href="#cb338-1044" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1045"><a href="#cb338-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1046"><a href="#cb338-1046" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb338-1047"><a href="#cb338-1047" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.acc"</span>))</span>
<span id="cb338-1048"><a href="#cb338-1048" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1049"><a href="#cb338-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1050"><a href="#cb338-1050" aria-hidden="true" tabindex="-1"></a>Now the sequential forward search selects yields a slightly higher classification accuracy.</span>
<span id="cb338-1051"><a href="#cb338-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1052"><a href="#cb338-1052" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>(*) Write a feature selection algorithm that is a hybrid of a filter and a wrapper method.</span>
<span id="cb338-1053"><a href="#cb338-1053" aria-hidden="true" tabindex="-1"></a>  This search algorithm should compute filter scores for all features and then perform a forward search.</span>
<span id="cb338-1054"><a href="#cb338-1054" aria-hidden="true" tabindex="-1"></a>  But instead of tentatively adding all remaining features to the current feature set, it should only stochastically try a subset of the available features.</span>
<span id="cb338-1055"><a href="#cb338-1055" aria-hidden="true" tabindex="-1"></a>  Features with high filter scores should be added with higher probability.</span>
<span id="cb338-1056"><a href="#cb338-1056" aria-hidden="true" tabindex="-1"></a>  Start by coding a stand-alone R method for this search (based on a learner, task, resampling, performance measure and some control settings).</span>
<span id="cb338-1057"><a href="#cb338-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1058"><a href="#cb338-1058" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-049}</span></span>
<span id="cb338-1059"><a href="#cb338-1059" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb338-1060"><a href="#cb338-1060" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb338-1061"><a href="#cb338-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1062"><a href="#cb338-1062" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>)</span>
<span id="cb338-1063"><a href="#cb338-1063" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb338-1064"><a href="#cb338-1064" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb338-1065"><a href="#cb338-1065" aria-hidden="true" tabindex="-1"></a>measure <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>)</span>
<span id="cb338-1066"><a href="#cb338-1066" aria-hidden="true" tabindex="-1"></a>filter <span class="ot">=</span> <span class="fu">flt</span>(<span class="st">"auc"</span>)</span>
<span id="cb338-1067"><a href="#cb338-1067" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb338-1068"><a href="#cb338-1068" aria-hidden="true" tabindex="-1"></a>max_features <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb338-1069"><a href="#cb338-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1070"><a href="#cb338-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1071"><a href="#cb338-1071" aria-hidden="true" tabindex="-1"></a>filter_forward_selection_search <span class="ot">=</span> <span class="cf">function</span>(task, learner, resampling, measure, filter, n, max_features) {</span>
<span id="cb338-1072"><a href="#cb338-1072" aria-hidden="true" tabindex="-1"></a>  features <span class="ot">=</span> task<span class="sc">$</span>feature_names</span>
<span id="cb338-1073"><a href="#cb338-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1074"><a href="#cb338-1074" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate filter scores</span></span>
<span id="cb338-1075"><a href="#cb338-1075" aria-hidden="true" tabindex="-1"></a>  filter<span class="sc">$</span><span class="fu">calculate</span>(task)</span>
<span id="cb338-1076"><a href="#cb338-1076" aria-hidden="true" tabindex="-1"></a>  scores <span class="ot">=</span> filter<span class="sc">$</span>scores</span>
<span id="cb338-1077"><a href="#cb338-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1078"><a href="#cb338-1078" aria-hidden="true" tabindex="-1"></a>  result_features <span class="ot">=</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb338-1079"><a href="#cb338-1079" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span>(max_features <span class="sc">&gt;</span> <span class="fu">length</span>(result_features)) {</span>
<span id="cb338-1080"><a href="#cb338-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1081"><a href="#cb338-1081" aria-hidden="true" tabindex="-1"></a>    <span class="co"># select n features to try</span></span>
<span id="cb338-1082"><a href="#cb338-1082" aria-hidden="true" tabindex="-1"></a>    filter_features <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">names</span>(scores), <span class="at">size =</span> <span class="fu">min</span>(n, <span class="fu">length</span>(scores)), <span class="at">prob =</span> scores)</span>
<span id="cb338-1083"><a href="#cb338-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1084"><a href="#cb338-1084" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create feature matrix</span></span>
<span id="cb338-1085"><a href="#cb338-1085" aria-hidden="true" tabindex="-1"></a>    states <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">FALSE</span>, <span class="at">ncol =</span> <span class="fu">length</span>(features), <span class="at">nrow =</span> <span class="fu">length</span>(filter_features))</span>
<span id="cb338-1086"><a href="#cb338-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1087"><a href="#cb338-1087" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add filter features to matrix</span></span>
<span id="cb338-1088"><a href="#cb338-1088" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(filter_features)) {</span>
<span id="cb338-1089"><a href="#cb338-1089" aria-hidden="true" tabindex="-1"></a>      states[i, <span class="fu">which</span>(features <span class="sc">%in%</span> filter_features[i])] <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb338-1090"><a href="#cb338-1090" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb338-1091"><a href="#cb338-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1092"><a href="#cb338-1092" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add already selected features to matrix</span></span>
<span id="cb338-1093"><a href="#cb338-1093" aria-hidden="true" tabindex="-1"></a>    states[, <span class="fu">which</span>(features <span class="sc">%in%</span> result_features)] <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb338-1094"><a href="#cb338-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1095"><a href="#cb338-1095" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert matrix to design</span></span>
<span id="cb338-1096"><a href="#cb338-1096" aria-hidden="true" tabindex="-1"></a>    design <span class="ot">=</span> <span class="fu">setnames</span>(<span class="fu">as.data.table</span>(states), features)</span>
<span id="cb338-1097"><a href="#cb338-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1098"><a href="#cb338-1098" aria-hidden="true" tabindex="-1"></a>    <span class="co"># evaluate feature combinations</span></span>
<span id="cb338-1099"><a href="#cb338-1099" aria-hidden="true" tabindex="-1"></a>    instance <span class="ot">=</span> <span class="fu">fselect</span>(</span>
<span id="cb338-1100"><a href="#cb338-1100" aria-hidden="true" tabindex="-1"></a>      <span class="at">fselector =</span> <span class="fu">fs</span>(<span class="st">"design_points"</span>, <span class="at">design =</span> design, <span class="at">batch_size =</span> <span class="fu">nrow</span>(design)),</span>
<span id="cb338-1101"><a href="#cb338-1101" aria-hidden="true" tabindex="-1"></a>      <span class="at">task =</span>  task,</span>
<span id="cb338-1102"><a href="#cb338-1102" aria-hidden="true" tabindex="-1"></a>      <span class="at">learner =</span> learner,</span>
<span id="cb338-1103"><a href="#cb338-1103" aria-hidden="true" tabindex="-1"></a>      <span class="at">resampling =</span> resampling,</span>
<span id="cb338-1104"><a href="#cb338-1104" aria-hidden="true" tabindex="-1"></a>      <span class="at">measure =</span> measure</span>
<span id="cb338-1105"><a href="#cb338-1105" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb338-1106"><a href="#cb338-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1107"><a href="#cb338-1107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># current best set</span></span>
<span id="cb338-1108"><a href="#cb338-1108" aria-hidden="true" tabindex="-1"></a>    result_features <span class="ot">=</span> instance<span class="sc">$</span>result_feature_set</span>
<span id="cb338-1109"><a href="#cb338-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1110"><a href="#cb338-1110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># remove selected features from scores</span></span>
<span id="cb338-1111"><a href="#cb338-1111" aria-hidden="true" tabindex="-1"></a>    scores <span class="ot">=</span> scores[<span class="sc">!</span><span class="fu">names</span>(scores) <span class="sc">%in%</span> result_features]</span>
<span id="cb338-1112"><a href="#cb338-1112" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb338-1113"><a href="#cb338-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1114"><a href="#cb338-1114" aria-hidden="true" tabindex="-1"></a>  result_features</span>
<span id="cb338-1115"><a href="#cb338-1115" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-1116"><a href="#cb338-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1117"><a href="#cb338-1117" aria-hidden="true" tabindex="-1"></a><span class="fu">filter_forward_selection_search</span>(task, learner, resampling, measure, filter, n, max_features)</span>
<span id="cb338-1118"><a href="#cb338-1118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1119"><a href="#cb338-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1120"><a href="#cb338-1120" aria-hidden="true" tabindex="-1"></a>Then, as a stretch goal, see if you can implement this as an R6 class inheriting from <span class="in">`FSelectorBatch`</span>.</span>
<span id="cb338-1121"><a href="#cb338-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1122"><a href="#cb338-1122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-050}</span></span>
<span id="cb338-1123"><a href="#cb338-1123" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(R6)</span>
<span id="cb338-1124"><a href="#cb338-1124" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(checkmate)</span>
<span id="cb338-1125"><a href="#cb338-1125" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb338-1126"><a href="#cb338-1126" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3fselect)</span>
<span id="cb338-1127"><a href="#cb338-1127" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb338-1128"><a href="#cb338-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1129"><a href="#cb338-1129" aria-hidden="true" tabindex="-1"></a>FSelectorBatchSequentialFilter <span class="ot">=</span> <span class="fu">R6Class</span>(<span class="st">"FSelectorBatchSequentialFilter"</span>,</span>
<span id="cb338-1130"><a href="#cb338-1130" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> FSelectorBatch,</span>
<span id="cb338-1131"><a href="#cb338-1131" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb338-1132"><a href="#cb338-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1133"><a href="#cb338-1133" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' @description</span></span>
<span id="cb338-1134"><a href="#cb338-1134" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' Creates a new instance of this [R6][R6::R6Class] class.`</span></span>
<span id="cb338-1135"><a href="#cb338-1135" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb338-1136"><a href="#cb338-1136" aria-hidden="true" tabindex="-1"></a>      param_set <span class="ot">=</span> <span class="fu">ps</span>(</span>
<span id="cb338-1137"><a href="#cb338-1137" aria-hidden="true" tabindex="-1"></a>        <span class="at">filter =</span> <span class="fu">p_uty</span>(<span class="at">tags =</span> <span class="st">"required"</span>),</span>
<span id="cb338-1138"><a href="#cb338-1138" aria-hidden="true" tabindex="-1"></a>        <span class="at">n =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">tags =</span> <span class="st">"required"</span>),</span>
<span id="cb338-1139"><a href="#cb338-1139" aria-hidden="true" tabindex="-1"></a>        <span class="at">max_features =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>)</span>
<span id="cb338-1140"><a href="#cb338-1140" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb338-1141"><a href="#cb338-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1142"><a href="#cb338-1142" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(</span>
<span id="cb338-1143"><a href="#cb338-1143" aria-hidden="true" tabindex="-1"></a>        <span class="at">id =</span> <span class="st">"filter_sequential"</span>,</span>
<span id="cb338-1144"><a href="#cb338-1144" aria-hidden="true" tabindex="-1"></a>        <span class="at">param_set =</span> param_set,</span>
<span id="cb338-1145"><a href="#cb338-1145" aria-hidden="true" tabindex="-1"></a>        <span class="at">properties =</span> <span class="st">"single-crit"</span>,</span>
<span id="cb338-1146"><a href="#cb338-1146" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="st">"Sequential Filter Search"</span>,</span>
<span id="cb338-1147"><a href="#cb338-1147" aria-hidden="true" tabindex="-1"></a>        <span class="at">man =</span> <span class="st">"mlr3fselect::mlr_fselectors_sequential"</span></span>
<span id="cb338-1148"><a href="#cb338-1148" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb338-1149"><a href="#cb338-1149" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb338-1150"><a href="#cb338-1150" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb338-1151"><a href="#cb338-1151" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb338-1152"><a href="#cb338-1152" aria-hidden="true" tabindex="-1"></a>    <span class="at">.optimize =</span> <span class="cf">function</span>(inst) {</span>
<span id="cb338-1153"><a href="#cb338-1153" aria-hidden="true" tabindex="-1"></a>      pv <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span>values</span>
<span id="cb338-1154"><a href="#cb338-1154" aria-hidden="true" tabindex="-1"></a>      features <span class="ot">=</span> inst<span class="sc">$</span>archive<span class="sc">$</span>cols_x</span>
<span id="cb338-1155"><a href="#cb338-1155" aria-hidden="true" tabindex="-1"></a>      max_features <span class="ot">=</span> pv<span class="sc">$</span>max_features <span class="sc">%??%</span> <span class="fu">length</span>(features)</span>
<span id="cb338-1156"><a href="#cb338-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1157"><a href="#cb338-1157" aria-hidden="true" tabindex="-1"></a>      <span class="co"># calculate filter scores</span></span>
<span id="cb338-1158"><a href="#cb338-1158" aria-hidden="true" tabindex="-1"></a>      pv<span class="sc">$</span>filter<span class="sc">$</span><span class="fu">calculate</span>(inst<span class="sc">$</span>objective<span class="sc">$</span>task)</span>
<span id="cb338-1159"><a href="#cb338-1159" aria-hidden="true" tabindex="-1"></a>      scores <span class="ot">=</span> pv<span class="sc">$</span>filter<span class="sc">$</span>scores</span>
<span id="cb338-1160"><a href="#cb338-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1161"><a href="#cb338-1161" aria-hidden="true" tabindex="-1"></a>      result_features <span class="ot">=</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb338-1162"><a href="#cb338-1162" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span>(max_features <span class="sc">&gt;</span> <span class="fu">length</span>(result_features)) {</span>
<span id="cb338-1163"><a href="#cb338-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1164"><a href="#cb338-1164" aria-hidden="true" tabindex="-1"></a>        <span class="co"># select n features to try</span></span>
<span id="cb338-1165"><a href="#cb338-1165" aria-hidden="true" tabindex="-1"></a>        filter_features <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">names</span>(scores), <span class="at">size =</span> <span class="fu">min</span>(pv<span class="sc">$</span>n, <span class="fu">length</span>(scores)), <span class="at">prob =</span> scores)</span>
<span id="cb338-1166"><a href="#cb338-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1167"><a href="#cb338-1167" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create feature matrix</span></span>
<span id="cb338-1168"><a href="#cb338-1168" aria-hidden="true" tabindex="-1"></a>        states <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">FALSE</span>, <span class="at">ncol =</span> <span class="fu">length</span>(features), <span class="at">nrow =</span> <span class="fu">length</span>(filter_features))</span>
<span id="cb338-1169"><a href="#cb338-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1170"><a href="#cb338-1170" aria-hidden="true" tabindex="-1"></a>        <span class="co"># add filter features to matrix</span></span>
<span id="cb338-1171"><a href="#cb338-1171" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(filter_features)) {</span>
<span id="cb338-1172"><a href="#cb338-1172" aria-hidden="true" tabindex="-1"></a>          states[i, <span class="fu">which</span>(features <span class="sc">%in%</span> filter_features[i])] <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb338-1173"><a href="#cb338-1173" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb338-1174"><a href="#cb338-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1175"><a href="#cb338-1175" aria-hidden="true" tabindex="-1"></a>        <span class="co"># add already selected features to matrix</span></span>
<span id="cb338-1176"><a href="#cb338-1176" aria-hidden="true" tabindex="-1"></a>        states[, <span class="fu">which</span>(features <span class="sc">%in%</span> result_features)] <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb338-1177"><a href="#cb338-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1178"><a href="#cb338-1178" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convert matrix to design</span></span>
<span id="cb338-1179"><a href="#cb338-1179" aria-hidden="true" tabindex="-1"></a>        design <span class="ot">=</span> <span class="fu">setnames</span>(<span class="fu">as.data.table</span>(states), features)</span>
<span id="cb338-1180"><a href="#cb338-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1181"><a href="#cb338-1181" aria-hidden="true" tabindex="-1"></a>        <span class="co"># evaluate feature combinations</span></span>
<span id="cb338-1182"><a href="#cb338-1182" aria-hidden="true" tabindex="-1"></a>        inst<span class="sc">$</span><span class="fu">eval_batch</span>(design)</span>
<span id="cb338-1183"><a href="#cb338-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1184"><a href="#cb338-1184" aria-hidden="true" tabindex="-1"></a>        <span class="co"># current best set</span></span>
<span id="cb338-1185"><a href="#cb338-1185" aria-hidden="true" tabindex="-1"></a>        res <span class="ot">=</span> inst<span class="sc">$</span>archive<span class="sc">$</span><span class="fu">best</span>(<span class="at">batch =</span> inst<span class="sc">$</span>archive<span class="sc">$</span>n_batch)</span>
<span id="cb338-1186"><a href="#cb338-1186" aria-hidden="true" tabindex="-1"></a>        result_features <span class="ot">=</span> features[<span class="fu">as.logical</span>(res[, features, <span class="at">with =</span> <span class="cn">FALSE</span>])]</span>
<span id="cb338-1187"><a href="#cb338-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1188"><a href="#cb338-1188" aria-hidden="true" tabindex="-1"></a>        <span class="co"># remove selected features from scores</span></span>
<span id="cb338-1189"><a href="#cb338-1189" aria-hidden="true" tabindex="-1"></a>        scores <span class="ot">=</span> scores[<span class="sc">!</span><span class="fu">names</span>(scores) <span class="sc">%in%</span> result_features]</span>
<span id="cb338-1190"><a href="#cb338-1190" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb338-1191"><a href="#cb338-1191" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb338-1192"><a href="#cb338-1192" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb338-1193"><a href="#cb338-1193" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1194"><a href="#cb338-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1195"><a href="#cb338-1195" aria-hidden="true" tabindex="-1"></a>mlr_fselectors<span class="sc">$</span><span class="fu">add</span>(<span class="st">"sequential_filter"</span>, FSelectorBatchSequentialFilter)</span>
<span id="cb338-1196"><a href="#cb338-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1197"><a href="#cb338-1197" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> <span class="fu">fselect</span>(</span>
<span id="cb338-1198"><a href="#cb338-1198" aria-hidden="true" tabindex="-1"></a>  <span class="at">fselector =</span> <span class="fu">fs</span>(</span>
<span id="cb338-1199"><a href="#cb338-1199" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sequential_filter"</span>,</span>
<span id="cb338-1200"><a href="#cb338-1200" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter =</span> <span class="fu">flt</span>(<span class="st">"auc"</span>),</span>
<span id="cb338-1201"><a href="#cb338-1201" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="dv">5</span>,</span>
<span id="cb338-1202"><a href="#cb338-1202" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_features =</span> <span class="dv">10</span>),</span>
<span id="cb338-1203"><a href="#cb338-1203" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span>  <span class="fu">tsk</span>(<span class="st">"sonar"</span>),</span>
<span id="cb338-1204"><a href="#cb338-1204" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>),</span>
<span id="cb338-1205"><a href="#cb338-1205" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>),</span>
<span id="cb338-1206"><a href="#cb338-1206" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>)</span>
<span id="cb338-1207"><a href="#cb338-1207" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1208"><a href="#cb338-1208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1209"><a href="#cb338-1209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1210"><a href="#cb338-1210" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-pipelines</span></span>
<span id="cb338-1211"><a href="#cb338-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1212"><a href="#cb338-1212" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Concatenate the PipeOps named in the exercise by using <span class="in">`%&gt;&gt;%`</span>.</span>
<span id="cb338-1213"><a href="#cb338-1213" aria-hidden="true" tabindex="-1"></a>  The resulting <span class="in">`r ref("Graph")`</span> can then be converted to a <span class="in">`r ref("Learner")`</span> by using <span class="in">`r ref("as_learner()")`</span>.</span>
<span id="cb338-1214"><a href="#cb338-1214" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-051}</span></span>
<span id="cb338-1215"><a href="#cb338-1215" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb338-1216"><a href="#cb338-1216" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3learners)</span>
<span id="cb338-1217"><a href="#cb338-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1218"><a href="#cb338-1218" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"imputeoor"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"scale"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>)</span>
<span id="cb338-1219"><a href="#cb338-1219" aria-hidden="true" tabindex="-1"></a>graph_learner <span class="ot">=</span> <span class="fu">as_learner</span>(graph)</span>
<span id="cb338-1220"><a href="#cb338-1220" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1221"><a href="#cb338-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1222"><a href="#cb338-1222" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>The <span class="in">`r ref("GraphLearner")`</span> can be trained like any other <span class="in">`Learner`</span> object, thereby filling in its <span class="in">`$model`</span> field.</span>
<span id="cb338-1223"><a href="#cb338-1223" aria-hidden="true" tabindex="-1"></a>  It is possible to access the <span class="in">`$state`</span> of any <span class="in">`PipeOp`</span> through this field: the states are named after the <span class="in">`PipeOp`</span>'s <span class="in">`$id`</span>.</span>
<span id="cb338-1224"><a href="#cb338-1224" aria-hidden="true" tabindex="-1"></a>  The logistic regression model can then be extracted from the state of the <span class="in">`po("learner")`</span> that contains the <span class="in">`lrn("classif.log_reg")`</span>.</span>
<span id="cb338-1225"><a href="#cb338-1225" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-052}</span></span>
<span id="cb338-1226"><a href="#cb338-1226" aria-hidden="true" tabindex="-1"></a>graph_learner<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"pima"</span>))</span>
<span id="cb338-1227"><a href="#cb338-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1228"><a href="#cb338-1228" aria-hidden="true" tabindex="-1"></a><span class="co"># access the state of the po("learner") to get the model</span></span>
<span id="cb338-1229"><a href="#cb338-1229" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> graph_learner<span class="sc">$</span>model<span class="sc">$</span>classif.log_reg<span class="sc">$</span>model</span>
<span id="cb338-1230"><a href="#cb338-1230" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(model)</span>
<span id="cb338-1231"><a href="#cb338-1231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1232"><a href="#cb338-1232" aria-hidden="true" tabindex="-1"></a>  Alternatively, the underlying <span class="in">`lrn("classif.log_reg")`</span> can be accessed through the <span class="in">`$base_learner()`</span> method:</span>
<span id="cb338-1233"><a href="#cb338-1233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-053}</span></span>
<span id="cb338-1234"><a href="#cb338-1234" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> graph_learner<span class="sc">$</span><span class="fu">base_learner</span>()<span class="sc">$</span>model</span>
<span id="cb338-1235"><a href="#cb338-1235" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(model)</span>
<span id="cb338-1236"><a href="#cb338-1236" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1237"><a href="#cb338-1237" aria-hidden="true" tabindex="-1"></a>  As a third option, the trained <span class="in">`PipeOp`</span> can be accessed through the <span class="in">`$graph_model`</span> field of the <span class="in">`GraphLearner`</span>.</span>
<span id="cb338-1238"><a href="#cb338-1238" aria-hidden="true" tabindex="-1"></a>  The trained <span class="in">`PipeOp`</span> has a <span class="in">`$learner_model`</span> field, which contains the trained <span class="in">`Learner`</span> object, which contains the model.</span>
<span id="cb338-1239"><a href="#cb338-1239" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-054}</span></span>
<span id="cb338-1240"><a href="#cb338-1240" aria-hidden="true" tabindex="-1"></a>pipeop <span class="ot">=</span> graph_learner<span class="sc">$</span>graph_model<span class="sc">$</span>pipeops<span class="sc">$</span>classif.log_reg</span>
<span id="cb338-1241"><a href="#cb338-1241" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> pipeop<span class="sc">$</span>learner_model<span class="sc">$</span>model</span>
<span id="cb338-1242"><a href="#cb338-1242" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(model)</span>
<span id="cb338-1243"><a href="#cb338-1243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1244"><a href="#cb338-1244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1245"><a href="#cb338-1245" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Set the <span class="in">`$keep_results`</span> flag of the Graph to <span class="in">`TRUE`</span> to keep the results of the individual PipeOps.</span>
<span id="cb338-1246"><a href="#cb338-1246" aria-hidden="true" tabindex="-1"></a>  Afterwards, the input of the <span class="in">`lrn("classif.log_reg")`</span> can be accessed through the <span class="in">`$.result`</span> field of its predecessor, the <span class="in">`po("scale")`</span>.</span>
<span id="cb338-1247"><a href="#cb338-1247" aria-hidden="true" tabindex="-1"></a>  Note that the <span class="in">`$.result`</span> is a <span class="in">`list`</span>, we want to access its only element, named <span class="in">`$output`</span>.</span>
<span id="cb338-1248"><a href="#cb338-1248" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-055}</span></span>
<span id="cb338-1249"><a href="#cb338-1249" aria-hidden="true" tabindex="-1"></a>graph_learner<span class="sc">$</span>graph<span class="sc">$</span>keep_results <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb338-1250"><a href="#cb338-1250" aria-hidden="true" tabindex="-1"></a>graph_learner<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"pima"</span>))</span>
<span id="cb338-1251"><a href="#cb338-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1252"><a href="#cb338-1252" aria-hidden="true" tabindex="-1"></a><span class="co"># access the input of the learner</span></span>
<span id="cb338-1253"><a href="#cb338-1253" aria-hidden="true" tabindex="-1"></a>scale_result <span class="ot">=</span> graph_learner<span class="sc">$</span>graph_model<span class="sc">$</span>pipeops<span class="sc">$</span>scale<span class="sc">$</span>.result</span>
<span id="cb338-1254"><a href="#cb338-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1255"><a href="#cb338-1255" aria-hidden="true" tabindex="-1"></a>scale_output_task <span class="ot">=</span> scale_result<span class="sc">$</span>output</span>
<span id="cb338-1256"><a href="#cb338-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1257"><a href="#cb338-1257" aria-hidden="true" tabindex="-1"></a>age_column <span class="ot">=</span> scale_output_task<span class="sc">$</span><span class="fu">data</span>()<span class="sc">$</span>age</span>
<span id="cb338-1258"><a href="#cb338-1258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1259"><a href="#cb338-1259" aria-hidden="true" tabindex="-1"></a><span class="co"># check if the age column is standardized:</span></span>
<span id="cb338-1260"><a href="#cb338-1260" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. does it have mean 0? -- almost, up to numerical precision!</span></span>
<span id="cb338-1261"><a href="#cb338-1261" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(age_column)</span>
<span id="cb338-1262"><a href="#cb338-1262" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. does it have standard deviation 1? -- yes!</span></span>
<span id="cb338-1263"><a href="#cb338-1263" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(age_column)</span>
<span id="cb338-1264"><a href="#cb338-1264" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1265"><a href="#cb338-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1266"><a href="#cb338-1266" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-pipelines-nonseq</span></span>
<span id="cb338-1267"><a href="#cb338-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1268"><a href="#cb338-1268" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Use the <span class="in">`po("pca")`</span> to replace numeric columns with their PCA transform.</span>
<span id="cb338-1269"><a href="#cb338-1269" aria-hidden="true" tabindex="-1"></a>  To restrict this operator to only columns without missing values, the <span class="in">`affect_columns`</span> with a fitting <span class="in">`r ref("Selector")`</span> can be used:</span>
<span id="cb338-1270"><a href="#cb338-1270" aria-hidden="true" tabindex="-1"></a>  The <span class="in">`selector_missing()`</span>, which selects columns *with* missing values, combined with <span class="in">`selector_invert()`</span>, which inverts the selection.</span>
<span id="cb338-1271"><a href="#cb338-1271" aria-hidden="true" tabindex="-1"></a>  Since <span class="in">`po("pca")`</span> only operates on numeric columns, it is not necessary to use a <span class="in">`Selector`</span> to select numeric columns.</span>
<span id="cb338-1272"><a href="#cb338-1272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-056}</span></span>
<span id="cb338-1273"><a href="#cb338-1273" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">as_graph</span>(<span class="fu">po</span>(<span class="st">"pca"</span>,</span>
<span id="cb338-1274"><a href="#cb338-1274" aria-hidden="true" tabindex="-1"></a>  <span class="at">affect_columns =</span> <span class="fu">selector_invert</span>(<span class="fu">selector_missing</span>()))</span>
<span id="cb338-1275"><a href="#cb338-1275" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1276"><a href="#cb338-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1277"><a href="#cb338-1277" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the graph to the pima task</span></span>
<span id="cb338-1278"><a href="#cb338-1278" aria-hidden="true" tabindex="-1"></a>graph_result <span class="ot">=</span> graph<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"pima"</span>))</span>
<span id="cb338-1279"><a href="#cb338-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1280"><a href="#cb338-1280" aria-hidden="true" tabindex="-1"></a><span class="co"># we get the following features</span></span>
<span id="cb338-1281"><a href="#cb338-1281" aria-hidden="true" tabindex="-1"></a>graph_result[[<span class="dv">1</span>]]<span class="sc">$</span>feature_names</span>
<span id="cb338-1282"><a href="#cb338-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1283"><a href="#cb338-1283" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare with feature-columns of tsk("pima") with missing values:</span></span>
<span id="cb338-1284"><a href="#cb338-1284" aria-hidden="true" tabindex="-1"></a><span class="fu">selector_missing</span>()(<span class="fu">tsk</span>(<span class="st">"pima"</span>))</span>
<span id="cb338-1285"><a href="#cb338-1285" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1286"><a href="#cb338-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1287"><a href="#cb338-1287" aria-hidden="true" tabindex="-1"></a>Alternatively, <span class="in">`po("select")`</span> can be used to select the columns without missing values that are passed to <span class="in">`po("pca")`</span>.</span>
<span id="cb338-1288"><a href="#cb338-1288" aria-hidden="true" tabindex="-1"></a>Another <span class="in">`po("select")`</span> can be used to select all the other columns.</span>
<span id="cb338-1289"><a href="#cb338-1289" aria-hidden="true" tabindex="-1"></a>It is put in parallel with the first <span class="in">`po("select")`</span> using <span class="in">`gunion()`</span>.</span>
<span id="cb338-1290"><a href="#cb338-1290" aria-hidden="true" tabindex="-1"></a>It is necessary to use different <span class="in">`$id`</span> values for both <span class="in">`po("select")`</span> to avoid a name clash in the <span class="in">`Graph`</span>.</span>
<span id="cb338-1291"><a href="#cb338-1291" aria-hidden="true" tabindex="-1"></a>To combine the output from both paths, <span class="in">`po("featureunion")`</span> can be used.</span>
<span id="cb338-1292"><a href="#cb338-1292" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-057}</span></span>
<span id="cb338-1293"><a href="#cb338-1293" aria-hidden="true" tabindex="-1"></a>path1 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"select"</span>, <span class="at">id =</span> <span class="st">"select_non_missing"</span>,</span>
<span id="cb338-1294"><a href="#cb338-1294" aria-hidden="true" tabindex="-1"></a>  <span class="at">selector =</span> <span class="fu">selector_invert</span>(<span class="fu">selector_missing</span>())) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1295"><a href="#cb338-1295" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"pca"</span>)</span>
<span id="cb338-1296"><a href="#cb338-1296" aria-hidden="true" tabindex="-1"></a>path2 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"select"</span>, <span class="at">id =</span> <span class="st">"select_missing"</span>,</span>
<span id="cb338-1297"><a href="#cb338-1297" aria-hidden="true" tabindex="-1"></a>  <span class="at">selector =</span> <span class="fu">selector_missing</span>())</span>
<span id="cb338-1298"><a href="#cb338-1298" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">gunion</span>(<span class="fu">list</span>(path1, path2)) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"featureunion"</span>)</span>
<span id="cb338-1299"><a href="#cb338-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1300"><a href="#cb338-1300" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the graph to the pima task</span></span>
<span id="cb338-1301"><a href="#cb338-1301" aria-hidden="true" tabindex="-1"></a>graph_result <span class="ot">=</span> graph<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"pima"</span>))</span>
<span id="cb338-1302"><a href="#cb338-1302" aria-hidden="true" tabindex="-1"></a>graph_result[[<span class="dv">1</span>]]<span class="sc">$</span>feature_names</span>
<span id="cb338-1303"><a href="#cb338-1303" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1304"><a href="#cb338-1304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1305"><a href="#cb338-1305" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>First, observe the feature names produced by the level 0 learners when applied to the <span class="in">`tsk("wine")`</span> task:</span>
<span id="cb338-1306"><a href="#cb338-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1307"><a href="#cb338-1307" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-058}</span></span>
<span id="cb338-1308"><a href="#cb338-1308" aria-hidden="true" tabindex="-1"></a>lrn_rpart <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb338-1309"><a href="#cb338-1309" aria-hidden="true" tabindex="-1"></a>po_rpart_cv <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, <span class="at">learner =</span> lrn_rpart,</span>
<span id="cb338-1310"><a href="#cb338-1310" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling.folds =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"rpart_cv"</span></span>
<span id="cb338-1311"><a href="#cb338-1311" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1312"><a href="#cb338-1312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1313"><a href="#cb338-1313" aria-hidden="true" tabindex="-1"></a>lrn_knn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.kknn"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb338-1314"><a href="#cb338-1314" aria-hidden="true" tabindex="-1"></a>po_knn_cv <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>,</span>
<span id="cb338-1315"><a href="#cb338-1315" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> lrn_knn,</span>
<span id="cb338-1316"><a href="#cb338-1316" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling.folds =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"knn_cv"</span></span>
<span id="cb338-1317"><a href="#cb338-1317" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1318"><a href="#cb338-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1319"><a href="#cb338-1319" aria-hidden="true" tabindex="-1"></a><span class="co"># we restrict ourselves to two level 0 learners here to</span></span>
<span id="cb338-1320"><a href="#cb338-1320" aria-hidden="true" tabindex="-1"></a><span class="co"># focus on the essentials.</span></span>
<span id="cb338-1321"><a href="#cb338-1321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1322"><a href="#cb338-1322" aria-hidden="true" tabindex="-1"></a>gr_level_0 <span class="ot">=</span> <span class="fu">gunion</span>(<span class="fu">list</span>(po_rpart_cv, po_knn_cv))</span>
<span id="cb338-1323"><a href="#cb338-1323" aria-hidden="true" tabindex="-1"></a>gr_combined <span class="ot">=</span> gr_level_0 <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"featureunion"</span>)</span>
<span id="cb338-1324"><a href="#cb338-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1325"><a href="#cb338-1325" aria-hidden="true" tabindex="-1"></a>gr_combined<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"wine"</span>))[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">head</span>()</span>
<span id="cb338-1326"><a href="#cb338-1326" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1327"><a href="#cb338-1327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1328"><a href="#cb338-1328" aria-hidden="true" tabindex="-1"></a>To use <span class="in">`po("select")`</span> to *remove*, instead of *keep*, a feature based on a pattern, use <span class="in">`r ref("selector_invert")`</span> together with <span class="in">`r ref("selector_grep")`</span>.</span>
<span id="cb338-1329"><a href="#cb338-1329" aria-hidden="true" tabindex="-1"></a>  To remove the "<span class="in">`1`</span>" class columns, i.e. all columns with names that end in "1", the following <span class="in">`po("select")`</span> could be used:</span>
<span id="cb338-1330"><a href="#cb338-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1331"><a href="#cb338-1331" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-059}</span></span>
<span id="cb338-1332"><a href="#cb338-1332" aria-hidden="true" tabindex="-1"></a>drop_one <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"select"</span>, <span class="at">selector =</span> <span class="fu">selector_invert</span>(<span class="fu">selector_grep</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">.1$"</span>)))</span>
<span id="cb338-1333"><a href="#cb338-1333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1334"><a href="#cb338-1334" aria-hidden="true" tabindex="-1"></a><span class="co"># Train it on the wine task with lrn("classif.multinom"):</span></span>
<span id="cb338-1335"><a href="#cb338-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1336"><a href="#cb338-1336" aria-hidden="true" tabindex="-1"></a>gr_stack <span class="ot">=</span> gr_combined <span class="sc">%&gt;&gt;%</span> drop_one <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1337"><a href="#cb338-1337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"classif.multinom"</span>, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb338-1338"><a href="#cb338-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1339"><a href="#cb338-1339" aria-hidden="true" tabindex="-1"></a>glrn_stack <span class="ot">=</span> <span class="fu">as_learner</span>(gr_stack)</span>
<span id="cb338-1340"><a href="#cb338-1340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1341"><a href="#cb338-1341" aria-hidden="true" tabindex="-1"></a>glrn_stack<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"wine"</span>))</span>
<span id="cb338-1342"><a href="#cb338-1342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1343"><a href="#cb338-1343" aria-hidden="true" tabindex="-1"></a>glrn_stack<span class="sc">$</span><span class="fu">base_learner</span>()<span class="sc">$</span>model</span>
<span id="cb338-1344"><a href="#cb338-1344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1345"><a href="#cb338-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1346"><a href="#cb338-1346" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>A solution that does not need to specify the target classes at all is to use a custom <span class="in">`r ref("Selector")`</span>, as was shown in @sec-pipelines-bagging:</span>
<span id="cb338-1347"><a href="#cb338-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1348"><a href="#cb338-1348" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-060}</span></span>
<span id="cb338-1349"><a href="#cb338-1349" aria-hidden="true" tabindex="-1"></a>selector_remove_one_prob_column <span class="ot">=</span> <span class="cf">function</span>(task) {</span>
<span id="cb338-1350"><a href="#cb338-1350" aria-hidden="true" tabindex="-1"></a>  class_removing <span class="ot">=</span> task<span class="sc">$</span>class_names[[<span class="dv">1</span>]]</span>
<span id="cb338-1351"><a href="#cb338-1351" aria-hidden="true" tabindex="-1"></a>  selector_use <span class="ot">=</span> <span class="fu">selector_invert</span>(<span class="fu">selector_grep</span>(<span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">."</span>, class_removing ,<span class="st">"$"</span>)))</span>
<span id="cb338-1352"><a href="#cb338-1352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">selector_use</span>(task)</span>
<span id="cb338-1353"><a href="#cb338-1353" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-1354"><a href="#cb338-1354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1355"><a href="#cb338-1355" aria-hidden="true" tabindex="-1"></a>Using this selector in @sec-pipelines-stack, one could use the resulting stacking learner on any classification task with arbitrary target classes.</span>
<span id="cb338-1356"><a href="#cb338-1356" aria-hidden="true" tabindex="-1"></a>It can be used as an alternative to the <span class="in">`Selector`</span> used in exercise 2:</span>
<span id="cb338-1357"><a href="#cb338-1357" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-061}</span></span>
<span id="cb338-1358"><a href="#cb338-1358" aria-hidden="true" tabindex="-1"></a>drop_one_alt <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"select"</span>, <span class="at">selector =</span> selector_remove_one_prob_column)</span>
<span id="cb338-1359"><a href="#cb338-1359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1360"><a href="#cb338-1360" aria-hidden="true" tabindex="-1"></a><span class="co"># The same as above:</span></span>
<span id="cb338-1361"><a href="#cb338-1361" aria-hidden="true" tabindex="-1"></a>gr_stack <span class="ot">=</span> gr_combined <span class="sc">%&gt;&gt;%</span> drop_one_alt <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1362"><a href="#cb338-1362" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"classif.multinom"</span>, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb338-1363"><a href="#cb338-1363" aria-hidden="true" tabindex="-1"></a>glrn_stack <span class="ot">=</span> <span class="fu">as_learner</span>(gr_stack)</span>
<span id="cb338-1364"><a href="#cb338-1364" aria-hidden="true" tabindex="-1"></a>glrn_stack<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"wine"</span>))</span>
<span id="cb338-1365"><a href="#cb338-1365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1366"><a href="#cb338-1366" aria-hidden="true" tabindex="-1"></a><span class="co"># As before, the first class was dropped.</span></span>
<span id="cb338-1367"><a href="#cb338-1367" aria-hidden="true" tabindex="-1"></a>glrn_stack<span class="sc">$</span><span class="fu">base_learner</span>()<span class="sc">$</span>model</span>
<span id="cb338-1368"><a href="#cb338-1368" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1369"><a href="#cb338-1369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1370"><a href="#cb338-1370" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>We choose to use the following options for imputation, factor encoding, and model training.</span>
<span id="cb338-1371"><a href="#cb338-1371" aria-hidden="true" tabindex="-1"></a>  Note the use of <span class="in">`pos()`</span> and <span class="in">`lrns()`</span>, which return lists of <span class="in">`PipeOp`</span> and <span class="in">`Learner`</span> objects, respectively.</span>
<span id="cb338-1372"><a href="#cb338-1372" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-062}</span></span>
<span id="cb338-1373"><a href="#cb338-1373" aria-hidden="true" tabindex="-1"></a>imputing <span class="ot">=</span> <span class="fu">pos</span>(<span class="fu">c</span>(<span class="st">"imputeoor"</span>, <span class="st">"imputesample"</span>))</span>
<span id="cb338-1374"><a href="#cb338-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1375"><a href="#cb338-1375" aria-hidden="true" tabindex="-1"></a>factor_encoding <span class="ot">=</span> <span class="fu">pos</span>(<span class="fu">c</span>(<span class="st">"encode"</span>, <span class="st">"encodeimpact"</span>))</span>
<span id="cb338-1376"><a href="#cb338-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1377"><a href="#cb338-1377" aria-hidden="true" tabindex="-1"></a>models <span class="ot">=</span> <span class="fu">lrns</span>(<span class="fu">c</span>(<span class="st">"classif.rpart"</span>, <span class="st">"classif.log_reg"</span>, <span class="st">"classif.svm"</span>))</span>
<span id="cb338-1378"><a href="#cb338-1378" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1379"><a href="#cb338-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1380"><a href="#cb338-1380" aria-hidden="true" tabindex="-1"></a>Use the <span class="in">`ppl("branch")`</span> pipeline to get <span class="in">`Graphs`</span> with alternative path branching, controlled by its own hyperparameter.</span>
<span id="cb338-1381"><a href="#cb338-1381" aria-hidden="true" tabindex="-1"></a>We need to give the <span class="in">`po("branch")`</span> operators that are created here individual prefixes to avoid nameclashes when we put everything together.</span>
<span id="cb338-1382"><a href="#cb338-1382" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-063}</span></span>
<span id="cb338-1383"><a href="#cb338-1383" aria-hidden="true" tabindex="-1"></a>full_graph <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"branch"</span>,</span>
<span id="cb338-1384"><a href="#cb338-1384" aria-hidden="true" tabindex="-1"></a>    <span class="at">prefix_branchops =</span> <span class="st">"impute_"</span>, <span class="at">graphs =</span> imputing</span>
<span id="cb338-1385"><a href="#cb338-1385" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;&gt;%</span> <span class="fu">ppl</span>(<span class="st">"branch"</span>,</span>
<span id="cb338-1386"><a href="#cb338-1386" aria-hidden="true" tabindex="-1"></a>    <span class="at">prefix_branchops =</span> <span class="st">"encode_"</span>, <span class="at">graphs =</span> factor_encoding</span>
<span id="cb338-1387"><a href="#cb338-1387" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;&gt;%</span> <span class="fu">ppl</span>(<span class="st">"branch"</span>,</span>
<span id="cb338-1388"><a href="#cb338-1388" aria-hidden="true" tabindex="-1"></a>    <span class="at">prefix_branchops =</span> <span class="st">"model_"</span>, <span class="at">graphs =</span> models</span>
<span id="cb338-1389"><a href="#cb338-1389" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb338-1390"><a href="#cb338-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1391"><a href="#cb338-1391" aria-hidden="true" tabindex="-1"></a>full_graph<span class="sc">$</span><span class="fu">plot</span>()</span>
<span id="cb338-1392"><a href="#cb338-1392" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1393"><a href="#cb338-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1394"><a href="#cb338-1394" aria-hidden="true" tabindex="-1"></a>The easiest way to set up the search space for this pipeline is to use <span class="in">`to_tune()`</span>.</span>
<span id="cb338-1395"><a href="#cb338-1395" aria-hidden="true" tabindex="-1"></a>It is necessary to record the dependencies of the hyperparameters of the preprocessing and model <span class="in">`PipeOps`</span> on the branch hyperparameters.</span>
<span id="cb338-1396"><a href="#cb338-1396" aria-hidden="true" tabindex="-1"></a>For this, <span class="in">`to_tune()`</span> needs to be applied to a <span class="in">`Domain`</span> object -- <span class="in">`p_dbl()`</span>, <span class="in">`p_fct()`</span>, etc. -- that has its dependency declared using the <span class="in">`depends`</span> argument.</span>
<span id="cb338-1397"><a href="#cb338-1397" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-064}</span></span>
<span id="cb338-1398"><a href="#cb338-1398" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"paradox"</span>)</span>
<span id="cb338-1399"><a href="#cb338-1399" aria-hidden="true" tabindex="-1"></a>full_graph<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">set_values</span>(</span>
<span id="cb338-1400"><a href="#cb338-1400" aria-hidden="true" tabindex="-1"></a>  <span class="at">impute_branch.selection =</span> <span class="fu">to_tune</span>(),</span>
<span id="cb338-1401"><a href="#cb338-1401" aria-hidden="true" tabindex="-1"></a>  <span class="at">encode_branch.selection =</span> <span class="fu">to_tune</span>(),</span>
<span id="cb338-1402"><a href="#cb338-1402" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_branch.selection =</span> <span class="fu">to_tune</span>(),</span>
<span id="cb338-1403"><a href="#cb338-1403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1404"><a href="#cb338-1404" aria-hidden="true" tabindex="-1"></a>  <span class="at">encodeimpact.smoothing =</span> <span class="fu">to_tune</span>(<span class="fu">p_dbl</span>(<span class="fl">1e-3</span>, <span class="fl">1e3</span>, <span class="at">logscale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb338-1405"><a href="#cb338-1405" aria-hidden="true" tabindex="-1"></a>    <span class="at">depends =</span> encode_branch.selection <span class="sc">==</span> <span class="st">"encodeimpact"</span>)),</span>
<span id="cb338-1406"><a href="#cb338-1406" aria-hidden="true" tabindex="-1"></a>  <span class="at">encode.method =</span> <span class="fu">to_tune</span>(<span class="fu">p_fct</span>(<span class="fu">c</span>(<span class="st">"one-hot"</span>, <span class="st">"poly"</span>),</span>
<span id="cb338-1407"><a href="#cb338-1407" aria-hidden="true" tabindex="-1"></a>    <span class="at">depends =</span> encode_branch.selection <span class="sc">==</span> <span class="st">"encode"</span>)),</span>
<span id="cb338-1408"><a href="#cb338-1408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1409"><a href="#cb338-1409" aria-hidden="true" tabindex="-1"></a>  <span class="at">classif.rpart.cp =</span> <span class="fu">to_tune</span>(<span class="fu">p_dbl</span>(<span class="fl">0.001</span>, <span class="fl">0.3</span>, <span class="at">logscale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb338-1410"><a href="#cb338-1410" aria-hidden="true" tabindex="-1"></a>    <span class="at">depends =</span> model_branch.selection <span class="sc">==</span> <span class="st">"classif.rpart"</span>)),</span>
<span id="cb338-1411"><a href="#cb338-1411" aria-hidden="true" tabindex="-1"></a>  <span class="at">classif.svm.cost =</span> <span class="fu">to_tune</span>(<span class="fu">p_dbl</span>(<span class="fl">1e-5</span>, <span class="fl">1e5</span>, <span class="at">logscale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb338-1412"><a href="#cb338-1412" aria-hidden="true" tabindex="-1"></a>    <span class="at">depends =</span> model_branch.selection <span class="sc">==</span> <span class="st">"classif.svm"</span>)),</span>
<span id="cb338-1413"><a href="#cb338-1413" aria-hidden="true" tabindex="-1"></a>  <span class="at">classif.svm.gamma =</span> <span class="fu">to_tune</span>(<span class="fu">p_dbl</span>(<span class="fl">1e-5</span>, <span class="fl">1e5</span>, <span class="at">logscale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb338-1414"><a href="#cb338-1414" aria-hidden="true" tabindex="-1"></a>    <span class="at">depends =</span> model_branch.selection <span class="sc">==</span> <span class="st">"classif.svm"</span>))</span>
<span id="cb338-1415"><a href="#cb338-1415" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1416"><a href="#cb338-1416" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1417"><a href="#cb338-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1418"><a href="#cb338-1418" aria-hidden="true" tabindex="-1"></a>We also set a few SVM kernel hyperparameters record their dependency on the model selection branch hyperparameter.</span>
<span id="cb338-1419"><a href="#cb338-1419" aria-hidden="true" tabindex="-1"></a>We could record these dependencies in the <span class="in">`Graph`</span>, using the <span class="in">`$add_dep()`</span> method of the <span class="in">`r ref("ParamSet")`</span>, but here we use the simpler approach of adding a single item search space component.</span>
<span id="cb338-1420"><a href="#cb338-1420" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-065}</span></span>
<span id="cb338-1421"><a href="#cb338-1421" aria-hidden="true" tabindex="-1"></a>full_graph<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">set_values</span>(</span>
<span id="cb338-1422"><a href="#cb338-1422" aria-hidden="true" tabindex="-1"></a>  <span class="at">classif.svm.type =</span> <span class="fu">to_tune</span>(<span class="fu">p_fct</span>(<span class="st">"C-classification"</span>,</span>
<span id="cb338-1423"><a href="#cb338-1423" aria-hidden="true" tabindex="-1"></a>    <span class="at">depends =</span> model_branch.selection <span class="sc">==</span> <span class="st">"classif.svm"</span>)),</span>
<span id="cb338-1424"><a href="#cb338-1424" aria-hidden="true" tabindex="-1"></a>  <span class="at">classif.svm.kernel =</span> <span class="fu">to_tune</span>(<span class="fu">p_fct</span>(<span class="st">"radial"</span>,</span>
<span id="cb338-1425"><a href="#cb338-1425" aria-hidden="true" tabindex="-1"></a>    <span class="at">depends =</span> model_branch.selection <span class="sc">==</span> <span class="st">"classif.svm"</span>))</span>
<span id="cb338-1426"><a href="#cb338-1426" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1427"><a href="#cb338-1427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1428"><a href="#cb338-1428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1429"><a href="#cb338-1429" aria-hidden="true" tabindex="-1"></a>To turn this <span class="in">`Graph`</span> into an AutoML-system, we use an <span class="in">`AutoTuner`</span>.</span>
<span id="cb338-1430"><a href="#cb338-1430" aria-hidden="true" tabindex="-1"></a>Here we use random search, but any other <span class="in">`Tuner`</span> could be used.</span>
<span id="cb338-1431"><a href="#cb338-1431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-066}</span></span>
<span id="cb338-1432"><a href="#cb338-1432" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3tuning"</span>)</span>
<span id="cb338-1433"><a href="#cb338-1433" aria-hidden="true" tabindex="-1"></a>automl_at <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb338-1434"><a href="#cb338-1434" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>),</span>
<span id="cb338-1435"><a href="#cb338-1435" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> full_graph,</span>
<span id="cb338-1436"><a href="#cb338-1436" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">4</span>),</span>
<span id="cb338-1437"><a href="#cb338-1437" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>),</span>
<span id="cb338-1438"><a href="#cb338-1438" aria-hidden="true" tabindex="-1"></a>  <span class="at">term_evals =</span> <span class="dv">30</span></span>
<span id="cb338-1439"><a href="#cb338-1439" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1440"><a href="#cb338-1440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1441"><a href="#cb338-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1442"><a href="#cb338-1442" aria-hidden="true" tabindex="-1"></a>We can now benchmark this <span class="in">`AutoTuner`</span> on a few tasks and compare it with the untuned random forest with out-of-range (OOR) imputation:</span>
<span id="cb338-1443"><a href="#cb338-1443" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-067}</span></span>
<span id="cb338-1444"><a href="#cb338-1444" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb338-1445"><a href="#cb338-1445" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb338-1446"><a href="#cb338-1446" aria-hidden="true" tabindex="-1"></a>  automl_at,</span>
<span id="cb338-1447"><a href="#cb338-1447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_learner</span>(<span class="fu">po</span>(<span class="st">"imputeoor"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>))</span>
<span id="cb338-1448"><a href="#cb338-1448" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1449"><a href="#cb338-1449" aria-hidden="true" tabindex="-1"></a>learners[[<span class="dv">1</span>]]<span class="sc">$</span>id <span class="ot">=</span> <span class="st">"automl"</span></span>
<span id="cb338-1450"><a href="#cb338-1450" aria-hidden="true" tabindex="-1"></a>learners[[<span class="dv">2</span>]]<span class="sc">$</span>id <span class="ot">=</span> <span class="st">"ranger"</span></span>
<span id="cb338-1451"><a href="#cb338-1451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1452"><a href="#cb338-1452" aria-hidden="true" tabindex="-1"></a>tasks <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb338-1453"><a href="#cb338-1453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tsk</span>(<span class="st">"breast_cancer"</span>),</span>
<span id="cb338-1454"><a href="#cb338-1454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tsk</span>(<span class="st">"pima"</span>),</span>
<span id="cb338-1455"><a href="#cb338-1455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tsk</span>(<span class="st">"sonar"</span>)</span>
<span id="cb338-1456"><a href="#cb338-1456" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1457"><a href="#cb338-1457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1458"><a href="#cb338-1458" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>L)</span>
<span id="cb338-1459"><a href="#cb338-1459" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(tasks, <span class="at">learners =</span> learners, <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>))</span>
<span id="cb338-1460"><a href="#cb338-1460" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb338-1461"><a href="#cb338-1461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1462"><a href="#cb338-1462" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>()</span>
<span id="cb338-1463"><a href="#cb338-1463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1464"><a href="#cb338-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1465"><a href="#cb338-1465" aria-hidden="true" tabindex="-1"></a>The <span class="in">`AutoTuner`</span> performs better than the untuned random forest on <span class="in">`r switch(1 + sum(bmr$aggregate()[, .SD[learner_id != "automl"][.SD[learner_id == "automl"], on = "task_id", i.classif.ce &lt; classif.ce]]), "none of the tasks", "one task", "two tasks", "all tasks")`</span>.</span>
<span id="cb338-1466"><a href="#cb338-1466" aria-hidden="true" tabindex="-1"></a>This is, of course, a toy example to demonstrate the capabilities of <span class="in">`mlr3pipelines`</span> in combination with the <span class="in">`mlr3tuning`</span> package.</span>
<span id="cb338-1467"><a href="#cb338-1467" aria-hidden="true" tabindex="-1"></a>To use this kind of setup on real world data, one would need to take care of making the process more robust, e.g. by using the <span class="in">`ppl("robustify")`</span> pipeline, and by using fallback learners.</span>
<span id="cb338-1468"><a href="#cb338-1468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1469"><a href="#cb338-1469" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions for @sec-preprocessing</span></span>
<span id="cb338-1470"><a href="#cb338-1470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1471"><a href="#cb338-1471" aria-hidden="true" tabindex="-1"></a>We will consider a prediction problem similar to the one from this chapter, but using the King County Housing regression data instead (available with <span class="in">`tsk("kc_housing")`</span>).</span>
<span id="cb338-1472"><a href="#cb338-1472" aria-hidden="true" tabindex="-1"></a>To evaluate the models, we again use 10-fold CV, mean absolute error and <span class="in">`lrn("regr.glmnet")`</span>.</span>
<span id="cb338-1473"><a href="#cb338-1473" aria-hidden="true" tabindex="-1"></a>For now we will ignore the <span class="in">`date`</span> column and simply remove it:</span>
<span id="cb338-1474"><a href="#cb338-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1475"><a href="#cb338-1475" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-068}</span></span>
<span id="cb338-1476"><a href="#cb338-1476" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-1477"><a href="#cb338-1477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1478"><a href="#cb338-1478" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3data"</span>)</span>
<span id="cb338-1479"><a href="#cb338-1479" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"kc_housing"</span>)</span>
<span id="cb338-1480"><a href="#cb338-1480" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">select</span>(<span class="fu">setdiff</span>(task<span class="sc">$</span>feature_names, <span class="st">"date"</span>))</span>
<span id="cb338-1481"><a href="#cb338-1481" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1482"><a href="#cb338-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1483"><a href="#cb338-1483" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Have a look at the features, are there any features which might be problematic? If so, change or remove them.</span>
<span id="cb338-1484"><a href="#cb338-1484" aria-hidden="true" tabindex="-1"></a>  Check the dataset and learner properties to understand which preprocessing steps you need to do.</span>
<span id="cb338-1485"><a href="#cb338-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1486"><a href="#cb338-1486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-069}</span></span>
<span id="cb338-1487"><a href="#cb338-1487" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(task)</span>
<span id="cb338-1488"><a href="#cb338-1488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1489"><a href="#cb338-1489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1490"><a href="#cb338-1490" aria-hidden="true" tabindex="-1"></a>The <span class="in">`zipcode`</span> should not be interpreted as a numeric value, so we cast it to a factor.</span>
<span id="cb338-1491"><a href="#cb338-1491" aria-hidden="true" tabindex="-1"></a>We could argue to remove <span class="in">`lat`</span> and <span class="in">`long`</span> as handling them as linear effects is not necessarily a suitable, but we will keep them since <span class="in">`glmnet`</span> performs internal feature selection anyways.</span>
<span id="cb338-1492"><a href="#cb338-1492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1493"><a href="#cb338-1493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-070, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1494"><a href="#cb338-1494" aria-hidden="true" tabindex="-1"></a>zipencode <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"mutate"</span>, <span class="at">mutation =</span> <span class="fu">list</span>(<span class="at">zipcode =</span> <span class="sc">~</span> <span class="fu">as.factor</span>(zipcode)), <span class="at">id =</span> <span class="st">"zipencode"</span>)</span>
<span id="cb338-1495"><a href="#cb338-1495" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1496"><a href="#cb338-1496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1497"><a href="#cb338-1497" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Build a suitable pipeline that allows <span class="in">`glmnet`</span> to be trained on the dataset.</span>
<span id="cb338-1498"><a href="#cb338-1498" aria-hidden="true" tabindex="-1"></a>  Construct a new <span class="in">`glmnet`</span> model with <span class="in">`ppl("robustify")`</span>.</span>
<span id="cb338-1499"><a href="#cb338-1499" aria-hidden="true" tabindex="-1"></a>  Compare the two pipelines in a benchmark experiment.</span>
<span id="cb338-1500"><a href="#cb338-1500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1501"><a href="#cb338-1501" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-071, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1502"><a href="#cb338-1502" aria-hidden="true" tabindex="-1"></a>lrn_glmnet <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.glmnet"</span>)</span>
<span id="cb338-1503"><a href="#cb338-1503" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1504"><a href="#cb338-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1505"><a href="#cb338-1505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-072, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1506"><a href="#cb338-1506" aria-hidden="true" tabindex="-1"></a>graph_preproc <span class="ot">=</span></span>
<span id="cb338-1507"><a href="#cb338-1507" aria-hidden="true" tabindex="-1"></a>  zipencode <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1508"><a href="#cb338-1508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"fixfactors"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1509"><a href="#cb338-1509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"encodeimpact"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1510"><a href="#cb338-1510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb338-1511"><a href="#cb338-1511" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"missind"</span>, <span class="at">type =</span> <span class="st">"integer"</span>, <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="st">"integer"</span>)),</span>
<span id="cb338-1512"><a href="#cb338-1512" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"imputehist"</span>, <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="st">"integer"</span>))) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1513"><a href="#cb338-1513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"featureunion"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1514"><a href="#cb338-1514" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"imputeoor"</span>, <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="st">"factor"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1515"><a href="#cb338-1515" aria-hidden="true" tabindex="-1"></a>  lrn_glmnet</span>
<span id="cb338-1516"><a href="#cb338-1516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1517"><a href="#cb338-1517" aria-hidden="true" tabindex="-1"></a>graph_preproc<span class="sc">$</span><span class="fu">plot</span>()</span>
<span id="cb338-1518"><a href="#cb338-1518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1519"><a href="#cb338-1519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1520"><a href="#cb338-1520" aria-hidden="true" tabindex="-1"></a><span class="in">`glmnet`</span> does not support factors or missing values.</span>
<span id="cb338-1521"><a href="#cb338-1521" aria-hidden="true" tabindex="-1"></a>So our pipeline needs to handle both.</span>
<span id="cb338-1522"><a href="#cb338-1522" aria-hidden="true" tabindex="-1"></a>First we fix the factor levels to ensure that all 70 zipcodes are fixed.</span>
<span id="cb338-1523"><a href="#cb338-1523" aria-hidden="true" tabindex="-1"></a>We can consider 70 levels high cardinality, so we use impact encoding.</span>
<span id="cb338-1524"><a href="#cb338-1524" aria-hidden="true" tabindex="-1"></a>We use the same imputation strategy as in @sec-preprocessing.</span>
<span id="cb338-1525"><a href="#cb338-1525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1526"><a href="#cb338-1526" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-073, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1527"><a href="#cb338-1527" aria-hidden="true" tabindex="-1"></a>graph_robustify <span class="ot">=</span></span>
<span id="cb338-1528"><a href="#cb338-1528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pipeline_robustify</span>(<span class="at">task =</span> task, <span class="at">learner =</span> lrn_glmnet) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1529"><a href="#cb338-1529" aria-hidden="true" tabindex="-1"></a>  lrn_glmnet</span>
<span id="cb338-1530"><a href="#cb338-1530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1531"><a href="#cb338-1531" aria-hidden="true" tabindex="-1"></a>graph_robustify<span class="sc">$</span><span class="fu">plot</span>()</span>
<span id="cb338-1532"><a href="#cb338-1532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1533"><a href="#cb338-1533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1534"><a href="#cb338-1534" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-074}</span></span>
<span id="cb338-1535"><a href="#cb338-1535" aria-hidden="true" tabindex="-1"></a>glrn_preproc <span class="ot">=</span> <span class="fu">as_learner</span>(graph_preproc, <span class="at">id =</span> <span class="st">"glmnet_preproc"</span>)</span>
<span id="cb338-1536"><a href="#cb338-1536" aria-hidden="true" tabindex="-1"></a>glrn_robustify <span class="ot">=</span> <span class="fu">as_learner</span>(graph_robustify, <span class="at">id =</span> <span class="st">"glmnet_robustify"</span>)</span>
<span id="cb338-1537"><a href="#cb338-1537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1538"><a href="#cb338-1538" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb338-1539"><a href="#cb338-1539" aria-hidden="true" tabindex="-1"></a>  <span class="at">tasks =</span> task,</span>
<span id="cb338-1540"><a href="#cb338-1540" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> <span class="fu">list</span>(glrn_preproc, glrn_robustify),</span>
<span id="cb338-1541"><a href="#cb338-1541" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb338-1542"><a href="#cb338-1542" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1543"><a href="#cb338-1543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1544"><a href="#cb338-1544" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb338-1545"><a href="#cb338-1545" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"regr.rmse"</span>))</span>
<span id="cb338-1546"><a href="#cb338-1546" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1547"><a href="#cb338-1547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1548"><a href="#cb338-1548" aria-hidden="true" tabindex="-1"></a>Our preprocessing pipeline performs slightly better than the robustified one.</span>
<span id="cb338-1549"><a href="#cb338-1549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1550"><a href="#cb338-1550" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Now consider the <span class="in">`date`</span> feature:</span>
<span id="cb338-1551"><a href="#cb338-1551" aria-hidden="true" tabindex="-1"></a>  How can you extract information from this feature in a way that <span class="in">`glmnet`</span> can use?</span>
<span id="cb338-1552"><a href="#cb338-1552" aria-hidden="true" tabindex="-1"></a>  Does this improve the performance of your pipeline?</span>
<span id="cb338-1553"><a href="#cb338-1553" aria-hidden="true" tabindex="-1"></a>  Finally, consider the spatial nature of the dataset.</span>
<span id="cb338-1554"><a href="#cb338-1554" aria-hidden="true" tabindex="-1"></a>  Can you extract an additional feature from the lat / long coordinates?</span>
<span id="cb338-1555"><a href="#cb338-1555" aria-hidden="true" tabindex="-1"></a>  (Hint: Downtown Seattle has lat/long coordinates <span class="in">`47.605`</span>/<span class="in">`122.334`</span>).</span>
<span id="cb338-1556"><a href="#cb338-1556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1557"><a href="#cb338-1557" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-075, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1558"><a href="#cb338-1558" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"kc_housing"</span>)</span>
<span id="cb338-1559"><a href="#cb338-1559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1560"><a href="#cb338-1560" aria-hidden="true" tabindex="-1"></a>graph_mutate <span class="ot">=</span></span>
<span id="cb338-1561"><a href="#cb338-1561" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"mutate"</span>, <span class="at">mutation =</span> <span class="fu">list</span>(</span>
<span id="cb338-1562"><a href="#cb338-1562" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="sc">~</span> <span class="fu">as.numeric</span>(date),</span>
<span id="cb338-1563"><a href="#cb338-1563" aria-hidden="true" tabindex="-1"></a>    <span class="at">distance_downtown =</span> <span class="sc">~</span> <span class="fu">sqrt</span>((lat <span class="sc">-</span> <span class="fl">47.605</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (long  <span class="sc">+</span> <span class="fl">122.334</span>)<span class="sc">^</span><span class="dv">2</span>))) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1564"><a href="#cb338-1564" aria-hidden="true" tabindex="-1"></a>  zipencode <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1565"><a href="#cb338-1565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"encodeimpact"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1566"><a href="#cb338-1566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb338-1567"><a href="#cb338-1567" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"missind"</span>, <span class="at">type =</span> <span class="st">"integer"</span>, <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="st">"integer"</span>)),</span>
<span id="cb338-1568"><a href="#cb338-1568" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"imputehist"</span>, <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="st">"integer"</span>))) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1569"><a href="#cb338-1569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"featureunion"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1570"><a href="#cb338-1570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"imputeoor"</span>, <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="st">"factor"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1571"><a href="#cb338-1571" aria-hidden="true" tabindex="-1"></a>  lrn_glmnet</span>
<span id="cb338-1572"><a href="#cb338-1572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1573"><a href="#cb338-1573" aria-hidden="true" tabindex="-1"></a>glrn_mutate <span class="ot">=</span> <span class="fu">as_learner</span>(graph_mutate)</span>
<span id="cb338-1574"><a href="#cb338-1574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1575"><a href="#cb338-1575" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb338-1576"><a href="#cb338-1576" aria-hidden="true" tabindex="-1"></a>  <span class="at">tasks =</span> task,</span>
<span id="cb338-1577"><a href="#cb338-1577" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> glrn_mutate,</span>
<span id="cb338-1578"><a href="#cb338-1578" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb338-1579"><a href="#cb338-1579" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1580"><a href="#cb338-1580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1581"><a href="#cb338-1581" aria-hidden="true" tabindex="-1"></a>bmr_2 <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb338-1582"><a href="#cb338-1582" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">combine</span>(bmr_2)</span>
<span id="cb338-1583"><a href="#cb338-1583" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"regr.mae"</span>))</span>
<span id="cb338-1584"><a href="#cb338-1584" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1585"><a href="#cb338-1585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1586"><a href="#cb338-1586" aria-hidden="true" tabindex="-1"></a>We simply convert the <span class="in">`date`</span> feature into a numeric timestamp so that <span class="in">`glmnet`</span> can handle the feature.</span>
<span id="cb338-1587"><a href="#cb338-1587" aria-hidden="true" tabindex="-1"></a>We create one additional feature as the distance to downtown Seattle.</span>
<span id="cb338-1588"><a href="#cb338-1588" aria-hidden="true" tabindex="-1"></a>This improves the average error of our model by a further 1400$.</span>
<span id="cb338-1589"><a href="#cb338-1589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1590"><a href="#cb338-1590" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-technical</span></span>
<span id="cb338-1591"><a href="#cb338-1591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1592"><a href="#cb338-1592" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Consider the following example where you resample a learner (debug learner, sleeps for 3 seconds during <span class="in">`$train()`</span>) on 4 workers using the multisession backend:</span>
<span id="cb338-1593"><a href="#cb338-1593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1594"><a href="#cb338-1594" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-076}</span></span>
<span id="cb338-1595"><a href="#cb338-1595" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"penguins"</span>)</span>
<span id="cb338-1596"><a href="#cb338-1596" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.debug"</span>, <span class="at">sleep_train =</span> <span class="cf">function</span>() <span class="dv">3</span>)</span>
<span id="cb338-1597"><a href="#cb338-1597" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">6</span>)</span>
<span id="cb338-1598"><a href="#cb338-1598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1599"><a href="#cb338-1599" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"multisession"</span>, <span class="at">workers =</span> <span class="dv">4</span>)</span>
<span id="cb338-1600"><a href="#cb338-1600" aria-hidden="true" tabindex="-1"></a><span class="fu">resample</span>(task, learner, resampling)</span>
<span id="cb338-1601"><a href="#cb338-1601" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1602"><a href="#cb338-1602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1603"><a href="#cb338-1603" aria-hidden="true" tabindex="-1"></a>i. Assuming that the learner would actually calculate something and not just sleep: Would all CPUs be busy?</span>
<span id="cb338-1604"><a href="#cb338-1604" aria-hidden="true" tabindex="-1"></a>ii. Prove your point by measuring the elapsed time, e.g., using <span class="in">`r ref("system.time()")`</span>.</span>
<span id="cb338-1605"><a href="#cb338-1605" aria-hidden="true" tabindex="-1"></a>iii. What would you change in the setup and why?</span>
<span id="cb338-1606"><a href="#cb338-1606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1607"><a href="#cb338-1607" aria-hidden="true" tabindex="-1"></a>Not all CPUs would be utilized for the whole duration.</span>
<span id="cb338-1608"><a href="#cb338-1608" aria-hidden="true" tabindex="-1"></a>All 4 of them are occupied for the first 4 iterations of the cross-validation.</span>
<span id="cb338-1609"><a href="#cb338-1609" aria-hidden="true" tabindex="-1"></a>The 5th iteration, however, only runs in parallel to the 6th fold, leaving 2 cores idle.</span>
<span id="cb338-1610"><a href="#cb338-1610" aria-hidden="true" tabindex="-1"></a>This is supported by the elapsed time of roughly 6 seconds for 6 jobs compared to also roughly 6 seconds for 8 jobs:</span>
<span id="cb338-1611"><a href="#cb338-1611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1612"><a href="#cb338-1612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-077}</span></span>
<span id="cb338-1613"><a href="#cb338-1613" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"penguins"</span>)</span>
<span id="cb338-1614"><a href="#cb338-1614" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.debug"</span>, <span class="at">sleep_train =</span> <span class="cf">function</span>() <span class="dv">3</span>)</span>
<span id="cb338-1615"><a href="#cb338-1615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1616"><a href="#cb338-1616" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"multisession"</span>, <span class="at">workers =</span> <span class="dv">4</span>)</span>
<span id="cb338-1617"><a href="#cb338-1617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1618"><a href="#cb338-1618" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">6</span>)</span>
<span id="cb338-1619"><a href="#cb338-1619" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">resample</span>(task, learner, resampling))</span>
<span id="cb338-1620"><a href="#cb338-1620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1621"><a href="#cb338-1621" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">8</span>)</span>
<span id="cb338-1622"><a href="#cb338-1622" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">resample</span>(task, learner, resampling))</span>
<span id="cb338-1623"><a href="#cb338-1623" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1624"><a href="#cb338-1624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1625"><a href="#cb338-1625" aria-hidden="true" tabindex="-1"></a>If possible, the number of resampling iterations should be an integer multiple of the number of workers.</span>
<span id="cb338-1626"><a href="#cb338-1626" aria-hidden="true" tabindex="-1"></a>Therefore, a simple adaptation either increases the number of folds for improved accuracy of the error estimate or reduces the number of folds for improved runtime.</span>
<span id="cb338-1627"><a href="#cb338-1627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1628"><a href="#cb338-1628" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Create a new custom binary classification measure which scores ("prob"-type) predictions.</span>
<span id="cb338-1629"><a href="#cb338-1629" aria-hidden="true" tabindex="-1"></a>  This measure should compute the absolute difference between the predicted probability for the positive class and a 0-1 encoding of the ground truth and then average these values across the test set.</span>
<span id="cb338-1630"><a href="#cb338-1630" aria-hidden="true" tabindex="-1"></a>  Test this with <span class="in">`classif.log_reg`</span> on <span class="in">`tsk("sonar")`</span>.</span>
<span id="cb338-1631"><a href="#cb338-1631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1632"><a href="#cb338-1632" aria-hidden="true" tabindex="-1"></a>The rules can easily be translated to R code where we first convert select the predicted probabilities for the positive class, 0-1 encode the truth vector and then calculate the mean absolute error between the two vectors.</span>
<span id="cb338-1633"><a href="#cb338-1633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1634"><a href="#cb338-1634" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-078}</span></span>
<span id="cb338-1635"><a href="#cb338-1635" aria-hidden="true" tabindex="-1"></a>mae_prob <span class="ot">=</span> <span class="cf">function</span>(truth, prob, task) {</span>
<span id="cb338-1636"><a href="#cb338-1636" aria-hidden="true" tabindex="-1"></a>  <span class="co"># retrieve positive class from task</span></span>
<span id="cb338-1637"><a href="#cb338-1637" aria-hidden="true" tabindex="-1"></a>  positive <span class="ot">=</span> task<span class="sc">$</span>positive</span>
<span id="cb338-1638"><a href="#cb338-1638" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select positive class probabilities</span></span>
<span id="cb338-1639"><a href="#cb338-1639" aria-hidden="true" tabindex="-1"></a>  prob_positive <span class="ot">=</span> prob[, positive]</span>
<span id="cb338-1640"><a href="#cb338-1640" aria-hidden="true" tabindex="-1"></a>  <span class="co"># obtain 0-1 encoding of truth</span></span>
<span id="cb338-1641"><a href="#cb338-1641" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">as.integer</span>(truth <span class="sc">==</span> positive)</span>
<span id="cb338-1642"><a href="#cb338-1642" aria-hidden="true" tabindex="-1"></a>  <span class="co"># average the absolute difference</span></span>
<span id="cb338-1643"><a href="#cb338-1643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">abs</span>(prob_positive <span class="sc">-</span> y))</span>
<span id="cb338-1644"><a href="#cb338-1644" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-1645"><a href="#cb338-1645" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1646"><a href="#cb338-1646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1647"><a href="#cb338-1647" aria-hidden="true" tabindex="-1"></a>This function can be embedded in the <span class="in">`Measure`</span> class accordingly.</span>
<span id="cb338-1648"><a href="#cb338-1648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1649"><a href="#cb338-1649" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-079}</span></span>
<span id="cb338-1650"><a href="#cb338-1650" aria-hidden="true" tabindex="-1"></a>MeasureMaeProb <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"MeasureMaeProb"</span>,</span>
<span id="cb338-1651"><a href="#cb338-1651" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3<span class="sc">::</span>MeasureClassif, <span class="co"># classification measure</span></span>
<span id="cb338-1652"><a href="#cb338-1652" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb338-1653"><a href="#cb338-1653" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() { <span class="co"># initialize class</span></span>
<span id="cb338-1654"><a href="#cb338-1654" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>( <span class="co"># initialize method of parent class</span></span>
<span id="cb338-1655"><a href="#cb338-1655" aria-hidden="true" tabindex="-1"></a>        <span class="at">id =</span> <span class="st">"mae_prob"</span>, <span class="co"># unique ID</span></span>
<span id="cb338-1656"><a href="#cb338-1656" aria-hidden="true" tabindex="-1"></a>        <span class="at">packages =</span> <span class="fu">character</span>(), <span class="co"># no dependencies</span></span>
<span id="cb338-1657"><a href="#cb338-1657" aria-hidden="true" tabindex="-1"></a>        <span class="at">properties =</span> <span class="st">"requires_task"</span>, <span class="co"># needs access to task for positive class</span></span>
<span id="cb338-1658"><a href="#cb338-1658" aria-hidden="true" tabindex="-1"></a>        <span class="at">predict_type =</span> <span class="st">"prob"</span>, <span class="co"># measures probability prediction</span></span>
<span id="cb338-1659"><a href="#cb338-1659" aria-hidden="true" tabindex="-1"></a>        <span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="co"># results in values between [0, 1]</span></span>
<span id="cb338-1660"><a href="#cb338-1660" aria-hidden="true" tabindex="-1"></a>        <span class="at">minimize =</span> <span class="cn">TRUE</span> <span class="co"># smaller values are better</span></span>
<span id="cb338-1661"><a href="#cb338-1661" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb338-1662"><a href="#cb338-1662" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb338-1663"><a href="#cb338-1663" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb338-1664"><a href="#cb338-1664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1665"><a href="#cb338-1665" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb338-1666"><a href="#cb338-1666" aria-hidden="true" tabindex="-1"></a>    <span class="at">.score =</span> <span class="cf">function</span>(prediction, task, ...) { <span class="co"># define score as private method</span></span>
<span id="cb338-1667"><a href="#cb338-1667" aria-hidden="true" tabindex="-1"></a>      <span class="co"># call loss function</span></span>
<span id="cb338-1668"><a href="#cb338-1668" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mae_prob</span>(prediction<span class="sc">$</span>truth, prediction<span class="sc">$</span>prob, task)</span>
<span id="cb338-1669"><a href="#cb338-1669" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb338-1670"><a href="#cb338-1670" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb338-1671"><a href="#cb338-1671" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1672"><a href="#cb338-1672" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1673"><a href="#cb338-1673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1674"><a href="#cb338-1674" aria-hidden="true" tabindex="-1"></a>Because this is a custom class that is not available in the <span class="in">`mlr_measures`</span> dictionary, we have to create a new instance using the <span class="in">`$new()`</span> constructor.</span>
<span id="cb338-1675"><a href="#cb338-1675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1676"><a href="#cb338-1676" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-080}</span></span>
<span id="cb338-1677"><a href="#cb338-1677" aria-hidden="true" tabindex="-1"></a>msr_mae_prob <span class="ot">=</span> MeasureMaeProb<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb338-1678"><a href="#cb338-1678" aria-hidden="true" tabindex="-1"></a>msr_mae_prob</span>
<span id="cb338-1679"><a href="#cb338-1679" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1680"><a href="#cb338-1680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1681"><a href="#cb338-1681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1682"><a href="#cb338-1682" aria-hidden="true" tabindex="-1"></a>To try this measure, we resample a logistic regression on the sonar task using five-fold cross-validation.</span>
<span id="cb338-1683"><a href="#cb338-1683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1684"><a href="#cb338-1684" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-081}</span></span>
<span id="cb338-1685"><a href="#cb338-1685" aria-hidden="true" tabindex="-1"></a><span class="co"># predict_type is set to "prob", as otherwise our measure does not work</span></span>
<span id="cb338-1686"><a href="#cb338-1686" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb338-1687"><a href="#cb338-1687" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>)</span>
<span id="cb338-1688"><a href="#cb338-1688" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(task, learner, <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>))</span>
<span id="cb338-1689"><a href="#cb338-1689" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1690"><a href="#cb338-1690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1691"><a href="#cb338-1691" aria-hidden="true" tabindex="-1"></a>We now score the resample result using our custom measure and <span class="in">`msr("classif.acc")`</span>.</span>
<span id="cb338-1692"><a href="#cb338-1692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1693"><a href="#cb338-1693" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-082}</span></span>
<span id="cb338-1694"><a href="#cb338-1694" aria-hidden="true" tabindex="-1"></a>score <span class="ot">=</span> rr<span class="sc">$</span><span class="fu">score</span>(<span class="fu">list</span>(msr_mae_prob, <span class="fu">msr</span>(<span class="st">"classif.acc"</span>)))</span>
<span id="cb338-1695"><a href="#cb338-1695" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1696"><a href="#cb338-1696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1697"><a href="#cb338-1697" aria-hidden="true" tabindex="-1"></a>In this case, there is a clear relationship between the classification accuracy and our custom measure, i.e. the higher the accuracy, the lower the mean absolute error of the predicted probabilities.</span>
<span id="cb338-1698"><a href="#cb338-1698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1699"><a href="#cb338-1699" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-083}</span></span>
<span id="cb338-1700"><a href="#cb338-1700" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(score<span class="sc">$</span>mae_prob, score<span class="sc">$</span>classif.acc)</span>
<span id="cb338-1701"><a href="#cb338-1701" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1702"><a href="#cb338-1702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1703"><a href="#cb338-1703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1704"><a href="#cb338-1704" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>"Tune" the <span class="in">`error_train`</span> hyperparameter of the <span class="in">`classif.debug`</span> learner on a continuous interval from 0 to 1, using a simple classification tree as the fallback learner and the penguins task.</span>
<span id="cb338-1705"><a href="#cb338-1705" aria-hidden="true" tabindex="-1"></a>  Tune for 50 iterations using random search and 10-fold cross-validation.</span>
<span id="cb338-1706"><a href="#cb338-1706" aria-hidden="true" tabindex="-1"></a>  Inspect the resulting archive and find out which evaluations resulted in an error, and which did not.</span>
<span id="cb338-1707"><a href="#cb338-1707" aria-hidden="true" tabindex="-1"></a>  Now do the same in the interval 0.3 to 0.7.</span>
<span id="cb338-1708"><a href="#cb338-1708" aria-hidden="true" tabindex="-1"></a>  Are your results surprising?</span>
<span id="cb338-1709"><a href="#cb338-1709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1710"><a href="#cb338-1710" aria-hidden="true" tabindex="-1"></a>First, we create the learner that we want to tune, mark the relevant parameter for tuning and set the fallback learner to a classification tree.</span>
<span id="cb338-1711"><a href="#cb338-1711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1712"><a href="#cb338-1712" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-084}</span></span>
<span id="cb338-1713"><a href="#cb338-1713" aria-hidden="true" tabindex="-1"></a>lrn_debug <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.debug"</span>,</span>
<span id="cb338-1714"><a href="#cb338-1714" aria-hidden="true" tabindex="-1"></a>  <span class="at">error_train =</span> <span class="fu">to_tune</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb338-1715"><a href="#cb338-1715" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1716"><a href="#cb338-1716" aria-hidden="true" tabindex="-1"></a>lrn_debug<span class="sc">$</span><span class="fu">encapsulate</span>(<span class="st">"evaluate"</span>, <span class="at">fallback =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span>
<span id="cb338-1717"><a href="#cb338-1717" aria-hidden="true" tabindex="-1"></a>lrn_debug</span>
<span id="cb338-1718"><a href="#cb338-1718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1719"><a href="#cb338-1719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1720"><a href="#cb338-1720" aria-hidden="true" tabindex="-1"></a>This example is unusual, because we expect better results from the fallback classification tree than from the primary debug learner, which predicts the mode of the target distribution.</span>
<span id="cb338-1721"><a href="#cb338-1721" aria-hidden="true" tabindex="-1"></a>Nonetheless it serves as a good example to illustrate the effects of training errors on the tuning results.</span>
<span id="cb338-1722"><a href="#cb338-1722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1723"><a href="#cb338-1723" aria-hidden="true" tabindex="-1"></a>We proceed with optimizing the classification accuracy of the learner on the penguins task.</span>
<span id="cb338-1724"><a href="#cb338-1724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1725"><a href="#cb338-1725" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-085}</span></span>
<span id="cb338-1726"><a href="#cb338-1726" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> <span class="fu">tune</span>(</span>
<span id="cb338-1727"><a href="#cb338-1727" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span>  lrn_debug,</span>
<span id="cb338-1728"><a href="#cb338-1728" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> <span class="fu">tsk</span>(<span class="st">"penguins"</span>),</span>
<span id="cb338-1729"><a href="#cb338-1729" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>),</span>
<span id="cb338-1730"><a href="#cb338-1730" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>),</span>
<span id="cb338-1731"><a href="#cb338-1731" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>),</span>
<span id="cb338-1732"><a href="#cb338-1732" aria-hidden="true" tabindex="-1"></a>  <span class="at">term_evals =</span> <span class="dv">50</span></span>
<span id="cb338-1733"><a href="#cb338-1733" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1734"><a href="#cb338-1734" aria-hidden="true" tabindex="-1"></a>instance</span>
<span id="cb338-1735"><a href="#cb338-1735" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1736"><a href="#cb338-1736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1737"><a href="#cb338-1737" aria-hidden="true" tabindex="-1"></a>To find out which evaluations resulted in an error, we can inspect the <span class="in">`$archive`</span> slot of the instance, which we convert to a <span class="in">`data.table`</span> for easier filtering.</span>
<span id="cb338-1738"><a href="#cb338-1738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1739"><a href="#cb338-1739" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-086}</span></span>
<span id="cb338-1740"><a href="#cb338-1740" aria-hidden="true" tabindex="-1"></a>archive <span class="ot">=</span> <span class="fu">as.data.table</span>(instance<span class="sc">$</span>archive)</span>
<span id="cb338-1741"><a href="#cb338-1741" aria-hidden="true" tabindex="-1"></a>archive[, <span class="fu">c</span>(<span class="st">"error_train"</span>, <span class="st">"classif.acc"</span>, <span class="st">"errors"</span>)]</span>
<span id="cb338-1742"><a href="#cb338-1742" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1743"><a href="#cb338-1743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1744"><a href="#cb338-1744" aria-hidden="true" tabindex="-1"></a>Below, we visualize the relationship between the error probabilty and the classification accuracy.</span>
<span id="cb338-1745"><a href="#cb338-1745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1746"><a href="#cb338-1746" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-087}</span></span>
<span id="cb338-1747"><a href="#cb338-1747" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> archive, <span class="fu">aes</span>(<span class="at">x =</span> error_train, <span class="at">y =</span> classif.acc, <span class="at">color =</span> errors)) <span class="sc">+</span></span>
<span id="cb338-1748"><a href="#cb338-1748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb338-1749"><a href="#cb338-1749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb338-1750"><a href="#cb338-1750" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1751"><a href="#cb338-1751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1752"><a href="#cb338-1752" aria-hidden="true" tabindex="-1"></a>Higher values for <span class="in">`error_train`</span> lead to more resampling iterations using the classification tree fallback learner and therefore to better classification accuracies.</span>
<span id="cb338-1753"><a href="#cb338-1753" aria-hidden="true" tabindex="-1"></a>Therefore, the best found hyperparameter configurations will tend to have values of <span class="in">`error_train`</span> close to 1.</span>
<span id="cb338-1754"><a href="#cb338-1754" aria-hidden="true" tabindex="-1"></a>When multiple parameter configurations have the same test performance, the first one is chosen by <span class="in">`$result_learner_param_vals`</span>.</span>
<span id="cb338-1755"><a href="#cb338-1755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1756"><a href="#cb338-1756" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-088}</span></span>
<span id="cb338-1757"><a href="#cb338-1757" aria-hidden="true" tabindex="-1"></a>instance<span class="sc">$</span>result_learner_param_vals</span>
<span id="cb338-1758"><a href="#cb338-1758" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1759"><a href="#cb338-1759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1760"><a href="#cb338-1760" aria-hidden="true" tabindex="-1"></a>We repeat the same experiment for the tuning interval from 0.3 to 0.7.</span>
<span id="cb338-1761"><a href="#cb338-1761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1762"><a href="#cb338-1762" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-089}</span></span>
<span id="cb338-1763"><a href="#cb338-1763" aria-hidden="true" tabindex="-1"></a>lrn_debug<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">set_values</span>(</span>
<span id="cb338-1764"><a href="#cb338-1764" aria-hidden="true" tabindex="-1"></a>  <span class="at">error_train =</span> <span class="fu">to_tune</span>(<span class="fl">0.3</span>, <span class="fl">0.7</span>)</span>
<span id="cb338-1765"><a href="#cb338-1765" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1766"><a href="#cb338-1766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1767"><a href="#cb338-1767" aria-hidden="true" tabindex="-1"></a>instance2 <span class="ot">=</span> <span class="fu">tune</span>(</span>
<span id="cb338-1768"><a href="#cb338-1768" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span>  lrn_debug,</span>
<span id="cb338-1769"><a href="#cb338-1769" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> <span class="fu">tsk</span>(<span class="st">"penguins"</span>),</span>
<span id="cb338-1770"><a href="#cb338-1770" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>),</span>
<span id="cb338-1771"><a href="#cb338-1771" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>),</span>
<span id="cb338-1772"><a href="#cb338-1772" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>),</span>
<span id="cb338-1773"><a href="#cb338-1773" aria-hidden="true" tabindex="-1"></a>  <span class="at">term_evals =</span> <span class="dv">50</span></span>
<span id="cb338-1774"><a href="#cb338-1774" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-1775"><a href="#cb338-1775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1776"><a href="#cb338-1776" aria-hidden="true" tabindex="-1"></a>archive2 <span class="ot">=</span> <span class="fu">as.data.table</span>(instance2<span class="sc">$</span>archive)</span>
<span id="cb338-1777"><a href="#cb338-1777" aria-hidden="true" tabindex="-1"></a>instance2</span>
<span id="cb338-1778"><a href="#cb338-1778" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1779"><a href="#cb338-1779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1780"><a href="#cb338-1780" aria-hidden="true" tabindex="-1"></a>As before, higher error probabilities during training lead to higher classification accuracies.</span>
<span id="cb338-1781"><a href="#cb338-1781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1782"><a href="#cb338-1782" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-090}</span></span>
<span id="cb338-1783"><a href="#cb338-1783" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> archive2, <span class="fu">aes</span>(<span class="at">x =</span> error_train, <span class="at">y =</span> classif.acc, <span class="at">color =</span> errors)) <span class="sc">+</span></span>
<span id="cb338-1784"><a href="#cb338-1784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb338-1785"><a href="#cb338-1785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb338-1786"><a href="#cb338-1786" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1787"><a href="#cb338-1787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1788"><a href="#cb338-1788" aria-hidden="true" tabindex="-1"></a>However, the best found configurations for the <span class="in">`error_train`</span> parameter, now tend to be close to 0.7 instead of 1 as before.</span>
<span id="cb338-1789"><a href="#cb338-1789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1790"><a href="#cb338-1790" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-091}</span></span>
<span id="cb338-1791"><a href="#cb338-1791" aria-hidden="true" tabindex="-1"></a>instance2<span class="sc">$</span>result_learner_param_vals</span>
<span id="cb338-1792"><a href="#cb338-1792" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1793"><a href="#cb338-1793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1794"><a href="#cb338-1794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1795"><a href="#cb338-1795" aria-hidden="true" tabindex="-1"></a>This demonstrates that when utilizing a fallback learner, the tuning results are influenced not only by the direct impact of the tuning parameters on the primary learner but also by their effect on its error probability.</span>
<span id="cb338-1796"><a href="#cb338-1796" aria-hidden="true" tabindex="-1"></a>Therefore, it is always advisable to manually inspect the tuning results afterward.</span>
<span id="cb338-1797"><a href="#cb338-1797" aria-hidden="true" tabindex="-1"></a>Note that in most real-world scenarios, the fallback learner performs worse than the primary learner, and thus the effects illustrated here are usually reversed.</span>
<span id="cb338-1798"><a href="#cb338-1798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1799"><a href="#cb338-1799" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-large-benchmarking</span></span>
<span id="cb338-1800"><a href="#cb338-1800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1801"><a href="#cb338-1801" aria-hidden="true" tabindex="-1"></a>{{&lt; include ./solutions_large-scale_benchmarking.qmd &gt;}}</span>
<span id="cb338-1802"><a href="#cb338-1802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1803"><a href="#cb338-1803" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-interpretation</span></span>
<span id="cb338-1804"><a href="#cb338-1804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1805"><a href="#cb338-1805" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Prepare a <span class="in">`mlr3`</span> regression task for <span class="in">`fifa`</span> data. Select only variables describing the age and skills of footballers. Train any predictive model for this task, e.g. <span class="in">`lrn("regr.ranger")`</span>.</span>
<span id="cb338-1806"><a href="#cb338-1806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1807"><a href="#cb338-1807" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-092, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1808"><a href="#cb338-1808" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DALEX)</span>
<span id="cb338-1809"><a href="#cb338-1809" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb338-1810"><a href="#cb338-1810" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"fifa"</span>, <span class="at">package =</span> <span class="st">"DALEX"</span>)</span>
<span id="cb338-1811"><a href="#cb338-1811" aria-hidden="true" tabindex="-1"></a>old_theme <span class="ot">=</span> <span class="fu">set_theme_dalex</span>(<span class="st">"ema"</span>)</span>
<span id="cb338-1812"><a href="#cb338-1812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1813"><a href="#cb338-1813" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3)</span>
<span id="cb338-1814"><a href="#cb338-1814" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3learners)</span>
<span id="cb338-1815"><a href="#cb338-1815" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-1816"><a href="#cb338-1816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1817"><a href="#cb338-1817" aria-hidden="true" tabindex="-1"></a>feat_of_interest <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"skill_ball_control"</span>, <span class="st">"skill_curve"</span>, <span class="st">"skill_dribbling"</span>,  <span class="st">"skill_fk_accuracy"</span>, <span class="st">"skill_long_passing"</span>, <span class="st">"value_eur"</span>)</span>
<span id="cb338-1818"><a href="#cb338-1818" aria-hidden="true" tabindex="-1"></a>fifa20 <span class="ot">=</span> fifa[,feat_of_interest]</span>
<span id="cb338-1819"><a href="#cb338-1819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1820"><a href="#cb338-1820" aria-hidden="true" tabindex="-1"></a>task_fifa <span class="ot">=</span> <span class="fu">as_task_regr</span>(fifa20, <span class="at">target =</span> <span class="st">"value_eur"</span>, <span class="at">id =</span> <span class="st">"fifa20"</span>)</span>
<span id="cb338-1821"><a href="#cb338-1821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1822"><a href="#cb338-1822" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)</span>
<span id="cb338-1823"><a href="#cb338-1823" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task_fifa)</span>
<span id="cb338-1824"><a href="#cb338-1824" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>model</span>
<span id="cb338-1825"><a href="#cb338-1825" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1826"><a href="#cb338-1826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1827"><a href="#cb338-1827" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Use the permutation importance method to calculate feature importance ranking. Which feature is the most important? Do you find the results surprising?</span>
<span id="cb338-1828"><a href="#cb338-1828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1829"><a href="#cb338-1829" aria-hidden="true" tabindex="-1"></a>**With `iml`**</span>
<span id="cb338-1830"><a href="#cb338-1830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1831"><a href="#cb338-1831" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-093, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1832"><a href="#cb338-1832" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(iml)</span>
<span id="cb338-1833"><a href="#cb338-1833" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> Predictor<span class="sc">$</span><span class="fu">new</span>(learner,</span>
<span id="cb338-1834"><a href="#cb338-1834" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> fifa20,</span>
<span id="cb338-1835"><a href="#cb338-1835" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> <span class="st">"value_eur"</span>)</span>
<span id="cb338-1836"><a href="#cb338-1836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1837"><a href="#cb338-1837" aria-hidden="true" tabindex="-1"></a>effect <span class="ot">=</span> FeatureImp<span class="sc">$</span><span class="fu">new</span>(model,</span>
<span id="cb338-1838"><a href="#cb338-1838" aria-hidden="true" tabindex="-1"></a>                <span class="at">loss =</span> <span class="st">"rmse"</span>)</span>
<span id="cb338-1839"><a href="#cb338-1839" aria-hidden="true" tabindex="-1"></a>effect<span class="sc">$</span><span class="fu">plot</span>()</span>
<span id="cb338-1840"><a href="#cb338-1840" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1841"><a href="#cb338-1841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1842"><a href="#cb338-1842" aria-hidden="true" tabindex="-1"></a>**With `DALEX`**</span>
<span id="cb338-1843"><a href="#cb338-1843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1844"><a href="#cb338-1844" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-094, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1845"><a href="#cb338-1845" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DALEX)</span>
<span id="cb338-1846"><a href="#cb338-1846" aria-hidden="true" tabindex="-1"></a>ranger_exp <span class="ot">=</span> DALEX<span class="sc">::</span><span class="fu">explain</span>(learner,</span>
<span id="cb338-1847"><a href="#cb338-1847" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> fifa20[, <span class="fu">setdiff</span>(<span class="fu">names</span>(fifa20), <span class="st">"value_eur"</span>)],</span>
<span id="cb338-1848"><a href="#cb338-1848" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> fifa<span class="sc">$</span>value_eur,</span>
<span id="cb338-1849"><a href="#cb338-1849" aria-hidden="true" tabindex="-1"></a>  <span class="at">label =</span> <span class="st">"Fifa 2020"</span>,</span>
<span id="cb338-1850"><a href="#cb338-1850" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb338-1851"><a href="#cb338-1851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1852"><a href="#cb338-1852" aria-hidden="true" tabindex="-1"></a>ranger_effect <span class="ot">=</span> <span class="fu">model_parts</span>(ranger_exp, <span class="at">B =</span> <span class="dv">5</span>)</span>
<span id="cb338-1853"><a href="#cb338-1853" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ranger_effect)</span>
<span id="cb338-1854"><a href="#cb338-1854" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ranger_effect)</span>
<span id="cb338-1855"><a href="#cb338-1855" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1856"><a href="#cb338-1856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1857"><a href="#cb338-1857" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Use the partial dependence plot/profile to draw the global behavior of the model for this feature. Is it aligned with your expectations?</span>
<span id="cb338-1858"><a href="#cb338-1858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1859"><a href="#cb338-1859" aria-hidden="true" tabindex="-1"></a>**With `iml`**</span>
<span id="cb338-1860"><a href="#cb338-1860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1861"><a href="#cb338-1861" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-095, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1862"><a href="#cb338-1862" aria-hidden="true" tabindex="-1"></a>impfeat <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"skill_ball_control"</span>)</span>
<span id="cb338-1863"><a href="#cb338-1863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1864"><a href="#cb338-1864" aria-hidden="true" tabindex="-1"></a>effect <span class="ot">=</span> FeatureEffects<span class="sc">$</span><span class="fu">new</span>(model, <span class="at">features =</span> impfeat)</span>
<span id="cb338-1865"><a href="#cb338-1865" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(effect)</span>
<span id="cb338-1866"><a href="#cb338-1866" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1867"><a href="#cb338-1867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1868"><a href="#cb338-1868" aria-hidden="true" tabindex="-1"></a>**With `DALEX`**</span>
<span id="cb338-1869"><a href="#cb338-1869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1870"><a href="#cb338-1870" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-096, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1871"><a href="#cb338-1871" aria-hidden="true" tabindex="-1"></a>impfeat <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"skill_ball_control"</span>)</span>
<span id="cb338-1872"><a href="#cb338-1872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1873"><a href="#cb338-1873" aria-hidden="true" tabindex="-1"></a>ranger_profiles <span class="ot">=</span> <span class="fu">model_profile</span>(ranger_exp, <span class="at">variables =</span> impfeat)</span>
<span id="cb338-1874"><a href="#cb338-1874" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ranger_profiles)</span>
<span id="cb338-1875"><a href="#cb338-1875" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1876"><a href="#cb338-1876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1877"><a href="#cb338-1877" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Choose Robert Lewandowski as a specific example and calculate and plot the Shapley values. Which feature is locally the most important and has the strongest influence on his valuation as a soccer player?</span>
<span id="cb338-1878"><a href="#cb338-1878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1879"><a href="#cb338-1879" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-097, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1880"><a href="#cb338-1880" aria-hidden="true" tabindex="-1"></a>player_1 <span class="ot">=</span> fifa20[<span class="st">"R. Lewandowski"</span>,]</span>
<span id="cb338-1881"><a href="#cb338-1881" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1882"><a href="#cb338-1882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1883"><a href="#cb338-1883" aria-hidden="true" tabindex="-1"></a>**With `iml`**</span>
<span id="cb338-1884"><a href="#cb338-1884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1885"><a href="#cb338-1885" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-098, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1886"><a href="#cb338-1886" aria-hidden="true" tabindex="-1"></a>shapley <span class="ot">=</span> Shapley<span class="sc">$</span><span class="fu">new</span>(model, <span class="at">x.interest =</span> player_1)</span>
<span id="cb338-1887"><a href="#cb338-1887" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(shapley)</span>
<span id="cb338-1888"><a href="#cb338-1888" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1889"><a href="#cb338-1889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1890"><a href="#cb338-1890" aria-hidden="true" tabindex="-1"></a>**With `DALEX`**</span>
<span id="cb338-1891"><a href="#cb338-1891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1892"><a href="#cb338-1892" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-099, warning=FALSE, message=FALSE}</span></span>
<span id="cb338-1893"><a href="#cb338-1893" aria-hidden="true" tabindex="-1"></a>ranger_shap <span class="ot">=</span> <span class="fu">predict_parts</span>(ranger_exp,</span>
<span id="cb338-1894"><a href="#cb338-1894" aria-hidden="true" tabindex="-1"></a>             <span class="at">new_observation =</span> player_1,</span>
<span id="cb338-1895"><a href="#cb338-1895" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="st">"shap"</span>, <span class="at">B =</span> <span class="dv">1</span>)</span>
<span id="cb338-1896"><a href="#cb338-1896" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ranger_shap, <span class="at">show_boxplots =</span> <span class="cn">FALSE</span>)</span>
<span id="cb338-1897"><a href="#cb338-1897" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1898"><a href="#cb338-1898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1899"><a href="#cb338-1899" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-special</span></span>
<span id="cb338-1900"><a href="#cb338-1900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1901"><a href="#cb338-1901" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Run a benchmark experiment on <span class="in">`tsk("german_credit")`</span> with <span class="in">`lrn("classif.featureless")`</span>, <span class="in">`lrn("classif.log_reg")`</span>, and <span class="in">`lrn("classif.ranger")`</span>. Tune the prediction thresholds of all learners by encapsulating them in a <span class="in">`po("learner_cv")`</span> (with two-fold CV), followed by a <span class="in">`po("tunethreshold")`</span>. Use <span class="in">`msr("classif.costs", costs = costs)`</span>, where the <span class="in">`costs`</span> matrix is as follows: true positive is <span class="in">`-10`</span>, true negative is <span class="in">`-1`</span>, false positive is <span class="in">`2`</span>, and false negative is <span class="in">`3`</span>. Use this measure in <span class="in">`po("tunethreshold")`</span> and when evaluating your benchmark experiment.</span>
<span id="cb338-1902"><a href="#cb338-1902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1903"><a href="#cb338-1903" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-100, message=FALSE, warning=FALSE}</span></span>
<span id="cb338-1904"><a href="#cb338-1904" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-1905"><a href="#cb338-1905" aria-hidden="true" tabindex="-1"></a><span class="co"># Load task and learners</span></span>
<span id="cb338-1906"><a href="#cb338-1906" aria-hidden="true" tabindex="-1"></a>tsk_german <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"german_credit"</span>)</span>
<span id="cb338-1907"><a href="#cb338-1907" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">lrns</span>(<span class="fu">c</span>(<span class="st">"classif.featureless"</span>, <span class="st">"classif.log_reg"</span>,</span>
<span id="cb338-1908"><a href="#cb338-1908" aria-hidden="true" tabindex="-1"></a>  <span class="st">"classif.ranger"</span>), <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb338-1909"><a href="#cb338-1909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1910"><a href="#cb338-1910" aria-hidden="true" tabindex="-1"></a><span class="co"># Create costs matrix</span></span>
<span id="cb338-1911"><a href="#cb338-1911" aria-hidden="true" tabindex="-1"></a>costs <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">2</span>,</span>
<span id="cb338-1912"><a href="#cb338-1912" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="st">"Predicted Credit"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"good"</span>, <span class="st">"bad"</span>),</span>
<span id="cb338-1913"><a href="#cb338-1913" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Truth =</span> <span class="fu">c</span>(<span class="st">"good"</span>, <span class="st">"bad"</span>)))</span>
<span id="cb338-1914"><a href="#cb338-1914" aria-hidden="true" tabindex="-1"></a>costs</span>
<span id="cb338-1915"><a href="#cb338-1915" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1916"><a href="#cb338-1916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1917"><a href="#cb338-1917" aria-hidden="true" tabindex="-1"></a>Our cost matrix is as expected so we can plug it into our measure and setup our pipeline.</span>
<span id="cb338-1918"><a href="#cb338-1918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1919"><a href="#cb338-1919" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-101, results='hide'}</span></span>
<span id="cb338-1920"><a href="#cb338-1920" aria-hidden="true" tabindex="-1"></a><span class="co"># Create measure</span></span>
<span id="cb338-1921"><a href="#cb338-1921" aria-hidden="true" tabindex="-1"></a>meas_costs <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"classif.costs"</span>, <span class="at">costs =</span> costs)</span>
<span id="cb338-1922"><a href="#cb338-1922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1923"><a href="#cb338-1923" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a function to wrap learners in internal cross-validation</span></span>
<span id="cb338-1924"><a href="#cb338-1924" aria-hidden="true" tabindex="-1"></a><span class="co">#  to tune the threshold</span></span>
<span id="cb338-1925"><a href="#cb338-1925" aria-hidden="true" tabindex="-1"></a>pipe <span class="ot">=</span> <span class="cf">function</span>(l) {</span>
<span id="cb338-1926"><a href="#cb338-1926" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"learner_cv"</span>, l, <span class="at">resampling.folds =</span> <span class="dv">2</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-1927"><a href="#cb338-1927" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"tunethreshold"</span>, <span class="at">measure =</span> meas_costs)</span>
<span id="cb338-1928"><a href="#cb338-1928" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-1929"><a href="#cb338-1929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1930"><a href="#cb338-1930" aria-hidden="true" tabindex="-1"></a><span class="co"># Benchmark</span></span>
<span id="cb338-1931"><a href="#cb338-1931" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">lapply</span>(learners, pipe)</span>
<span id="cb338-1932"><a href="#cb338-1932" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(tsk_german, learners, <span class="fu">rsmp</span>(<span class="st">"holdout"</span>))</span>
<span id="cb338-1933"><a href="#cb338-1933" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)<span class="sc">$</span><span class="fu">aggregate</span>(meas_costs)</span>
<span id="cb338-1934"><a href="#cb338-1934" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1935"><a href="#cb338-1935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1936"><a href="#cb338-1936" aria-hidden="true" tabindex="-1"></a>Now exploring our results...</span>
<span id="cb338-1937"><a href="#cb338-1937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1938"><a href="#cb338-1938" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-102}</span></span>
<span id="cb338-1939"><a href="#cb338-1939" aria-hidden="true" tabindex="-1"></a>bmr[, .(learner_id, classif.costs)]</span>
<span id="cb338-1940"><a href="#cb338-1940" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1941"><a href="#cb338-1941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1942"><a href="#cb338-1942" aria-hidden="true" tabindex="-1"></a>Based on these results, the logistic regression performs the best with the greatest increase to costs, however the difference is only marginal compared to the other learners.</span>
<span id="cb338-1943"><a href="#cb338-1943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1944"><a href="#cb338-1944" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Train and test a survival forest using <span class="in">`lrn("surv.rfsrc")`</span> (from <span class="in">`mlr3extralearners`</span>). Run this experiment using <span class="in">`tsk("rats")`</span> and <span class="in">`partition()`</span>. Evaluate your model with the RCLL measure.</span>
<span id="cb338-1945"><a href="#cb338-1945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1946"><a href="#cb338-1946" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-103}</span></span>
<span id="cb338-1947"><a href="#cb338-1947" aria-hidden="true" tabindex="-1"></a><span class="co"># Get learners</span></span>
<span id="cb338-1948"><a href="#cb338-1948" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3extralearners)</span>
<span id="cb338-1949"><a href="#cb338-1949" aria-hidden="true" tabindex="-1"></a><span class="co"># Get survival models</span></span>
<span id="cb338-1950"><a href="#cb338-1950" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3proba)</span>
<span id="cb338-1951"><a href="#cb338-1951" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-1952"><a href="#cb338-1952" aria-hidden="true" tabindex="-1"></a><span class="co"># Use partition to split data and test our model</span></span>
<span id="cb338-1953"><a href="#cb338-1953" aria-hidden="true" tabindex="-1"></a>tsk_rats <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"rats"</span>)</span>
<span id="cb338-1954"><a href="#cb338-1954" aria-hidden="true" tabindex="-1"></a>splits <span class="ot">=</span> <span class="fu">partition</span>(tsk_rats)</span>
<span id="cb338-1955"><a href="#cb338-1955" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"surv.rfsrc"</span>)</span>
<span id="cb338-1956"><a href="#cb338-1956" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">train</span>(tsk_rats, splits<span class="sc">$</span>train)<span class="sc">$</span><span class="fu">predict</span>(tsk_rats, splits<span class="sc">$</span>test)</span>
<span id="cb338-1957"><a href="#cb338-1957" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"surv.rcll"</span>))</span>
<span id="cb338-1958"><a href="#cb338-1958" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1959"><a href="#cb338-1959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1960"><a href="#cb338-1960" aria-hidden="true" tabindex="-1"></a>The right-censored logloss provides a measure of predictive accuracy, but it is quite hard to interpret it without comparison to another model.</span>
<span id="cb338-1961"><a href="#cb338-1961" aria-hidden="true" tabindex="-1"></a>To yield a more informative value, we could either compute the RCLL for an uninformed baseline like the Kaplan-Meier estimator, or we could use the <span class="in">`ERV`</span> (explained residual variation) parameter in the measure, which returns the RCLL as a percentage increase in performance compared to an uninformed baseline (in this case the Kaplan-Meier estimator):</span>
<span id="cb338-1962"><a href="#cb338-1962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1963"><a href="#cb338-1963" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-104}</span></span>
<span id="cb338-1964"><a href="#cb338-1964" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"surv.kaplan"</span>)<span class="sc">$</span></span>
<span id="cb338-1965"><a href="#cb338-1965" aria-hidden="true" tabindex="-1"></a>  <span class="fu">train</span>(tsk_rats, splits<span class="sc">$</span>train)<span class="sc">$</span></span>
<span id="cb338-1966"><a href="#cb338-1966" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(tsk_rats, splits<span class="sc">$</span>test)<span class="sc">$</span></span>
<span id="cb338-1967"><a href="#cb338-1967" aria-hidden="true" tabindex="-1"></a>  <span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"surv.rcll"</span>))</span>
<span id="cb338-1968"><a href="#cb338-1968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1969"><a href="#cb338-1969" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"surv.rcll"</span>, <span class="at">ERV =</span> <span class="cn">TRUE</span>),</span>
<span id="cb338-1970"><a href="#cb338-1970" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> tsk_rats, <span class="at">train_set =</span> splits<span class="sc">$</span>train)</span>
<span id="cb338-1971"><a href="#cb338-1971" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1972"><a href="#cb338-1972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1973"><a href="#cb338-1973" aria-hidden="true" tabindex="-1"></a>Now we can see that our model is only marginally better than the Kaplan-Meier baseline (a 2% performance increase).</span>
<span id="cb338-1974"><a href="#cb338-1974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1975"><a href="#cb338-1975" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Estimate the density of the "precip" task from the <span class="in">`mlr3proba`</span> package using <span class="in">`lrn("dens.hist")`</span>, evaluate your estimation with the logloss measure. As a stretch goal, look into the documentation of <span class="in">`distr6`</span> to learn how to analyse your estimated distribution further.</span>
<span id="cb338-1976"><a href="#cb338-1976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1977"><a href="#cb338-1977" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-105}</span></span>
<span id="cb338-1978"><a href="#cb338-1978" aria-hidden="true" tabindex="-1"></a><span class="co"># Get density models</span></span>
<span id="cb338-1979"><a href="#cb338-1979" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3proba)</span>
<span id="cb338-1980"><a href="#cb338-1980" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-1981"><a href="#cb338-1981" aria-hidden="true" tabindex="-1"></a><span class="co"># Run experiment</span></span>
<span id="cb338-1982"><a href="#cb338-1982" aria-hidden="true" tabindex="-1"></a>tsk_precip <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"precip"</span>)</span>
<span id="cb338-1983"><a href="#cb338-1983" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"dens.hist"</span>)</span>
<span id="cb338-1984"><a href="#cb338-1984" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">train</span>(tsk_precip)<span class="sc">$</span><span class="fu">predict</span>(tsk_precip)</span>
<span id="cb338-1985"><a href="#cb338-1985" aria-hidden="true" tabindex="-1"></a>prediction</span>
<span id="cb338-1986"><a href="#cb338-1986" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"dens.logloss"</span>))</span>
<span id="cb338-1987"><a href="#cb338-1987" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1988"><a href="#cb338-1988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1989"><a href="#cb338-1989" aria-hidden="true" tabindex="-1"></a>As before the logloss is not too informative by itself but as the Histogram is itself a baseline, we can use this value for comparison to more sophisticated models. To learn more about our predicted distribution, we could use <span class="in">`distr6`</span> to summarise the distribution and to compute values such as the pdf and cdf:</span>
<span id="cb338-1990"><a href="#cb338-1990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1991"><a href="#cb338-1991" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-106}</span></span>
<span id="cb338-1992"><a href="#cb338-1992" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span>distr<span class="sc">$</span><span class="fu">summary</span>()</span>
<span id="cb338-1993"><a href="#cb338-1993" aria-hidden="true" tabindex="-1"></a><span class="co"># pdf evaluated at `50`</span></span>
<span id="cb338-1994"><a href="#cb338-1994" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span>distr<span class="sc">$</span><span class="fu">pdf</span>(<span class="dv">50</span>)</span>
<span id="cb338-1995"><a href="#cb338-1995" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-1996"><a href="#cb338-1996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1997"><a href="#cb338-1997" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Run a benchmark clustering experiment on the "wine" dataset without a label column. Compare the performance of k-means learner with <span class="in">`k`</span> equal to <span class="in">`2`</span>, <span class="in">`3`</span> and <span class="in">`4`</span> using the silhouette measure and the insample resampling technique. What value of <span class="in">`k`</span> would you choose based on the silhouette scores?</span>
<span id="cb338-1998"><a href="#cb338-1998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-1999"><a href="#cb338-1999" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-107, messages=FALSE, warnings=FALSE}</span></span>
<span id="cb338-2000"><a href="#cb338-2000" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb338-2001"><a href="#cb338-2001" aria-hidden="true" tabindex="-1"></a><span class="co"># Load clustering models and tasks</span></span>
<span id="cb338-2002"><a href="#cb338-2002" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3cluster)</span>
<span id="cb338-2003"><a href="#cb338-2003" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the clustering dataset by extracting only the features from the</span></span>
<span id="cb338-2004"><a href="#cb338-2004" aria-hidden="true" tabindex="-1"></a><span class="co">#  wine task</span></span>
<span id="cb338-2005"><a href="#cb338-2005" aria-hidden="true" tabindex="-1"></a>tsk_wine <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"wine"</span>)</span>
<span id="cb338-2006"><a href="#cb338-2006" aria-hidden="true" tabindex="-1"></a>tsk_wine <span class="ot">=</span> <span class="fu">as_task_clust</span>(tsk_wine<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> tsk_wine<span class="sc">$</span>feature_names))</span>
<span id="cb338-2007"><a href="#cb338-2007" aria-hidden="true" tabindex="-1"></a><span class="co"># Create learners and ensure they have unique IDs</span></span>
<span id="cb338-2008"><a href="#cb338-2008" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb338-2009"><a href="#cb338-2009" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>, <span class="at">centers =</span> <span class="dv">2</span>, <span class="at">id =</span> <span class="st">"K=2"</span>),</span>
<span id="cb338-2010"><a href="#cb338-2010" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>, <span class="at">centers =</span> <span class="dv">3</span>, <span class="at">id =</span> <span class="st">"K=3"</span>),</span>
<span id="cb338-2011"><a href="#cb338-2011" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>, <span class="at">centers =</span> <span class="dv">4</span>, <span class="at">id =</span> <span class="st">"K=4"</span>)</span>
<span id="cb338-2012"><a href="#cb338-2012" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-2013"><a href="#cb338-2013" aria-hidden="true" tabindex="-1"></a><span class="co"># Benchmark</span></span>
<span id="cb338-2014"><a href="#cb338-2014" aria-hidden="true" tabindex="-1"></a>meas <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"clust.silhouette"</span>)</span>
<span id="cb338-2015"><a href="#cb338-2015" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(tsk_wine, learners, <span class="fu">rsmp</span>(<span class="st">"insample"</span>))</span>
<span id="cb338-2016"><a href="#cb338-2016" aria-hidden="true" tabindex="-1"></a><span class="fu">benchmark</span>(design)<span class="sc">$</span><span class="fu">aggregate</span>(meas)[, .(learner_id, clust.silhouette)]</span>
<span id="cb338-2017"><a href="#cb338-2017" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2018"><a href="#cb338-2018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2019"><a href="#cb338-2019" aria-hidden="true" tabindex="-1"></a>We can see that we get the silhouette closest to <span class="in">`1`</span> with <span class="in">`K=2`</span> so we might use this value for future experiments.</span>
<span id="cb338-2020"><a href="#cb338-2020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2021"><a href="#cb338-2021" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Manually <span class="in">`$train()`</span> a GBM regression model from <span class="in">`r ref_pkg("mlr3extralearners")`</span> on <span class="in">`tsk("mtcars")`</span> to predict the 95th percentile of the target variable.</span>
<span id="cb338-2022"><a href="#cb338-2022" aria-hidden="true" tabindex="-1"></a>  Make sure that you split the data and only use the test data for fitting the learner.</span>
<span id="cb338-2023"><a href="#cb338-2023" aria-hidden="true" tabindex="-1"></a>  Use the test data to evaluate your learner with the pinball loss.</span>
<span id="cb338-2024"><a href="#cb338-2024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2025"><a href="#cb338-2025" aria-hidden="true" tabindex="-1"></a>We start by loading <span class="in">`mlr3extralearners`</span> and creating the tasks and the test train split.</span>
<span id="cb338-2026"><a href="#cb338-2026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2027"><a href="#cb338-2027" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-108}</span></span>
<span id="cb338-2028"><a href="#cb338-2028" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3extralearners)</span>
<span id="cb338-2029"><a href="#cb338-2029" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"california_housing"</span>)</span>
<span id="cb338-2030"><a href="#cb338-2030" aria-hidden="true" tabindex="-1"></a>splits <span class="ot">=</span> <span class="fu">partition</span>(task)</span>
<span id="cb338-2031"><a href="#cb338-2031" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2032"><a href="#cb338-2032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2033"><a href="#cb338-2033" aria-hidden="true" tabindex="-1"></a>In the next step, we initialize the learner as <span class="in">`"regr.gbm"`</span> and explicitly set the <span class="in">`quantiles`</span> parameter to 0.95.</span>
<span id="cb338-2034"><a href="#cb338-2034" aria-hidden="true" tabindex="-1"></a>For the learner to be able to predict this quantile, we need to specify the <span class="in">`predict_type`</span>.</span>
<span id="cb338-2035"><a href="#cb338-2035" aria-hidden="true" tabindex="-1"></a>Lastly, we train the learner using only the test data.</span>
<span id="cb338-2036"><a href="#cb338-2036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2037"><a href="#cb338-2037" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-109}</span></span>
<span id="cb338-2038"><a href="#cb338-2038" aria-hidden="true" tabindex="-1"></a>lrn_gbm <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.gbm"</span>, <span class="at">predict_type =</span> <span class="st">"quantiles"</span>, <span class="at">quantiles =</span> <span class="fl">0.95</span>)</span>
<span id="cb338-2039"><a href="#cb338-2039" aria-hidden="true" tabindex="-1"></a>lrn_gbm<span class="sc">$</span><span class="fu">train</span>(task, <span class="at">row_ids =</span> splits<span class="sc">$</span>train)</span>
<span id="cb338-2040"><a href="#cb338-2040" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2041"><a href="#cb338-2041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2042"><a href="#cb338-2042" aria-hidden="true" tabindex="-1"></a>To evaluate the learner, we first use it to predict on the test data.</span>
<span id="cb338-2043"><a href="#cb338-2043" aria-hidden="true" tabindex="-1"></a>Then, we calculate the pinball loss using the predictions.</span>
<span id="cb338-2044"><a href="#cb338-2044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2045"><a href="#cb338-2045" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-110}</span></span>
<span id="cb338-2046"><a href="#cb338-2046" aria-hidden="true" tabindex="-1"></a>prds_gbm <span class="ot">=</span> lrn_gbm<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> splits<span class="sc">$</span>test)</span>
<span id="cb338-2047"><a href="#cb338-2047" aria-hidden="true" tabindex="-1"></a>score_gbm <span class="ot">=</span> prds_gbm<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"regr.pinball"</span>, <span class="at">alpha =</span> <span class="fl">0.95</span>, <span class="at">id =</span> <span class="st">"q0.95"</span>))</span>
<span id="cb338-2048"><a href="#cb338-2048" aria-hidden="true" tabindex="-1"></a>score_gbm</span>
<span id="cb338-2049"><a href="#cb338-2049" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2050"><a href="#cb338-2050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2051"><a href="#cb338-2051" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-fairness</span></span>
<span id="cb338-2052"><a href="#cb338-2052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2053"><a href="#cb338-2053" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Train a model of your choice on <span class="in">`tsk("adult_train")`</span> and test it on <span class="in">`tsk("adult_test")`</span>, use any measure of your choice to evaluate your predictions. Assume our goal is to achieve parity in false omission rates across the protected 'sex' attribute. Construct a fairness metric that encodes this and evaluate your model. To get a deeper understanding, look at the <span class="in">`r ref("groupwise_metrics")`</span> function to obtain performance in each group.</span>
<span id="cb338-2054"><a href="#cb338-2054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2055"><a href="#cb338-2055" aria-hidden="true" tabindex="-1"></a>For now we simply load the data and look at the data.</span>
<span id="cb338-2056"><a href="#cb338-2056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2057"><a href="#cb338-2057" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-111}</span></span>
<span id="cb338-2058"><a href="#cb338-2058" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3)</span>
<span id="cb338-2059"><a href="#cb338-2059" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3fairness)</span>
<span id="cb338-2060"><a href="#cb338-2060" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">8</span>)</span>
<span id="cb338-2061"><a href="#cb338-2061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2062"><a href="#cb338-2062" aria-hidden="true" tabindex="-1"></a>tsk_adult_train <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"adult_train"</span>)</span>
<span id="cb338-2063"><a href="#cb338-2063" aria-hidden="true" tabindex="-1"></a>tsk_adult_test <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"adult_test"</span>)</span>
<span id="cb338-2064"><a href="#cb338-2064" aria-hidden="true" tabindex="-1"></a>tsk_adult_train</span>
<span id="cb338-2065"><a href="#cb338-2065" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2066"><a href="#cb338-2066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2067"><a href="#cb338-2067" aria-hidden="true" tabindex="-1"></a>We can now train a simple model, e.g., a decision tree and evaluate for accuracy.</span>
<span id="cb338-2068"><a href="#cb338-2068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2069"><a href="#cb338-2069" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-112}</span></span>
<span id="cb338-2070"><a href="#cb338-2070" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb338-2071"><a href="#cb338-2071" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(tsk_adult_train)</span>
<span id="cb338-2072"><a href="#cb338-2072" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(tsk_adult_test)</span>
<span id="cb338-2073"><a href="#cb338-2073" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>()</span>
<span id="cb338-2074"><a href="#cb338-2074" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2075"><a href="#cb338-2075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2076"><a href="#cb338-2076" aria-hidden="true" tabindex="-1"></a>The *false omission rate parity* metric is available via the key <span class="in">`"fairness.fomr"`</span>.</span>
<span id="cb338-2077"><a href="#cb338-2077" aria-hidden="true" tabindex="-1"></a>Note, that evaluating our prediction now requires that we also provide the task.</span>
<span id="cb338-2078"><a href="#cb338-2078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2079"><a href="#cb338-2079" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-113}</span></span>
<span id="cb338-2080"><a href="#cb338-2080" aria-hidden="true" tabindex="-1"></a>msr_1 <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"fairness.fomr"</span>)</span>
<span id="cb338-2081"><a href="#cb338-2081" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(msr_1, tsk_adult_test)</span>
<span id="cb338-2082"><a href="#cb338-2082" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2083"><a href="#cb338-2083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2084"><a href="#cb338-2084" aria-hidden="true" tabindex="-1"></a>In addition, we can look at false omission rates in each group.</span>
<span id="cb338-2085"><a href="#cb338-2085" aria-hidden="true" tabindex="-1"></a>The <span class="in">`groupwise_metrics`</span> function creates a metric for each group specified in the <span class="in">`pta`</span> column role:</span>
<span id="cb338-2086"><a href="#cb338-2086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2087"><a href="#cb338-2087" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-114}</span></span>
<span id="cb338-2088"><a href="#cb338-2088" aria-hidden="true" tabindex="-1"></a>tsk_adult_test<span class="sc">$</span>col_roles<span class="sc">$</span>pta</span>
<span id="cb338-2089"><a href="#cb338-2089" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2090"><a href="#cb338-2090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2091"><a href="#cb338-2091" aria-hidden="true" tabindex="-1"></a>We can then use this metric to evaluate our model again.</span>
<span id="cb338-2092"><a href="#cb338-2092" aria-hidden="true" tabindex="-1"></a>This gives us the false omission rates for male and female individuals separately.</span>
<span id="cb338-2093"><a href="#cb338-2093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2094"><a href="#cb338-2094" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-115}</span></span>
<span id="cb338-2095"><a href="#cb338-2095" aria-hidden="true" tabindex="-1"></a>msr_2 <span class="ot">=</span> <span class="fu">groupwise_metrics</span>(<span class="at">base_measure =</span> <span class="fu">msr</span>(<span class="st">"classif.fomr"</span>), <span class="at">task =</span> tsk_adult_test)</span>
<span id="cb338-2096"><a href="#cb338-2096" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(msr_2, tsk_adult_test)</span>
<span id="cb338-2097"><a href="#cb338-2097" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2098"><a href="#cb338-2098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2099"><a href="#cb338-2099" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Improve your model by employing pipelines that use pre- or post-processing methods for fairness. Evaluate your model along the two metrics and visualize the resulting metrics. Compare the different models using an appropriate visualization.</span>
<span id="cb338-2100"><a href="#cb338-2100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2101"><a href="#cb338-2101" aria-hidden="true" tabindex="-1"></a>First we can again construct the learners above.</span>
<span id="cb338-2102"><a href="#cb338-2102" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-116}</span></span>
<span id="cb338-2103"><a href="#cb338-2103" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb338-2104"><a href="#cb338-2104" aria-hidden="true" tabindex="-1"></a>lrn_1 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"reweighing_wts"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb338-2105"><a href="#cb338-2105" aria-hidden="true" tabindex="-1"></a>lrn_2 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb338-2106"><a href="#cb338-2106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"EOd"</span>)</span>
<span id="cb338-2107"><a href="#cb338-2107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2108"><a href="#cb338-2108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2109"><a href="#cb338-2109" aria-hidden="true" tabindex="-1"></a>And run the benchmark again. Note, that we use three-fold CV this time for comparison.</span>
<span id="cb338-2110"><a href="#cb338-2110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2111"><a href="#cb338-2111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-117}</span></span>
<span id="cb338-2112"><a href="#cb338-2112" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">list</span>(learner, lrn_1, lrn_2)</span>
<span id="cb338-2113"><a href="#cb338-2113" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(tsk_adult_train, learners, <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>L))</span>
<span id="cb338-2114"><a href="#cb338-2114" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb338-2115"><a href="#cb338-2115" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msrs</span>(<span class="fu">c</span>(<span class="st">"classif.acc"</span>, <span class="st">"fairness.fomr"</span>)))</span>
<span id="cb338-2116"><a href="#cb338-2116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2117"><a href="#cb338-2117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2118"><a href="#cb338-2118" aria-hidden="true" tabindex="-1"></a>We can now again visualize the result.</span>
<span id="cb338-2119"><a href="#cb338-2119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2120"><a href="#cb338-2120" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-118}</span></span>
<span id="cb338-2121"><a href="#cb338-2121" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb338-2122"><a href="#cb338-2122" aria-hidden="true" tabindex="-1"></a><span class="fu">fairness_accuracy_tradeoff</span>(bmr, <span class="fu">msr</span>(<span class="st">"fairness.fomr"</span>)) <span class="sc">+</span></span>
<span id="cb338-2123"><a href="#cb338-2123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="st">"Learner"</span>) <span class="sc">+</span></span>
<span id="cb338-2124"><a href="#cb338-2124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb338-2125"><a href="#cb338-2125" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2126"><a href="#cb338-2126" aria-hidden="true" tabindex="-1"></a>We can notice two main results:</span>
<span id="cb338-2127"><a href="#cb338-2127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2128"><a href="#cb338-2128" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>We do not improve in the false omission rate by using fairness interventions.</span>
<span id="cb338-2129"><a href="#cb338-2129" aria-hidden="true" tabindex="-1"></a>  One reason might be, that the interventions chosen do not optimize for the *false omission rate*,</span>
<span id="cb338-2130"><a href="#cb338-2130" aria-hidden="true" tabindex="-1"></a>  but other metrics, e.g. *equalized odds*.</span>
<span id="cb338-2131"><a href="#cb338-2131" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The spread between the different cross-validation iterations (small dots) is quite large,</span>
<span id="cb338-2132"><a href="#cb338-2132" aria-hidden="true" tabindex="-1"></a>  estimates might come with a considerable error.</span>
<span id="cb338-2133"><a href="#cb338-2133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2134"><a href="#cb338-2134" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Add "race" as a second sensitive attribute to your dataset. Add the information to your task and evaluate the initial model again. What changes? Again study the <span class="in">`groupwise_metrics`</span>.</span>
<span id="cb338-2135"><a href="#cb338-2135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2136"><a href="#cb338-2136" aria-hidden="true" tabindex="-1"></a>This can be achieved by adding "race" to the <span class="in">`"pta"`</span> col_role.</span>
<span id="cb338-2137"><a href="#cb338-2137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2138"><a href="#cb338-2138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-119}</span></span>
<span id="cb338-2139"><a href="#cb338-2139" aria-hidden="true" tabindex="-1"></a>tsk_adult_train<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"race"</span>, <span class="at">add_to =</span> <span class="st">"pta"</span>)</span>
<span id="cb338-2140"><a href="#cb338-2140" aria-hidden="true" tabindex="-1"></a>tsk_adult_train</span>
<span id="cb338-2141"><a href="#cb338-2141" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2142"><a href="#cb338-2142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2143"><a href="#cb338-2143" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-120}</span></span>
<span id="cb338-2144"><a href="#cb338-2144" aria-hidden="true" tabindex="-1"></a>tsk_adult_test<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"race"</span>, <span class="at">add_to =</span> <span class="st">"pta"</span>)</span>
<span id="cb338-2145"><a href="#cb338-2145" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(msr_1, tsk_adult_test)</span>
<span id="cb338-2146"><a href="#cb338-2146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2147"><a href="#cb338-2147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2148"><a href="#cb338-2148" aria-hidden="true" tabindex="-1"></a>Evaluating for the intersection, we obtain a large deviation from <span class="in">`0`</span>.</span>
<span id="cb338-2149"><a href="#cb338-2149" aria-hidden="true" tabindex="-1"></a>Note, that the metric by default computes the maximum discrepancy between all metrics for the non-binary case.</span>
<span id="cb338-2150"><a href="#cb338-2150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2151"><a href="#cb338-2151" aria-hidden="true" tabindex="-1"></a>If we now compute the <span class="in">`groupwise_metrics`</span>, we will get a metric for the intersection of each group.</span>
<span id="cb338-2152"><a href="#cb338-2152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2153"><a href="#cb338-2153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-121}</span></span>
<span id="cb338-2154"><a href="#cb338-2154" aria-hidden="true" tabindex="-1"></a>msr_3 <span class="ot">=</span> <span class="fu">groupwise_metrics</span>(<span class="fu">msr</span>(<span class="st">"classif.fomr"</span>),  tsk_adult_train)</span>
<span id="cb338-2155"><a href="#cb338-2155" aria-hidden="true" tabindex="-1"></a><span class="fu">unname</span>(<span class="fu">sapply</span>(msr_3, <span class="cf">function</span>(x) x<span class="sc">$</span>id))</span>
<span id="cb338-2156"><a href="#cb338-2156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2157"><a href="#cb338-2157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2158"><a href="#cb338-2158" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-122}</span></span>
<span id="cb338-2159"><a href="#cb338-2159" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(msr_3, tsk_adult_test)</span>
<span id="cb338-2160"><a href="#cb338-2160" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2161"><a href="#cb338-2161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2162"><a href="#cb338-2162" aria-hidden="true" tabindex="-1"></a>And we can see, that the reason might be, that the false omission rate for female Amer-Indian-Eskimo is at <span class="in">`1.0`</span>!</span>
<span id="cb338-2163"><a href="#cb338-2163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2164"><a href="#cb338-2164" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>In this chapter we were unable to reduce bias in our experiment. Using everything you have learned in this book, see if you can successfully reduce bias in your model. Critically reflect on this exercise, why might this be a bad idea?</span>
<span id="cb338-2165"><a href="#cb338-2165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2166"><a href="#cb338-2166" aria-hidden="true" tabindex="-1"></a>Several problems with the existing metrics.</span>
<span id="cb338-2167"><a href="#cb338-2167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2168"><a href="#cb338-2168" aria-hidden="true" tabindex="-1"></a>We'll go through them one by one to deepen our understanding:</span>
<span id="cb338-2169"><a href="#cb338-2169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2170"><a href="#cb338-2170" aria-hidden="true" tabindex="-1"></a>**Metric and evaluation**</span>
<span id="cb338-2171"><a href="#cb338-2171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2172"><a href="#cb338-2172" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>In order for the fairness metric to be useful, we need to ensure that the data used for evaluation is representative and sufficiently large.</span>
<span id="cb338-2173"><a href="#cb338-2173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2174"><a href="#cb338-2174" aria-hidden="true" tabindex="-1"></a>  We can investigate this further by looking at actual counts:</span>
<span id="cb338-2175"><a href="#cb338-2175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2176"><a href="#cb338-2176" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-123}</span></span>
<span id="cb338-2177"><a href="#cb338-2177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>(tsk_adult_test<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"race"</span>, <span class="st">"sex"</span>, <span class="st">"target"</span>)))</span>
<span id="cb338-2178"><a href="#cb338-2178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2179"><a href="#cb338-2179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2180"><a href="#cb338-2180" aria-hidden="true" tabindex="-1"></a>  One of the reasons might be that there are only 3 individuals in the "&gt;50k" category!</span>
<span id="cb338-2181"><a href="#cb338-2181" aria-hidden="true" tabindex="-1"></a>  This is an often encountered problem, as error metrics have a large variance when samples are small.</span>
<span id="cb338-2182"><a href="#cb338-2182" aria-hidden="true" tabindex="-1"></a>  Note, that the pre- and post-processing methods in general do not all support multiple protected attributes.</span>
<span id="cb338-2183"><a href="#cb338-2183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2184"><a href="#cb338-2184" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>We should question whether comparing the metric between all groups actually makes sense for the question we are trying to answer. Instead, we might want to observe the metric between two specific subgroups, in this case between individuals with <span class="in">`sex`</span>: <span class="in">`Female`</span> and <span class="in">`race`</span>: <span class="in">`"Black"`</span> or <span class="in">`"White"`</span>.</span>
<span id="cb338-2185"><a href="#cb338-2185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2186"><a href="#cb338-2186" aria-hidden="true" tabindex="-1"></a>First, we create a subset of only <span class="in">`sex`</span>: <span class="in">`Female`</span> and <span class="in">`race`</span>: <span class="in">`"Black", "White"`</span>.</span>
<span id="cb338-2187"><a href="#cb338-2187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2188"><a href="#cb338-2188" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-124}</span></span>
<span id="cb338-2189"><a href="#cb338-2189" aria-hidden="true" tabindex="-1"></a>adult_subset <span class="ot">=</span> tsk_adult_test<span class="sc">$</span><span class="fu">clone</span>()</span>
<span id="cb338-2190"><a href="#cb338-2190" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> adult_subset<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb338-2191"><a href="#cb338-2191" aria-hidden="true" tabindex="-1"></a>rows <span class="ot">=</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(df))[df<span class="sc">$</span>race <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Black"</span>, <span class="st">"White"</span>) <span class="sc">&amp;</span> df<span class="sc">$</span>sex <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Female"</span>)]</span>
<span id="cb338-2192"><a href="#cb338-2192" aria-hidden="true" tabindex="-1"></a>adult_subset<span class="sc">$</span><span class="fu">filter</span>(rows)</span>
<span id="cb338-2193"><a href="#cb338-2193" aria-hidden="true" tabindex="-1"></a>adult_subset<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"race"</span>, <span class="at">add_to =</span> <span class="st">"pta"</span>)</span>
<span id="cb338-2194"><a href="#cb338-2194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2195"><a href="#cb338-2195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2196"><a href="#cb338-2196" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb338-2197"><a href="#cb338-2197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2198"><a href="#cb338-2198" aria-hidden="true" tabindex="-1"></a>Currently, there is a bug in the <span class="in">`mlr3fairness`</span> package that causes the following code chunk to fail.</span>
<span id="cb338-2199"><a href="#cb338-2199" aria-hidden="true" tabindex="-1"></a>See https://github.com/mlr-org/mlr3fairness/issues/79 for more details.</span>
<span id="cb338-2200"><a href="#cb338-2200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2201"><a href="#cb338-2201" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb338-2202"><a href="#cb338-2202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2203"><a href="#cb338-2203" aria-hidden="true" tabindex="-1"></a>And evaluate our measure again:</span>
<span id="cb338-2204"><a href="#cb338-2204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2205"><a href="#cb338-2205" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-125}</span></span>
<span id="cb338-2206"><a href="#cb338-2206" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb338-2207"><a href="#cb338-2207" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(msr_3, <span class="at">task =</span> adult_subset)</span>
<span id="cb338-2208"><a href="#cb338-2208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2209"><a href="#cb338-2209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2210"><a href="#cb338-2210" aria-hidden="true" tabindex="-1"></a>We can see, that between women there is an even bigger discrepancy compared to men.</span>
<span id="cb338-2211"><a href="#cb338-2211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2212"><a href="#cb338-2212" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The bias mitigation strategies we employed do not optimize for the *false omission rate* metric, but other metrics instead. It might therefore be better to try to achieve fairness via other strategies, using different or more powerful models or tuning hyperparameters.</span>
<span id="cb338-2213"><a href="#cb338-2213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2214"><a href="#cb338-2214" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-predsets-valid-inttune</span></span>
<span id="cb338-2215"><a href="#cb338-2215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2216"><a href="#cb338-2216" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Manually <span class="in">`$train()`</span> a LightGBM classifier from <span class="in">`r ref_pkg("mlr3extralearners")`</span> on the pima task using $1/3$ of the training data for validation.</span>
<span id="cb338-2217"><a href="#cb338-2217" aria-hidden="true" tabindex="-1"></a>   As the pima task has missing values, select a method from <span class="in">`r ref_pkg("mlr3pipelines")`</span> to impute them.</span>
<span id="cb338-2218"><a href="#cb338-2218" aria-hidden="true" tabindex="-1"></a>   Explicitly set the evaluation metric to logloss (<span class="in">`"binary_logloss"`</span>), the maximum number of boosting iterations to 1000, the patience parameter to 10, and the step size to 0.01.</span>
<span id="cb338-2219"><a href="#cb338-2219" aria-hidden="true" tabindex="-1"></a>   After training the learner, inspect the final validation scores as well as the early stopped number of iterations.</span>
<span id="cb338-2220"><a href="#cb338-2220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2221"><a href="#cb338-2221" aria-hidden="true" tabindex="-1"></a>We start by loading the packages and creating the task.</span>
<span id="cb338-2222"><a href="#cb338-2222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2223"><a href="#cb338-2223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-126}</span></span>
<span id="cb338-2224"><a href="#cb338-2224" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3)</span>
<span id="cb338-2225"><a href="#cb338-2225" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3extralearners)</span>
<span id="cb338-2226"><a href="#cb338-2226" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb338-2227"><a href="#cb338-2227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2228"><a href="#cb338-2228" aria-hidden="true" tabindex="-1"></a>tsk_pima <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"pima"</span>)</span>
<span id="cb338-2229"><a href="#cb338-2229" aria-hidden="true" tabindex="-1"></a>tsk_pima</span>
<span id="cb338-2230"><a href="#cb338-2230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2231"><a href="#cb338-2231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2232"><a href="#cb338-2232" aria-hidden="true" tabindex="-1"></a>Below, we see that the task has five features with missing values.</span>
<span id="cb338-2233"><a href="#cb338-2233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2234"><a href="#cb338-2234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-127}</span></span>
<span id="cb338-2235"><a href="#cb338-2235" aria-hidden="true" tabindex="-1"></a>tsk_pima<span class="sc">$</span><span class="fu">missings</span>()</span>
<span id="cb338-2236"><a href="#cb338-2236" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2237"><a href="#cb338-2237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2238"><a href="#cb338-2238" aria-hidden="true" tabindex="-1"></a>Next, we create the LightGBM classifier, but don't specify the validation data yet.</span>
<span id="cb338-2239"><a href="#cb338-2239" aria-hidden="true" tabindex="-1"></a>We handle the missing values using a simple median imputation.</span>
<span id="cb338-2240"><a href="#cb338-2240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2241"><a href="#cb338-2241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-128}</span></span>
<span id="cb338-2242"><a href="#cb338-2242" aria-hidden="true" tabindex="-1"></a>lrn_lgbm <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.lightgbm"</span>,</span>
<span id="cb338-2243"><a href="#cb338-2243" aria-hidden="true" tabindex="-1"></a>  <span class="at">num_iterations =</span> <span class="dv">1000</span>,</span>
<span id="cb338-2244"><a href="#cb338-2244" aria-hidden="true" tabindex="-1"></a>  <span class="at">early_stopping_rounds =</span> <span class="dv">10</span>,</span>
<span id="cb338-2245"><a href="#cb338-2245" aria-hidden="true" tabindex="-1"></a>  <span class="at">learning_rate =</span> <span class="fl">0.01</span>,</span>
<span id="cb338-2246"><a href="#cb338-2246" aria-hidden="true" tabindex="-1"></a>  <span class="at">eval =</span> <span class="st">"binary_logloss"</span></span>
<span id="cb338-2247"><a href="#cb338-2247" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-2248"><a href="#cb338-2248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2249"><a href="#cb338-2249" aria-hidden="true" tabindex="-1"></a>glrn <span class="ot">=</span> <span class="fu">as_learner</span>(<span class="fu">po</span>(<span class="st">"imputemedian"</span>) <span class="sc">%&gt;&gt;%</span> lrn_lgbm)</span>
<span id="cb338-2250"><a href="#cb338-2250" aria-hidden="true" tabindex="-1"></a>glrn<span class="sc">$</span>id <span class="ot">=</span> <span class="st">"lgbm"</span></span>
<span id="cb338-2251"><a href="#cb338-2251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2252"><a href="#cb338-2252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2253"><a href="#cb338-2253" aria-hidden="true" tabindex="-1"></a>After constructing the graphlearner, we now configure the validation data using <span class="in">`r ref("set_validate()")`</span>.</span>
<span id="cb338-2254"><a href="#cb338-2254" aria-hidden="true" tabindex="-1"></a>The call below sets the <span class="in">`$validate`</span> field of the LightGBM pipeop to <span class="in">`"predefined"`</span> and of the graphlearner to <span class="in">`0.3`</span>.</span>
<span id="cb338-2255"><a href="#cb338-2255" aria-hidden="true" tabindex="-1"></a>Recall that only the graphlearner itself can specify *how* the validation data is generated.</span>
<span id="cb338-2256"><a href="#cb338-2256" aria-hidden="true" tabindex="-1"></a>The individual pipeops can either use it (<span class="in">`"predefined"`</span>) or not (<span class="in">`NULL`</span>).</span>
<span id="cb338-2257"><a href="#cb338-2257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2258"><a href="#cb338-2258" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-129}</span></span>
<span id="cb338-2259"><a href="#cb338-2259" aria-hidden="true" tabindex="-1"></a><span class="fu">set_validate</span>(glrn, <span class="at">validate =</span> <span class="fl">0.3</span>, <span class="at">ids =</span> <span class="st">"classif.lightgbm"</span>)</span>
<span id="cb338-2260"><a href="#cb338-2260" aria-hidden="true" tabindex="-1"></a>glrn<span class="sc">$</span>validate</span>
<span id="cb338-2261"><a href="#cb338-2261" aria-hidden="true" tabindex="-1"></a>glrn<span class="sc">$</span>graph<span class="sc">$</span>pipeops<span class="sc">$</span>classif.lightgbm<span class="sc">$</span>validate</span>
<span id="cb338-2262"><a href="#cb338-2262" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2263"><a href="#cb338-2263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2264"><a href="#cb338-2264" aria-hidden="true" tabindex="-1"></a>Finally, we train the learner and inspect the validation scores and internally tuned parameters.</span>
<span id="cb338-2265"><a href="#cb338-2265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2266"><a href="#cb338-2266" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-130}</span></span>
<span id="cb338-2267"><a href="#cb338-2267" aria-hidden="true" tabindex="-1"></a>glrn<span class="sc">$</span><span class="fu">train</span>(tsk_pima)</span>
<span id="cb338-2268"><a href="#cb338-2268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2269"><a href="#cb338-2269" aria-hidden="true" tabindex="-1"></a>glrn<span class="sc">$</span>internal_tuned_values</span>
<span id="cb338-2270"><a href="#cb338-2270" aria-hidden="true" tabindex="-1"></a>glrn<span class="sc">$</span>internal_valid_scores</span>
<span id="cb338-2271"><a href="#cb338-2271" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2272"><a href="#cb338-2272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2273"><a href="#cb338-2273" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Wrap the learner from exercise 1) in an <span class="in">`AutoTuner`</span> using a three-fold CV for the tuning.</span>
<span id="cb338-2274"><a href="#cb338-2274" aria-hidden="true" tabindex="-1"></a>   Also change the rule for aggregating the different boosting iterations from averaging to taking the maximum across the folds.</span>
<span id="cb338-2275"><a href="#cb338-2275" aria-hidden="true" tabindex="-1"></a>   Don't tune any parameters other than <span class="in">`nrounds`</span>, which can be done using <span class="in">`tnr("internal")`</span>.</span>
<span id="cb338-2276"><a href="#cb338-2276" aria-hidden="true" tabindex="-1"></a>   Use the internal validation metric as the tuning measure.</span>
<span id="cb338-2277"><a href="#cb338-2277" aria-hidden="true" tabindex="-1"></a>   Compare this learner with a <span class="in">`lrn("classif.rpart")`</span> using a 10-fold outer cross-validation with respect to classification accuracy.</span>
<span id="cb338-2278"><a href="#cb338-2278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2279"><a href="#cb338-2279" aria-hidden="true" tabindex="-1"></a>We start by setting the number of boosting iterations to an internal tune token where the maximum number of boosting iterations is 1000 and the aggregation function the maximum.</span>
<span id="cb338-2280"><a href="#cb338-2280" aria-hidden="true" tabindex="-1"></a>Note that the input to the aggregation function is a list of integer values (the early stopped values for the different resampling iterations), so we need to <span class="in">`unlist()`</span> it first before taking the maximum.</span>
<span id="cb338-2281"><a href="#cb338-2281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2282"><a href="#cb338-2282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-131}</span></span>
<span id="cb338-2283"><a href="#cb338-2283" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3tuning)</span>
<span id="cb338-2284"><a href="#cb338-2284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2285"><a href="#cb338-2285" aria-hidden="true" tabindex="-1"></a>glrn<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">set_values</span>(</span>
<span id="cb338-2286"><a href="#cb338-2286" aria-hidden="true" tabindex="-1"></a>  <span class="at">classif.lightgbm.num_iterations =</span> <span class="fu">to_tune</span>(</span>
<span id="cb338-2287"><a href="#cb338-2287" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> <span class="dv">1000</span>, <span class="at">internal =</span> <span class="cn">TRUE</span>, <span class="at">aggr =</span> <span class="cf">function</span>(x) <span class="fu">max</span>(<span class="fu">unlist</span>(x))</span>
<span id="cb338-2288"><a href="#cb338-2288" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb338-2289"><a href="#cb338-2289" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-2290"><a href="#cb338-2290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2291"><a href="#cb338-2291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2292"><a href="#cb338-2292" aria-hidden="true" tabindex="-1"></a>Now, we change the validation data from <span class="in">`0.3`</span> to <span class="in">`"test"`</span>, where we can omit the <span class="in">`ids`</span> specification as LightGBM is the base learner.</span>
<span id="cb338-2293"><a href="#cb338-2293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2294"><a href="#cb338-2294" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-132}</span></span>
<span id="cb338-2295"><a href="#cb338-2295" aria-hidden="true" tabindex="-1"></a><span class="fu">set_validate</span>(glrn, <span class="at">validate =</span> <span class="st">"test"</span>)</span>
<span id="cb338-2296"><a href="#cb338-2296" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2297"><a href="#cb338-2297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2298"><a href="#cb338-2298" aria-hidden="true" tabindex="-1"></a>Next, we create the autotuner using the configuration given in the instructions.</span>
<span id="cb338-2299"><a href="#cb338-2299" aria-hidden="true" tabindex="-1"></a>As the internal validation measures are calculated by <span class="in">`lightgbm`</span> and not <span class="in">`mlr3`</span>, we need to specify whether the metric should be minimized.</span>
<span id="cb338-2300"><a href="#cb338-2300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2301"><a href="#cb338-2301" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-133}</span></span>
<span id="cb338-2302"><a href="#cb338-2302" aria-hidden="true" tabindex="-1"></a>at_lgbm <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb338-2303"><a href="#cb338-2303" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> glrn,</span>
<span id="cb338-2304"><a href="#cb338-2304" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"internal"</span>),</span>
<span id="cb338-2305"><a href="#cb338-2305" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>),</span>
<span id="cb338-2306"><a href="#cb338-2306" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"internal_valid_score"</span>,</span>
<span id="cb338-2307"><a href="#cb338-2307" aria-hidden="true" tabindex="-1"></a>    <span class="at">select =</span> <span class="st">"classif.lightgbm.binary_logloss"</span>, <span class="at">minimize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb338-2308"><a href="#cb338-2308" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-2309"><a href="#cb338-2309" aria-hidden="true" tabindex="-1"></a>at_lgbm<span class="sc">$</span>id <span class="ot">=</span> <span class="st">"at_lgbm"</span></span>
<span id="cb338-2310"><a href="#cb338-2310" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2311"><a href="#cb338-2311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2312"><a href="#cb338-2312" aria-hidden="true" tabindex="-1"></a>Finally, we set up the benchmark design, run it, and evaluate the learners in terms of their classification accuracy.</span>
<span id="cb338-2313"><a href="#cb338-2313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2314"><a href="#cb338-2314" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-134}</span></span>
<span id="cb338-2315"><a href="#cb338-2315" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb338-2316"><a href="#cb338-2316" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> tsk_pima,</span>
<span id="cb338-2317"><a href="#cb338-2317" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> <span class="fu">list</span>(at_lgbm, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)),</span>
<span id="cb338-2318"><a href="#cb338-2318" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">10</span>)</span>
<span id="cb338-2319"><a href="#cb338-2319" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb338-2320"><a href="#cb338-2320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2321"><a href="#cb338-2321" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb338-2322"><a href="#cb338-2322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2323"><a href="#cb338-2323" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.acc"</span>))</span>
<span id="cb338-2324"><a href="#cb338-2324" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb338-2325"><a href="#cb338-2325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2326"><a href="#cb338-2326" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Consider the code below:</span>
<span id="cb338-2327"><a href="#cb338-2327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2328"><a href="#cb338-2328" aria-hidden="true" tabindex="-1"></a>   <span class="in">```{r solutions-135}</span></span>
<span id="cb338-2329"><a href="#cb338-2329" aria-hidden="true" tabindex="-1"></a>   branch_lrn <span class="ot">=</span> <span class="fu">as_learner</span>(</span>
<span id="cb338-2330"><a href="#cb338-2330" aria-hidden="true" tabindex="-1"></a>     <span class="fu">ppl</span>(<span class="st">"branch"</span>, <span class="fu">list</span>(</span>
<span id="cb338-2331"><a href="#cb338-2331" aria-hidden="true" tabindex="-1"></a>       <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>),</span>
<span id="cb338-2332"><a href="#cb338-2332" aria-hidden="true" tabindex="-1"></a>       <span class="fu">lrn</span>(<span class="st">"classif.xgboost"</span>,</span>
<span id="cb338-2333"><a href="#cb338-2333" aria-hidden="true" tabindex="-1"></a>         <span class="at">early_stopping_rounds =</span> <span class="dv">10</span>,</span>
<span id="cb338-2334"><a href="#cb338-2334" aria-hidden="true" tabindex="-1"></a>         <span class="at">eval_metric =</span> <span class="st">"error"</span>,</span>
<span id="cb338-2335"><a href="#cb338-2335" aria-hidden="true" tabindex="-1"></a>         <span class="at">eta =</span> <span class="fu">to_tune</span>(<span class="fl">0.001</span>, <span class="fl">0.1</span>, <span class="at">logscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb338-2336"><a href="#cb338-2336" aria-hidden="true" tabindex="-1"></a>         <span class="at">nrounds =</span> <span class="fu">to_tune</span>(<span class="at">upper =</span> <span class="dv">1000</span>, <span class="at">internal =</span> <span class="cn">TRUE</span>)))))</span>
<span id="cb338-2337"><a href="#cb338-2337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2338"><a href="#cb338-2338" aria-hidden="true" tabindex="-1"></a>   <span class="fu">set_validate</span>(branch_lrn, <span class="at">validate =</span> <span class="st">"test"</span>, <span class="at">ids =</span> <span class="st">"classif.xgboost"</span>)</span>
<span id="cb338-2339"><a href="#cb338-2339" aria-hidden="true" tabindex="-1"></a>   branch_lrn<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">set_values</span>(<span class="at">branch.selection =</span> <span class="fu">to_tune</span>())</span>
<span id="cb338-2340"><a href="#cb338-2340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2341"><a href="#cb338-2341" aria-hidden="true" tabindex="-1"></a>   at <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb338-2342"><a href="#cb338-2342" aria-hidden="true" tabindex="-1"></a>     <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>),</span>
<span id="cb338-2343"><a href="#cb338-2343" aria-hidden="true" tabindex="-1"></a>     <span class="at">learner =</span> branch_lrn,</span>
<span id="cb338-2344"><a href="#cb338-2344" aria-hidden="true" tabindex="-1"></a>     <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>, <span class="at">ratio =</span> <span class="fl">0.8</span>),</span>
<span id="cb338-2345"><a href="#cb338-2345" aria-hidden="true" tabindex="-1"></a>     <span class="co"># cannot use internal validation score because ranger does not have one</span></span>
<span id="cb338-2346"><a href="#cb338-2346" aria-hidden="true" tabindex="-1"></a>     <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>),</span>
<span id="cb338-2347"><a href="#cb338-2347" aria-hidden="true" tabindex="-1"></a>     <span class="at">term_evals =</span> <span class="dv">10</span>L,</span>
<span id="cb338-2348"><a href="#cb338-2348" aria-hidden="true" tabindex="-1"></a>     <span class="at">store_models =</span> <span class="cn">TRUE</span></span>
<span id="cb338-2349"><a href="#cb338-2349" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb338-2350"><a href="#cb338-2350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2351"><a href="#cb338-2351" aria-hidden="true" tabindex="-1"></a>   tsk_sonar <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>)<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)</span>
<span id="cb338-2352"><a href="#cb338-2352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2353"><a href="#cb338-2353" aria-hidden="true" tabindex="-1"></a>   rr <span class="ot">=</span> <span class="fu">resample</span>(</span>
<span id="cb338-2354"><a href="#cb338-2354" aria-hidden="true" tabindex="-1"></a>     tsk_sonar, at, <span class="fu">rsmp</span>(<span class="st">"holdout"</span>, <span class="at">ratio =</span> <span class="fl">0.8</span>), <span class="at">store_models =</span> <span class="cn">TRUE</span></span>
<span id="cb338-2355"><a href="#cb338-2355" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb338-2356"><a href="#cb338-2356" aria-hidden="true" tabindex="-1"></a>   <span class="in">```</span></span>
<span id="cb338-2357"><a href="#cb338-2357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2358"><a href="#cb338-2358" aria-hidden="true" tabindex="-1"></a>   Answer the following questions (ideally without running the code):</span>
<span id="cb338-2359"><a href="#cb338-2359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2360"><a href="#cb338-2360" aria-hidden="true" tabindex="-1"></a>  3.1 During the hyperparameter optimization, how many observations are used to train the XGBoost algorithm (excluding validation data) and how many for the random forest?</span>
<span id="cb338-2361"><a href="#cb338-2361" aria-hidden="true" tabindex="-1"></a>      Hint: learners that cannot make use of validation data ignore it.</span>
<span id="cb338-2362"><a href="#cb338-2362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2363"><a href="#cb338-2363" aria-hidden="true" tabindex="-1"></a>The outer resampling already removes 20 observations from the data (the outer test set), leaving only 80 data points (the outer train set) for the inner resampling.</span>
<span id="cb338-2364"><a href="#cb338-2364" aria-hidden="true" tabindex="-1"></a>Then 16 (0.2 * 80; the test set of the inner holdout resampling) observations are used to evaluate the hyperparameter configurations.</span>
<span id="cb338-2365"><a href="#cb338-2365" aria-hidden="true" tabindex="-1"></a>This leaves 64 (80 - 16) observations for training.</span>
<span id="cb338-2366"><a href="#cb338-2366" aria-hidden="true" tabindex="-1"></a>For XGBoost, the 16 observations that make up the inner test set are also used for validation, so no more observations from the 64 training points are removed.</span>
<span id="cb338-2367"><a href="#cb338-2367" aria-hidden="true" tabindex="-1"></a>Because the random forest does not support validation, the 16 observations from the inner test set will only be used for evaluation the hyperparameter configuration, but not simultanteously for internal validation.</span>
<span id="cb338-2368"><a href="#cb338-2368" aria-hidden="true" tabindex="-1"></a>Therefore, both the random forest and XGBoost models use 64 observations for training.</span>
<span id="cb338-2369"><a href="#cb338-2369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2370"><a href="#cb338-2370" aria-hidden="true" tabindex="-1"></a>  3.2 How many observations would be used to train the final model if XGBoost was selected? What if the random forest was chosen?</span>
<span id="cb338-2371"><a href="#cb338-2371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2372"><a href="#cb338-2372" aria-hidden="true" tabindex="-1"></a>In both cases, all 80 observations (the train set from the outer resampling) would be used.</span>
<span id="cb338-2373"><a href="#cb338-2373" aria-hidden="true" tabindex="-1"></a>This is because during the final model fit no validation data is generated.</span>
<span id="cb338-2374"><a href="#cb338-2374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2375"><a href="#cb338-2375" aria-hidden="true" tabindex="-1"></a>  3.3 How would the answers to the last two questions change if we had set the <span class="in">`$validate`</span> field of the graphlearner to <span class="in">`0.25`</span> instead of <span class="in">`"test"`</span>?</span>
<span id="cb338-2376"><a href="#cb338-2376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2377"><a href="#cb338-2377" aria-hidden="true" tabindex="-1"></a>In this case, the validation data is no longer identical to the inner resampling test set.</span>
<span id="cb338-2378"><a href="#cb338-2378" aria-hidden="true" tabindex="-1"></a>Instead, it is split from the 64 observations that make up the inner training set.</span>
<span id="cb338-2379"><a href="#cb338-2379" aria-hidden="true" tabindex="-1"></a>Because this happens before the task enters the graphlearner, both the XGBoost model *and* the random forest only have access to 48 ((1 - 0.25) * 64) observations, and the remaining 16 are used to create the validation data.</span>
<span id="cb338-2380"><a href="#cb338-2380" aria-hidden="true" tabindex="-1"></a>Note that the random forest will again ignore the validation data as it does not have the 'validation' property and therefore cannot use it.</span>
<span id="cb338-2381"><a href="#cb338-2381" aria-hidden="true" tabindex="-1"></a>Also, the autotuner would now use a different set for tuning the step size and boosting iterations (which coincidentally both have size 16).</span>
<span id="cb338-2382"><a href="#cb338-2382" aria-hidden="true" tabindex="-1"></a>Therefore, the answer to question 3.1 would be 48 instead of 64.</span>
<span id="cb338-2383"><a href="#cb338-2383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2384"><a href="#cb338-2384" aria-hidden="true" tabindex="-1"></a>However, this does not change the answer to 3.2, as, again, no validation is performed during the final model fit.</span>
<span id="cb338-2385"><a href="#cb338-2385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2386"><a href="#cb338-2386" aria-hidden="true" tabindex="-1"></a>Note that we would normally recommend setting the validation data to <span class="in">`"test"`</span> when tuning, so this should be thought of as a illustrative example.</span>
<span id="cb338-2387"><a href="#cb338-2387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2388"><a href="#cb338-2388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2389"><a href="#cb338-2389" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Look at the (failing) code below:</span>
<span id="cb338-2390"><a href="#cb338-2390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2391"><a href="#cb338-2391" aria-hidden="true" tabindex="-1"></a>   <span class="in">```{r solutions-136, error = TRUE}</span></span>
<span id="cb338-2392"><a href="#cb338-2392" aria-hidden="true" tabindex="-1"></a>   tsk_sonar <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>)</span>
<span id="cb338-2393"><a href="#cb338-2393" aria-hidden="true" tabindex="-1"></a>   glrn <span class="ot">=</span> <span class="fu">as_learner</span>(</span>
<span id="cb338-2394"><a href="#cb338-2394" aria-hidden="true" tabindex="-1"></a>     <span class="fu">po</span>(<span class="st">"pca"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">lrn</span>(<span class="st">"classif.xgboost"</span>, <span class="at">validate =</span> <span class="fl">0.3</span>)</span>
<span id="cb338-2395"><a href="#cb338-2395" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb338-2396"><a href="#cb338-2396" aria-hidden="true" tabindex="-1"></a>   <span class="in">```</span></span>
<span id="cb338-2397"><a href="#cb338-2397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2398"><a href="#cb338-2398" aria-hidden="true" tabindex="-1"></a>   Can you explain *why* the code fails?</span>
<span id="cb338-2399"><a href="#cb338-2399" aria-hidden="true" tabindex="-1"></a>   Hint: Should the data that xgboost uses for validation be preprocessed according to the *train* or *predict* logic?</span>
<span id="cb338-2400"><a href="#cb338-2400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-2401"><a href="#cb338-2401" aria-hidden="true" tabindex="-1"></a>If we set the <span class="in">`$validate`</span> field of the XGBoost classifier to <span class="in">`0.3`</span>, the validation data would be generated from the output task of <span class="in">`PipeOpOpPCA`</span>.</span>
<span id="cb338-2402"><a href="#cb338-2402" aria-hidden="true" tabindex="-1"></a>However, this task has been exclusively preprocessed using the train logic, because the <span class="in">`PipeOpPCA`</span> does not 'know' that the LightGBM classifier wants to do validation.</span>
<span id="cb338-2403"><a href="#cb338-2403" aria-hidden="true" tabindex="-1"></a>Because validation performance is intended to measure how well a model would perform during prediction, the validation should be preprocessed according to the predict logic.</span>
<span id="cb338-2404"><a href="#cb338-2404" aria-hidden="true" tabindex="-1"></a>For this reason, splitting of the 30% of the output from <span class="in">`PipeOpPCA`</span> to use as validation data in the XGBoost classifier would be invalid.</span>
<span id="cb338-2405"><a href="#cb338-2405" aria-hidden="true" tabindex="-1"></a>Therefore, it is not possible to set the <span class="in">`$validate`</span> field of <span class="in">`PipeOps`</span> to values other than <span class="in">`predefined' or `</span>NULL'.</span>
<span id="cb338-2406"><a href="#cb338-2406" aria-hidden="true" tabindex="-1"></a>Only the <span class="in">`GraphLearner`</span> itself can dictate *how* the validation data is created *before* it enters the <span class="in">`Graph`</span>, so the validation data is then preprocessed according to the predict logic.</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>All content licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> <br> © Bernd Bischl, Raphael Sonabend, Lars Kotthoff, Michel Lang.</p>
</div>   
    <div class="nav-footer-center">
<p><a href="https://mlr-org.com">Website</a> | <a href="https://github.com/mlr-org/mlr3book">GitHub</a> | <a href="https://mlr-org.com/gallery">Gallery</a> | <a href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/">Mattermost</a></p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mlr-org/mlr3book/edit/main/book/chapters/appendices/solutions.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mlr-org/mlr3book/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/mlr-org/mlr3book/blob/main/book/chapters/appendices/solutions.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>